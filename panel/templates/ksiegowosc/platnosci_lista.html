{% load static %}
<!DOCTYPE html><html lang="pl"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Księgowość — Płatności do akceptacji</title>
<style>
:root{--brand:#0b74ff;--ink:#0b1320;--muted:#5b6777;--bg:#f7f9fe;--line:#e6edff;--ok:#16a34a;--err:#ef4444;--radius:16px;--maxw:1100px}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:var(--maxw);margin:32px auto;padding:0 16px}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius)}
.card-h{padding:16px 18px;border-bottom:1px solid var(--line);font-weight:700}
.card-b{padding:18px}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse;min-width:1080px}
th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
.btn{appearance:none;border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
.btn-ghost{background:#fff;border:1px solid var(--line)}
.btn-ok{background:var(--ok);color:#fff}
.btn-bad{background:var(--err);color:#fff}
.btn-tab{background:#fff;border:1px solid var(--line);border-radius:999px;padding:6px 12px}
.btn-tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.muted{color:var(--muted)} form{display:inline}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
tr.just-updated{animation: flash 2s ease}
@keyframes flash{0%{background:#ecffec}100%{background:transparent}}
</style>
</head><body>

{% include "partials/brand.html" %}
<div class="wrap">
  <div class="card">
    <div class="card-h">Płatności — przegląd</div>
    <div class="card-b">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
        <a href="?filtr=wszystkie" class="btn-tab {% if filtr != 'oczekujace' %}active{% endif %}">Wszystkie</a>
        <a href="?filtr=oczekujace" class="btn-tab {% if filtr == 'oczekujace' %}active{% endif %}">Oczekujące</a>
        <a class="btn-ghost" href="{% url 'panel_ksiegowosc' %}" style="margin-left:auto">Wróć do panelu księgowości</a>
      </div>

      {% if rezerwacje %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Uczeń</th>
              <th>Nauczyciel</th>
              <th>Przedmiot</th>
              <th>Poziom</th>
              <th>Termin</th>
              <th>Tytuł</th>
              <th>Kwota</th>
              <th>Potwierdzenia</th>
              <th>Status</th>
              <th>Akcje</th>
            </tr>
          </thead>
          <tbody>
          {% for r in rezerwacje %}
            <tr id="row-{{ r.id }}" class="{% if just|default:'' == r.id|stringformat:'s' %}just-updated{% endif %}">
              <td>#{{ r.id }}</td>
              <td>{{ r.uczen.get_full_name|default:r.uczen.username }}</td>
              <td>{{ r.nauczyciel.get_full_name|default:r.nauczyciel.username }}</td>
              <td>{{ r.przedmiot|default:"—" }}</td>
              <td>{{ r.poziom|default:r.poziom_nauki|default:"—" }}</td>
              <td>{{ r.termin|date:"Y-m-d H:i" }}</td>
              <td>Zajęcia {{ r.id }} — {{ r.uczen.username }}</td>
              <td>{{ r.kwota|floatformat:2 }} zł</td>

              <td>
                {% if r.potwierdzenia.all %}
                  <div style="display:flex;flex-direction:column;gap:4px">
                    {% for p in r.potwierdzenia.all %}
                      <a href="{{ p.file.url }}" target="_blank" rel="noopener">Pobierz #{{ p.id }}</a>
                      {% if p.note %}<span class="muted" style="margin-left:4px">— {{ p.note }}</span>{% endif %}
                    {% endfor %}
                  </div>
                {% else %}
                  <span class="muted">brak</span>
                {% endif %}
              </td>

              <td>
                {% if r.oplacona %}
                  <span class="badge" style="border-color:#16a34a;color:#16a34a">opłacona</span>
                {% elif r.odrzucona %}
                  <span class="badge" style="border-color:#ef4444;color:#ef4444">odrzucona</span>
                {% else %}
                  <span class="badge">do opłaty</span>
                {% endif %}
              </td>

              <td>
                <form method="post" action="{% url 'ksiegowosc_oznacz_oplacona' r.id %}">
                  {% csrf_token %}<button class="btn btn-ok" type="submit">Opłacone</button>
                </form>
                <form method="post" action="{% url 'ksiegowosc_oznacz_odrzucona' r.id %}">
                  {% csrf_token %}<button class="btn btn-bad" type="submit">Odrzuć</button>
                </form>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        Brak rezerwacji dla wybranego filtra.
      {% endif %}
    </div>
  </div>
</div>
</body></html>
