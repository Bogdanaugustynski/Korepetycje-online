<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Wybierz dzień i godzinę korepetycji</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .teacher-box {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            width: 600px;
            text-align: center;
        }
        .btn {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn:hover { background-color: #0056b3; }

        .calendar { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .day {
            width: 40px; height: 40px; margin: 5px;
            display: flex; align-items: center; justify-content: center;
            background-color: #e9ecef; border-radius: 5px; cursor: pointer;
        }
        .day:hover { background-color: #ccc; }
        .day.selected { background-color: #007bff; color: #fff; }

        .hour-grid { display: none; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .hour {
            width: 80px; height: 30px; margin: 5px;
            display: flex; align-items: center; justify-content: center;
            background-color: #e9ecef; border-radius: 5px; cursor: pointer;
        }
        .hour.selected { background-color: #28a745; color: #fff; }
    </style>
</head>
<body>

<div class="teacher-box">
    <h2>Wybierz dzień i godzinę korepetycji</h2>

    <h3>Wybierz dostępne godziny</h3>
    <div style="display:flex; gap:4%; justify-content:center; margin-bottom:10px;">
        <button class="btn" style="width:48%;" onclick="changeMonth(-1)">◀ Poprzedni miesiąc</button>
        <button class="btn" style="width:48%;" onclick="changeMonth(1)">Następny miesiąc ▶</button>
    </div>
    <div id="month-name" style="font-weight:bold; margin-bottom:10px;"></div>

    <div id="calendar" class="calendar"></div>

    <h3>Wybierz godziny</h3>
    <div id="hourGrid" class="hour-grid"></div>

    <button class="btn" onclick="sendToDjango()">Zapisz dostępne godziny</button>
</div>

<script>
    let currentDate   = new Date();
    let selectedDay   = null;
    const availableHours = {};   // { 'DD': ['07:00', '08:00', ...] }

    /* -----------  Renderowanie kalendarza  ---------------- */
    function renderCalendar() {
        const calendar   = document.getElementById("calendar");
        const monthName  = document.getElementById("month-name");
        calendar.innerHTML = "";

        monthName.textContent = currentDate.toLocaleString("pl-PL", { month: "long", year: "numeric" });

        const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
        for (let i = 1; i <= daysInMonth; i++) {
            const day = document.createElement("div");
            day.className = "day";
            day.textContent = i;
            day.onclick = () => selectDay(i, day);
            calendar.appendChild(day);
        }
        // Jeśli dany dzień ma już zapamiętane godziny, zaznacz go
        if (selectedDay) {
            const dayEls = calendar.querySelectorAll(".day");
            const match  = [...dayEls].find(el => parseInt(el.textContent, 10) === selectedDay);
            if (match) match.classList.add("selected");
        }
    }

    /* -----------  Wybór dnia  ---------------- */
    function selectDay(day, element) {
        selectedDay = day;
        document.querySelectorAll(".day").forEach(d => d.classList.remove("selected"));
        element.classList.add("selected");
        document.getElementById("hourGrid").style.display = "flex";
        renderHours();
    }

    /* -----------  Renderowanie godzin  ---------------- */
    function renderHours() {
        const hourGrid = document.getElementById("hourGrid");
        hourGrid.innerHTML = "";
        const hours = ["07:00","07:30","08:00","08:30","09:00","09:30","10:00","10:30",
                       "11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30",
                       "15:00","15:30","16:00","16:30","17:00","17:30","18:00","18:30",
                       "19:00","19:30","20:00"];
        hours.forEach(hour => {
            const hourDiv = document.createElement("div");
            hourDiv.className = "hour";
            hourDiv.textContent = hour;
            hourDiv.onclick = () => toggleHour(hour);
            hourGrid.appendChild(hourDiv);
        });
        // zaznacz zapamiętane godziny
        (availableHours[selectedDay] || []).forEach(h => {
            const el = [...hourGrid.children].find(e => e.textContent === h);
            if (el) el.classList.add("selected");
        });
    }

    /* -----------  Dodawanie / usuwanie godziny  ---------------- */
    function toggleHour(hour) {
        if (!selectedDay) return;
        if (!availableHours[selectedDay]) availableHours[selectedDay] = [];
        const idx = availableHours[selectedDay].indexOf(hour);
        idx === -1 ? availableHours[selectedDay].push(hour)
                   : availableHours[selectedDay].splice(idx, 1);
        renderHours();
    }

    /* -----------  Wysyłka do Django  ---------------- */
    function sendToDjango() {
        if (!selectedDay) { alert("Wybierz dzień przed zapisaniem godzin!"); return; }

        const terminy = Object.keys(availableHours).map(dzien => ({
            data: `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(dzien).padStart(2,'0')}`,
            godziny: availableHours[dzien]
        }));

        fetch('/wybierz_godziny/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ terminy })
        })
        .then(r => r.json())
        .then(() => {
            alert("Terminy zostały zapisane!");
            // odśwież kalendarz
            renderCalendar();
            document.getElementById("hourGrid").style.display = "none";
            selectedDay = null;
        })
        .catch(err => console.error('Błąd:', err));
    }

    /* -----------  Zmiana miesiąca  ---------------- */
    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        selectedDay = null;                          // reset zaznaczonego dnia
        document.getElementById("hourGrid").style.display = "none";
        renderCalendar();
    }

    /* -----------  Pobierz cookie CSRF  ---------------- */
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        return parts.length === 2 ? decodeURIComponent(parts.pop().split(';').shift()) : null;
    }

    /* -----------  Inicjalizacja: pobierz zapisane terminy  ---------------- */
    window.onload = () => {
        fetch('/pobierz_terminy/')
            .then(r => r.json())
            .then(data => {
                data.terminy.forEach(t => {
                    const dzien = parseInt(t.data.split('-')[2], 10);
                    if (!availableHours[dzien]) availableHours[dzien] = [];
                    availableHours[dzien].push(t.godzina);
                });
                renderCalendar();
            });
    };
</script>
</body>
</html>
