{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wybierz dzień i godzinę — PolubiszTo.pl</title>

  <style>
    :root{
      --brand:#0b74ff;
      --brand-700:#095cd1;
      --ink:#0b1320;
      --muted:#5b6777;
      --bg:#f7f9fe;
      --card:#ffffff;
      --line:#e6edff;
      --radius:18px;
      --shadow:0 12px 36px rgba(11,116,255,.14);
      --maxw:1100px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,"Noto Sans",sans-serif}
    a{color:inherit}
    .wrap{max-width:var(--maxw);margin:24px auto;padding:0 16px}
    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:20px;
    }
    h1{font-size:clamp(20px,4vw,28px); margin:6px 0 14px}
    .sub{color:var(--muted); margin:0 0 16px}

    .btn{
      appearance:none; border:0; cursor:pointer; border-radius:14px;
      padding:12px 16px; font-weight:600;
      background:var(--brand); color:#fff; box-shadow:0 6px 18px rgba(11,116,255,.22);
      transition:.2s transform ease, .2s opacity ease, .2s background ease;
    }
    .btn:hover{background:var(--brand-700); transform:translateY(-1px)}
    .btn.secondary{background:#eef3ff;color:#114; box-shadow:none; border:1px solid var(--line)}
    .btn.secondary:hover{background:#e4ecff}

    .calendar{
      display:grid; gap:8px; margin-top:8px;
      grid-template-columns: repeat(7, 1fr);
    }
    .weekday{font-size:.9rem; color:var(--muted); text-align:center}
    .day{
      height:46px; border-radius:12px; background:#eef3ff; color:#1b2440;
      display:flex; align-items:center; justify-content:center; cursor:pointer; position:relative;
      transition:.15s ease background, .15s ease transform;
      border:1px solid #e7edff;
    }
    .day:hover{background:#e2ebff}
    .day.selected{background:var(--brand); color:#fff; border-color:transparent}
    .day.disabled{opacity:.45; cursor:not-allowed; background:#f1f4fa}
    .day.has-hours::after{
      content:""; position:absolute; bottom:6px; width:6px; height:6px; border-radius:50%;
      background:#28a745;
    }
    .legend{display:flex; gap:12px; align-items:center; justify-content:center; color:var(--muted); font-size:.92rem; margin-top:10px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.green{background:#28a745}
    .dot.blue{background:var(--brand)}
    .dot.gray{background:#94a3b8}

    .month-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 0 4px}
    .month-title{font-weight:700}

    .hours-wrap{margin-top:18px}
    .hour-grid{
      display:grid; grid-template-columns:repeat(auto-fill, minmax(84px,1fr)); gap:8px;
    }
    .hour{
      height:36px; border-radius:12px; border:1px solid #e7edff; background:#f4f7ff; color:#1b2440;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      transition:.15s ease background, .15s ease transform;
      font-weight:600; user-select:none;
    }
    .hour:hover{background:#e8f0ff}
    .hour.selected{background:#28a745; color:#fff; border-color:transparent}
    .hour.disabled{
      background:#f1f5f9; color:#94a3b8; border-color:#e2e8f0; cursor:not-allowed; text-decoration:line-through;
    }

    .hr{height:1px; background:var(--line); margin:18px 0}
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .right{display:flex; gap:10px; align-items:center}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:24px; background:#111827; color:#fff; padding:12px 16px; border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.25); opacity:0; pointer-events:none; transition:.2s opacity ease;
    }
    .toast.show{opacity:1}
    .spinner{
      width:16px;height:16px;border-radius:50%; border:2px solid #cbd5e1;border-top-color:var(--brand);
      animation:spin .8s linear infinite; display:inline-block; vertical-align:middle; margin-right:8px
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  {% include "partials/brand.html" %}

  <!-- CSRF: wymuszenie nadania cookie + meta fallback -->
  <form style="display:none">{% csrf_token %}</form>
  <meta name="csrf-token" content="{{ csrf_token }}">

  <div class="wrap">
    <div class="card">
      <h1>Wybierz dzień i godzinę korepetycji</h1>
      <p class="sub">Zaznacz dzień w kalendarzu, potem wybierz sloty godzin. Zielona kropka = dzień ma zapisane godziny. Szare godziny = niedostępne (przeszłe lub zajęte).</p>

      <div class="month-head">
        <button class="btn secondary" id="prevBtn" aria-label="Poprzedni miesiąc">◀ Poprzedni</button>
        <div class="month-title" id="month-name">—</div>
        <button class="btn secondary" id="nextBtn" aria-label="Następny miesiąc">Następny ▶</button>
      </div>

      <div class="calendar" id="calendar"></div>

      <div class="legend">
        <span class="dot green"></span> zapisane godziny
        <span class="dot blue"></span> zaznaczony dzień
        <span class="dot gray"></span> zajęte/przeszłe sloty
      </div>

      <div class="hr"></div>

      <div class="hours-wrap">
        <div class="row" style="margin-bottom:8px">
          <strong>Wybierz godziny</strong>
          <div class="right">
            <button class="btn secondary" id="clearDayBtn">Wyczyść dzień</button>
            <button class="btn secondary" id="clearAllBtn">Wyczyść wszystko</button>
          </div>
        </div>
        <div class="hour-grid" id="hourGrid" aria-live="polite" aria-label="Siatka godzin"></div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="sub">Kliknij, by zapisać w systemie.</div>
        <button class="btn" id="saveBtn">Zapisz dostępne godziny</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ================== KONFIG ==================
    const HOURS = [
      "07:00","07:30","08:00","08:30","09:00","09:30","10:00","10:30",
      "11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30",
      "15:00","15:30","16:00","16:30","17:00","17:30","18:00","18:30",
      "19:00","19:30","20:00"
    ];
    const WEEKDAYS = ["Pn","Wt","Śr","Cz","Pt","So","Nd"];

    // ================== STAN ==================
    let viewDate = new Date();              // miesiąc wyświetlany
    let selectedDateKey = null;             // klucz YYYY-MM-DD
    const availableHours = {};              // { 'YYYY-MM-DD': ['07:30', ...] }
    const busyHours = {};                   // { 'YYYY-MM-DD': Set('HH:MM',...) } opcjonalnie z backendu

    // ================== POMOCNICZE ==================
    function pad(n){ return String(n).padStart(2,'0'); }
    function toKey(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function fromKey(key){ const [y,m,dd]=key.split('-').map(Number); return new Date(y, m-1, dd); }
    function monthLabel(d){ return d.toLocaleString("pl-PL",{month:"long", year:"numeric"}); }
    function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
    function isPastDate(dateObj){
      const today = new Date(); today.setHours(0,0,0,0);
      const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
      return d < today;
    }
    function showToast(msg, ok=true){
      const el = document.getElementById('toast');
      el.innerHTML = msg;
      el.style.background = ok ? "#111827" : "#991b1b";
      el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), 2200);
    }
    function spinnerText(text){ return `<span class="spinner"></span>${text}` }
    function nowHM(){
      const n = new Date();
      return `${pad(n.getHours())}:${n.getMinutes()>=30?'30':'00'}`;
    }
    function compareHM(a,b){ return a.localeCompare(b); }

    // ================== CSRF ==================
    function getCSRFToken(){
      // 1) cookie standardowe
      const value = `; ${document.cookie}`;
      const parts = value.split(`; csrftoken=`);
      if (parts.length === 2) {
        const t = decodeURIComponent(parts.pop().split(';').shift());
        if (t && t !== 'undefined' && t !== 'null') return t;
      }
      // 2) meta fallback
      const meta = document.querySelector('meta[name="csrf-token"]');
      if (meta && meta.content && meta.content !== 'NOTPROVIDED') return meta.content;
      return null;
    }

    // ================== KALENDARZ ==================
    function renderCalendar(){
      const cal = document.getElementById('calendar');
      const monthName = document.getElementById('month-name');
      cal.innerHTML = '';

      WEEKDAYS.forEach(w => {
        const wEl = document.createElement('div');
        wEl.className='weekday';
        wEl.textContent = w;
        cal.appendChild(wEl);
      });

      monthName.textContent = monthLabel(viewDate);

      const first = startOfMonth(viewDate);
      const last  = endOfMonth(viewDate);
      let startIndex = (first.getDay()+6)%7;

      for(let i=0;i<startIndex;i++){
        const empty = document.createElement('div');
        cal.appendChild(empty);
      }

      for(let day=1; day<=last.getDate(); day++){
        const d = new Date(viewDate.getFullYear(), viewDate.getMonth(), day);
        const key = toKey(d);

        const el = document.createElement('div');
        el.className = 'day';
        el.textContent = day;

        if (isPastDate(d)){
          el.classList.add('disabled');
        } else {
          el.tabIndex = 0;
          el.addEventListener('click', ()=>selectDate(key));
          el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); selectDate(key);} });
        }

        if (selectedDateKey === key) el.classList.add('selected');
        if (Array.isArray(availableHours[key]) && availableHours[key].length>0){
          el.classList.add('has-hours');
        }

        cal.appendChild(el);
      }
    }

    function selectDate(key){
      selectedDateKey = key;
      renderCalendar();
      renderHours();
    }

    // ================== GODZINY ==================
    function renderHours(){
      const grid = document.getElementById('hourGrid');
      grid.innerHTML = '';

      if(!selectedDateKey){
        grid.innerHTML = '<div style="color:var(--muted)">Najpierw wybierz dzień w kalendarzu.</div>';
        return;
      }

      if(!availableHours[selectedDateKey]) availableHours[selectedDateKey] = [];
      const todayKey = toKey(new Date());
      const disablePastToday = (selectedDateKey === todayKey);
      const currentHM = nowHM();
      const busySet = busyHours[selectedDateKey] || new Set();

      HOURS.forEach(h=>{
        const el = document.createElement('div');
        el.className = 'hour';
        el.textContent = h;

        const isSelected = availableHours[selectedDateKey].includes(h);
        const isBusy = busySet.has(h);
        const isPast = disablePastToday && compareHM(h, currentHM) < 0;

        if(isSelected) el.classList.add('selected');
        if(isBusy || isPast) el.classList.add('disabled');

        el.addEventListener('click', ()=>{
          if (el.classList.contains('disabled')) return;
          toggleHour(h);
        });
        grid.appendChild(el);
      });
    }

    function toggleHour(h){
      const arr = availableHours[selectedDateKey] || (availableHours[selectedDateKey]=[]);
      const i = arr.indexOf(h);
      if(i===-1) arr.push(h); else arr.splice(i,1);
      arr.sort(compareHM);
      renderHours();
      renderCalendar();
    }

    function changeMonth(delta){
      viewDate.setMonth(viewDate.getMonth()+delta);
      if(selectedDateKey){
        const d = fromKey(selectedDateKey);
        if(d.getMonth() !== viewDate.getMonth() || d.getFullYear() !== viewDate.getFullYear()){
          selectedDateKey = null;
        }
      }
      renderCalendar();
      renderHours();
    }

    // ================== API ==================
    async function loadTerminy(){
      const monthName = document.getElementById('month-name');
      const old = monthName.textContent;
      monthName.innerHTML = spinnerText('Wczytywanie...');
      try{
        const r = await fetch('/pobierz_terminy/', {
          method: 'GET',
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await r.json();

        // Oczekujemy: { terminy: [ {data:"YYYY-MM-DD", godzina:"HH:MM"} ], busy?: [ {data, godzina} ] }
        (data.terminy || []).forEach(t=>{
          if(!availableHours[t.data]) availableHours[t.data] = [];
          if(!availableHours[t.data].includes(t.godzina)) availableHours[t.data].push(t.godzina);
          availableHours[t.data].sort(compareHM);
        });

        if (Array.isArray(data.busy)) {
          data.busy.forEach(b=>{
            if(!busyHours[b.data]) busyHours[b.data] = new Set();
            busyHours[b.data].add(b.godzina);
          });
        }

      }catch(e){
        console.error('LOAD error:', e);
        showToast('Nie udało się pobrać terminów.', false);
      }finally{
        monthName.textContent = old || monthLabel(viewDate);
        renderCalendar();
        renderHours();
      }
    }

    async function saveTerminy(){
      const grouped = Object.keys(availableHours)
        .filter(k => Array.isArray(availableHours[k]) && availableHours[k].length > 0)
        .map(k => ({ data: k, godziny: [...availableHours[k]].sort(compareHM) }));

      if(grouped.length === 0){
        showToast('Brak godzin do zapisania.', false);
        return;
      }

      const btn = document.getElementById('saveBtn');
      const old = btn.innerHTML;
      btn.innerHTML = spinnerText('Zapisywanie...');
      btn.disabled = true;

      const token = getCSRFToken();

      const postJson = async (bodyObj) => {
        const r = await fetch('/wybierz_godziny/', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': token,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify(bodyObj)
        });
        return r;
      };

      try{
        // 1) grouped
        let res = await postJson({ terminy: grouped, format: 'grouped' });
        if(!res.ok){
          const text = await res.text().catch(()=> '');
          console.warn('SAVE grouped failed:', res.status, text);

          // 2) flat retry
          const flat = [];
          grouped.forEach(item => item.godziny.forEach(h => flat.push({ data: item.data, godzina: h })));
          res = await postJson({ terminy: flat, format: 'flat' });

          if(!res.ok){
            const text2 = await res.text().catch(()=> '');
            console.error('SAVE flat failed:', res.status, text2);
            showToast(`Błąd zapisu (${res.status}). Szczegóły w konsoli.`, false);
            return;
          }
        }

        await res.json().catch(()=> ({}));
        showToast('Terminy zapisane ✔️', true);
        renderCalendar();
      }catch(e){
        console.error('SAVE exception:', e);
        showToast('Błąd zapisu terminów ❌', false);
      }finally{
        btn.innerHTML = old;
        btn.disabled = false;
      }
    }

    // ================== CZYSZCZENIE ==================
    function clearDay(){
      if(!selectedDateKey) return;
      delete availableHours[selectedDateKey];
      renderHours();
      renderCalendar();
    }
    function clearAll(){
      if(!confirm('Usunąć wszystkie zaznaczone godziny ze wszystkich dni?')) return;
      for(const k of Object.keys(availableHours)) delete availableHours[k];
      selectedDateKey = null;
      renderHours();
      renderCalendar();
    }

    // ================== INIT ==================
    window.addEventListener('load', ()=>{
      document.getElementById('prevBtn').addEventListener('click', ()=>changeMonth(-1));
      document.getElementById('nextBtn').addEventListener('click', ()=>changeMonth(1));
      document.getElementById('saveBtn').addEventListener('click', saveTerminy);
      document.getElementById('clearDayBtn').addEventListener('click', clearDay);
      document.getElementById('clearAllBtn').addEventListener('click', clearAll);

      renderCalendar();
      renderHours();
      loadTerminy();
    });
  </script>
</body>
</html>
