<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>ZajÄ™cia online â€” audio (auto-connect, fix TX student)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#0b74ff; --ok:#28a745; --warn:#ffb300; --danger:#dc3545; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:#f4f6fb}
    header{background:var(--primary);color:#fff;padding:10px 14px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .title{font-weight:800;font-size:18px;margin-right:auto}
    .pill{background:#fff;color:#111;padding:8px 10px;border-radius:10px;border:1px solid #dde3f0;display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .pill.disabled{opacity:.55;pointer-events:none}
    .status-dot{width:14px;height:14px;border-radius:50%}
    .status--on{background:#2dd66f}.status--off{background:#bdbdbd}
    main{padding:22px 16px;display:flex;flex-direction:column;align-items:center;gap:18px}
    .btn{padding:12px 18px;border-radius:10px;border:1px solid #d7e0f0;background:#fff;cursor:pointer}
    .btn.primary{background:var(--ok);color:#fff;border:none}
    .btn.danger{background:#fff;color:#b30000;border-color:#f3c3c3}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .slider{width:220px}
    .badge{padding:6px 10px;border-radius:10px;background:#fff;border:1px dashed #cfd6e4;color:#2a2f3a}
    #vu{width:120px;height:10px;background:#eef3fb;border-radius:6px;overflow:hidden}
    #vu>span{display:block;height:100%;width:0;background:#28a745;transition:width .08s linear}
    #autoplay{display:none;align-items:center;gap:10px;background:#fff3cd;border:1px solid #ffe08a;color:#663c00;padding:10px 12px;border-radius:10px}
    #autoplay button{border:0;border-radius:8px;padding:8px 10px;cursor:pointer;background:var(--warn);color:#000;font-weight:800}
    small{opacity:.9;font-weight:600}
    audio{width:0;height:0;opacity:0;pointer-events:none}
  </style>
</head>
<body>

<header>
  <div class="title">ZajÄ™cia online â€” audio</div>

  <button class="pill" id="presence-pill" type="button" title="Kliknij, aby sprÃ³bowaÄ‡ poÅ‚Ä…czyÄ‡">
    <span id="presence-dot" class="status-dot status--off"></span>
    <span id="presence-text">NiedostÄ™pny</span>
  </button>

  <div class="pill">ğŸ‘¥ <span id="participants">1</span></div>

  <button class="pill disabled" id="mic-btn" type="button" onclick="toggleMic()">
    <span id="mic-ico">ğŸ”‡</span><span id="mic-lbl">Wycisz mikrofon</span>
  </button>

  <div class="pill">
    ğŸ”ˆ <input id="vol" class="slider" type="range" min="0" max="100" value="100" oninput="setVolume(this.value)">
    <span id="vol-val">100%</span>
  </div>

  <div class="pill">â± <span id="timer">--:--</span></div>

  <div class="pill" id="out-pill">ğŸ”Š WyjÅ›cie:
    <select id="out" onchange="changeOutput(this.value)"><option>Åadowanieâ€¦</option></select>
  </div>

  <div class="pill">ğŸ“¶ WejÅ›cie: <div id="vu"><span></span></div></div>

  <div class="pill">ğŸ§Š ICE: <small id="ice">init</small> <small id="ice-path" style="opacity:.8"></small></div>
  <div class="pill">ğŸ” Signaling: <small id="sig">init</small></div>
  <div class="pill">ğŸ—ƒï¸ Store: <small id="store">offer: â€“, answer: â€“</small></div>

  {% if is_teacher %}
    <button class="pill" id="announce" type="button" onclick="announceHost()">ğŸ“£ OgÅ‚oÅ›: jestem gospodarzem</button>
    <button class="pill" id="host" type="button" onclick="startHost()">ğŸ”— PoÅ‚Ä…cz (gospodarz)</button>
  {% else %}
    <span class="pill" id="wait-host" style="display:none;">â³ Czekamy na gospodarzaâ€¦</span>
    <button class="pill" id="student" type="button" onclick="joinMeeting()">ğŸ”— PoÅ‚Ä…cz (uczeÅ„)</button>
  {% endif %}

  <button class="pill btn danger" id="bye" type="button" onclick="hangup()" style="display:none;">ğŸ”Œ RozÅ‚Ä…cz</button>
</header>

<main>
  <a class="btn primary" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">âœï¸ OtwÃ³rz tablicÄ™</a>

  {% if is_teacher %}
  <form method="POST" style="display:flex;gap:8px;flex-wrap:wrap">
    {% csrf_token %}
    <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required
           style="min-width:280px;width:420px;max-width:100%;padding:10px 12px;border-radius:10px;border:1px solid #cfd6e4">
    <button type="submit" class="pill">ğŸ’¾ Zapisz link</button>
  </form>
  {% endif %}

  <div id="autoplay">ğŸ”‡ PrzeglÄ…darka zablokowaÅ‚a dÅºwiÄ™k. Kliknij: <button type="button" id="autoplay-btn">WÅ‚Ä…cz audio</button></div>

  <div class="badge">ğŸ“± Mobile wymaga <b>HTTPS</b>. Dla ciÄ™Å¼kich NAT skonfiguruj <b>TURN</b> i ewentualnie tryb <i>relay</i>.</div>
</main>

<audio id="remote" autoplay playsinline></audio>

<script>
/* ====== Kontekst szablonu ====== */
const rezerwacjaId = "{{ rezerwacja.id }}";
const csrfToken    = "{{ csrf_token }}";
const IS_TEACHER   = {% if is_teacher %}true{% else %}false{% endif %};

const OFFER_URL  = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_offer' rez_id=rezerwacja.id %}";
const ANSWER_URL = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_answer' rez_id=rezerwacja.id %}";

/* ====== TURN (opcjonalnie) ====== */
const TURN = {
  host: "",   // np. "turn.example.com"
  user: "",   // np. "webrtc"
  pass: "",   // np. "webrtc123"
  forceRelay: false
};

/* ====== RTC config ====== */
const rtcConfig = {
  iceServers: [
    { urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"] },
    ...(TURN.host ? [{ urls:[`turn:${TURN.host}:3478?transport=udp`,`turn:${TURN.host}:3478?transport=tcp`], username:TURN.user, credential:TURN.pass }] : [])
  ],
  iceTransportPolicy: TURN.forceRelay ? "relay" : "all",
  bundlePolicy: "max-bundle"
};

/* ====== Stan ====== */
let pc=null, localStream=null, remoteStream=null, audioTransceiver=null;
let joined=false, connecting=false, negReady=false, otherOnline=false, isMuted=false;
let offerWatch=null, vuLoop=null, inVuTimer=null;
let gumBusy=false;

/* ====== Helpers/UI ====== */
const $ = sel => document.querySelector(sel);
const supportsSink = ('setSinkId' in HTMLMediaElement.prototype);
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function setSig(m){ $('#sig').textContent=m; }
function setIce(m){ $('#ice').textContent=m; }
function setIcePath(m){ $('#ice-path').textContent=m; }

function uiRefresh(){
  $('#participants').textContent = (joined?2:1);
  $('#mic-btn').classList.toggle('disabled', !localStream);
  const bye = $('#bye');
  if(joined){ bye.style.display='inline-flex'; } else { bye.style.display='none'; }

  if(IS_TEACHER){
    $('#announce').style.display = joined ? 'none' : 'inline-flex';
    $('#host').style.display     = joined ? 'none' : 'inline-flex';
  }else{
    $('#student').style.display  = joined ? 'none' : 'inline-flex';
  }
}
function setVolume(v){
  $('#vol-val').textContent = v+'%';
  const el = $('#remote'); el.volume = Math.max(0,Math.min(1,Number(v)/100));
}
async function populateOutputs(){
  if(!supportsSink){ $('#out-pill').style.display='none'; return; }
  try{
    const devs = await navigator.mediaDevices.enumerateDevices();
    const outs = devs.filter(d=>d.kind==='audiooutput');
    const sel = $('#out'); sel.innerHTML='';
    if(!outs.length){ sel.innerHTML='<option value="">DomyÅ›lne</option>'; return; }
    outs.forEach(d=>{
      const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||d.deviceId; sel.appendChild(o);
    });
  }catch(e){ $('#out-pill').style.display='none'; }
}
async function changeOutput(id){ if(supportsSink){ try{ await $('#remote').setSinkId(id||''); }catch(e){} } setVolume($('#vol').value); }

/* ====== Audio unlock & VU ====== */
let audioCtx=null, analyser=null, srcNode=null;
async function ensureAudio(){
  try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state!=='running') await audioCtx.resume(); }catch(e){}
  try{ await $('#remote').play(); $('#autoplay').style.display='none'; }catch(e){ $('#autoplay').style.display='flex'; }
}
function startInputVU(stream){
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    if(!analyser){ analyser=audioCtx.createAnalyser(); analyser.fftSize=256; }
    if(srcNode){ try{srcNode.disconnect();}catch(e){} srcNode=null; }
    srcNode = audioCtx.createMediaStreamSource(stream); srcNode.connect(analyser);
    const bar = $('#vu>span');
    if(vuLoop) cancelAnimationFrame(vuLoop);
    const data=new Uint8Array(analyser.frequencyBinCount);
    const tick=()=>{ analyser.getByteTimeDomainData(data); let sum=0; for(const x of data){ const v=(x-128)/128; sum+=v*v; }
      const rms=Math.sqrt(sum/data.length); bar.style.width=Math.min(100,Math.round(rms*200))+'%'; vuLoop=requestAnimationFrame(tick); };
    tick();
  }catch(e){}
}
function startInboundStatsVU(){
  if(inVuTimer) clearTimeout(inVuTimer);
  const bar = $('#vu>span');
  const loop = async ()=>{
    try{
      const rcv = pc?.getReceivers().find(r=>r.track && r.track.kind==='audio');
      if(!rcv){ bar.style.width='0%'; inVuTimer=setTimeout(loop,300); return; }
      const st = await rcv.getStats(); let level=null;
      st.forEach(s=>{ if(s.type==='inbound-rtp' && s.kind==='audio' && typeof s.audioLevel==='number') level=s.audioLevel; });
      bar.style.width = (level!=null) ? Math.min(100,Math.round(level*200))+'%' : '0%';
    }catch(e){}
    inVuTimer=setTimeout(loop,300);
  };
  loop();
}

/* ====== RTC core ====== */
function attachRemoteAudio(){ $('#remote').srcObject=null; ensureAudio(); }

function setupPeer(){
  pc = new RTCPeerConnection(rtcConfig);
  // utwÃ³rz transceiver od razu (po obu stronach)
  audioTransceiver = pc.addTransceiver('audio', { direction:'sendrecv' });

  setSig('pc:new'); setIce(pc.iceConnectionState||'new');

  pc.onicegatheringstatechange = ()=>setIce(pc.iceConnectionState||pc.iceGatheringState);
  pc.oniceconnectionstatechange = ()=>{
    setIce(pc.iceConnectionState||''); updateIcePath();
  };
  pc.onconnectionstatechange = ()=>{ if(['disconnected','failed','closed'].includes(pc.connectionState)){ joined=false; uiRefresh(); } };

  pc.ontrack = (e)=>{
    const el = $('#remote');
    if(e.streams && e.streams[0]){ el.srcObject = e.streams[0]; startInputVU(e.streams[0]); }
    else{ if(!remoteStream) remoteStream=new MediaStream(); remoteStream.addTrack(e.track); el.srcObject=remoteStream; startInputVU(remoteStream); }
    e.track.onunmute = ensureAudio;
    ensureAudio(); startInboundStatsVU();
  };

  // renegocjacja dopiero po peÅ‚nym handshaku
  pc.onnegotiationneeded = async ()=>{
    if(!negReady || pc.signalingState!=='stable') return;
    try{
      setSig('re-negotiationâ€¦');
      const offer = await pc.createOffer(); await pc.setLocalDescription(offer); await waitIce();
      await postJSON(OFFER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'re-offer');
      setSig('re-negotiation offer sent');
    }catch(e){ console.warn('onnegotiationneeded', e); }
  };
}

async function requestMicNow(){
  if(gumBusy || localStream) return;
  gumBusy=true;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true, channelCount:1 }
    });
    localStream = stream;
    const track = stream.getAudioTracks()[0];

    // ğŸ”§ NAPRAWA: pewny transceiver + sendrecv + replaceTrack (z fallbackiem)
    if(!audioTransceiver && pc){
      audioTransceiver = pc.addTransceiver('audio',{direction:'sendrecv'});
    }
    if(audioTransceiver?.sender){
      audioTransceiver.direction='sendrecv';
      await audioTransceiver.sender.replaceTrack(track);
    }else if(pc){
      pc.addTrack(track, localStream);
    }

    $('#mic-btn').classList.remove('disabled');
    $('#mic-ico').textContent='ğŸ™ï¸'; $('#mic-lbl').textContent='Wycisz mikrofon';
    uiRefresh();
  }catch(e){ console.warn('[MIC] gUM error', e); }
  finally{ gumBusy=false; }
}

function waitIce(){
  if(!pc || pc.iceGatheringState==='complete') return Promise.resolve();
  return new Promise(res=>{
    const f=()=>{ if(pc.iceGatheringState==='complete'){ pc.removeEventListener('icegatheringstatechange', f); res(); } };
    pc.addEventListener('icegatheringstatechange', f);
  });
}
function teardown(){
  try{ pc?.close(); }catch(e){} pc=null; audioTransceiver=null;
  try{ localStream?.getTracks().forEach(t=>t.stop()); }catch(e){}
  localStream=null; remoteStream=null; joined=false; negReady=false;
  if(vuLoop) cancelAnimationFrame(vuLoop); if(inVuTimer) clearTimeout(inVuTimer); if(offerWatch) clearTimeout(offerWatch);
  setSig('init'); setIce('init'); setIcePath(''); uiRefresh();
}

/* ====== Re-offer watcher ====== */
function startOfferWatcher(){
  if(offerWatch) clearTimeout(offerWatch);
  const loop = async ()=>{
    try{
      if(!pc){ offerWatch=setTimeout(loop,1000); return; }
      const off = await getJSON(OFFER_URL,'offer-watch');
      if(off && off.type==='offer' && off.sdp){
        if(pc.signalingState!=='stable'){ offerWatch=setTimeout(loop,1000); return; }
        setSig('remote-offer'); await pc.setRemoteDescription(new RTCSessionDescription(off));
        const ans = await pc.createAnswer(); await pc.setLocalDescription(ans); await waitIce();
        await postJSON(ANSWER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'re-answer');
        setSig('renegotiation-answer-sent');
      }
    }catch(e){}
    offerWatch=setTimeout(loop,1000);
  };
  loop();
}

/* ====== Host ====== */
async function startHost(){
  if(joined||connecting) return; connecting=true;
  const btn = $('#host'); btn.textContent='ÅÄ…czenieâ€¦'; btn.classList.add('disabled');
  try{
    attachRemoteAudio(); setupPeer(); setSig('creating-offer');
    const offer = await pc.createOffer(); await pc.setLocalDescription(offer); await waitIce();
    setSig('posting-offer'); await postJSON(OFFER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'offer-post');
    // host moÅ¼e pobraÄ‡ mic juÅ¼ teraz (replaceTrack jest bezpieczne)
    await requestMicNow();

    setSig('waiting-answer'); let ok=false;
    for(let i=0;i<120 && pc;i++){
      const ans = await getJSON(ANSWER_URL,'answer-get');
      if(ans && ans.type==='answer' && ans.sdp){ await pc.setRemoteDescription(new RTCSessionDescription(ans)); ok=true; break; }
      await sleep(1000);
    }
    if(!ok) throw new Error('Brak odpowiedzi ucznia');

    joined=true; uiRefresh(); await populateOutputs();
    negReady=true; startOfferWatcher();
  }catch(e){ alert('Host error: '+e); teardown(); }
  finally{ btn.textContent='ğŸ”— PoÅ‚Ä…cz (gospodarz)'; btn.classList.remove('disabled'); connecting=false; updateIcePath(); }
}

/* ====== Student ====== */
async function joinMeeting(){
  if(joined||connecting) return; connecting=true;
  const btn = $('#student'); const waitE = $('#wait-host');
  btn.textContent='ÅÄ…czenieâ€¦'; btn.classList.add('disabled');
  try{
    attachRemoteAudio(); setupPeer(); ensureAudio();
    setSig('fetch-offer'); waitE && (waitE.style.display='inline-flex');

    let offer=null;
    for(let i=0;i<120;i++){
      offer = await getJSON(OFFER_URL,'offer-get');
      if(offer && offer.type==='offer' && offer.sdp){ setSig('got-offer'); break; }
      await sleep(1000);
    }
    waitE && (waitE.style.display='none');
    if(!offer){ setSig('no-offer'); alert('Brak gospodarza (offer).'); return; }

    setSig('set-remote-offer'); await pc.setRemoteDescription(new RTCSessionDescription(offer));

    // ğŸ”‘ KLUCZ: uczeÅ„ bierze mikrofon PRZED createAnswer
    await requestMicNow();

    setSig('creating-answer');
    const answer = await pc.createAnswer(); await pc.setLocalDescription(answer); await waitIce();
    setSig('posting-answer'); await postJSON(ANSWER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'answer-post');

    joined=true; uiRefresh(); await populateOutputs();
    negReady=true; startOfferWatcher();
  }catch(e){ alert('Join error: '+e); teardown(); }
  finally{ btn.textContent='ğŸ”— PoÅ‚Ä…cz (uczeÅ„)'; btn.classList.remove('disabled'); connecting=false; updateIcePath(); }
}

/* ====== Misc ====== */
function toggleMic(){
  if(!localStream){ requestMicNow(); return; }
  const t = localStream.getAudioTracks()[0]; if(!t) return;
  t.enabled = !t.enabled; isMuted = !t.enabled;
  $('#mic-ico').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ™ï¸';
  $('#mic-lbl').textContent = isMuted ? 'WÅ‚Ä…cz mikrofon' : 'Wycisz mikrofon';
}
function hangup(){ teardown(); }
function updateIcePath(){ if(!pc){ setIcePath(''); return; }
  (async()=>{
    try{
      const st = await pc.getStats(); let proto='?', l='?', r='?';
      st.forEach(s=>{
        if(s.type==='transport' && s.selectedCandidatePairId){
          const pair=st.get(s.selectedCandidatePairId);
          const lc=st.get(pair.localCandidateId), rc=st.get(pair.remoteCandidateId);
          if(lc){ l=lc.candidateType; proto=lc.protocol; }
          if(rc){ r=rc.candidateType; }
        }
      });
      setIcePath(`(${l}â†’${r}, ${proto})`);
    }catch(e){ setIcePath(''); }
  })();
}

/* ====== Signaling helpers ====== */
async function postJSON(url,data,label){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},body:JSON.stringify(data),credentials:'same-origin',cache:'no-store'}); if(!r.ok) throw new Error(`${label} ${url} -> ${r.status}`); try{return await r.json();}catch{return {ok:true}}}
async function getJSON(url,label){ const r=await fetch(url,{credentials:'same-origin',cache:'no-store'}); if(r.status===404) return null; if(!r.ok) throw new Error(`${label} ${url} -> ${r.status}`); try{return await r.json();}catch{return null}}

/* ====== Presence & store badge ====== */
function pingPresence(){ fetch("{% url 'ping_online_status' %}",{method:'POST',headers:{'X-CSRFToken':csrfToken,'Content-Type':'application/x-www-form-urlencoded'},body:'rezerwacja_id='+encodeURIComponent(rezerwacjaId)}).catch(()=>{}); }
function checkPresence(){
  fetch(`/check-online-status/${rezerwacjaId}/`).then(r=>r.ok?r.json():Promise.reject(r.status)).then(d=>{
    otherOnline = !!(d&&d.online);
    $('#presence-dot').className = 'status-dot '+(otherOnline?'status--on':'status--off');
    $('#presence-text').textContent = otherOnline?'DostÄ™pny':'NiedostÄ™pny';
    uiRefresh();
    if(otherOnline && !joined && !connecting){ IS_TEACHER ? startHost() : joinMeeting(); }
  }).catch(()=>{});
}
function updateStore(){
  Promise.all([getJSON(OFFER_URL,'offer-get'), getJSON(ANSWER_URL,'answer-get')]).then(([o,a])=>{
    $('#store').textContent = `offer: ${o&&o.sdp?`âœ“(${o.sdp.length})`:'â€“'}, answer: ${a&&a.sdp?`âœ“(${a.sdp.length})`:'â€“'}`;
  }).catch(()=>{ $('#store').textContent='offer: ?, answer: ?'; });
}

/* ====== Timer ====== */
function initTimer(){
  const el=$('#timer'); const start=new Date("{{ rezerwacja.termin|date:'Y-m-d H:i:s' }}").getTime();
  const end=start+55*60*1000;
  const tick=()=>{ const d=end-Date.now(); if(d<=0){ el.textContent='ZakoÅ„czone'; return; }
    const m=Math.floor(d/60000), s=Math.floor((d%60000)/1000); el.textContent=`${m}:${String(s).padStart(2,'0')}`; };
  tick(); setInterval(tick,1000);
}

/* ====== Init ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  initTimer(); uiRefresh(); populateOutputs();
  $('#autoplay-btn')?.addEventListener('click', ensureAudio);
  $('#presence-pill')?.addEventListener('click', ()=>{ if(otherOnline && !joined && !connecting){ IS_TEACHER ? startHost() : joinMeeting(); }});
  setInterval(pingPresence, 10_000);
  setInterval(checkPresence, 10_000);
  setInterval(updateStore, 2_000);
  setVolume($('#vol').value);
});
</script>
</body>
</html>
