<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>ZajÄ™cia online â€” audio (kliknij aby poÅ‚Ä…czyÄ‡)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#0b74ff; --ok:#28a745; --warn:#ffb300; --danger:#dc3545; }

    /* --- Ali: estetyka & animacje lekkie --- */
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --ring:#bcd3ff;
      --ring-ink:#0b3d91;
      --shadow-sm:0 1px 2px rgba(0,0,0,.06);
      --shadow-md:0 6px 18px rgba(11,116,255,.12);
      --focus:#8ab6ff;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg)}
    header{
      background: linear-gradient(180deg, rgba(11,116,255,.98), rgba(11,116,255,.92));
      color:#fff;padding:10px 14px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;
      box-shadow: var(--shadow-md);
    }
    .title{font-weight:800;font-size:18px;margin-right:auto}
    .pill{
      background: var(--card); color:#111; padding:8px 10px; border-radius:10px;
      border:1px solid #dfe6f5; display:inline-flex; align-items:center; gap:8px; font-weight:600;
      box-shadow: var(--shadow-sm);
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease, background-color .2s ease;
    }
    .pill:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,.08); }
    .pill:active{ transform: translateY(0); box-shadow: var(--shadow-sm); }
    .pill.disabled{opacity:.55;pointer-events:none}
    .pill:focus-visible, .btn:focus-visible, input:focus-visible, select:focus-visible{
      outline: 0; box-shadow: 0 0 0 3px var(--focus); border-color: var(--focus);
    }

    .status-dot{width:14px;height:14px;border-radius:50%; position:relative}
    .status--on{
      background:#2dd66f;
      box-shadow: 0 0 0 0 rgba(45,214,111,.4);
      animation: dot-breathe 1.8s ease-in-out infinite;
    }
    .status--off{background:#bdbdbd}
    @keyframes dot-breathe{
      0%{ box-shadow:0 0 0 0 rgba(45,214,111,.40); }
      70%{ box-shadow:0 0 0 10px rgba(45,214,111,0); }
      100%{ box-shadow:0 0 0 0 rgba(45,214,111,0); }
    }

    main{padding:22px 16px;display:flex;flex-direction:column;align-items:center;gap:18px}
    .btn{padding:12px 18px;border-radius:10px;border:1px solid #d7e0f0;background:#fff;cursor:pointer;transition:transform .08s ease}
    .btn.primary{
      background: linear-gradient(180deg, #28a745, #1f8b39);
      color:#fff;border:none; box-shadow: 0 6px 14px rgba(40,167,69,.22);
    }
    .btn.primary:hover{ transform: translateY(-1px); }
    .btn.primary:active{ transform: translateY(0); }
    .btn.danger{background:#fff;color:#b30000;border-color:#f3c3c3}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .slider{width:220px;height:6px;border-radius:999px;background:#e8eefc;outline:none}
    .slider::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none; width:16px; height:16px; border-radius:50%;
      background: var(--primary); border:2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,.2);
    }
    .slider::-moz-range-thumb{
      width:16px; height:16px; border-radius:50%; background: var(--primary); border:2px solid #fff;
    }

    .badge{padding:6px 10px;border-radius:10px;background:#fff;border:1px dashed #cfd6e4;color:#2a2f3a; box-shadow: var(--shadow-sm)}
    #vu{width:120px;height:10px;background:#e8eefc;border-radius:6px;overflow:hidden}
    #vu>span{display:block;height:100%;width:0;background:#28a745;transition:width .06s linear; border-radius:6px}

    #autoplay{
      display:none;align-items:center;gap:10px;background:#fff9e6;border:1px solid #ffe08a;color:#5a3c00;
      padding:10px 12px;border-radius:10px; box-shadow: var(--shadow-sm);
    }
    #autoplay button{border:0;border-radius:8px;padding:8px 10px;cursor:pointer;background:var(--warn);color:#000;font-weight:800}

    /* Baner poÅ‚Ä…czenia (Ali) */
    #incoming{
      display:none; align-items:center; gap:10px;
      background:#eef4ff; border:1px solid var(--ring); color:var(--ring-ink);
      padding:10px 12px; border-radius:12px; box-shadow: var(--shadow-sm);
      opacity:0; transform: translateY(-4px);
    }
    #incoming.show{ display:flex; animation: incomingFade .25s ease forwards, ringPulse 1.6s ease-out infinite; }
    @keyframes incomingFade{ to{ opacity:1; transform: translateY(0); } }
    @keyframes ringPulse{
      0%{ box-shadow: 0 0 0 0 rgba(140,174,255,.35); }
      70%{ box-shadow: 0 0 0 12px rgba(140,174,255,0); }
      100%{ box-shadow: 0 0 0 0 rgba(140,174,255,0); }
    }

    small{opacity:.9;font-weight:600}
    audio{width:0;height:0;opacity:0;pointer-events:none}

    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>

<header>
  <div class="title">ZajÄ™cia online â€” audio</div>

  <button class="pill" id="presence-pill" type="button" title="Status obecnoÅ›ci (bez auto-Å‚Ä…czenia)">
    <span id="presence-dot" class="status-dot status--off"></span>
    <span id="presence-text">NiedostÄ™pny</span>
  </button>

  <div class="pill">ğŸ‘¥ <span id="participants">1</span></div>

  <button class="pill disabled" id="mic-btn" type="button" onclick="toggleMic()">
    <span id="mic-ico">ğŸ”‡</span><span id="mic-lbl">Wycisz mikrofon</span>
  </button>

  <div class="pill">
    ğŸ”ˆ <input id="vol" class="slider" type="range" min="0" max="100" value="100" oninput="setVolume(this.value)">
    <span id="vol-val">100%</span>
  </div>

  <div class="pill">â± <span id="timer">--:--</span></div>

  <div class="pill" id="out-pill">ğŸ”Š WyjÅ›cie:
    <select id="out" onchange="changeOutput(this.value)"><option>Åadowanieâ€¦</option></select>
  </div>

  <div class="pill">ğŸ“¶ WejÅ›cie: <div id="vu"><span></span></div></div>

  <div class="pill">ğŸ§Š ICE: <small id="ice">init</small> <small id="ice-path" style="opacity:.8"></small></div>
  <div class="pill">ğŸ” Signaling: <small id="sig">init</small></div>
  <div class="pill">ğŸ—ƒï¸ Store: <small id="store">offer: â€“, answer: â€“</small></div>

  {% if is_teacher %}
    <button class="pill" id="announce" type="button" onclick="announceHost()">ğŸ“£ OgÅ‚oÅ›: jestem gospodarzem</button>
    <button class="pill" id="host" type="button" onclick="startHost()">ğŸ”— PoÅ‚Ä…cz (gospodarz)</button>
  {% else %}
    <span class="pill" id="wait-host" style="display:none;">â³ Czekamy na gospodarzaâ€¦</span>
    <button class="pill" id="student" type="button" onclick="/* uczeÅ„ uÅ¼ywa przycisku w banerze */void(0)">ğŸ”— PoÅ‚Ä…cz (uczeÅ„)</button>
  {% endif %}

  <button class="pill btn danger" id="bye" type="button" onclick="hangup()" style="display:none;">ğŸ”Œ RozÅ‚Ä…cz</button>
</header>

<main>
  <a class="btn primary" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">âœï¸ OtwÃ³rz tablicÄ™</a>

  {% if is_teacher %}
  <form method="POST" style="display:flex;gap:8px;flex-wrap:wrap">
    {% csrf_token %}
    <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required
           style="min-width:280px;width:420px;max-width:100%;padding:10px 12px;border-radius:10px;border:1px solid #cfd6e4">
    <button type="submit" class="pill">ğŸ’¾ Zapisz link</button>
  </form>
  {% endif %}

  <div id="autoplay">ğŸ”‡ PrzeglÄ…darka zablokowaÅ‚a dÅºwiÄ™k. Kliknij: <button type="button" id="autoplay-btn">WÅ‚Ä…cz audio</button></div>

  <!-- Baner poÅ‚Ä…czenia przychodzÄ…cego (Ali) -->
  <div id="incoming">
    ğŸ“ PoÅ‚Ä…czenie przychodzÄ…ce od nauczycielaâ€¦
    <div style="margin-left:auto;display:flex;gap:8px">
      <button type="button" id="accept" class="pill">âœ… Odbierz</button>
      <button type="button" id="decline" class="pill">âŒ OdrzuÄ‡</button>
    </div>
  </div>

  <div class="badge">ğŸ“± Mobile wymaga <b>HTTPS</b>. Dla ciÄ™Å¼kich NAT skonfiguruj <b>TURN</b> i ewentualnie tryb <i>relay</i>.</div>
</main>

<audio id="remote" autoplay playsinline></audio>

<script>
/* ====== Kontekst szablonu ====== */
const rezerwacjaId = "{{ rezerwacja.id }}";
const csrfToken Â  Â = "{{ csrf_token }}";
const IS_TEACHER Â  = {% if is_teacher %}true{% else %}false{% endif %};

const OFFER_URL Â = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_offer' rez_id=rezerwacja.id %}";
const ANSWER_URL = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_answer' rez_id=rezerwacja.id %}";

/* ====== TURN (opcjonalnie) ====== */
const TURN = {
Â  host: "", Â  // np. "turn.example.com"
Â  user: "", Â  // np. "webrtc"
Â  pass: "", Â  // np. "webrtc123"
Â  forceRelay: false
};

/* ====== RTC config ====== */
const rtcConfig = {
Â  iceServers: [
Â  Â  { urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"] },
Â  Â  ...(TURN.host ? [{ urls:[`turn:${TURN.host}:3478?transport=udp`,`turn:${TURN.host}:3478?transport=tcp`], username:TURN.user, credential:TURN.pass }] : [])
Â  ],
Â  iceTransportPolicy: TURN.forceRelay ? "relay" : "all",
Â  bundlePolicy: "max-bundle"
};

/* ====== Stan ====== */
let pc=null, localStream=null, remoteStream=null, audioTransceiver=null;
let joined=false, connecting=false, negReady=false, otherOnline=false, isMuted=false;
let offerWatch=null, vuLoop=null, inVuTimer=null;
let gumBusy=false;
let incomingOffer=false, ringWatch=null; // dzwonek

/* ====== Helpers/UI ====== */
const $ = sel => document.querySelector(sel);
const supportsSink = ('setSinkId' in HTMLMediaElement.prototype);
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function setSig(m){ $('#sig').textContent=m; }
function setIce(m){ $('#ice').textContent=m; }
function setIcePath(m){ $('#ice-path').textContent=m; }

function uiRefresh(){
Â  const two = joined ? 2 : 1; // licznik tylko po realnym doÅ‚Ä…czeniu
Â  $('#participants').textContent = two;
Â  $('#mic-btn').classList.toggle('disabled', !localStream);
Â  $('#bye').style.display = joined ? 'inline-flex' : 'none';

Â  if(IS_TEACHER){
Â  Â  $('#announce').style.display = joined ? 'none' : 'inline-flex';
Â  Â  $('#host').style.display Â  Â  = joined ? 'none' : 'inline-flex';
Â  }else{
Â  Â  $('#student').style.display Â = joined ? 'none' : 'inline-flex';
Â  }
}
function setVolume(v){
Â  $('#vol-val').textContent = v+'%';
Â  const el = $('#remote'); el.volume = Math.max(0,Math.min(1,Number(v)/100));
}
async function populateOutputs(){
Â  if(!supportsSink){ $('#out-pill').style.display='none'; return; }
Â  try{
Â  Â  const devs = await navigator.mediaDevices.enumerateDevices();
Â  Â  const outs = devs.filter(d=>d.kind==='audiooutput');
Â  Â  const sel = $('#out'); sel.innerHTML='';
Â  Â  if(!outs.length){ sel.innerHTML='<option value="">DomyÅ›lne</option>'; return; }
Â  Â  outs.forEach(d=>{
Â  Â  Â  const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||d.deviceId; sel.appendChild(o);
Â  Â  });
Â  }catch(e){ $('#out-pill').style.display='none'; }
}
async function changeOutput(id){ if(supportsSink){ try{ await $('#remote').setSinkId(id||''); }catch(e){} } setVolume($('#vol').value); }

/* ====== Audio unlock & VU ====== */
let audioCtx=null, analyser=null, srcNode=null;
async function ensureAudio(){
Â  try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state!=='running') await audioCtx.resume(); }catch(e){}
Â  try{ await $('#remote').play(); $('#autoplay').style.display='none'; }catch(e){ $('#autoplay').style.display='flex'; }
}
function startInputVU(stream){
Â  try{
Â  Â  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
Â  Â  if(!analyser){ analyser=audioCtx.createAnalyser(); analyser.fftSize=256; }
Â  Â  if(srcNode){ try{srcNode.disconnect();}catch(e){} srcNode=null; }
Â  Â  srcNode = audioCtx.createMediaStreamSource(stream); srcNode.connect(analyser);
Â  Â  const bar = $('#vu>span');
Â  Â  if(vuLoop) cancelAnimationFrame(vuLoop);
Â  Â  const data=new Uint8Array(analyser.frequencyBinCount);
Â  Â  const tick=()=>{ analyser.getByteTimeDomainData(data); let sum=0; for(const x of data){ const v=(x-128)/128; sum+=v*v; }
Â  Â  Â  const rms=Math.sqrt(sum/data.length); bar.style.width=Math.min(100,Math.round(rms*200))+'%'; vuLoop=requestAnimationFrame(tick); };
Â  Â  tick();
Â  }catch(e){}
}
function startInboundStatsVU(){
Â  if(inVuTimer) clearTimeout(inVuTimer);
Â  const bar = $('#vu>span');
Â  const loop = async ()=>{
Â  Â  try{
Â  Â  Â  const rcv = pc?.getReceivers().find(r=>r.track && r.track.kind==='audio');
Â  Â  Â  if(!rcv){ bar.style.width='0%'; inVuTimer=setTimeout(loop,300); return; }
Â  Â  Â  const st = await rcv.getStats(); let level=null;
Â  Â  Â  st.forEach(s=>{ if(s.type==='inbound-rtp' && s.kind==='audio' && typeof s.audioLevel==='number') level=s.audioLevel; });
Â  Â  Â  bar.style.width = (level!=null) ? Math.min(100,Math.round(level*200))+'%' : '0%';
Â  Â  }catch(e){}
Â  Â  inVuTimer=setTimeout(loop,300);
Â  };
Â  loop();
}

/* ====== RTC core ====== */
function attachRemoteAudio(){ $('#remote').srcObject=null; ensureAudio(); }

function setupPeer(){
Â  pc = new RTCPeerConnection(rtcConfig);
Â  audioTransceiver = pc.addTransceiver('audio', { direction:'sendrecv' });

Â  setSig('pc:new'); setIce(pc.iceConnectionState||'new');

Â  // czytelniejsze raportowanie ICE
Â  pc.onicegatheringstatechange = ()=>{/* opcjonalny log 'gathering' */};
Â  pc.oniceconnectionstatechange = ()=>{
Â  Â  setIce(pc.iceConnectionState || '');
Â  Â  updateIcePath();
Â  };
Â  pc.onconnectionstatechange = ()=>{ if(['disconnected','failed','closed'].includes(pc.connectionState)){ joined=false; uiRefresh(); } };

Â  pc.ontrack = (e)=>{
Â  Â  const el = $('#remote');
Â  Â  if(e.streams && e.streams[0]){ el.srcObject = e.streams[0]; startInputVU(e.streams[0]); }
Â  Â  else{ if(!remoteStream) remoteStream=new MediaStream(); remoteStream.addTrack(e.track); el.srcObject=remoteStream; startInputVU(remoteStream); }
Â  Â  e.track.onunmute = ensureAudio;
Â  Â  ensureAudio(); startInboundStatsVU();
Â  };

Â  // renegocjacja dopiero po stabilnym handshaku
Â  pc.onnegotiationneeded = async ()=>{
Â  Â  if(!negReady || pc.signalingState!=='stable') return;
Â  Â  try{
Â  Â  Â  setSig('re-negotiationâ€¦');
Â  Â  Â  const offer = await pc.createOffer(); await pc.setLocalDescription(offer); await waitIce();
Â  Â  Â  await postJSON(OFFER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'re-offer');
Â  Â  Â  setSig('re-negotiation offer sent');
Â  Â  }catch(e){ console.warn('onnegotiationneeded', e); }
Â  };
}

async function requestMicNow(){
Â  if(gumBusy || localStream) return;
Â  gumBusy=true;
Â  try{
Â  Â  const stream = await navigator.mediaDevices.getUserMedia({
Â  Â  Â  audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true, channelCount:1 }
Â  Â  });
Â  Â  localStream = stream;
Â  Â  const track = stream.getAudioTracks()[0];

Â  Â  // pewny transceiver + sendrecv + replaceTrack (fallback: addTrack)
Â  Â  if(!audioTransceiver && pc){
Â  Â  Â  audioTransceiver = pc.addTransceiver('audio',{direction:'sendrecv'});
Â  Â  }
Â  Â  if(audioTransceiver?.sender){
Â  Â  Â  audioTransceiver.direction='sendrecv';
Â  Â  Â  await audioTransceiver.sender.replaceTrack(track);
Â  Â  }else if(pc){
Â  Â  Â  pc.addTrack(track, localStream);
Â  Â  }

Â  Â  $('#mic-btn').classList.remove('disabled');
Â  Â  $('#mic-ico').textContent='ğŸ™ï¸'; $('#mic-lbl').textContent='Wycisz mikrofon';
Â  Â  uiRefresh();
Â  }catch(e){ console.warn('[MIC] gUM error', e); }
Â  finally{ gumBusy=false; }
}

function waitIce(){
Â  if(!pc || pc.iceGatheringState==='complete') return Promise.resolve();
Â  return new Promise(res=>{
Â  Â  const f=()=>{ if(pc.iceGatheringState==='complete'){ pc.removeEventListener('icegatheringstatechange', f); res(); } };
Â  Â  pc.addEventListener('icegatheringstatechange', f);
Â  });
}
function teardown(){
Â  try{ pc?.close(); }catch(e){} pc=null; audioTransceiver=null;
Â  try{ localStream?.getTracks().forEach(t=>t.stop()); }catch(e){}
Â  localStream=null; remoteStream=null; joined=false; negReady=false;
Â  if(vuLoop) cancelAnimationFrame(vuLoop); if(inVuTimer) clearTimeout(inVuTimer); if(offerWatch) clearTimeout(offerWatch);
Â  setSig('init'); setIce('init'); setIcePath(''); uiRefresh();
Â  const inc = $('#incoming'); inc.classList.remove('show'); inc.style.display='none'; incomingOffer=false;
}

/* ====== Re-offer watcher (dla renegocjacji po poÅ‚Ä…czeniu) ====== */
function startOfferWatcher(){
Â  if(offerWatch) clearTimeout(offerWatch);
Â  const loop = async ()=>{
Â  Â  try{
Â  Â  Â  if(!pc){ offerWatch=setTimeout(loop,1000); return; }
Â  Â  Â  const off = await getJSON(OFFER_URL,'offer-watch');
Â  Â  Â  if(off && off.type==='offer' && off.sdp){
Â  Â  Â  Â  if(pc.signalingState!=='stable'){ offerWatch=setTimeout(loop,1000); return; }
Â  Â  Â  Â  setSig('remote-offer'); await pc.setRemoteDescription(new RTCSessionDescription(off));
Â  Â  Â  Â  const ans = await pc.createAnswer(); await pc.setLocalDescription(ans); await waitIce();
Â  Â  Â  Â  await postJSON(ANSWER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'re-answer');
Â  Â  Â  Â  setSig('renegotiation-answer-sent');
Â  Â  Â  }
Â  Â  }catch(e){}
Â  Â  offerWatch=setTimeout(loop,1000);
Â  };
Â  loop();
}

/* ====== Host (nauczyciel) ====== */
async function startHost(){
Â  if(!IS_TEACHER) return;
Â  if(joined||connecting) return; connecting=true;
Â  const btn = $('#host'); btn.textContent='Dzwonienieâ€¦'; btn.classList.add('disabled');
Â  try{
Â  Â  attachRemoteAudio();
Â  Â  setupPeer();
Â  Â  await requestMicNow();
Â  Â  setSig('creating-offer');
Â  Â  const offer = await pc.createOffer();
Â  Â  await pc.setLocalDescription(offer);
Â  Â  await waitIce();
Â  Â  setSig('posting-offer'); await postJSON(OFFER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'offer-post');
Â  Â  setSig('waiting-answer'); let ok=false;
Â  Â  for(let i=0;i<180 && pc;i++){
Â  Â  Â  const ans = await getJSON(ANSWER_URL,'answer-get');
Â  Â  Â  if(ans && ans.type==='answer' && ans.sdp){ await pc.setRemoteDescription(new RTCSessionDescription(ans)); ok=true; break; }
Â  Â  Â  await sleep(1000);
Â  Â  }
Â  Â  if(!ok) throw new Error('Brak odpowiedzi ucznia');
Â  Â  joined=true; uiRefresh(); await populateOutputs();
Â  Â  negReady=true; startOfferWatcher();
Â  }catch(e){ alert('Host error: '+e); teardown(); }
Â  finally{ btn.textContent='ğŸ”— PoÅ‚Ä…cz (gospodarz)'; btn.classList.remove('disabled'); connecting=false; updateIcePath(); }
}

/* ====== Student (uczeÅ„) â€“ Å‚Ä…czy TYLKO po klikniÄ™ciu "Odbierz" ====== */
async function joinMeeting(){
Â  if(IS_TEACHER) return;
Â  if(joined||connecting) return; connecting=true;
Â  try{
Â  Â  attachRemoteAudio();
Â  Â  setupPeer();
Â  Â  await requestMicNow();
Â  Â  ensureAudio();
Â  Â  let offer=null;
Â  Â  for(let i=0;i<3;i++){
Â  Â  Â  offer = await getJSON(OFFER_URL,'offer-get');
Â  Â  Â  if(offer && offer.type==='offer' && offer.sdp) break;
Â  Â  Â  await sleep(300);
Â  Â  }
Â  Â  if(!offer){ alert('Brak poÅ‚Ä…czenia przychodzÄ…cego.'); connecting=false; return; }
Â  Â  setSig('set-remote-offer'); await pc.setRemoteDescription(new RTCSessionDescription(offer));
Â  Â  setSig('creating-answer');
Â  Â  const answer = await pc.createAnswer(); await pc.setLocalDescription(answer); await waitIce();
Â  Â  setSig('posting-answer'); await postJSON(ANSWER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'answer-post');
Â  Â  joined=true; uiRefresh(); await populateOutputs();
Â  Â  negReady=true; startOfferWatcher();
Â  Â  const inc = $('#incoming'); inc.classList.remove('show'); inc.style.display='none'; incomingOffer=false;
Â  }catch(e){ alert('Join error: '+e); teardown(); }
Â  finally{ connecting=false; updateIcePath(); }
}

/* ====== Misc ====== */
function toggleMic(){
Â  if(!localStream){ requestMicNow(); return; }
Â  const t = localStream.getAudioTracks()[0]; if(!t) return;
Â  t.enabled = !t.enabled; isMuted = !t.enabled;
Â  $('#mic-ico').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ™ï¸';
Â  $('#mic-lbl').textContent = isMuted ? 'WÅ‚Ä…cz mikrofon' : 'Wycisz mikrofon';
}
function hangup(){ teardown(); }
function updateIcePath(){ if(!pc){ setIcePath(''); return; }
Â  (async()=>{
Â  Â  try{
Â  Â  Â  const st = await pc.getStats(); let proto='?', l='?', r='?';
Â  Â  Â  st.forEach(s=>{
Â  Â  Â  Â  if(s.type==='transport' && s.selectedCandidatePairId){
Â  Â  Â  Â  Â  const pair=st.get(s.selectedCandidatePairId);
Â  Â  Â  Â  Â  const lc=st.get(pair.localCandidateId), rc=st.get(pair.remoteCandidateId);
Â  Â  Â  Â  Â  if(lc){ l=lc.candidateType; proto=lc.protocol; }
Â  Â  Â  Â  Â  if(rc){ r=rc.candidateType; }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  setIcePath(`(${l}â†’${r}, ${proto})`);
Â  Â  }catch(e){ setIcePath(''); }
Â  })();
}

/* ====== Signaling helpers ====== */
async function postJSON(url,data,label){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},body:JSON.stringify(data),credentials:'same-origin',cache:'no-store'}); if(!r.ok) throw new Error(`${label} ${url} -> ${r.status}`); try{return await r.json();}catch{return {ok:true}}}
async function getJSON(url,label){ const r=await fetch(url,{credentials:'same-origin',cache:'no-store'}); if(r.status===404) return null; if(!r.ok) throw new Error(`${label} ${url} -> ${r.status}`); try{return await r.json();}catch{return null}}

/* ====== Presence (bez auto-Å‚Ä…czenia) & store badge ====== */
function pingPresence(){ fetch("{% url 'ping_online_status' %}",{method:'POST',headers:{'X-CSRFToken':csrfToken,'Content-Type':'application/x-www-form-urlencoded'},body:'rezerwacja_id='+encodeURIComponent(rezerwacjaId)}).catch(()=>{}); }
function checkPresence(){
Â  fetch(`/check-online-status/${rezerwacjaId}/`).then(r=>r.ok?r.json():Promise.reject(r.status)).then(d=>{
Â  Â  otherOnline = !!(d&&d.online);
Â  Â  $('#presence-dot').className = 'status-dot '+(otherOnline?'status--on':'status--off');
Â  Â  $('#presence-text').textContent = otherOnline?'DostÄ™pny':'NiedostÄ™pny';
Â  Â  uiRefresh();
Â  }).catch(()=>{});
}
function updateStore(){
Â  Promise.all([getJSON(OFFER_URL,'offer-get'), getJSON(ANSWER_URL,'answer-get')]).then(([o,a])=>{
Â  Â  $('#store').textContent = `offer: ${o&&o.sdp?`âœ“(${o.sdp.length})`:'â€“'}, answer: ${a&&a.sdp?`âœ“(${a.sdp.length})`:'â€“'}`;
Â  }).catch(()=>{ $('#store').textContent='offer: ?, answer: ?'; });
}

/* ====== â€Dzwonekâ€ â€” watcher u ucznia (pokazuje baner, nie Å‚Ä…czy automatycznie) ====== */
function startRingWatcherForStudent(){
Â  if(IS_TEACHER) return;
Â  if(ringWatch) clearTimeout(ringWatch);
Â  const loop = async ()=>{
Â  Â  try{
Â  Â  Â  if(joined){
Â  Â  Â  Â  const inc = $('#incoming'); inc.classList.remove('show'); inc.style.display='none';
Â  Â  Â  Â  incomingOffer=false; ringWatch=setTimeout(loop,1500); return;
Â  Â  Â  }
Â  Â  Â  const off = await getJSON(OFFER_URL,'ring-watch');
Â  Â  Â  const has = !!(off && off.type==='offer' && off.sdp);
Â  Â  Â  incomingOffer = has;
Â  Â  Â  const inc = $('#incoming');
Â  Â  Â  if(has){ inc.classList.add('show'); inc.style.display='flex'; }
Â  Â  Â  else{ inc.classList.remove('show'); inc.style.display='none'; }
Â  Â  }catch(e){}
Â  Â  ringWatch = setTimeout(loop,1500);
Â  };
Â  loop();
}

/* ====== Drobny broadcast przycisku â€OgÅ‚oÅ›â€ (opcjonalny) ====== */
async function announceHost(){
Â  try{
Â  Â  await fetch("{% url 'ping_online_status' %}", {
Â  Â  Â  method:'POST',
Â  Â  Â  headers:{'X-CSRFToken':csrfToken,'Content-Type':'application/x-www-form-urlencoded'},
Â  Â  Â  body:'rezerwacja_id='+encodeURIComponent(rezerwacjaId)
Â  Â  });
Â  Â  setSig('host announced');
Â  Â  updateStore();
Â  }catch(e){}
}

/* ====== Init ====== */
document.addEventListener('DOMContentLoaded', ()=>{
Â  initTimer(); uiRefresh(); populateOutputs();
Â  $('#autoplay-btn')?.addEventListener('click', ensureAudio);

Â  // Bez auto-Å‚Ä…czenia po klikniÄ™ciu presence â€” tylko podglÄ…d statusu
Â  $('#presence-pill')?.addEventListener('click', ()=>{ /* no-op */ });

Â  setInterval(pingPresence, 10_000);
Â  setInterval(checkPresence, 10_000);
Â  setInterval(updateStore, 2_000);
Â  setVolume($('#vol').value);

Â  // Watcher â€dzwonkaâ€ u ucznia
Â  startRingWatcherForStudent();

Â  // Odbierz / OdrzuÄ‡
Â  $('#accept')?.addEventListener('click', ()=>{ if(incomingOffer && !joined && !connecting){ joinMeeting(); } });
Â  $('#decline')?.addEventListener('click', ()=>{
Â  Â  const inc = $('#incoming'); inc.classList.remove('show'); inc.style.display='none'; incomingOffer=false;
Â  });
});

/* ====== Timer ====== */
function initTimer(){
Â  const el=$('#timer'); const start=new Date("{{ rezerwacja.termin|date:'Y-m-d H:i:s' }}").getTime();
Â  const end=start+55*60*1000;
Â  const tick=()=>{ const d=end-Date.now(); if(d<=0){ el.textContent='ZakoÅ„czone'; return; }
Â  Â  const m=Math.floor(d/60000), s=Math.floor((d%60000)/1000); el.textContent=`${m}:${String(s).padStart(2,'0')}`; };
Â  tick(); setInterval(tick,1000);
}
</script>
</body>
</html>
