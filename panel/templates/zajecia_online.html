{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Zajęcia online — PolubiszTo.pl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0b3d91; --ring:#bcd3ff; --focus:#8ab6ff;
      --ok:#2dd66f; --muted:#bdbdbd; --shadow-sm:0 1px 2px rgba(0,0,0,.06);
      --shadow-md:0 6px 18px rgba(11,116,255,.12);
      --grad:linear-gradient(180deg, rgba(11,116,255,.98), rgba(11,116,255,.92));
      --cta:linear-gradient(180deg, #28a745, #1f8b39);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:#1c2533}

    header{background:var(--grad);color:#fff;padding:14px 18px;display:flex;gap:12px;align-items:center;box-shadow:var(--shadow-md);flex-wrap:wrap}
    h1{font-size:18px;margin:0;font-weight:800;margin-right:auto}
    main{max-width:900px;margin:22px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #e6ecfb;border-radius:16px;box-shadow:var(--shadow-sm);padding:18px;display:grid;gap:14px}

    .pill{background:var(--card);border:1px solid #dfe6f5;border-radius:12px;padding:8px 12px;display:inline-flex;gap:8px;align-items:center;box-shadow:var(--shadow-sm);font-weight:600}
    .status-dot{width:12px;height:12px;border-radius:999px}
    .on{background:var(--ok);box-shadow:0 0 0 0 rgba(45,214,111,.35);animation:breath 1.8s ease-in-out infinite}
    .off{background:var(--muted)}
    @keyframes breath{0%{box-shadow:0 0 0 0 rgba(45,214,111,.35)}70%{box-shadow:0 0 0 12px rgba(45,214,111,0)}100%{box-shadow:0 0 0 0 rgba(45,214,111,0)}}

    .cta{display:inline-flex;align-items:center;gap:8px;padding:12px 18px;border-radius:12px;border:none;background:var(--cta);color:#fff;font-weight:800;cursor:pointer;box-shadow:0 6px 14px rgba(40,167,69,.22);text-decoration:none}
    input[type=url]{padding:12px;border-radius:12px;border:1px solid #cfd6e4;min-width:280px;width:420px;max-width:100%}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hint{font-size:14px;color:#334;opacity:.85}
    .muted{opacity:.85}

    /* Historia zajęć */
    .history{margin-top:18px}
    .history h2{margin:0 0 8px 0; font-size:17px}
    .list{display:grid;gap:10px;margin:0;padding:0;list-style:none}
    .item{display:flex;gap:12px;align-items:center;justify-content:space-between;border:1px solid #e6ecfb;background:#fff;border-radius:12px;padding:10px 12px}
    .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .dt{font-weight:700}
    .teacher{opacity:.9}
    .go{font-weight:700;text-decoration:none}
    .empty{padding:8px 12px;border:1px dashed #cfd6e4;border-radius:12px;background:#fff}
    .pill:focus-visible, input:focus-visible, .cta:focus-visible, a.go:focus-visible{outline:0;box-shadow:0 0 0 3px var(--focus)}
    @media (prefers-reduced-motion: reduce){*{animation:none !important;transition:none !important}}
  </style>
</head>
<body>

{% include "partials/brand.html" %}

<header>
  <h1>Zajęcia online</h1>
</header>

<main>
  <!-- Karta główna -->
  <div class="card">
    <div class="row">
      <a class="cta" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">✏️ Otwórz tablicę</a>
      <div class="hint">Rozmowa głosowa odbywa się w Excalidraw.</div>
    </div>

    {% if is_teacher %}
    <form method="POST" class="row">
      {% csrf_token %}
      <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required>
      <button class="pill" type="submit">💾 Zapisz link</button>
    </form>
    {% endif %}

    <div class="muted">ID zajęć: {{ rezerwacja.id }} • Termin: {{ rezerwacja.termin }}</div>
  </div>

  <!-- Historia zajęć ucznia (najnowsze na górze) -->
  <div class="card history">
    <h2>Historia zajęć ucznia</h2>

    {% if past_lessons %}
      <ul class="list">
        {% for z in past_lessons %}
          <li class="item">
            <div class="meta">
              <span class="dt">{{ z.termin|date:"d.m.Y H:i" }}</span>
              <span class="teacher">👨‍🏫 {{ z.nauczyciel.get_full_name|default:z.nauczyciel.username }}</span>
              <span class="muted">ID: {{ z.id }}</span>
            </div>
            {% if z.excalidraw_link %}
              <a class="go" href="{{ z.excalidraw_link }}" target="_blank" rel="noopener">Otwórz ▶</a>
            {% else %}
              <span class="muted">Brak linku do tablicy</span>
            {% endif %}

          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty">Brak wcześniejszych zajęć do wyświetlenia.</div>
    {% endif %}
  </div>
</main>

<script>
const rezerwacjaId="{{ rezerwacja.id }}";
const csrfToken="{{ csrf_token }}";

function pingPresence(){
  fetch("{% url 'ping_online_status' %}", {
    method:'POST',
    headers:{'X-CSRFToken':csrfToken,'Content-Type':'application/x-www-form-urlencoded'},
    body:'rezerwacja_id='+encodeURIComponent(rezerwacjaId)
  }).catch(()=>{});
}
function checkPresence(){
  // (obecnie nie wyświetlamy statusu na pasku, więc pingi zostają, ale UI nie pokazuje kropek)
}
function initTimer(){
  // jeśli chcesz timer, dodaj elementy w headerze i tu logikę
}
document.addEventListener('DOMContentLoaded', ()=>{
  setInterval(pingPresence,10_000);
  pingPresence();
});
</script>
</body>
</html>
