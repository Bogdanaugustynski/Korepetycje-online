<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Zajęcia online — audio + tablica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#007bff; --ok:#28a745; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:#f4f4f4; }
    header {
      background: var(--primary); color:#fff; padding:10px 14px;
      display:flex; align-items:center; gap:14px; flex-wrap:wrap;
    }
    .title { font-weight:700; font-size:18px; flex: 1 1 auto; }
    .pill { background:#fff; color:#000; padding:8px 10px; border-radius:8px; border:1px solid #ddd;
      display:flex; align-items:center; gap:8px; font-weight:600; }
    .status-dot { width:12px; height:12px; border-radius:50%; background:#b1b1b1; }
    .status--on { background:#39d158; }
    main { padding:24px 16px; display:flex; flex-direction:column; align-items:center; gap:16px; }
    .btn { padding:12px 16px; border-radius:10px; border:1px solid #ddd; cursor:pointer; }
    .btn-primary { background:var(--ok); color:#fff; border:none; }
    .btn-ghost { background:#fff; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .hint { max-width:900px; background:#fff; border:1px dashed #cfd6e4; padding:12px 14px; border-radius:8px; color:#2a2f3a; }
    /* IFRAME Jitsi – nie ukrywamy całkiem; zostawiamy 10×10 px i prawie przezroczyste (Chrome chętniej pozwala na audio) */
    #jitsi-container { position:fixed; left:0; bottom:0; width:10px; height:10px; opacity:0.01; pointer-events:none; }
    .vol-wrap { display:flex; align-items:center; gap:8px; }
    .vol-range { width:120px; }
  </style>
</head>
<body>
<header>
  <div class="title">Zajęcia online — tryb audio</div>

  <div class="pill">
    <span id="presence-dot" class="status-dot"></span>
    <span id="presence-text">Niedostępny</span>
  </div>

  <div class="pill">
    👥 <span id="pcount">0</span>
  </div>

  <button id="mic-toggle" class="pill btn-ghost" type="button" disabled>🔇 Wycisz mikrofon</button>

  <div class="pill vol-wrap" title="Głośność odsłuchu">
    🔊 <input id="vol" class="vol-range" type="range" min="0" max="100" step="1" value="100" disabled>
    <span id="vol-val">100%</span>
  </div>
</header>

<main>
  <div class="row">
    <a class="btn btn-primary" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">✏️ Otwórz tablicę</a>
    <button id="connect-audio" class="btn btn-ghost" type="button">🎙️ Połącz audio</button>
    <a class="btn btn-ghost" id="open-full" target="_blank" rel="noopener">🔗 Otwórz pełne Jitsi</a>
  </div>

  {% if is_teacher %}
  <form method="POST" class="row">
    {% csrf_token %}
    <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..."
           required style="min-width:280px; width:420px; max-width:100%; padding:10px 12px; border-radius:8px; border:1px solid #cfd6e4;">
    <button type="submit" class="btn btn-ghost">💾 Zapisz link</button>
  </form>
  {% endif %}

  <div class="hint" id="vol-hint" style="display:none">
    💡 Suwak głośności przeglądarki jest niedostępny na tym urządzeniu. Użyj przycisków głośności
    lub miksera systemowego/ikony głośnika obok paska adresu.
  </div>

  <div class="hint">
    ℹ️ Najpierw kliknij <b>„Połącz audio”</b> na obu urządzeniach (to wywoła prośbę o dostęp do mikrofonu).
    Potem możesz używać „Wycisz mikrofon”. Upewnij się, że na obu urządzeniach zezwoliłeś na mikrofon dla domeny.
  </div>
</main>

<div id="jitsi-container"></div>

<script src="https://meet.jit.si/external_api.js"></script>
<script>
  const rezerwacjaId = "{{ rezerwacja.id }}";
  const csrfToken = "{{ csrf_token }}";
  const roomName = "ZajeciaAudio_{{ rezerwacja.id }}";

  let api = null;
  let isMuted = false;
  let volumeSupported = true;

  document.getElementById('open-full').href = "https://meet.jit.si/" + encodeURIComponent(roomName);

  function initJitsi() {
    const domain = "meet.jit.si";
    const options = {
      roomName,
      parentNode: document.getElementById("jitsi-container"),
      userInfo: { displayName: "{{ request.user.get_full_name|default:request.user.username }}" },
      configOverwrite: {
        startAudioOnly: true,
        startWithAudioMuted: false,
        startWithVideoMuted: true,
        prejoinConfig: { enabled: false },
        disableDeepLinking: true,
      },
      interfaceConfigOverwrite: {
        TOOLBAR_BUTTONS: [],
        SHOW_JITSI_WATERMARK: false,
        HIDE_DEEP_LINKING_LOGO: true,
        MOBILE_APP_PROMO: false
      }
    };

    api = new JitsiMeetExternalAPI(domain, options);

    api.addListener('audioMuteStatusChanged', ({ muted }) => {
      isMuted = muted;
      syncMicUI();
    });
    const updateCount = () => {
      api.getParticipantsInfo().then(list => {
        document.getElementById('pcount').textContent = String(list.length + 1); // +1 bo Ty też uczestnik
      }).catch(()=>{});
    };
    api.addListener('participantJoined', updateCount);
    api.addListener('participantLeft', updateCount);
    setTimeout(updateCount, 1000);

    // spróbuj ustawić głośność – jeśli się nie uda, pokaż tip
    setTimeout(() => {
      try {
        api.executeCommand('setAudioOutputVolume', 100);
        volumeSupported = true;
      } catch (e) {
        volumeSupported = false;
        document.getElementById('vol-hint').style.display = 'block';
      }
      enableControls();
    }, 500);
  }

  function enableControls() {
    document.getElementById('mic-toggle').disabled = false;
    document.getElementById('vol').disabled = false;
  }

  function syncMicUI() {
    const btn = document.getElementById('mic-toggle');
    btn.textContent = isMuted ? '🎙️ Włącz mikrofon' : '🔇 Wycisz mikrofon';
  }

  document.getElementById('mic-toggle').addEventListener('click', () => {
    if (!api) return;
    api.executeCommand('toggleAudio');
  });

  document.getElementById('vol').addEventListener('input', (e) => {
    const v = Number(e.target.value);
    document.getElementById('vol-val').textContent = v + '%';
    if (!api) return;
    try {
      api.executeCommand('setAudioOutputVolume', v);
      if (!volumeSupported) {
        volumeSupported = true;
        document.getElementById('vol-hint').style.display = 'none';
      }
    } catch (e2) {
      volumeSupported = false;
      document.getElementById('vol-hint').style.display = 'block';
    }
  });

  // „Połącz audio” — wywołuje powstanie iframu Jitsi (gest użytkownika!)
  document.getElementById('connect-audio').addEventListener('click', () => {
    if (api) return;
    initJitsi();
  });

  // Presence
  function pingOnlineStatus() {
    fetch("{% url 'ping_online_status' %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken, "Content-Type": "application/x-www-form-urlencoded" },
      body: "rezerwacja_id=" + encodeURIComponent(rezerwacjaId)
    }).catch(()=>{});
  }
  function checkOtherUserStatus() {
    fetch(`/check-online-status/${rezerwacjaId}/`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('presence-dot').classList.toggle('status--on', !!data.online);
        document.getElementById('presence-text').textContent = data.online ? "Dostępny" : "Niedostępny";
      }).catch(()=>{});
  }
  setInterval(pingOnlineStatus, 10000);
  setInterval(checkOtherUserStatus, 10000);
  pingOnlineStatus();
  checkOtherUserStatus();
</script>
</body>
</html>
