<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Zajęcia online — audio (dwukierunkowe)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#0b74ff; --ok:#28a745; --warn:#ffb300; --danger:#dc3545; }
    :root{ --bg:#f4f6fb; --card:#fff; --ring:#bcd3ff; --shadow-sm:0 1px 2px rgba(0,0,0,.06); --shadow-md:0 6px 18px rgba(11,116,255,.12); }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg)}
    header{background:linear-gradient(180deg,rgba(11,116,255,.98),rgba(11,116,255,.92));color:#fff;padding:10px 14px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;box-shadow:var(--shadow-md)}
    .title{font-weight:800;font-size:18px;margin-right:auto}
    .pill{background:var(--card);color:#111;padding:8px 10px;border-radius:10px;border:1px solid #dfe6f5;display:inline-flex;align-items:center;gap:8px;font-weight:600;box-shadow:var(--shadow-sm)}
    .pill.disabled{opacity:.55;pointer-events:none}
    main{padding:22px 16px;display:flex;flex-direction:column;align-items:center;gap:18px}
    .btn{padding:12px 18px;border-radius:10px;border:1px solid #d7e0f0;background:#fff;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#28a745,#1f8b39);color:#fff;border:none}
    .slider{width:220px;height:6px;border-radius:999px;background:#e8eefc;outline:none}
    .badge{padding:6px 10px;border-radius:10px;background:#fff;border:1px dashed #cfd6e4;color:#2a2f3a;box-shadow:var(--shadow-sm)}
    #vu{width:120px;height:10px;background:#e8eefc;border-radius:6px;overflow:hidden}
    #vu>span{display:block;height:100%;width:0;background:#28a745;transition:width .06s linear;border-radius:6px}
    #autoplay{display:none;align-items:center;gap:10px;background:#fff9e6;border:1px solid #ffe08a;color:#5a3c00;padding:10px 12px;border-radius:10px}
    audio{width:0;height:0;opacity:0}
  </style>
</head>
<body>
<header>
  <div class="title">Zajęcia online — audio</div>
  <div class="pill">👥 <span id="participants">1</span></div>
  <button class="pill disabled" id="mic-btn" type="button" onclick="toggleMic()"><span id="mic-ico">🔇</span><span id="mic-lbl">Wycisz mikrofon</span></button>
  <div class="pill">🔈 <input id="vol" class="slider" type="range" min="0" max="100" value="100" oninput="setVolume(this.value)"> <span id="vol-val">100%</span></div>
  <div class="pill">📶 Wejście: <div id="vu"><span></span></div></div>
  <div class="pill">🧊 ICE: <small id="ice">init</small> <small id="ice-path" style="opacity:.8"></small></div>
  <div class="pill">🔁 Signaling: <small id="sig">init</small></div>
  <div class="pill">🗃️ Store: <small id="store">offer: –, answer: –</small></div>

  {% if is_teacher %}
    <button class="pill" id="host" type="button" onclick="startHost()">🔗 Połącz (gospodarz)</button>
  {% else %}
    <button class="pill" id="student" type="button" onclick="joinMeeting()">🔗 Połącz (uczeń)</button>
  {% endif %}
  <button class="pill" id="bye" type="button" onclick="hangup()" style="display:none;">🔌 Rozłącz</button>
</header>

<main>
  <a class="btn primary" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">✏️ Otwórz tablicę</a>
  {% if is_teacher %}
  <form method="POST" style="display:flex;gap:8px;flex-wrap:wrap">
    {% csrf_token %}
    <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required style="min-width:280px;width:420px;max-width:100%;padding:10px 12px;border-radius:10px;border:1px solid #cfd6e4">
    <button type="submit" class="pill">💾 Zapisz link</button>
  </form>
  {% endif %}
  <div id="autoplay">🔇 Przeglądarka zablokowała dźwięk. <button type="button" onclick="ensureAudio()">Włącz audio</button></div>
  <div class="badge">📱 Mobile wymaga HTTPS. Dla ciężkich NAT rozważ TURN (coturn).</div>
</main>

<audio id="remote" autoplay playsinline></audio>

<script>
/* ====== Kontekst (Django) ====== */
const IS_TEACHER = {% if is_teacher %}true{% else %}false{% endif %};
const OFFER_URL  = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_offer' rez_id=rezerwacja.id %}";
const ANSWER_URL = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_answer' rez_id=rezerwacja.id %}";

/* ====== CSRF — kluczowa poprawka ====== */
function getCookie(name){
  const v = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
  return v ? decodeURIComponent(v.pop()) : '';
}
function csrfHeader(){
  const t = getCookie('csrftoken'); // Django default
  return t ? {'X-CSRFToken': t, 'X-Requested-With':'XMLHttpRequest'} : {'X-Requested-With':'XMLHttpRequest'};
}

/* ====== RTC config (STUN ok; TURN dodasz gdy postawisz) ====== */
const rtcConfig = {
  iceServers: [{ urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"] }],
  bundlePolicy: "max-bundle"
};

/* ====== Stan ====== */
let pc=null, localStream=null, remoteStream=null, audioTransceiver=null;
let joined=false, connecting=false, negReady=false;
let vuLoop=null;

/* ====== Helpers ====== */
const $ = s=>document.querySelector(s);
function setSig(m){ $('#sig').textContent=m; }
function setIce(m){ $('#ice').textContent=m; }
function setIcePath(m){ $('#ice-path').textContent=m; }
function uiRefresh(){
  $('#participants').textContent = joined ? 2 : 1;
  $('#mic-btn').classList.toggle('disabled', !localStream);
  $('#bye').style.display = joined ? 'inline-flex' : 'none';
  if(IS_TEACHER){ $('#host').style.display = joined ? 'none' : 'inline-flex'; }
  else { $('#student').style.display = joined ? 'none' : 'inline-flex'; }
}
function setVolume(v){ $('#vol-val').textContent=v+'%'; $('#remote').volume=Math.max(0,Math.min(1,Number(v)/100)); }
async function ensureAudio(){
  try{ await $('#remote').play(); $('#autoplay').style.display='none'; }catch{ $('#autoplay').style.display='block'; }
}

/* ====== VU ====== */
let audioCtx=null, analyser=null, srcNode=null;
function startInputVU(stream){
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    if(!analyser){ analyser=audioCtx.createAnalyser(); analyser.fftSize=256; }
    if(srcNode){ try{srcNode.disconnect();}catch{} srcNode=null; }
    srcNode = audioCtx.createMediaStreamSource(stream); srcNode.connect(analyser);
    const bar = $('#vu>span');
    if(vuLoop) cancelAnimationFrame(vuLoop);
    const data=new Uint8Array(analyser.frequencyBinCount);
    const tick=()=>{ analyser.getByteTimeDomainData(data); let sum=0; for(const x of data){ const v=(x-128)/128; sum+=v*v; }
      const rms=Math.sqrt(sum/data.length); bar.style.width=Math.min(100,Math.round(rms*200))+'%'; vuLoop=requestAnimationFrame(tick); };
    tick();
  }catch{}
}

/* ====== RTC core ====== */
function setupPeer(){
  pc = new RTCPeerConnection(rtcConfig);
  audioTransceiver = pc.addTransceiver('audio', { direction: IS_TEACHER ? 'sendrecv' : 'recvonly' });

  setSig('pc:new'); setIce(pc.iceConnectionState||'new');
  pc.oniceconnectionstatechange = ()=>{
    setIce(pc.iceConnectionState||'');
    updateIcePath();
  };
  pc.ontrack = (e)=>{
    const el=$('#remote');
    if(e.streams && e.streams[0]){ el.srcObject=e.streams[0]; startInputVU(e.streams[0]); }
    else{ if(!remoteStream) remoteStream=new MediaStream(); remoteStream.addTrack(e.track); el.srcObject=remoteStream; startInputVU(remoteStream); }
    ensureAudio();
  };
  pc.onnegotiationneeded = async ()=>{
    if(!negReady || pc.signalingState!=='stable') return;
    try{
      setSig('re-offer');
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer); await waitIce();
      await postJSON(OFFER_URL, pc.localDescription, 're-offer');
      setSig('re-offer sent');
    }catch(e){ console.warn(e); }
  };
}
async function requestMic(){
  if(localStream) return;
  localStream = await navigator.mediaDevices.getUserMedia({
    audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true, channelCount:1 }
  });
  const track = localStream.getAudioTracks()[0];
  if(!IS_TEACHER){ audioTransceiver.direction='sendrecv'; }
  if(audioTransceiver?.sender){ await audioTransceiver.sender.replaceTrack(track); } else { pc.addTrack(track, localStream); }
  $('#mic-btn').classList.remove('disabled'); $('#mic-ico').textContent='🎙️'; $('#mic-lbl').textContent='Wycisz mikrofon';
}
function waitIce(){
  if(!pc || pc.iceGatheringState==='complete') return Promise.resolve();
  return new Promise(res=>{
    const f=()=>{ if(pc.iceGatheringState==='complete'){ pc.removeEventListener('icegatheringstatechange', f); res(); } };
    pc.addEventListener('icegatheringstatechange', f);
  });
}
async function postJSON(url,desc,label){
  const r = await fetch(url,{
    method:'POST',
    headers:{'Content-Type':'application/json', ...csrfHeader()},
    credentials:'same-origin',
    body: JSON.stringify({type:desc.type, sdp:desc.sdp})
  });
  if(!r.ok){
    setSig(`${label} FAIL ${r.status}`);
    alert(`${label} → ${r.status}. Sprawdź CSRF i URL.`);
    throw new Error(`${label} ${r.status}`);
  }
  try{ return await r.json(); }catch{ return {ok:true}; }
}
async function getJSON(url,label){
  const r = await fetch(url,{credentials:'same-origin', cache:'no-store'});
  if(r.status===404) return null;
  if(!r.ok){ setSig(`${label} FAIL ${r.status}`); throw new Error(`${label} ${r.status}`); }
  try{ return await r.json(); }catch{ return null; }
}

/* ====== Start: nauczyciel ====== */
async function startHost(){
  if(!IS_TEACHER || joined || connecting) return; connecting=true;
  try{
    setupPeer();
    await requestMic(); // mic PRZED offer
    setSig('creating-offer');
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await waitIce();
    await postJSON(OFFER_URL, pc.localDescription, 'offer-post');

    setSig('waiting-answer');
    // czekamy aż student zapisze answer
    for(let i=0;i<180;i++){
      const ans = await getJSON(ANSWER_URL,'answer-get');
      if(ans && ans.type==='answer' && ans.sdp){
        await pc.setRemoteDescription(new RTCSessionDescription(ans));
        joined=true; uiRefresh(); negReady=true; break;
      }
      await new Promise(r=>setTimeout(r,1000));
    }
    if(!joined) throw new Error('Brak ANSWER od ucznia (sprawdź CSRF po stronie ucznia).');
  }catch(e){
    alert('Host error: '+e.message);
    teardown();
  }finally{
    connecting=false; ensureAudio();
  }
}

/* ====== Start: uczeń ====== */
async function joinMeeting(){
  if(IS_TEACHER || joined || connecting) return; connecting=true;
  try{
    setupPeer();
    // 1) pobierz ofertę
    let offer=null;
    for(let i=0;i<6;i++){
      offer = await getJSON(OFFER_URL,'offer-get');
      if(offer && offer.type==='offer' && offer.sdp) break;
      await new Promise(r=>setTimeout(r,300));
    }
    if(!offer) throw new Error('Brak oferty od nauczyciela.');
    await pc.setRemoteDescription(new RTCSessionDescription(offer));

    // 2) mic PRZED answer (i przełączenie na sendrecv)
    await requestMic();

    // 3) answer -> POST (z poprawnym CSRF z cookie!)
    setSig('creating-answer');
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await waitIce();
    await postJSON(ANSWER_URL, pc.localDescription, 'answer-post');

    joined=true; uiRefresh(); negReady=true;
  }catch(e){
    alert('Student error: '+e.message);
    teardown();
  }finally{
    connecting=false; ensureAudio();
  }
}

/* ====== Misc ====== */
async function toggleMic(){
  if(!localStream){ await requestMic(); return; }
  const t=localStream.getAudioTracks()[0]; if(!t) return;
  t.enabled=!t.enabled;
  const muted=!t.enabled;
  $('#mic-ico').textContent = muted ? '🔇' : '🎙️';
  $('#mic-lbl').textContent = muted ? 'Włącz mikrofon' : 'Wycisz mikrofon';
}
function hangup(){ teardown(); }
function teardown(){
  try{ pc?.close(); }catch{}
  try{ localStream?.getTracks().forEach(t=>t.stop()); }catch{}
  pc=null; localStream=null; remoteStream=null; audioTransceiver=null; joined=false; negReady=false;
  if(vuLoop) cancelAnimationFrame(vuLoop);
  setSig('init'); setIce('init'); setIcePath(''); uiRefresh();
}
function updateIcePath(){
  (async()=>{
    try{
      const st = await pc.getStats(); let proto='?', l='?', r='?';
      st.forEach(s=>{
        if(s.type==='transport' && s.selectedCandidatePairId){
          const pair=st.get(s.selectedCandidatePairId);
          const lc=st.get(pair.localCandidateId), rc=st.get(pair.remoteCandidateId);
          if(lc){ l=lc.candidateType; proto=lc.protocol; }
          if(rc){ r=rc.candidateType; }
        }
      });
      setIcePath(`(${l}→${r}, ${proto})`);
    }catch{ setIcePath(''); }
  })();
}

/* ====== Init ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  uiRefresh();
  setVolume($('#vol').value);
  setInterval(async ()=>{
    try{
      const o = await getJSON(OFFER_URL,'offer-watch');
      const a = await getJSON(ANSWER_URL,'answer-watch');
      $('#store').textContent = `offer: ${o&&o.sdp?`✓(${o.sdp.length})`:'–'}, answer: ${a&&a.sdp?`✓(${a.sdp.length})`:'–'}`;
    }catch{ $('#store').textContent='offer: ?, answer: ?'; }
  }, 1500);
});
</script>
</body>
</html>
