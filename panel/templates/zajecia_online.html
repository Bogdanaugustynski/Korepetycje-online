<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Zajęcia online — audio (auto)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#007bff; --ok:#28a745; --warn:#ffb300; --muted:#ccc; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:#f4f4f4; }
    header {
      background: var(--primary); color:#fff; padding:10px 14px;
      display:flex; align-items:center; gap:14px; flex-wrap:wrap;
    }
    .title { font-weight:700; font-size:18px; flex:1 1 auto; }
    .pill {
      background:#fff; color:#000; padding:8px 10px; border-radius:8px; border:1px solid #ddd;
      display:flex; align-items:center; gap:8px; font-weight:600;
    }
    .countdown { font-weight:700; }
    .countdown.red { color:#ffeb3b; }
    main { padding:16px; display:flex; flex-direction:column; align-items:center; gap:14px; }
    .btn-tablica {
      padding:12px 18px; font-size:16px; background:var(--ok); color:#fff;
      border:none; border-radius:10px; text-decoration:none; display:inline-block;
    }
    /* Jitsi osadzony w tle (niewidoczny) */
    #jitsi-hidden { position:fixed; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0; pointer-events:none; }
    /* Pasek awaryjny dla autoplay (znika po sukcesie) */
    #autoplay-banner {
      display:none; gap:10px; align-items:center;
      background:#fff3cd; border:1px solid #ffe08a; color:#663c00;
      padding:10px 12px; border-radius:8px;
    }
    #autoplay-banner button {
      border:0; border-radius:8px; padding:8px 10px; cursor:pointer; background:var(--warn); color:#000; font-weight:700;
    }
    .vol-wrap { display:flex; align-items:center; gap:10px; }
    input[type="range"] { width:180px; }
  </style>
</head>
<body>

<header>
  <div class="title">Zajęcia online — tryb audio (auto)</div>

  <div class="pill">
    <span>👥</span> <span id="participants-count">1</span>
  </div>

  <div class="pill vol-wrap">
    <span>🔈</span>
    <input id="vol" type="range" min="0" max="100" value="100" oninput="setVolume(this.value)">
    <span id="vol-val">100%</span>
  </div>

  <div class="pill">
    <span>⏱</span>
    <span id="countdown" class="countdown">Pozostało: --:--</span>
  </div>
</header>

<main>
  <a class="btn-tablica" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">✏️ Otwórz tablicę</a>

  {% if is_teacher %}
  <form method="POST" style="display:flex; gap:8px; flex-wrap:wrap;">
    {% csrf_token %}
    <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required
           style="min-width:280px; width:420px; max-width:100%; padding:10px 12px; border-radius:8px; border:1px solid #cfd6e4;">
    <button type="submit" class="pill">💾 Zapisz link</button>
  </form>
  {% endif %}

  <!-- Pasek autoodtwarzania (pokazuje się tylko jeśli przeglądarka zablokuje dźwięk) -->
  <div id="autoplay-banner">
    🔇 Przeglądarka zablokowała automatyczny dźwięk.
    <button type="button" id="autoplay-btn">Połącz audio</button>
  </div>
</main>

<!-- Niewidoczny kontener Jitsi -->
<div id="jitsi-hidden"></div>

<script src="https://meet.jit.si/external_api.js"></script>
<script>
  const rezerwacjaId = "{{ rezerwacja.id }}";
  let api = null;
  let audioArmed = false;
  let autoplayOk = false;

  // ——— Init Jitsi W TLE, bez prejoin, bez toolbara ———
  function startJitsiHidden() {
    if (api) { try { api.dispose(); } catch(e) {} api = null; }

    api = new JitsiMeetExternalAPI("meet.jit.si", {
      roomName: "ZajeciaAudio_{{ rezerwacja.id }}",
      parentNode: document.getElementById('jitsi-hidden'),
      configOverwrite: {
        // Bez prejoin, bez video
        prejoinConfig: { enabled: false },
        startWithVideoMuted: true,
        startWithAudioMuted: false,

        // Stabilny tor audio (pozwól na UDP)
        p2p: { enabled: true },
        webrtcIceUdpDisable: false,
        webrtcIceTcpDisable: false,

        // Audio sanity
        startSilent: false,
        disableAudioLevels: false,
        enableNoAudioDetection: true,
        enableNoisyMicDetection: true,
        constraints: {
          audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
        },

        disableDeepLinking: true
      },
      interfaceConfigOverwrite: {
        // Brak UI
        TOOLBAR_BUTTONS: [],
        MOBILE_APP_PROMO: false,
        SHOW_JITSI_WATERMARK: false,
        SHOW_BRAND_WATERMARK: false
      },
      userInfo: { displayName: "{{ request.user.get_full_name|default:request.user.username|default:'Gość' }}" }
    });

    // Zdarzenia
    api.addListener('videoConferenceJoined', () => {
      setVolume(100);
      armAudio();
      refreshCount();
    });
    api.addListener('participantJoined', refreshCount);
    api.addListener('participantLeft', refreshCount);
    api.addListener('devicesChanged', () => {
      // Jeśli system zmieni urządzenie — odśwież głośność po chwili
      setTimeout(() => setVolume(document.getElementById('vol').value), 100);
    });

    // Spróbuj kilka razy odblokować audio (na wypadek opóźnień)
    tryAutoConnectAudio(6, 400); // 6 prób co 400 ms
  }

  function refreshCount() {
    try {
      api.getParticipantsInfo().then(list => {
        document.getElementById('participants-count').textContent = Math.max(1, list.length);
      });
    } catch(e) {}
  }

  // ——— Głośność (tylko odbiór) ———
  function setVolume(val) {
    document.getElementById('vol-val').textContent = val + '%';
    try { api && api.setAudioVolume(Number(val)); } catch(e) {}
  }

  // ——— Autoplay: „zbroimy” audio i próbujemy w tle ———
  function warmAudioContext() {
    // Ciche piknięcie; część przeglądarek pozwala bez gestu, część wymaga kliknięcia
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      g.gain.value = 0.0001;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(() => { try { o.stop(); ctx.close(); } catch(e){} }, 40);
    } catch(e) {}
  }

  async function armAudio() {
    if (!api) return;
    audioArmed = true;
    warmAudioContext();
    try { api.setAudioVolume(100); } catch(e) {}
    // Nie używamy podwójnych toggle; tylko upewniamy się, że nie jest zmutowane
    try {
      const muted = await api.isAudioMuted();
      if (muted) await api.executeCommand('toggleAudio');
    } catch(e) {}
  }

  // Próbujemy kilkukrotnie po starcie konferencji
  async function tryAutoConnectAudio(tries=5, delay=300) {
    for (let i=0;i<tries;i++) {
      await new Promise(r => setTimeout(r, delay));
      if (!api) break;
      try {
        // test: jeśli nadal zmutowane albo nie gra, spróbuj ustawić głośność i unmute
        const muted = await api.isAudioMuted();
        if (muted) await api.executeCommand('toggleAudio');
        await api.setAudioVolume(100);
        // Jeżeli przeglądarka blokuje autoplay — pokaż pasek
        if (!autoplayOk && i >= 1) showAutoplayBanner();
      } catch(e) {
        showAutoplayBanner();
      }
    }
  }

  // ——— Pasek do ręcznego odblokowania (tylko jeśli trzeba) ———
  function showAutoplayBanner() {
    if (autoplayOk) return;
    const bar = document.getElementById('autoplay-banner');
    bar.style.display = 'flex';
  }

  async function manualConnectAudio() {
    autoplayOk = true;
    const bar = document.getElementById('autoplay-banner');
    bar.style.display = 'none';
    try {
      await armAudio();
      // niektóre przeglądarki „łapią” po drugim wywołaniu
      await api.executeCommand('toggleAudio'); 
      await api.executeCommand('toggleAudio');
      await api.setAudioVolume(100);
    } catch(e) {}
  }

  // ——— Odliczanie ———
  function initCountdown() {
    const el = document.getElementById('countdown');
    const start = new Date("{{ rezerwacja.termin|date:'Y-m-d H:i:s' }}").getTime();
    const end = start + 55 * 60 * 1000;
    function tick() {
      const diff = end - Date.now();
      if (diff <= 0) { el.textContent = "Zakończone"; el.classList.add('red'); return; }
      const m = Math.floor(diff/60000), s = Math.floor((diff%60000)/1000);
      el.textContent = `Pozostało: ${m}:${String(s).padStart(2,'0')}`;
      el.classList.toggle('red', m < 5);
    }
    tick(); setInterval(tick, 1000);
  }

  document.addEventListener('DOMContentLoaded', () => {
    startJitsiHidden();      // start od razu w tle, bez okienka i bez prejoin
    initCountdown();

    // guzik do ręcznego odblokowania (pokazuje się tylko gdy trzeba)
    document.getElementById('autoplay-btn').addEventListener('click', manualConnectAudio);
  });
</script>
</body>
</html>
