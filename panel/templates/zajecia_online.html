{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Zajƒôcia online ‚Äî PolubiszTo.pl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --ink:#0b3d91; --ring:#bcd3ff; --focus:#8ab6ff;
      --ok:#2dd66f; --muted:#bdbdbd; --shadow-sm:0 1px 2px rgba(0,0,0,.06);
      --shadow-md:0 6px 18px rgba(11,116,255,.12);
      --grad:linear-gradient(180deg, rgba(11,116,255,.98), rgba(11,116,255,.92));
      --cta:linear-gradient(180deg, #28a745, #1f8b39);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:#1c2533}

    header{background:var(--grad);color:#fff;padding:14px 18px;display:flex;gap:12px;align-items:center;box-shadow:var(--shadow-md);flex-wrap:wrap}
    h1{font-size:18px;margin:0;font-weight:800;margin-right:auto}
    .pill{background:var(--card);border:1px solid #dfe6f5;border-radius:12px;padding:8px 12px;display:flex;gap:8px;align-items:center;box-shadow:var(--shadow-sm);font-weight:600}
    .status-dot{width:12px;height:12px;border-radius:999px}
    .on{background:var(--ok);box-shadow:0 0 0 0 rgba(45,214,111,.35);animation:breath 1.8s ease-in-out infinite}
    .off{background:var(--muted)}
    @keyframes breath{0%{box-shadow:0 0 0 0 rgba(45,214,111,.35)}70%{box-shadow:0 0 0 12px rgba(45,214,111,0)}100%{box-shadow:0 0 0 0 rgba(45,214,111,0)}}
    main{max-width:900px;margin:22px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #e6ecfb;border-radius:16px;box-shadow:var(--shadow-sm);padding:18px;display:grid;gap:14px}
    .cta{display:inline-flex;align-items:center;gap:8px;padding:12px 18px;border-radius:12px;border:none;background:var(--cta);color:#fff;font-weight:800;cursor:pointer;box-shadow:0 6px 14px rgba(40,167,69,.22);text-decoration:none}
    input[type=url]{padding:12px;border-radius:12px;border:1px solid #cfd6e4;min-width:280px;width:420px;max-width:100%}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hint{font-size:14px;color:#334;opacity:.85}
    .muted{opacity:.85}
    .pill:focus-visible, input:focus-visible, .cta:focus-visible{outline:0;box-shadow:0 0 0 3px var(--focus)}
    @media (prefers-reduced-motion: reduce){*{animation:none !important;transition:none !important}}
  </style>
</head>
<body>

{% include "portials/brand.html" %}

<header>
  <h1>Zajƒôcia online ‚Äî tablica</h1>
  <div class="pill" title="Status obecno≈õci">
    <span id="dot" class="status-dot off"></span>
    <span id="presence">Niedostƒôpny</span>
  </div>
  <div class="pill">üë• <span id="participants">1</span></div>
  <div class="pill">‚è± <span id="timer">--:--</span></div>
</header>

<main>
  <div class="card">
    <div class="row">
      <a class="cta" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">‚úèÔ∏è Otw√≥rz tablicƒô</a>
      <div class="hint">Rozmowa g≈Çosowa odbywa siƒô w Excalidraw.</div>
    </div>

    {% if is_teacher %}
    <form method="POST" class="row">
      {% csrf_token %}
      <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required>
      <button class="pill" type="submit">üíæ Zapisz link</button>
    </form>
    {% endif %}

    <div class="muted">ID zajƒôƒá: {{ rezerwacja.id }} ‚Ä¢ Termin: {{ rezerwacja.termin }}</div>
  </div>
</main>

<script>
const rezerwacjaId="{{ rezerwacja.id }}";
const csrfToken="{{ csrf_token }}";

function pingPresence(){
  fetch("{% url 'ping_online_status' %}", {
    method:'POST',
    headers:{'X-CSRFToken':csrfToken,'Content-Type':'application/x-www-form-urlencoded'},
    body:'rezerwacja_id='+encodeURIComponent(rezerwacjaId)
  }).catch(()=>{});
}
function checkPresence(){
  fetch(`/check-online-status/${rezerwacjaId}/`)
    .then(r=>r.ok?r.json():Promise.reject(r.status))
    .then(d=>{
      const on = !!(d&&d.online);
      document.getElementById('dot').className = 'status-dot ' + (on?'on':'off');
      document.getElementById('presence').textContent = on ? 'Dostƒôpny' : 'Niedostƒôpny';
      document.getElementById('participants').textContent = on ? '2' : '1';
    }).catch(()=>{});
}
function initTimer(){
  const el=document.getElementById('timer');
  const start=new Date("{{ rezerwacja.termin|date:'Y-m-d H:i:s' }}").getTime();
  const end=start+55*60*1000;
  const tick=()=>{
    const d=end-Date.now(); if(d<=0){ el.textContent='Zako≈Ñczone'; return; }
    const m=Math.floor(d/60000), s=Math.floor((d%60000)/1000);
    el.textContent=`${m}:${String(s).padStart(2,'0')}`;
  };
  tick(); setInterval(tick,1000);
}
document.addEventListener('DOMContentLoaded', ()=>{
  initTimer();
  setInterval(pingPresence,10_000);
  setInterval(checkPresence,10_000);
  checkPresence();
});
</script>
</body>
</html>
