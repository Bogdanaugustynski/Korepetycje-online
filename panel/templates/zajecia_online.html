<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Zajęcia online — audio (kliknij aby połączyć)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#0b74ff; --ok:#28a745; --warn:#ffb300; --danger:#dc3545; }
    :root{
      --bg:#f4f6fb; --card:#ffffff; --ring:#bcd3ff; --ring-ink:#0b3d91;
      --shadow-sm:0 1px 2px rgba(0,0,0,.06); --shadow-md:0 6px 18px rgba(11,116,255,.12); --focus:#8ab6ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg)}
    header{
      background: linear-gradient(180deg, rgba(11,116,255,.98), rgba(11,116,255,.92));
      color:#fff;padding:10px 14px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;
      box-shadow: var(--shadow-md);
    }
    .title{font-weight:800;font-size:18px;margin-right:auto}
    .pill{
      background: var(--card); color:#111; padding:8px 10px; border-radius:10px;
      border:1px solid #dfe6f5; display:inline-flex; align-items:center; gap:8px; font-weight:600;
      box-shadow: var(--shadow-sm);
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease, background-color .2s ease;
    }
    .pill:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,.08); }
    .pill:active{ transform: translateY(0); box-shadow: var(--shadow-sm); }
    .pill.disabled{opacity:.55;pointer-events:none}
    .pill:focus-visible, .btn:focus-visible, input:focus-visible, select:focus-visible{
      outline: 0; box-shadow: 0 0 0 3px var(--focus); border-color: var(--focus);
    }
    .status-dot{width:14px;height:14px;border-radius:50%}
    .status--on{ background:#2dd66f; box-shadow:0 0 0 0 rgba(45,214,111,.4); animation:dot-breathe 1.8s ease-in-out infinite; }
    .status--off{background:#bdbdbd}
    @keyframes dot-breathe{ 0%{box-shadow:0 0 0 0 rgba(45,214,111,.40);} 70%{box-shadow:0 0 0 10px rgba(45,214,111,0);} 100%{box-shadow:0 0 0 0 rgba(45,214,111,0);} }
    main{padding:22px 16px;display:flex;flex-direction:column;align-items:center;gap:18px}
    .btn{padding:12px 18px;border-radius:10px;border:1px solid #d7e0f0;background:#fff;cursor:pointer;transition:transform .08s ease}
    .btn.primary{ background: linear-gradient(180deg, #28a745, #1f8b39); color:#fff;border:none; box-shadow: 0 6px 14px rgba(40,167,69,.22); }
    .btn.primary:hover{ transform: translateY(-1px); }
    .btn.primary:active{ transform: translateY(0); }
    .btn.danger{background:#fff;color:#b30000;border-color:#f3c3c3}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .slider{width:220px;height:6px;border-radius:999px;background:#e8eefc;outline:none}
    .slider::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none; width:16px; height:16px; border-radius:50%;
      background: var(--primary); border:2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,.2);
    }
    .slider::-moz-range-thumb{ width:16px; height:16px; border-radius:50%; background: var(--primary); border:2px solid #fff; }
    .badge{padding:6px 10px;border-radius:10px;background:#fff;border:1px dashed #cfd6e4;color:#2a2f3a; box-shadow: var(--shadow-sm)}
    #vu{width:120px;height:10px;background:#e8eefc;border-radius:6px;overflow:hidden}
    #vu>span{display:block;height:100%;width:0;background:#28a745;transition:width .06s linear; border-radius:6px}
    #autoplay{ display:none;align-items:center;gap:10px;background:#fff9e6;border:1px solid #ffe08a;color:#5a3c00;
      padding:10px 12px;border-radius:10px; box-shadow: var(--shadow-sm); }
    #autoplay button{border:0;border-radius:8px;padding:8px 10px;cursor:pointer;background:var(--warn);color:#000;font-weight:800}
    #incoming{ display:none; align-items:center; gap:10px; background:#eef4ff; border:1px solid var(--ring); color:var(--ring-ink);
      padding:10px 12px; border-radius:12px; box-shadow: var(--shadow-sm); opacity:0; transform: translateY(-4px); }
    #incoming.show{ display:flex; animation: incomingFade .25s ease forwards, ringPulse 1.6s ease-out infinite; }
    @keyframes incomingFade{ to{ opacity:1; transform: translateY(0); } }
    @keyframes ringPulse{ 0%{ box-shadow: 0 0 0 0 rgba(140,174,255,.35);} 70%{ box-shadow: 0 0 0 12px rgba(140,174,255,0);} 100%{ box-shadow: 0 0 0 0 rgba(140,174,255,0);} }
    small{opacity:.9;font-weight:600}
    audio{width:0;height:0;opacity:0;pointer-events:none}
    @media (prefers-reduced-motion: reduce){ *{ animation: none !important; transition: none !important; } }
  </style>
</head>
<body>
<header>
  <div class="title">Zajęcia online — audio</div>
  <button class="pill" id="presence-pill" type="button" title="Status obecności (bez auto-łączenia)">
    <span id="presence-dot" class="status-dot status--off"></span>
    <span id="presence-text">Niedostępny</span>
  </button>
  <div class="pill">👥 <span id="participants">1</span></div>
  <button class="pill disabled" id="mic-btn" type="button" onclick="toggleMic()">
    <span id="mic-ico">🔇</span><span id="mic-lbl">Wycisz mikrofon</span>
  </button>
  <div class="pill">
    🔈 <input id="vol" class="slider" type="range" min="0" max="100" value="100" oninput="setVolume(this.value)">
    <span id="vol-val">100%</span>
  </div>
  <div class="pill">⏱ <span id="timer">--:--</span></div>
  <div class="pill" id="out-pill">🔊 Wyjście:
    <select id="out" onchange="changeOutput(this.value)"><option>Ładowanie…</option></select>
  </div>
  <div class="pill">📶 Wejście: <div id="vu"><span></span></div></div>
  <div class="pill">🧊 ICE: <small id="ice">init</small> <small id="ice-path" style="opacity:.8"></small></div>
  <div class="pill">🔁 Signaling: <small id="sig">init</small></div>
  <div class="pill">🗃️ Store: <small id="store">offer: –, answer: –</small></div>

  {% if is_teacher %}
    <button class="pill" id="announce" type="button" onclick="announceHost()">📣 Ogłoś: jestem gospodarzem</button>
    <button class="pill" id="host" type="button" onclick="startHost()">🔗 Połącz (gospodarz)</button>
  {% else %}
    <span class="pill" id="wait-host" style="display:none;">⏳ Czekamy na gospodarza…</span>
    <button class="pill" id="student" type="button" onclick="/* uczeń używa przycisku w banerze */void(0)">🔗 Połącz (uczeń)</button>
  {% endif %}

  <button class="pill btn danger" id="bye" type="button" onclick="hangup()" style="display:none;">🔌 Rozłącz</button>
</header>

<main>
  <a class="btn primary" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">✏️ Otwórz tablicę</a>

  {% if is_teacher %}
  <form method="POST" style="display:flex;gap:8px;flex-wrap:wrap">
    {% csrf_token %}
    <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required
           style="min-width:280px;width:420px;max-width:100%;padding:10px 12px;border-radius:10px;border:1px solid #cfd6e4">
    <button type="submit" class="pill">💾 Zapisz link</button>
  </form>
  {% endif %}

  <div id="autoplay">🔇 Przeglądarka zablokowała dźwięk. Kliknij: <button type="button" id="autoplay-btn">Włącz audio</button></div>

  <div id="incoming">
    📞 Połączenie przychodzące od nauczyciela…
    <div style="margin-left:auto;display:flex;gap:8px">
      <button type="button" id="accept" class="pill">✅ Odbierz</button>
      <button type="button" id="decline" class="pill">❌ Odrzuć</button>
    </div>
  </div>

  <div class="badge">📱 Mobile wymaga <b>HTTPS</b>. Dla ciężkich NAT skonfiguruj <b>TURN</b> i ewentualnie tryb <i>relay</i>.</div>
</main>

<audio id="remote" autoplay playsinline></audio>

<script>
/* ====== Kontekst ====== */
const rezerwacjaId = "{{ rezerwacja.id }}";
const csrfToken    = "{{ csrf_token }}";
const IS_TEACHER   = {% if is_teacher %}true{% else %}false{% endif %};

const OFFER_URL  = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_offer' rez_id=rezerwacja.id %}";
const ANSWER_URL = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_answer' rez_id=rezerwacja.id %}";

/* ====== TURN (opcjonalnie) ====== */
/* Uzupełnij host/user/pass i ustaw forceRelay:true, jeśli masz jednostronny dźwięk przez NAT */
const TURN = {
  host: "",     // np. "turn.example.com"
  user: "",     // np. "webrtc"
  pass: "",     // np. "webrtc123"
  forceRelay: true
};

/* ====== RTC config ====== */
const rtcConfig = {
  iceServers: [
    { urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"] },
    ...(TURN.host ? [{ urls:[`turn:${TURN.host}:3478?transport=udp`,`turn:${TURN.host}:3478?transport=tcp`], username:TURN.user, credential:TURN.pass }] : [])
  ],
  iceTransportPolicy: TURN.forceRelay ? "relay" : "all",
  bundlePolicy: "max-bundle"
};

/* ====== Stan ====== */
let pc=null, localStream=null, remoteStream=null, audioTransceiver=null;
let joined=false, connecting=false, negReady=false, otherOnline=false, isMuted=false;
let offerWatch=null, vuLoop=null, inVuTimer=null;
let gumBusy=false;
let incomingOffer=false, ringWatch=null;

/* ====== Helpers/UI ====== */
const $ = sel => document.querySelector(sel);
const supportsSink = ('setSinkId' in HTMLMediaElement.prototype);
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function setSig(m){ $('#sig').textContent=m; }
function setIce(m){ $('#ice').textContent=m; }
function setIcePath(m){ $('#ice-path').textContent=m; }

function uiRefresh(){
  $('#participants').textContent = joined ? 2 : 1;
  $('#mic-btn').classList.toggle('disabled', !localStream);
  $('#bye').style.display = joined ? 'inline-flex' : 'none';
  if(IS_TEACHER){
    $('#announce').style.display = joined ? 'none' : 'inline-flex';
    $('#host').style.display     = joined ? 'none' : 'inline-flex';
  }else{
    $('#student').style.display  = joined ? 'none' : 'inline-flex';
  }
}
function setVolume(v){
  $('#vol-val').textContent = v+'%';
  const el = $('#remote'); el.volume = Math.max(0,Math.min(1,Number(v)/100));
}
async function populateOutputs(){
  if(!supportsSink){ $('#out-pill').style.display='none'; return; }
  try{
    const devs = await navigator.mediaDevices.enumerateDevices();
    const outs = devs.filter(d=>d.kind==='audiooutput');
    const sel = $('#out'); sel.innerHTML='';
    if(!outs.length){ sel.innerHTML='<option value="">Domyślne</option>'; return; }
    outs.forEach(d=>{
      const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||d.deviceId; sel.appendChild(o);
    });
  }catch(e){ $('#out-pill').style.display='none'; }
}
async function changeOutput(id){ if(supportsSink){ try{ await $('#remote').setSinkId(id||''); }catch(e){} } setVolume($('#vol').value); }

/* ====== Audio unlock & VU ====== */
let audioCtx=null, analyser=null, srcNode=null;
async function ensureAudio(){
  try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state!=='running') await audioCtx.resume(); }catch(e){}
  try{
    const el=$('#remote'); el.muted=false; el.setAttribute('playsinline',''); await el.play();
    $('#autoplay').style.display='none';
  }catch(e){ $('#autoplay').style.display='flex'; }
}
function startInputVU(stream){
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    if(!analyser){ analyser=audioCtx.createAnalyser(); analyser.fftSize=256; }
    if(srcNode){ try{srcNode.disconnect();}catch(e){} srcNode=null; }
    srcNode = audioCtx.createMediaStreamSource(stream); srcNode.connect(analyser);
    const bar = $('#vu>span');
    if(vuLoop) cancelAnimationFrame(vuLoop);
    const data=new Uint8Array(analyser.frequencyBinCount);
    const tick=()=>{ analyser.getByteTimeDomainData(data); let sum=0; for(const x of data){ const v=(x-128)/128; sum+=v*v; }
      const rms=Math.sqrt(sum/data.length); bar.style.width=Math.min(100,Math.round(rms*200))+'%'; vuLoop=requestAnimationFrame(tick); };
    tick();
  }catch(e){}
}
function startInboundStatsVU(){
  if(inVuTimer) clearTimeout(inVuTimer);
  const bar = $('#vu>span');
  const loop = async ()=>{
    try{
      const rcv = pc?.getReceivers().find(r=>r.track && r.track.kind==='audio');
      if(!rcv){ bar.style.width='0%'; inVuTimer=setTimeout(loop,300); return; }
      const st = await rcv.getStats(); let level=null;
      st.forEach(s=>{ if(s.type==='inbound-rtp' && s.kind==='audio' && typeof s.audioLevel==='number') level=s.audioLevel; });
      bar.style.width = (level!=null) ? Math.min(100,Math.round(level*200))+'%' : '0%';
    }catch(e){}
    inVuTimer=setTimeout(loop,300);
  };
  loop();
}

/* ====== RTC core ====== */
function attachRemoteAudio(){
  const el=$('#remote');
  el.srcObject=null; el.muted=false; el.setAttribute('playsinline',''); ensureAudio();
}

function setupPeer(){
  pc = new RTCPeerConnection(rtcConfig);

  // KLUCZ: różne kierunki startowe
  audioTransceiver = pc.addTransceiver('audio', { direction: IS_TEACHER ? 'sendrecv' : 'recvonly' });

  setSig('pc:new'); setIce(pc.iceConnectionState||'new');

  pc.onicegatheringstatechange = ()=>{};
  pc.oniceconnectionstatechange = ()=>{
    setIce(pc.iceConnectionState || '');
    updateIcePath();
    if(['failed','disconnected'].includes(pc.iceConnectionState||'')){
      if(joined) hardIceRestartIfNeeded();
    }
  };
  pc.onconnectionstatechange = ()=>{ if(['disconnected','failed','closed'].includes(pc.connectionState)){ joined=false; uiRefresh(); } };

  pc.ontrack = (e)=>{
    const el = $('#remote');
    if(e.streams && e.streams[0]){ el.srcObject = e.streams[0]; startInputVU(e.streams[0]); }
    else{ if(!remoteStream) remoteStream=new MediaStream(); remoteStream.addTrack(e.track); el.srcObject=remoteStream; startInputVU(remoteStream); }
    e.track.onunmute = ensureAudio;
    ensureAudio(); startInboundStatsVU();
  };

  // Renegocjacja dopiero po stabilnym handshaku
  pc.onnegotiationneeded = async ()=>{
    if(!negReady || pc.signalingState!=='stable') return;
    try{
      setSig('re-negotiation…');
      const offer = await pc.createOffer(); await pc.setLocalDescription(offer); await waitIce();
      await postJSON(OFFER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'re-offer');
      setSig('re-negotiation offer sent');
    }catch(e){ console.warn('onnegotiationneeded', e); }
  };
}

/* ====== SYGNAŁ: uczeń ma mikrofon (hak na twardą renegocjację nauczyciela) ====== */
async function signalStudentReady() {
  try {
    await fetch("{% url 'ping_online_status' %}", {
      method:'POST',
      headers:{'X-CSRFToken':csrfToken,'Content-Type':'application/x-www-form-urlencoded'},
      body:'rezerwacja_id='+encodeURIComponent(rezerwacjaId)+'&event=student_mic_ready'
    });
  } catch(_) {}
}

async function requestMicNow(){
  if(gumBusy || localStream) return;
  gumBusy=true;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true, channelCount:1 }
    });
    localStream = stream;
    const track = stream.getAudioTracks()[0];

    if(!audioTransceiver && pc){
      audioTransceiver = pc.addTransceiver('audio', {direction: IS_TEACHER ? 'sendrecv' : 'recvonly'});
    }
    if(!IS_TEACHER){
      audioTransceiver.direction='sendrecv';
    }
    if(audioTransceiver?.sender){
      await audioTransceiver.sender.replaceTrack(track);
    }else if(pc){
      pc.addTrack(track, localStream);
    }

    // 🔔 poinformuj nauczyciela, żeby zrobił re-offer i dociągnął tor RX
    if(!IS_TEACHER) signalStudentReady();

    $('#mic-btn').classList.remove('disabled');
    $('#mic-ico').textContent='🎙️'; $('#mic-lbl').textContent='Wycisz mikrofon';
    uiRefresh();
  }catch(e){ console.warn('[MIC] gUM error', e); }
  finally{ gumBusy=false; }
}

function waitIce(){
  if(!pc || pc.iceGatheringState==='complete') return Promise.resolve();
  return new Promise(res=>{
    const f=()=>{ if(pc.iceGatheringState==='complete'){ pc.removeEventListener('icegatheringstatechange', f); res(); } };
    pc.addEventListener('icegatheringstatechange', f);
  });
}
function teardown(){
  try{ pc?.close(); }catch(e){} pc=null; audioTransceiver=null;
  try{ localStream?.getTracks().forEach(t=>t.stop()); }catch(e){}
  localStream=null; remoteStream=null; joined=false; negReady=false;
  if(vuLoop) cancelAnimationFrame(vuLoop); if(inVuTimer) clearTimeout(inVuTimer); if(offerWatch) clearTimeout(offerWatch);
  setSig('init'); setIce('init'); setIcePath(''); uiRefresh();
  const inc = $('#incoming'); inc.classList.remove('show'); inc.style.display='none'; incomingOffer=false;
}

/* ====== Re-offer watcher ====== */
function startOfferWatcher(){
  if(offerWatch) clearTimeout(offerWatch);
  const loop = async ()=>{
    try{
      if(!pc){ offerWatch=setTimeout(loop,1000); return; }
      const off = await getJSON(OFFER_URL,'offer-watch');
      if(off && off.type==='offer' && off.sdp){
        if(pc.signalingState!=='stable'){ offerWatch=setTimeout(loop,1000); return; }
        setSig('remote-offer'); await pc.setRemoteDescription(new RTCSessionDescription(off));
        const ans = await pc.createAnswer(); await pc.setLocalDescription(ans); await waitIce();
        await postJSON(ANSWER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'re-answer');
        setSig('renegotiation-answer-sent');
      }
    }catch(e){}
    offerWatch=setTimeout(loop,1000);
  };
  loop();
}

/* ====== TWARDY re-offer po stronie NAUCZYCIELA, gdy uczeń ma mic ====== */
async function forceReofferByTeacher(){
  if(!IS_TEACHER || !pc) return;
  if(pc.signalingState!=='stable') return;
  try{
    setSig('teacher re-offer');
    const offer = await pc.createOffer({iceRestart:false});
    await pc.setLocalDescription(offer);
    await waitIce();
    await postJSON(OFFER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'teacher-reoffer');
    setSig('teacher re-offer sent');
  }catch(e){ console.warn('forceReofferByTeacher', e); }
}

/* ====== ICE restart w razie zrywania ====== */
async function hardIceRestartIfNeeded(){
  if(!pc || pc.signalingState!=='stable') return;
  try{
    setSig('iceRestart');
    const offer = await pc.createOffer({iceRestart:true});
    await pc.setLocalDescription(offer);
    await waitIce();
    await postJSON(OFFER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'ice-restart-offer');
    setSig('iceRestart sent');
  }catch(e){ console.warn('iceRestart', e); }
}

/* ====== Host (nauczyciel) ====== */
async function startHost(){
  if(!IS_TEACHER) return;
  if(joined||connecting) return; connecting=true;
  const btn = $('#host'); btn.textContent='Dzwonienie…'; btn.classList.add('disabled');
  try{
    attachRemoteAudio(); setupPeer(); setSig('creating-offer');

    // Nauczyciel może wziąć mikrofon PRZED offer
    await requestMicNow();

    const offer = await pc.createOffer(); await pc.setLocalDescription(offer); await waitIce();
    setSig('posting-offer'); await postJSON(OFFER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'offer-post');

    // czekamy aż uczeń odpowie
    setSig('waiting-answer'); let ok=false;
    for(let i=0;i<180 && pc;i++){
      const ans = await getJSON(ANSWER_URL,'answer-get');
      if(ans && ans.type==='answer' && ans.sdp){ await pc.setRemoteDescription(new RTCSessionDescription(ans)); ok=true; break; }
      await sleep(1000);
    }
    if(!ok) throw new Error('Brak odpowiedzi ucznia');

    joined=true; uiRefresh(); await populateOutputs();
    negReady=true; startOfferWatcher();

    try{ await $('#remote').play(); }catch{}
  }catch(e){ alert('Host error: '+e); teardown(); }
  finally{ btn.textContent='🔗 Połącz (gospodarz)'; btn.classList.remove('disabled'); connecting=false; updateIcePath(); }
}

/* ====== Student (uczeń) ====== */
async function joinMeeting(){
  if(IS_TEACHER) return;
  if(joined||connecting) return; connecting=true;
  try{
    attachRemoteAudio(); setupPeer(); ensureAudio();

    // Czekamy na ofertę od nauczyciela
    let offer=null;
    for(let i=0;i<6;i++){
      offer = await getJSON(OFFER_URL,'offer-get');
      if(offer && offer.type==='offer' && offer.sdp) break;
      await sleep(300);
    }
    if(!offer){ alert('Brak połączenia przychodzącego.'); connecting=false; return; }

    setSig('set-remote-offer'); await pc.setRemoteDescription(new RTCSessionDescription(offer));

    // KLUCZ: uczeń bierze mikrofon PRZED createAnswer i przełącza transceiver na sendrecv
    await requestMicNow();

    setSig('creating-answer');
    const answer = await pc.createAnswer(); await pc.setLocalDescription(answer); await waitIce();
    setSig('posting-answer'); await postJSON(ANSWER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'answer-post');

    joined=true; uiRefresh(); await populateOutputs();
    negReady=true; startOfferWatcher();

    const inc = $('#incoming'); inc.classList.remove('show'); inc.style.display='none'; incomingOffer=false;

    try{ await $('#remote').play(); }catch{}
  }catch(e){ alert('Join error: '+e); teardown(); }
  finally{ connecting=false; updateIcePath(); }
}

/* ====== Misc ====== */
async function toggleMic(){
  if(!localStream){
    await requestMicNow();
    // jeśli połączono i stable – wyzwól renegocjację, aby upewnić się, że tor TX trafił do SDP
    if(joined && pc?.signalingState==='stable'){
      try{
        const offer = await pc.createOffer(); await pc.setLocalDescription(offer); await waitIce();
        await postJSON(OFFER_URL,{type:pc.localDescription.type,sdp:pc.localDescription.sdp},'re-offer-mic');
      }catch(e){}
    }
    return;
  }
  const t = localStream.getAudioTracks()[0]; if(!t) return;
  t.enabled = !t.enabled; isMuted = !t.enabled;
  $('#mic-ico').textContent = isMuted ? '🔇' : '🎙️';
  $('#mic-lbl').textContent = isMuted ? 'Włącz mikrofon' : 'Wycisz mikrofon';
}
function hangup(){ teardown(); }
function updateIcePath(){ if(!pc){ setIcePath(''); return; }
  (async()=>{
    try{
      const st = await pc.getStats(); let proto='?', l='?', r='?';
      st.forEach(s=>{
        if(s.type==='transport' && s.selectedCandidatePairId){
          const pair=st.get(s.selectedCandidatePairId);
          const lc=st.get(pair.localCandidateId), rc=st.get(pair.remoteCandidateId);
          if(lc){ l=lc.candidateType; proto=lc.protocol; }
          if(rc){ r=rc.candidateType; }
        }
      });
      setIcePath(`(${l}→${r}, ${proto})`);
    }catch(e){ setIcePath(''); }
  })();
}

/* ====== Signaling helpers ====== */
async function postJSON(url,data,label){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},body:JSON.stringify(data),credentials:'same-origin',cache:'no-store'}); if(!r.ok) throw new Error(`${label} ${url} -> ${r.status}`); try{return await r.json();}catch{return {ok:true}}}
async function getJSON(url,label){ const r=await fetch(url,{credentials:'same-origin',cache:'no-store'}); if(r.status===404) return null; if(!r.ok) throw new Error(`${label} ${url} -> ${r.status}`); try{return await r.json();}catch{return null}}

/* ====== Presence & store ====== */
function pingPresence(){ fetch("{% url 'ping_online_status' %}",{method:'POST',headers:{'X-CSRFToken':csrfToken,'Content-Type':'application/x-www-form-urlencoded'},body:'rezerwacja_id='+encodeURIComponent(rezerwacjaId)}).catch(()=>{}); }
function checkPresence(){
  fetch(`/check-online-status/${rezerwacjaId}/`).then(r=>r.ok?r.json():Promise.reject(r.status)).then(d=>{
    otherOnline = !!(d&&d.online);
    $('#presence-dot').className = 'status-dot '+(otherOnline?'status--on':'status--off');
    $('#presence-text').textContent = otherOnline?'Dostępny':'Niedostępny';
    uiRefresh();
  }).catch(()=>{});
}
function updateStore(){
  Promise.all([getJSON(OFFER_URL,'offer-get'), getJSON(ANSWER_URL,'answer-get')]).then(async ([o,a])=>{
    $('#store').textContent = `offer: ${o&&o.sdp?`✓(${o.sdp.length})`:'–'}, answer: ${a&&a.sdp?`✓(${a.sdp.length})`:'–'}`;

    // jeśli nauczyciel jest połączony, SDP stable, a nie płyną bajty inbound – zrób re-offer
    if(IS_TEACHER && joined && pc?.signalingState==='stable'){
      try{
        const r = pc.getReceivers().find(r=>r.track && r.track.kind==='audio');
        if(r){
          const st = await r.getStats();
          let bytes = 0;
          st.forEach(s=>{ if(s.type==='inbound-rtp' && s.kind==='audio' && typeof s.bytesReceived==='number') bytes = s.bytesReceived; });
          if(bytes===0){ forceReofferByTeacher(); }
        }
      }catch(_){}
    }
  }).catch(()=>{ $('#store').textContent='offer: ?, answer: ?'; });
}

/* ====== Dzwonek u ucznia ====== */
function startRingWatcherForStudent(){
  if(IS_TEACHER) return;
  if(ringWatch) clearTimeout(ringWatch);
  const loop = async ()=>{
    try{
      if(joined){
        const inc = $('#incoming'); inc.classList.remove('show'); inc.style.display='none';
        incomingOffer=false; ringWatch=setTimeout(loop,1500); return;
      }
      const off = await getJSON(OFFER_URL,'ring-watch');
      const has = !!(off && off.type==='offer' && off.sdp);
      incomingOffer = has;
      const inc = $('#incoming');
      if(has){ inc.classList.add('show'); inc.style.display='flex'; }
      else{ inc.classList.remove('show'); inc.style.display='none'; }
    }catch(e){}
    ringWatch = setTimeout(loop,1500);
  };
  loop();
}

/* ====== Ogłoszenie hosta ====== */
async function announceHost(){
  try{
    await fetch("{% url 'ping_online_status' %}", {
      method:'POST',
      headers:{'X-CSRFToken':csrfToken,'Content-Type':'application/x-www-form-urlencoded'},
      body:'rezerwacja_id='+encodeURIComponent(rezerwacjaId)
    });
    setSig('host announced');
    updateStore();
  }catch(e){}
}

/* ====== Init ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  initTimer(); uiRefresh(); populateOutputs();
  $('#autoplay-btn')?.addEventListener('click', ensureAudio);

  $('#presence-pill')?.addEventListener('click', ()=>{ /* no-op */ });

  setInterval(pingPresence, 10_000);
  setInterval(checkPresence, 10_000);
  setInterval(updateStore, 2_000);
  setVolume($('#vol').value);

  startRingWatcherForStudent();

  $('#accept')?.addEventListener('click', ()=>{ if(incomingOffer && !joined && !connecting){ joinMeeting(); } });
  $('#decline')?.addEventListener('click', ()=>{
    const inc = $('#incoming'); inc.classList.remove('show'); inc.style.display='none'; incomingOffer=false;
  });
});

/* ====== Timer ====== */
function initTimer(){
  const el=$('#timer'); const start=new Date("{{ rezerwacja.termin|date:'Y-m-d H:i:s' }}").getTime();
  const end=start+55*60*1000;
  const tick=()=>{ const d=end-Date.now(); if(d<=0){ el.textContent='Zakończone'; return; }
    const m=Math.floor(d/60000), s=Math.floor((d%60000)/1000); el.textContent=`${m}:${String(s).padStart(2,'0')}`; };
  tick(); setInterval(tick,1000);
}
</script>
</body>
</html>
