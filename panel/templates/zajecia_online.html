<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>ZajÄ™cia online â€” audio (mic select + bi-VU)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#007bff; --ok:#28a745; --warn:#ffb300; --danger:#dc3545; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:#f4f4f4; }
    header { background: var(--primary); color:#fff; padding:10px 14px; display:flex; align-items:center; gap:14px; flex-wrap:wrap; }
    .title { font-weight:700; font-size:18px; flex:1 1 auto; }
    .pill { background:#fff; color:#000; padding:8px 10px; border-radius:8px; border:1px solid #ddd; display:flex; align-items:center; gap:8px; font-weight:600; }
    .pill.disabled { opacity:.5; pointer-events:none; }
    .status-dot { width:14px; height:14px; border-radius:50%; display:inline-block; vertical-align:middle; }
    .status--on { background:#39d158; } .status--off { background:#b1b1b1; }
    .countdown { font-weight:700; } .countdown.red { color:#ffeb3b; }
    main { padding:24px 16px; display:flex; flex-direction:column; align-items:center; gap:18px; }
    .btn-tablica { padding:14px 24px; font-size:18px; background:var(--ok); color:#fff; border:none; border-radius:10px; text-decoration:none; display:inline-block; }
    .hint { max-width:900px; background:#fff; border:1px dashed #cfd6e4; padding:12px 14px; border-radius:8px; color:#2a2f3a; }
    input[type="range"] { width:200px; }
    select { padding:6px 8px; border-radius:8px; border:1px solid #ddd; }
    #remote-audio { width:0; height:0; opacity:0; pointer-events:none; }
    #autoplay-banner { display:none; align-items:center; gap:10px; background:#fff3cd; border:1px solid #ffe08a; color:#663c00; padding:10px 12px; border-radius:8px; }
    #autoplay-banner button { border:0; border-radius:8px; padding:8px 10px; cursor:pointer; background:var(--warn); color:#000; font-weight:700; }
    .vu { width:120px;height:10px;background:#eee;border-radius:6px;overflow:hidden;display:inline-block;vertical-align:middle }
    .vu > span { display:block;height:100%;width:0;background:#28a745;transition:width .08s linear }
    .btn-danger { background:#fff; border-color:#f1b6b6; color:#b30000; }
    small { font-weight:600; }
  </style>
</head>
<body>

<header>
  <div class="title">ZajÄ™cia online â€” audio</div>

  <button class="pill" id="presence-pill" type="button" title="Kliknij, aby sprÃ³bowaÄ‡ poÅ‚Ä…czyÄ‡">
    <span id="presence-dot" class="status-dot status--off"></span>
    <span id="presence-text">NiedostÄ™pny</span>
  </button>

  <div class="pill"><span>ğŸ‘¥</span><span id="participants-count">1</span></div>

  <button class="pill disabled" id="mic-toggle" type="button" onclick="toggleMic()">
    <span id="mic-icon">ğŸ”‡</span>
    <span id="mic-label">Wycisz mikrofon</span>
  </button>

  <div class="pill">
    <span>ğŸ”ˆ</span>
    <input id="vol" type="range" min="0" max="100" value="100" oninput="setVolume(this.value)">
    <span id="vol-val">100%</span>
  </div>

  <div class="pill"><span>â±</span><span id="countdown" class="countdown">PozostaÅ‚o: --:--</span></div>

  <div class="pill" id="output-pill">
    ğŸ”Š WyjÅ›cie:
    <select id="audio-output" onchange="changeOutput(this.value)"><option>Åadowanie...</option></select>
  </div>

  <div class="pill">
    ğŸ¤ MÃ³j mikrofon:
    <select id="mic-input"><option>Wczytywanieâ€¦</option></select>
    <div class="vu" title="Poziom mojego mikrofonu"><span id="vu-local"></span></div>
  </div>

  <div class="pill">ğŸ“¶ WejÅ›cie (od rozmÃ³wcy): <div class="vu"><span id="vu-remote"></span></div></div>

  <div class="pill">ğŸ§Š ICE: <small id="ice-state">init</small> <small id="ice-path" style="opacity:.8"></small></div>
  <div class="pill">ğŸ” Signaling: <small id="sig-state">init</small></div>

  <button class="pill" type="button" onclick="playSpeakerTest()">ğŸ”‰ Test gÅ‚oÅ›nika</button>

  {% if is_teacher %}
    <button class="pill" id="announce-host" type="button" onclick="announceHost()">ğŸ“£ OgÅ‚oÅ›: jestem gospodarzem</button>
    <button class="pill" id="host-connect" type="button" onclick="startHost()">ğŸ”— PoÅ‚Ä…cz (gospodarz)</button>
  {% else %}
    <span class="pill" id="waiting-host" style="display:none;">â³ Czekamy na gospodarzaâ€¦</span>
    <button class="pill" id="student-connect" type="button" onclick="joinMeeting()">ğŸ”— PoÅ‚Ä…cz (uczeÅ„)</button>
  {% endif %}
  <button class="pill btn-danger" id="disconnect-btn" type="button" onclick="stopPeer()" style="display:none;">ğŸ”Œ RozÅ‚Ä…cz</button>
</header>

<main>
  <a class="btn-tablica" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">âœï¸ OtwÃ³rz tablicÄ™</a>

  {% if is_teacher %}
  <form method="POST" style="display:flex; gap:8px; flex-wrap:wrap;">
    {% csrf_token %}
    <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required
           style="min-width:280px; width:420px; max-width:100%; padding:10px 12px; border-radius:8px; border:1px solid #cfd6e4;">
    <button type="submit" class="pill">ğŸ’¾ Zapisz link</button>
  </form>
  {% endif %}

  <div id="autoplay-banner">ğŸ”‡ PrzeglÄ…darka zablokowaÅ‚a dÅºwiÄ™k. Kliknij: <button type="button" id="autoplay-btn">WÅ‚Ä…cz audio</button></div>

  <div class="hint">
    ğŸ“± Mobile wymaga <b>HTTPS</b>. JeÅ›li sÄ… trudne sieci/NAT â€” uzupeÅ‚nij <b>TURN</b> (poniÅ¼ej w JS) i ewentualnie wÅ‚Ä…cz tryb <i>relay</i> do testu.
  </div>
</main>

<audio id="remote-audio" autoplay playsinline></audio>

<script>
  // ===== Kontekst =====
  const rezerwacjaId = "{{ rezerwacja.id }}";
  const csrfToken    = "{{ csrf_token }}";
  const IS_TEACHER   = {% if is_teacher %}true{% else %}false{% endif %};

  // Absolutne URL-e
  const OFFER_URL  = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_offer' rez_id=rezerwacja.id %}";
  const ANSWER_URL = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_answer' rez_id=rezerwacja.id %}";

  // ===== TURN (opcjonalnie) =====
  const TURN_HOST = "twoj.turn.host";       // np. turn.twojadomena.pl
  const TURN_USER = "webrtc";
  const TURN_PASS = "webrtc123";
  const FORCE_RELAY = false;

  // ===== RTC config =====
  const rtcConfig = {
    iceServers: [
      { urls: ["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"] },
      // { urls:[`turn:${TURN_HOST}:3478?transport=udp`,`turn:${TURN_HOST}:3478?transport=tcp`], username: TURN_USER, credential: TURN_PASS }
    ],
    iceTransportPolicy: FORCE_RELAY ? "relay" : "all",
    bundlePolicy: "max-bundle"
  };

  // ===== Stan =====
  let pc=null, localStream=null, remoteStream=null, audioTransceiver=null;
  let joined=false, remoteConnected=false, otherOnline=false, isMuted=false, hostAnnounced=false;
  let connecting=false, autoHostTried=false, autoStudentTried=false;

  // Audio / VU
  let audioCtx=null, analyserIn=null, analyserRx=null, srcIn=null, srcRx=null, vuTimerIn=null, vuTimerRx=null;
  let inboundVUtimer=null, inboundReceiver=null, outboundStatTimer=null, outboundSender=null;

  // Helpers
  const supportsSinkId=('setSinkId' in HTMLMediaElement.prototype);
  const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
  const setSig = (m)=>{ console.log("[SIG]", m); const el=document.getElementById('sig-state'); if(el) el.textContent=m; };
  const setIce = (m)=>{ const el=document.getElementById('ice-state'); if(el) el.textContent=m; };
  const setIcePath=(m)=>{ const el=document.getElementById('ice-path'); if(el) el.textContent=m; };

  async function postJSON(url,data,label="POST"){
    const r=await fetch(url,{ method:"POST", headers:{"Content-Type":"application/json","X-CSRFToken":csrfToken}, body:JSON.stringify(data), cache:"no-store", credentials:"same-origin" });
    if(!r.ok){ throw new Error(`${label} ${url} -> ${r.status} ${await r.text()}`); }
    try { return await r.json(); } catch { return {ok:true}; }
  }
  async function getJSON(url,label="GET"){
    const r=await fetch(url,{cache:"no-store",credentials:"same-origin"});
    if(r.status===404) return null;
    if(!r.ok){ throw new Error(`${label} ${url} -> ${r.status} ${await r.text()}`); }
    try { return await r.json(); } catch { return null; }
  }

  // ===== UI =====
  function refreshUI(){
    const micBtn=document.getElementById('mic-toggle');
    if(localStream) micBtn.classList.remove('disabled'); else micBtn.classList.add('disabled');

    const announceBtn = document.getElementById('announce-host');
    const hostBtn     = document.getElementById('host-connect');
    const studentBtn  = document.getElementById('student-connect');
    const waitHost    = document.getElementById('waiting-host');
    const disconnect  = document.getElementById('disconnect-btn');

    if(waitHost) waitHost.style.display = (hostAnnounced || otherOnline) ? 'none' : 'inline-flex';

    if(joined){
      announceBtn && (announceBtn.style.display='none');
      hostBtn     && (hostBtn.style.display='none');
      studentBtn  && (studentBtn.style.display='none');
      disconnect  && (disconnect.style.display='inline-flex');
    }else{
      disconnect  && (disconnect.style.display='none');
      announceBtn && (announceBtn.style.display= IS_TEACHER ? 'inline-flex' : 'none');
      hostBtn     && (hostBtn.style.display    = IS_TEACHER ? 'inline-flex' : 'none');
      studentBtn  && (studentBtn.style.display = !IS_TEACHER ? 'inline-flex' : 'none');
    }

    const me=1, withRemote=remoteConnected?2:me, count=otherOnline?Math.max(2,withRemote):withRemote;
    const pcnt=document.getElementById('participants-count'); pcnt && (pcnt.textContent=count);
  }

  function toggleMic(){
    if(!localStream) return;
    const t=localStream.getAudioTracks()[0]; if(!t) return;
    t.enabled=!t.enabled; isMuted=!t.enabled;
    document.getElementById('mic-icon').textContent=isMuted?'ğŸ™ï¸':'ğŸ”‡';
    document.getElementById('mic-label').textContent=isMuted?'WÅ‚Ä…cz mikrofon':'Wycisz mikrofon';
  }
  function setVolume(v){
    document.getElementById('vol-val').textContent=v+'%';
    const el=document.getElementById('remote-audio');
    el.volume=Math.max(0,Math.min(1,Number(v)/100));
  }
  async function populateOutputs(){
    const pill=document.getElementById('output-pill'); const sel=document.getElementById('audio-output');
    if(!supportsSinkId){ pill.style.display='none'; return; }
    try{
      const devs=await navigator.mediaDevices.enumerateDevices();
      const outs=devs.filter(d=>d.kind==='audiooutput'); sel.innerHTML='';
      if(!outs.length){ const opt=document.createElement('option'); opt.textContent='DomyÅ›lne'; opt.value=''; sel.appendChild(opt); return; }
      outs.forEach(d=>{ const opt=document.createElement('option'); opt.value=d.deviceId; opt.textContent=d.label||d.deviceId; sel.appendChild(opt); });
    }catch(e){ pill.style.display='none'; }
  }

  // ===== Audio unlock / test =====
  async function ensureAudio(){
    try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state!=='running') await audioCtx.resume(); }catch(e){}
    try{ const el=document.getElementById('remote-audio'); await el.play(); document.getElementById('autoplay-banner').style.display='none'; }
    catch(e){ document.getElementById('autoplay-banner').style.display='flex'; }
  }
  function playSpeakerTest(){
    try{
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      g.gain.value=0.08; o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(audioCtx.destination);
      o.start(); setTimeout(()=>{ try{o.stop();}catch(e){} }, 350);
      document.getElementById('autoplay-banner').style.display='none';
    }catch(e){}
  }

  // ===== VU helpers =====
  function startLocalVU(stream){
    try{
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      if(!analyserIn){ analyserIn=audioCtx.createAnalyser(); analyserIn.fftSize=256; }
      if(srcIn){ try{srcIn.disconnect();}catch(e){} srcIn=null; }
      srcIn=audioCtx.createMediaStreamSource(stream); srcIn.connect(analyserIn);
      const bar=document.getElementById('vu-local');
      if(vuTimerIn) cancelAnimationFrame(vuTimerIn);
      const data=new Uint8Array(analyserIn.frequencyBinCount);
      const tick=()=>{ analyserIn.getByteTimeDomainData(data);
        let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; }
        const rms=Math.sqrt(sum/data.length); bar.style.width=Math.min(100,Math.round(rms*200))+'%';
        vuTimerIn=requestAnimationFrame(tick);
      }; tick();
    }catch(e){}
  }
  function startRemoteVU(stream){
    try{
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      if(!analyserRx){ analyserRx=audioCtx.createAnalyser(); analyserRx.fftSize=256; }
      if(srcRx){ try{srcRx.disconnect();}catch(e){} srcRx=null; }
      srcRx=audioCtx.createMediaStreamSource(stream); srcRx.connect(analyserRx);
      const bar=document.getElementById('vu-remote');
      if(vuTimerRx) cancelAnimationFrame(vuTimerRx);
      const data=new Uint8Array(analyserRx.frequencyBinCount);
      const tick=()=>{ analyserRx.getByteTimeDomainData(data);
        let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; }
        const rms=Math.sqrt(sum/data.length); bar.style.width=Math.min(100,Math.round(rms*200))+'%';
        vuTimerRx=requestAnimationFrame(tick);
      }; tick();
    }catch(e){}
  }
  function startInboundStatsVU(){
    if(!pc) return;
    const bar=document.getElementById('vu-remote');
    const poll=async ()=>{
      try{
        const receivers=pc.getReceivers().filter(r=>r.track&&r.track.kind==='audio');
        if(!receivers.length){ bar.style.width='0%'; inboundReceiver=null; return schedule(); }
        const rcv=inboundReceiver||receivers[0]; inboundReceiver=rcv;
        const stats=await rcv.getStats();
        stats.forEach(s=>{
          if(s.type==='inbound-rtp' && s.kind==='audio' && typeof s.audioLevel==='number'){
            bar.style.width=Math.min(100,Math.round(s.audioLevel*200))+'%';
          }
        });
      }catch(e){}
      schedule();
    };
    const schedule=()=>{ inboundVUtimer=setTimeout(poll,250); };
    if(inboundVUtimer) clearTimeout(inboundVUtimer);
    schedule();
  }
  function startOutboundStatsVU(){
    if(!pc) return;
    const bar=document.getElementById('vu-local');
    const poll=async ()=>{
      try{
        const senders=pc.getSenders().filter(s=>s.track && s.track.kind==='audio');
        const snd=senders[0]; outboundSender=snd;
        if(!snd){ bar.style.width='0%'; return schedule(); }
        const stats=await snd.getStats();
        stats.forEach(s=>{
          if(s.type==='outbound-rtp' && s.kind==='audio' && typeof s.audioLevel==='number'){
            bar.style.width=Math.min(100,Math.round(s.audioLevel*200))+'%';
          }
        });
      }catch(e){}
      schedule();
    };
    const schedule=()=>{ outboundStatTimer=setTimeout(poll,250); };
    if(outboundStatTimer) clearTimeout(outboundStatTimer);
    schedule();
  }

  // ===== WebRTC core =====
  function attachRemoteAudio(){
    document.getElementById('remote-audio').srcObject=null;
    ensureAudio();
  }
  function setupPeerBase(){
    pc=new RTCPeerConnection(rtcConfig);
    audioTransceiver=pc.addTransceiver('audio',{direction:'sendrecv'});
    setSig('pc:new'); updateIceNow();

    pc.onicegatheringstatechange = updateIceNow;
    pc.oniceconnectionstatechange = ()=>{ updateIceNow(); updateIcePathNow(); };
    pc.onconnectionstatechange = ()=>{ if(['disconnected','failed','closed'].includes(pc.connectionState)){ remoteConnected=false; refreshUI(); } };
    pc.ontrack=(ev)=>{
      const el=document.getElementById('remote-audio');
      const stream = ev.streams && ev.streams[0] ? ev.streams[0] : (remoteStream ||= new MediaStream(), remoteStream.addTrack(ev.track), remoteStream);
      if(el.srcObject!==stream) el.srcObject=stream;
      startRemoteVU(stream);
      ev.track.onunmute=()=>ensureAudio();
      ensureAudio();
      remoteConnected=true; refreshUI();
      startInboundStatsVU();
    };
  }

  async function ensureLocalMic(deviceId){
    // zawsze prosimy o mikrofon PRZED tworzeniem SDP (klik uÅ¼ytkownika)
    const constraints = { audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true, channelCount:1, sampleRate:48000 } };
    if(deviceId) constraints.audio.deviceId = { exact: deviceId };

    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    if(localStream){ try{ localStream.getTracks().forEach(t=>t.stop()); }catch(e){} }
    localStream = stream;

    // podmieÅ„ w transceiverze
    const track = localStream.getAudioTracks()[0];
    if(audioTransceiver && audioTransceiver.sender){
      await audioTransceiver.sender.replaceTrack(track);
      audioTransceiver.direction='sendrecv';
    }

    // wÅ‚Ä…cz/odÅ›wieÅ¼ VU lokalne
    startLocalVU(localStream);
    document.getElementById('mic-toggle').classList.remove('disabled');

    // odczytaj listÄ™ mikrofonÃ³w (etykiety pojawiÄ… siÄ™ dopiero po zgodzie uÅ¼ytkownika)
    populateMicInputs(track.getSettings()?.deviceId);
  }

  async function populateMicInputs(selectedId){
    try{
      const sel = document.getElementById('mic-input');
      const devs = await navigator.mediaDevices.enumerateDevices();
      const ins = devs.filter(d=>d.kind==='audioinput');
      sel.innerHTML='';
      if(!ins.length){
        const opt = document.createElement('option'); opt.textContent='Brak mikrofonu'; opt.value=''; sel.appendChild(opt);
      }else{
        ins.forEach(d=>{
          const opt=document.createElement('option');
          opt.value=d.deviceId; opt.textContent=d.label || d.deviceId;
          if(selectedId && d.deviceId===selectedId) opt.selected=true;
          sel.appendChild(opt);
        });
      }
    }catch(e){}
  }

  async function switchMic(deviceId){
    try{
      await ensureLocalMic(deviceId);
      // jeÅ›li jesteÅ›my poÅ‚Ä…czeni â€” nic wiÄ™cej nie trzeba, replaceTrack juÅ¼ wysÅ‚aÅ‚ nowy tor
    }catch(err){
      alert('Nie udaÅ‚o siÄ™ przeÅ‚Ä…czyÄ‡ mikrofonu: '+err);
    }
  }

  function waitIceComplete(){
    if(!pc) return Promise.resolve();
    if(pc.iceGatheringState==='complete') return Promise.resolve();
    return new Promise(res=>{
      const f=()=>{ if(pc.iceGatheringState==='complete'){ pc.removeEventListener('icegatheringstatechange', f); res(); } };
      pc.addEventListener('icegatheringstatechange', f);
    });
  }
  function teardown(){
    try{ pc&&pc.close(); }catch(e){} pc=null;
    audioTransceiver=null;
    try{ localStream&&localStream.getTracks().forEach(t=>t.stop()); }catch(e){}
    localStream=null; remoteStream=null; isMuted=false;
    document.getElementById('mic-icon').textContent='ğŸ”‡';
    document.getElementById('mic-label').textContent='Wycisz mikrofon';
    document.getElementById('vu-local').style.width='0%';
    document.getElementById('vu-remote').style.width='0%';
    remoteConnected=false; joined=false; connecting=false;
    if(vuTimerIn) cancelAnimationFrame(vuTimerIn);
    if(vuTimerRx) cancelAnimationFrame(vuTimerRx);
    if(inboundVUtimer) clearTimeout(inboundVUtimer);
    if(outboundStatTimer) clearTimeout(outboundStatTimer);
    setIce('init'); setIcePath(''); setSig('init');
    refreshUI();
  }

  // ===== â€OgÅ‚oÅ›: jestem gospodarzemâ€ =====
  function announceHost(){ hostAnnounced = true; refreshUI(); }

  // ===== Host: PoÅ‚Ä…cz =====
  async function startHost(){
    if(joined || connecting) return; connecting=true;
    const btn=document.getElementById('host-connect');
    btn.textContent='ÅÄ…czenieâ€¦'; btn.classList.add('disabled');

    try{
      attachRemoteAudio(); setupPeerBase();

      // 1) Mikrofon NAJPIERW
      await ensureLocalMic();

      // 2) Offer
      setSig('creating-offer');
      const offer=await pc.createOffer();
      await pc.setLocalDescription(offer);
      await waitIceComplete();

      setSig('posting-offer');
      await postJSON(OFFER_URL, { type:pc.localDescription.type, sdp:pc.localDescription.sdp }, 'offer-post');

      // 3) sesja aktywna
      joined=true; refreshUI(); await populateOutputs(); startOutboundStatsVU();

      // 4) czekaj na answer
      setSig('waiting-answer');
      for(let i=0;i<120 && pc;i++){
        const ans=await getJSON(ANSWER_URL,'answer-get');
        if(ans && ans.type==='answer' && ans.sdp){
          await pc.setRemoteDescription(new RTCSessionDescription(ans));
          setSig('answer-set'); break;
        }
        await sleep(1000);
      }
    } catch(err){
      setSig('ERROR: '+String(err).slice(0,150));
      alert('Host error: '+err);
      teardown();
    } finally {
      btn.textContent='ğŸ”— PoÅ‚Ä…cz (gospodarz)'; btn.classList.remove('disabled');
      connecting=false; updateIceNow(); updateIcePathNow();
    }
  }

  // ===== Student: PoÅ‚Ä…cz =====
  async function joinMeeting(){
    if(joined || connecting) return; connecting=true;
    const btn=document.getElementById('student-connect');
    const waitEl=document.getElementById('waiting-host');
    btn.textContent='ÅÄ…czenieâ€¦'; btn.classList.add('disabled');

    try{
      attachRemoteAudio(); setupPeerBase(); await ensureAudio();

      // 1) Mikrofon NAJPIERW
      await ensureLocalMic();

      // 2) Pobierz i ustaw OFFER
      setSig('fetch-offer'); waitEl && (waitEl.style.display='inline-flex');
      let offer=null;
      for(let i=0;i<120;i++){
        offer=await getJSON(OFFER_URL,'offer-get');
        if(offer && offer.type==='offer' && offer.sdp){ setSig('got-offer'); break; }
        await sleep(1000);
      }
      waitEl && (waitEl.style.display='none');
      if(!offer){ setSig('no-offer'); alert('Brak gospodarza (offer).'); return; }

      await pc.setRemoteDescription(new RTCSessionDescription(offer));

      // 3) Odpowiedz
      setSig('creating-answer');
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await waitIceComplete();

      setSig('posting-answer');
      await postJSON(ANSWER_URL, { type:pc.localDescription.type, sdp:pc.localDescription.sdp }, 'answer-post');
      setSig('answer-posted');

      // 4) sesja aktywna
      joined=true; refreshUI(); await populateOutputs(); startOutboundStatsVU();

    } catch(err){
      setSig('ERROR: '+String(err).slice(0,150));
      alert('Join error: '+err);
      teardown();
    } finally {
      btn.textContent='ğŸ”— PoÅ‚Ä…cz (uczeÅ„)'; btn.classList.remove('disabled');
      connecting=false; updateIceNow(); updateIcePathNow();
    }
  }

  function stopPeer(){ teardown(); }

  // ===== AUTO-CONNECT po â€DostÄ™pnyâ€ =====
  function maybeAutoConnect(){
    if(!otherOnline || joined || connecting) return;
    if(IS_TEACHER){ if(!autoHostTried){ autoHostTried=true; startHost(); } }
    else { if(!autoStudentTried){ autoStudentTried=true; joinMeeting(); } }
  }

  // ===== Presence =====
  function pingOnlineStatus(){
    fetch("{% url 'ping_online_status' %}", {
      method:"POST",
      headers:{ "X-CSRFToken": csrfToken, "Content-Type":"application/x-www-form-urlencoded" },
      body:"rezerwacja_id="+encodeURIComponent(rezerwacjaId)
    }).catch(()=>{});
  }
  function checkOtherUserStatus(){
    fetch(`/check-online-status/${rezerwacjaId}/`)
      .then(r=>r.ok?r.json():Promise.reject(r.status))
      .then(data=>{
        otherOnline=!!(data&&data.online);
        const dot=document.getElementById('presence-dot'), text=document.getElementById('presence-text');
        dot.classList.toggle('status--on', otherOnline);
        dot.classList.toggle('status--off', !otherOnline);
        text.textContent=otherOnline?"DostÄ™pny":"NiedostÄ™pny";
        refreshUI();
        maybeAutoConnect();
      })
      .catch(()=>{});
  }

  // ===== ICE debug =====
  function updateIceNow(){ setIce(pc ? (pc.iceConnectionState||'new') : 'init'); }
  async function updateIcePathNow(){
    if(!pc){ setIcePath(''); return; }
    let localType='?', remoteType='?', proto='?';
    try{
      const stats=await pc.getStats();
      stats.forEach(s=>{
        if(s.type==='transport' && s.selectedCandidatePairId){
          const pair=stats.get(s.selectedCandidatePairId);
          if(pair){
            const l=stats.get(pair.localCandidateId);
            const r=stats.get(pair.remoteCandidateId);
            if(l){ localType=`${l.candidateType}`; proto=l.protocol; }
            if(r){ remoteType=`${r.candidateType}`; }
          }
        }
      });
    }catch(e){}
    setIcePath(`(${localType}â†’${remoteType}, ${proto})`);
  }

  // ===== Timer & Init =====
  function initCountdown(){
    const el=document.getElementById('countdown');
    const start=new Date("{{ rezerwacja.termin|date:'Y-m-d H:i:s' }}").getTime();
    const end=start+55*60*1000;
    function tick(){
      const diff=end-Date.now();
      if(diff<=0){ el.textContent="ZakoÅ„czone"; el.classList.add('red'); return; }
      const m=Math.floor(diff/60000), s=Math.floor((diff%60000)/1000);
      el.textContent=`PozostaÅ‚o: ${m}:${String(s).padStart(2,'0')}`;
      el.classList.toggle('red', m<5);
    }
    tick(); setInterval(tick, 1000);
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    initCountdown(); refreshUI(); populateOutputs();

    // mik rozwinie siÄ™ po pierwszym ensureLocalMic (po zgodzie); dodaj handler zmiany
    document.getElementById('mic-input').addEventListener('change', (e)=>switchMic(e.target.value));

    pingOnlineStatus(); checkOtherUserStatus();
    setInterval(pingOnlineStatus,10_000);
    setInterval(checkOtherUserStatus,10_000);

    document.getElementById('autoplay-btn')?.addEventListener('click', ensureAudio);
    document.getElementById('presence-pill')?.addEventListener('click', maybeAutoConnect);

    console.log('OFFER_URL=', OFFER_URL);
    console.log('ANSWER_URL=', ANSWER_URL);
  });

  // ===== Eksport =====
  window.announceHost = announceHost;
  window.startHost    = startHost;
  window.joinMeeting  = joinMeeting;
  window.stopPeer     = stopPeer;
  window.toggleMic    = toggleMic;
  window.setVolume    = setVolume;
  window.changeOutput = async function(deviceId){
    const el=document.getElementById('remote-audio');
    if(!supportsSinkId) return;
    try{ await el.setSinkId(deviceId||''); }catch(e){}
    setVolume(document.getElementById('vol').value);
  };
  window.playSpeakerTest = playSpeakerTest;
</script>
</body>
</html>
