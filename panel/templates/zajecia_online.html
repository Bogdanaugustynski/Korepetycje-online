<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Zajęcia online (audio-only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f4f4f4; }
    header {
      background:#007bff; color:#fff; padding:10px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .header-left { font-weight:bold; }
    .header-right { display:flex; gap:14px; align-items:center; }
    .mic-button {
      cursor:pointer; background:#fff; color:#000; padding:6px 10px;
      border:1px solid #ccc; border-radius:6px;
    }
    .countdown { font-weight:bold; }
    .countdown.red { color:red; }
    .content { padding:16px; display:flex; flex-direction:column; align-items:center; gap:16px; }

    /* “Niewidzialny” Jitsi – 1px wysokości, żeby nie zabierał miejsca */
    #jitsi-audio {
      width:1px; height:1px; overflow:hidden; border:0; position:absolute; left:-9999px;
    }
    .btn-tablica {
      padding: 10px 18px; font-size:16px; background:#28a745; color:#fff;
      border:none; border-radius:8px; cursor:pointer; text-decoration:none;
    }
    .form-link { margin-top:6px; }
    .hint { font-size:14px; color:#555; }
  </style>
</head>
<body>
<header>
  <div class="header-left">Zajęcia online — tryb audio</div>
  <div class="header-right">
    <div id="online-status-icon">🔴 Niedostępny</div>
    <button class="mic-button" id="mic-toggle" type="button">🔇 Wycisz mikrofon</button>
    <div id="countdown" class="countdown">Pozostało: --:--</div>
  </div>
</header>

<div class="content">
  <a class="btn-tablica" target="_blank" href="{{ rezerwacja.excalidraw_link }}">🖊️ Otwórz tablicę</a>
  {% if is_teacher %}
  <form method="POST" class="form-link">
    {% csrf_token %}
    <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required />
    <button type="submit">Zapisz link</button>
  </form>
  {% endif %}

  <div class="hint" id="autoplay-hint" style="display:none;">
    ℹ️ Jeśli przeglądarka zablokowała automatyczny start audio, kliknij gdziekolwiek w stronę lub przycisk wyciszenia, aby połączyć dźwięk.
  </div>
</div>

<!-- NIEWIDZIALNY kontener Jitsi -->
<div id="jitsi-audio" aria-hidden="true"></div>

<script src="https://meet.jit.si/external_api.js"></script>
<script>
  const rezerwacjaId = "{{ rezerwacja.id }}";
  let api = null;
  let isMuted = false;
  let started = false;

  function startAudioOnlyJitsi() {
    if (started) return;
    started = true;

    const options = {
      roomName: "ZajeciaOnline_{{ rezerwacja.id }}",
      parentNode: document.getElementById("jitsi-audio"),
      width: "1px",
      height: "1px",

      // Minimalna konfiguracja, bez ekranu wstępnego, bez wideo, audio ON
      configOverwrite: {
        prejoinPageEnabled: false,
        startWithAudioMuted: false,
        startWithVideoMuted: true,
        startAudioOnly: true,
        disableDeepLinking: true,
        // poniższe pomagają ograniczyć UI/feature’y
        toolbarButtons: [],
        enableWelcomePage: false
      },

      // UI i tak ukryty, ale zostawiamy pusto na wszelki wypadek
      interfaceConfigOverwrite: {
        TOOLBAR_BUTTONS: []
      },

      userInfo: {
        displayName: "{{ request.user.get_full_name|default:request.user.username }}"
      },
    };

    api = new JitsiMeetExternalAPI("meet.jit.si", options);

    // atrybuty uprawnień dla iframe (mic/camera — choć video off)
    const iframe = api.getIFrame();
    iframe.setAttribute("allow", "microphone; camera; fullscreen; autoplay; clipboard-write; display-capture");
    iframe.setAttribute("allowfullscreen", "true");

    // Zsynchronizuj przycisk po zmianie mute w Jitsi (np. gdyby API samo zmieniło stan)
    api.addListener('audioMuteStatusChanged', (e) => {
      isMuted = e.muted;
      updateMicButton();
    });

    // Fallback gdy autoplay zablokowany (niektóre przeglądarki)
    api.addListener('audioAvailabilityChanged', (e) => {
      if (!e.available) {
        document.getElementById('autoplay-hint').style.display = 'block';
      }
    });
  }

  function updateMicButton() {
    const btn = document.getElementById("mic-toggle");
    btn.textContent = isMuted ? "🎙️ Włącz mikrofon" : "🔇 Wycisz mikrofon";
  }

  function toggleMic() {
    if (!api) return;
    api.executeCommand('toggleAudio');
    // isMuted zaktualizuje się w listenerze 'audioMuteStatusChanged'
  }

  // Ping/status drugiego użytkownika (jak miałeś)
  function pingOnlineStatus() {
    fetch("{% url 'ping_online_status' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: "rezerwacja_id=" + encodeURIComponent(rezerwacjaId)
    }).catch(()=>{});
  }

  function checkOtherUserStatus() {
    fetch(`/check-online-status/${rezerwacjaId}/`)
      .then(r => r.json())
      .then(data => {
        const icon = document.getElementById("online-status-icon");
        icon.textContent = data.online ? "🟢 Dostępny" : "🔴 Niedostępny";
      })
      .catch(()=>{});
  }

  // Odliczanie jak było
  function initCountdown() {
    const el = document.getElementById("countdown");
    const startTime = new Date("{{ rezerwacja.termin|date:'Y-m-d H:i:s' }}");
    const endTime = new Date(startTime.getTime() + 55 * 60 * 1000);
    function tick() {
      const now = new Date();
      const diff = endTime - now;
      if (diff <= 0) {
        el.textContent = "Zakończone";
        el.classList.add("red");
        return;
      }
      const m = Math.floor(diff / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      el.textContent = `Pozostało: ${m}:${s.toString().padStart(2,'0')}`;
      if (m < 5) el.classList.add("red"); else el.classList.remove("red");
    }
    tick();
    setInterval(tick, 1000);
  }

  // Auto-start po załadowaniu (może wyświetlić prompt o mikrofon)
  document.addEventListener("DOMContentLoaded", () => {
    startAudioOnlyJitsi();     // spróbuj od razu
    pingOnlineStatus();
    checkOtherUserStatus();
    initCountdown();
    setInterval(pingOnlineStatus, 10000);
    setInterval(checkOtherUserStatus, 10000);

    // fallback — klik w przycisk lub nagłówek „odblokuje” autoplay w razie potrzeby
    document.getElementById("mic-toggle").addEventListener("click", () => {
      if (!started) startAudioOnlyJitsi();
      toggleMic();
    });
    document.body.addEventListener("click", () => {
      if (!started) startAudioOnlyJitsi();
    }, { once: true });
  });
</script>
</body>
</html>
