<!DOCTYPE html>
<html lang="pl">
<head>
Â  <meta charset="UTF-8" />
Â  <title>ZajÄ™cia online â€” audio (auto-connect + renegocjacja)</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <style>
Â  Â  :root { --primary:#007bff; --ok:#28a745; --warn:#ffb300; --danger:#dc3545; }
Â  Â  * { box-sizing: border-box; }
Â  Â  body { margin:0; font-family: system-ui, Arial, sans-serif; background:#f4f4f4; }
Â  Â  header { background: var(--primary); color:#fff; padding:10px 14px; display:flex; align-items:center; gap:14px; flex-wrap:wrap; }
Â  Â  .title { font-weight:700; font-size:18px; flex:1 1 auto; }
Â  Â  .pill { background:#fff; color:#000; padding:8px 10px; border-radius:8px; border:1px solid #ddd; display:flex; align-items:center; gap:8px; font-weight:600; }
Â  Â  .pill.disabled { opacity:.5; pointer-events:none; }
Â  Â  .status-dot { width:14px; height:14px; border-radius:50%; display:inline-block; vertical-align:middle; }
Â  Â  .status--on { background:#39d158; } .status--off { background:#b1b1b1; }
Â  Â  .countdown { font-weight:700; } .countdown.red { color:#ffeb3b; }
Â  Â  main { padding:24px 16px; display:flex; flex-direction:column; align-items:center; gap:18px; }
Â  Â  .btn-tablica { padding:14px 24px; font-size:18px; background:var(--ok); color:#fff; border:none; border-radius:10px; text-decoration:none; display:inline-block; }
Â  Â  .hint { max-width:900px; background:#fff; border:1px dashed #cfd6e4; padding:12px 14px; border-radius:8px; color:#2a2f3a; }
Â  Â  input[type="range"] { width:200px; }
Â  Â  select { padding:6px 8px; border-radius:8px; border:1px solid #ddd; }
Â  Â  #remote-audio { width:0; height:0; opacity:0; pointer-events:none; }
Â  Â  #autoplay-banner { display:none; align-items:center; gap:10px; background:#fff3cd; border:1px solid #ffe08a; color:#663c00; padding:10px 12px; border-radius:8px; }
Â  Â  #autoplay-banner button { border:0; border-radius:8px; padding:8px 10px; cursor:pointer; background:var(--warn); color:#000; font-weight:700; }
Â  Â  #vu { width:120px;height:10px;background:#eee;border-radius:6px;overflow:hidden;display:inline-block;vertical-align:middle }
Â  Â  #vu > span { display:block;height:100%;width:0;background:#28a745;transition:width .08s linear }
Â  Â  .btn-danger { background:#fff; border-color:#f1b6b6; color:#b30000; }
Â  Â  small { font-weight:600; }
Â  </style>
</head>
<body>

<header>
Â  <div class="title">ZajÄ™cia online â€” audio</div>

Â  <button class="pill" id="presence-pill" type="button" title="Kliknij, aby sprÃ³bowaÄ‡ poÅ‚Ä…czyÄ‡">
Â  Â  <span id="presence-dot" class="status-dot status--off"></span>
Â  Â  <span id="presence-text">NiedostÄ™pny</span>
Â  </button>

Â  <div class="pill"><span>ğŸ‘¥</span><span id="participants-count">1</span></div>

Â  <button class="pill disabled" id="mic-toggle" type="button" onclick="toggleMic()">
Â  Â  <span id="mic-icon">ğŸ”‡</span>
Â  Â  <span id="mic-label">Wycisz mikrofon</span>
Â  </button>

Â  <div class="pill">
Â  Â  <span>ğŸ”ˆ</span>
Â  Â  <input id="vol" type="range" min="0" max="100" value="100" oninput="setVolume(this.value)">
Â  Â  <span id="vol-val">100%</span>
Â  </div>

Â  <div class="pill"><span>â±</span><span id="countdown" class="countdown">PozostaÅ‚o: --:--</span></div>

Â  <div class="pill" id="output-pill">
Â  Â  ğŸ”Š WyjÅ›cie: <select id="audio-output" onchange="changeOutput(this.value)"><option>Åadowanie...</option></select>
Â  </div>

Â  <div class="pill">ğŸ“¶ WejÅ›cie: <div id="vu"><span></span></div></div>

Â  <div class="pill">ğŸ§Š ICE: <small id="ice-state">init</small> <small id="ice-path" style="opacity:.8"></small></div>
Â  <div class="pill">ğŸ” Signaling: <small id="sig-state">init</small></div>
Â  <div class="pill">ğŸ—ƒï¸ Store: <small id="store-badge">offer: â€“ , answer: â€“</small></div>

Â  <button class="pill" type="button" onclick="playSpeakerTest()">ğŸ”‰ Test gÅ‚oÅ›nika</button>

Â  {% if is_teacher %}
Â  Â  <button class="pill" id="announce-host" type="button" onclick="announceHost()">ğŸ“£ OgÅ‚oÅ›: jestem gospodarzem</button>
Â  Â  <button class="pill" id="host-connect" type="button" onclick="startHost()">ğŸ”— PoÅ‚Ä…cz (gospodarz)</button>
Â  {% else %}
Â  Â  <span class="pill" id="waiting-host" style="display:none;">â³ Czekamy na gospodarzaâ€¦</span>
Â  Â  <button class="pill" id="student-connect" type="button" onclick="joinMeeting()">ğŸ”— PoÅ‚Ä…cz (uczeÅ„)</button>
Â  {% endif %}
Â  <button class="pill btn-danger" id="disconnect-btn" type="button" onclick="stopPeer()" style="display:none;">ğŸ”Œ RozÅ‚Ä…cz</button>
</header>

<main>
Â  <a class="btn-tablica" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">âœï¸ OtwÃ³rz tablicÄ™</a>

Â  {% if is_teacher %}
Â  <form method="POST" style="display:flex; gap:8px; flex-wrap:wrap;">
Â  Â  {% csrf_token %}
Â  Â  <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required
Â  Â  Â  Â  Â  Â style="min-width:280px; width:420px; max-width:100%; padding:10px 12px; border-radius:8px; border:1px solid #cfd6e4;">
Â  Â  <button type="submit" class="pill">ğŸ’¾ Zapisz link</button>
Â  </form>
Â  {% endif %}

Â  <div id="autoplay-banner">ğŸ”‡ PrzeglÄ…darka zablokowaÅ‚a dÅºwiÄ™k. Kliknij: <button type="button" id="autoplay-btn">WÅ‚Ä…cz audio</button></div>

Â  <div class="hint">
Â  Â  ğŸ“± Mobile wymaga <b>HTTPS</b>. JeÅ›li sÄ… trudne sieci/NAT â€” uzupeÅ‚nij <b>TURN</b> i/lub ustaw tryb <i>relay</i>.
Â  </div>
</main>

<audio id="remote-audio" autoplay playsinline></audio>

<script>
Â  // ===== Kontekst =====
Â  const rezerwacjaId = "{{ rezerwacja.id }}";
Â  const csrfToken Â  Â = "{{ csrf_token }}";
Â  const IS_TEACHER Â  = {% if is_teacher %}true{% else %}false{% endif %};
Â  const WHO Â  Â  Â  Â  Â = IS_TEACHER ? "teacher" : "student";

Â  // Absolutne URL-e
Â  const OFFER_URL Â = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_offer' rez_id=rezerwacja.id %}";
Â  const ANSWER_URL = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_answer' rez_id=rezerwacja.id %}";

Â  // ===== TURN (opcjonalnie) =====
Â  const TURN_HOST = "twoj.turn.host";
Â  const TURN_USER = "webrtc";
Â  const TURN_PASS = "webrtc123";
Â  const FORCE_RELAY = false;

Â  // ===== RTC config =====
Â  const rtcConfig = {
Â  Â  iceServers: [
Â  Â  Â  { urls: ["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"] },
Â  Â  Â  // { urls:[`turn:${TURN_HOST}:3478?transport=udp`,`turn:${TURN_HOST}:3478?transport=tcp`], username: TURN_USER, credential: TURN_PASS }
Â  Â  ],
Â  Â  iceTransportPolicy: FORCE_RELAY ? "relay" : "all",
Â  Â  bundlePolicy: "max-bundle"
Â  };

Â  // ===== Stan =====
Â  let pc=null, localStream=null, remoteStream=null, audioTransceiver=null;
Â  let joined=false, remoteConnected=false, otherOnline=false, isMuted=false, hostAnnounced=false;
Â  let connecting=false, autoHostTried=false, autoStudentTried=false;
Â  let gumInFlight=false;

Â  // Renegocjacja â€” Å›ledzenie
Â  let offerWatcherStarted=false;
Â  let lastLocalOfferSDP=null;
Â  let lastRemoteOfferSDP=null;
Â  let lastLocalAnswerSDP=null;

Â  // VU / audio unlock
Â  let audioCtx=null, analyser=null, vuSrc=null, vuTimer=null;
Â  let inboundVUtimer=null, inboundReceiver=null, lastBytes=0, lastTs=0;

Â  // Helpers
Â  const supportsSinkId=('setSinkId' in HTMLMediaElement.prototype);
Â  const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
Â  const setSig = (m)=>{ console.log("[SIG]", m); const el=document.getElementById('sig-state'); if(el) el.textContent=m; };
Â  const setIce = (m)=>{ const el=document.getElementById('ice-state'); if(el) el.textContent=m; };
Â  const setIcePath=(m)=>{ const el=document.getElementById('ice-path'); if(el) el.textContent=m; };

Â  async function postJSON(url,data,label="POST"){
Â  Â  const r=await fetch(url,{
Â  Â  Â  method:"POST",
Â  Â  Â  headers:{"Content-Type":"application/json","X-CSRFToken":csrfToken},
Â  Â  Â  body:JSON.stringify(data),
Â  Â  Â  cache:"no-store", credentials:"same-origin"
Â  Â  });
Â  Â  if(!r.ok){ throw new Error(`${label} ${url} -> ${r.status} ${await r.text()}`); }
Â  Â  try { return await r.json(); } catch { return {ok:true}; }
Â  }
Â  async function getJSON(url,label="GET"){
Â  Â  const r=await fetch(url,{cache:"no-store",credentials:"same-origin"});
Â  Â  if(r.status===404) return null;
Â  Â  if(!r.ok){ throw new Error(`${label} ${url} -> ${r.status} ${await r.text()}`); }
Â  Â  try { return await r.json(); } catch { return null; }
Â  }

Â  // ===== UI =====
Â  function refreshUI(){
Â  Â  const micBtn=document.getElementById('mic-toggle');
Â  Â  if(localStream) micBtn.classList.remove('disabled'); else micBtn.classList.add('disabled');

Â  Â  const announceBtn = document.getElementById('announce-host');
Â  Â  const hostBtn Â  Â  = document.getElementById('host-connect');
Â  Â  const studentBtn Â = document.getElementById('student-connect');
Â  Â  const waitHost Â  Â = document.getElementById('waiting-host');
Â  Â  const disconnect Â = document.getElementById('disconnect-btn');

Â  Â  if(waitHost) waitHost.style.display = (hostAnnounced || otherOnline) ? 'none' : 'inline-flex';

Â  Â  if(joined){
Â  Â  Â  announceBtn && (announceBtn.style.display='none');
Â  Â  Â  hostBtn Â  Â  && (hostBtn.style.display='none');
Â  Â  Â  studentBtn Â && (studentBtn.style.display='none');
Â  Â  Â  disconnect Â && (disconnect.style.display='inline-flex');
Â  Â  }else{
Â  Â  Â  disconnect Â && (disconnect.style.display='none');
Â  Â  Â  announceBtn && (announceBtn.style.display= IS_TEACHER ? 'inline-flex' : 'none');
Â  Â  Â  hostBtn Â  Â  && (hostBtn.style.display Â  Â = IS_TEACHER ? 'inline-flex' : 'none');
Â  Â  Â  studentBtn Â && (studentBtn.style.display = !IS_TEACHER ? 'inline-flex' : 'none');
Â  Â  }

Â  Â  const me=1, withRemote=remoteConnected?2:me, count=otherOnline?Math.max(2,withRemote):withRemote;
Â  Â  const pcnt=document.getElementById('participants-count'); pcnt && (pcnt.textContent=count);
Â  }

Â  function toggleMic(){
Â  Â  if(!localStream){ requestMicNow(); return; }
Â  Â  const t=localStream.getAudioTracks()[0]; if(!t) return;
Â  Â  t.enabled=!t.enabled; isMuted=!t.enabled;
Â  Â  document.getElementById('mic-icon').textContent=isMuted?'ğŸ™ï¸':'ğŸ”‡';
Â  Â  document.getElementById('mic-label').textContent=isMuted?'WÅ‚Ä…cz mikrofon':'Wycisz mikrofon';
Â  }

Â  function setVolume(v){
Â  Â  document.getElementById('vol-val').textContent=v+'%';
Â  Â  const el=document.getElementById('remote-audio');
Â  Â  el.volume=Math.max(0,Math.min(1,Number(v)/100));
Â  }
Â  async function populateOutputs(){
Â  Â  const pill=document.getElementById('output-pill'); const sel=document.getElementById('audio-output');
Â  Â  if(!supportsSinkId){ pill.style.display='none'; return; }
Â  Â  try{
Â  Â  Â  const devs=await navigator.mediaDevices.enumerateDevices();
Â  Â  Â  const outs=devs.filter(d=>d.kind==='audiooutput'); sel.innerHTML='';
Â  Â  Â  if(!outs.length){ const opt=document.createElement('option'); opt.textContent='DomyÅ›lne'; opt.value=''; sel.appendChild(opt); return; }
Â  Â  Â  outs.forEach(d=>{ const opt=document.createElement('option'); opt.value=d.deviceId; opt.textContent=d.label||d.deviceId; sel.appendChild(opt); });
Â  Â  }catch(e){ pill.style.display='none'; }
Â  }
Â  async function changeOutput(deviceId){
Â  Â  const el=document.getElementById('remote-audio');
Â  Â  if(!supportsSinkId) return;
Â  Â  try{ await el.setSinkId(deviceId||''); }catch(e){}
Â  Â  setVolume(document.getElementById('vol').value);
Â  }

Â  // ===== Audio unlock / test =====
Â  async function ensureAudio(){
Â  Â  try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state!=='running') await audioCtx.resume(); }catch(e){}
Â  Â  try{ const el=document.getElementById('remote-audio'); await el.play(); document.getElementById('autoplay-banner').style.display='none'; }
Â  Â  catch(e){ document.getElementById('autoplay-banner').style.display='flex'; }
Â  }
Â  function playSpeakerTest(){
Â  Â  try{
Â  Â  Â  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
Â  Â  Â  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
Â  Â  Â  g.gain.value=0.08; o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(audioCtx.destination);
Â  Â  Â  o.start(); setTimeout(()=>{ try{o.stop();}catch(e){} }, 350);
Â  Â  Â  document.getElementById('autoplay-banner').style.display='none';
Â  Â  }catch(e){}
Â  }

Â  // ===== VU (wejÅ›cie zdalne) =====
Â  function startAudioContextVU(stream){
Â  Â  try{
Â  Â  Â  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
Â  Â  Â  if(!analyser){ analyser=audioCtx.createAnalyser(); analyser.fftSize=256; }
Â  Â  Â  if(vuSrc){ try{vuSrc.disconnect();}catch(e){} vuSrc=null; }
Â  Â  Â  vuSrc=audioCtx.createMediaStreamSource(stream); vuSrc.connect(analyser);
Â  Â  Â  const bar=document.querySelector('#vu > span');
Â  Â  Â  if(vuTimer) cancelAnimationFrame(vuTimer);
Â  Â  Â  const data=new Uint8Array(analyser.frequencyBinCount);
Â  Â  Â  const tick=()=>{ analyser.getByteTimeDomainData(data);
Â  Â  Â  Â  let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; }
Â  Â  Â  Â  const rms=Math.sqrt(sum/data.length);
Â  Â  Â  Â  bar.style.width=Math.min(100,Math.round(rms*200))+'%';
Â  Â  Â  Â  vuTimer=requestAnimationFrame(tick);
Â  Â  Â  };
Â  Â  Â  tick();
Â  Â  }catch(e){}
Â  }
Â  function startInboundStatsVU(){
Â  Â  if(!pc) return;
Â  Â  const bar=document.querySelector('#vu > span');
Â  Â  const poll=async ()=>{
Â  Â  Â  try{
Â  Â  Â  Â  const receivers=pc.getReceivers().filter(r=>r.track&&r.track.kind==='audio');
Â  Â  Â  Â  if(!receivers.length){ bar.style.width='0%'; inboundReceiver=null; return schedule(); }
Â  Â  Â  Â  const rcv=inboundReceiver||receivers[0]; inboundReceiver=rcv;
Â  Â  Â  Â  const stats=await rcv.getStats();
Â  Â  Â  Â  let level=null, bytes=null, ts=null;
Â  Â  Â  Â  stats.forEach(s=>{
Â  Â  Â  Â  Â  if(s.type==='inbound-rtp' && s.kind==='audio'){
Â  Â  Â  Â  Â  Â  if(typeof s.audioLevel==='number') level=s.audioLevel;
Â  Â  Â  Â  Â  Â  bytes=s.bytesReceived; ts=s.timestamp;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  if(level!=null){
Â  Â  Â  Â  Â  bar.style.width=Math.min(100,Math.round(level*200))+'%';
Â  Â  Â  Â  }else if(bytes!=null){
Â  Â  Â  Â  Â  if(lastBytes && lastTs && ts>lastTs){
Â  Â  Â  Â  Â  Â  const bps=(bytes-lastBytes)*8/((ts-lastTs)/1000);
Â  Â  Â  Â  Â  Â  const norm=Math.max(0,Math.min(1,bps/64000));
Â  Â  Â  Â  Â  Â  bar.style.width=Math.round(norm*100)+'%';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  lastBytes=bytes; lastTs=ts;
Â  Â  Â  Â  }else{
Â  Â  Â  Â  Â  bar.style.width='0%';
Â  Â  Â  Â  }
Â  Â  Â  }catch(e){}
Â  Â  Â  schedule();
Â  Â  };
Â  Â  const schedule=()=>{ inboundVUtimer=setTimeout(poll,250); };
Â  Â  if(inboundVUtimer) clearTimeout(inboundVUtimer);
Â  Â  schedule();
Â  }

Â  // ===== ICE debug =====
Â  function updateIceNow(){ setIce(pc ? (pc.iceConnectionState||'new') : 'init'); }
Â  async function updateIcePathNow(){
Â  Â  if(!pc){ setIcePath(''); return; }
Â  Â  let localType='?', remoteType='?', proto='?';
Â  Â  try{
Â  Â  Â  const stats=await pc.getStats();
Â  Â  Â  stats.forEach(s=>{
Â  Â  Â  Â  if(s.type==='transport' && s.selectedCandidatePairId){
Â  Â  Â  Â  Â  const pair=stats.get(s.selectedCandidatePairId);
Â  Â  Â  Â  Â  if(pair){
Â  Â  Â  Â  Â  Â  const l=stats.get(pair.localCandidateId);
Â  Â  Â  Â  Â  Â  const r=stats.get(pair.remoteCandidateId);
Â  Â  Â  Â  Â  Â  if(l){ localType=`${l.candidateType}`; proto=l.protocol; }
Â  Â  Â  Â  Â  Â  if(r){ remoteType=`${r.candidateType}`; }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }catch(e){}
Â  Â  setIcePath(`(${localType}â†’${remoteType}, ${proto})`);
Â  }

Â  // ===== WebRTC core =====
Â  function attachRemoteAudio(){
Â  Â  document.getElementById('remote-audio').srcObject=null;
Â  Â  ensureAudio();
Â  }

Â  function setupPeerBase(){
Â  Â  pc=new RTCPeerConnection(rtcConfig);
Â  Â  audioTransceiver=pc.addTransceiver('audio',{direction:'sendrecv'});
Â  Â  setSig('pc:new'); updateIceNow();

Â  Â  pc.onicegatheringstatechange = updateIceNow;
Â  Â  pc.oniceconnectionstatechange = ()=>{ updateIceNow(); updateIcePathNow(); };
Â  Â  pc.onconnectionstatechange = ()=>{ if(['disconnected','failed','closed'].includes(pc.connectionState)){ remoteConnected=false; refreshUI(); } };
Â  Â  pc.ontrack=(ev)=>{
Â  Â  Â  const el=document.getElementById('remote-audio');
Â  Â  Â  if(ev.streams && ev.streams[0]){ if(el.srcObject!==ev.streams[0]) el.srcObject=ev.streams[0]; startAudioContextVU(ev.streams[0]); }
Â  Â  Â  else { if(!remoteStream) remoteStream=new MediaStream(); remoteStream.addTrack(ev.track); if(el.srcObject!==remoteStream) el.srcObject=remoteStream; startAudioContextVU(remoteStream); }
Â  Â  Â  ev.track.onunmute=()=>ensureAudio(); ensureAudio(); remoteConnected=true; refreshUI(); startInboundStatsVU();
Â  Â  };

Â  Â  // >>> RENEGOCJACJA: gdy dodamy/zmienimy Å›cieÅ¼kÄ™
Â  Â  pc.onnegotiationneeded = async () => {
Â  Â  Â  try{
Â  Â  Â  Â  if(!joined) return;
Â  Â  Â  Â  if(pc.signalingState !== 'stable') return;
Â  Â  Â  Â  setSig('re-negotiatingâ€¦');
Â  Â  Â  Â  const offer = await pc.createOffer();
Â  Â  Â  Â  await pc.setLocalDescription(offer);
Â  Â  Â  Â  await waitIceComplete();
Â  Â  Â  Â  await postJSON(OFFER_URL, { type: pc.localDescription.type, sdp: pc.localDescription.sdp, from: WHO }, 'renegotiation-offer');
Â  Â  Â  Â  lastLocalOfferSDP = pc.localDescription.sdp;
Â  Â  Â  Â  setSig('re-negotiation offer sent');
Â  Â  Â  }catch(e){
Â  Â  Â  Â  console.warn('Renegotiation failed:', e);
Â  Â  Â  }
Â  Â  };
Â  }

Â  // ğŸ”ˆ PoproÅ› o mikrofon w tle; replaceTrack nie zrywa sesji
Â  function requestMicNow(){
Â  Â  if(gumInFlight || localStream) return;
Â  Â  gumInFlight = true;
Â  Â  navigator.mediaDevices.getUserMedia({
Â  Â  Â  audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true, channelCount:1, sampleRate:48000 }
Â  Â  }).then(async (stream)=>{
Â  Â  Â  gumInFlight=false;
Â  Â  Â  localStream = stream;
Â  Â  Â  const track = localStream.getAudioTracks()[0];
Â  Â  Â  if(audioTransceiver && audioTransceiver.sender){
Â  Â  Â  Â  audioTransceiver.direction='sendrecv';
Â  Â  Â  Â  await audioTransceiver.sender.replaceTrack(track);
Â  Â  Â  Â  document.getElementById('mic-toggle').classList.remove('disabled');
Â  Â  Â  }
Â  Â  }).catch(()=>{ gumInFlight=false; });
Â  }

Â  function waitIceComplete(){
Â  Â  if(!pc) return Promise.resolve();
Â  Â  if(pc.iceGatheringState==='complete') return Promise.resolve();
Â  Â  return new Promise(res=>{
Â  Â  Â  const f=()=>{ if(pc.iceGatheringState==='complete'){ pc.removeEventListener('icegatheringstatechange', f); res(); } };
Â  Â  Â  pc.addEventListener('icegatheringstatechange', f);
Â  Â  });
Â  }

Â  function teardown(){
Â  Â  try{ pc&&pc.close(); }catch(e){} pc=null;
Â  Â  audioTransceiver=null;
Â  Â  try{ localStream&&localStream.getTracks().forEach(t=>t.stop()); }catch(e){}
Â  Â  localStream=null; remoteStream=null; isMuted=false; gumInFlight=false;
Â  Â  document.getElementById('mic-icon').textContent='ğŸ”‡';
Â  Â  document.getElementById('mic-label').textContent='Wycisz mikrofon';
Â  Â  remoteConnected=false; joined=false; connecting=false;
Â  Â  if(vuTimer) cancelAnimationFrame(vuTimer);
Â  Â  if(inboundVUtimer) clearTimeout(inboundVUtimer);
Â  Â  setIce('init'); setIcePath(''); setSig('init');
Â  Â  refreshUI();
Â  }

Â  // ===== Watcher: reaguj na nowe oferty (takÅ¼e renegocjacyjne) z drugiej strony =====
Â  async function watchRemoteOffersLoop(){
Â  Â  while(true){
Â  Â  Â  await sleep(1000);
Â  Â  Â  if(!pc) continue;
Â  Â  Â  try{
Â  Â  Â  Â  const off = await getJSON(OFFER_URL, 'offer-watch');
Â  Â  Â  Â  if(!off || off.type!=='offer' || !off.sdp) continue;

Â  Â  Â  Â  // Pomijamy naszÄ… wÅ‚asnÄ… Å›wieÅ¼o wysÅ‚anÄ… ofertÄ™
Â  Â  Â  Â  if(off.from && off.from === WHO) continue;

Â  Â  Â  Â  if(!lastRemoteOfferSDP || off.sdp !== lastRemoteOfferSDP){
Â  Â  Â  Â  Â  lastRemoteOfferSDP = off.sdp;
Â  Â  Â  Â  Â  setSig('remote-offer-received');
Â  Â  Â  Â  Â  await pc.setRemoteDescription(new RTCSessionDescription(off));
Â  Â  Â  Â  Â  const answer = await pc.createAnswer();
Â  Â  Â  Â  Â  await pc.setLocalDescription(answer);
Â  Â  Â  Â  Â  await waitIceComplete();
Â  Â  Â  Â  Â  await postJSON(ANSWER_URL, { type: pc.localDescription.type, sdp: pc.localDescription.sdp, to: off.from||null }, 'renegotiation-answer');
Â  Â  Â  Â  Â  lastLocalAnswerSDP = pc.localDescription.sdp;
Â  Â  Â  Â  Â  setSig('renegotiation-answer-sent');
Â  Â  Â  Â  }
Â  Â  Â  }catch(e){ /* no-op */ }
Â  Â  }
Â  }
Â  function startOfferWatcher(){
Â  Â  if(offerWatcherStarted) return;
Â  Â  offerWatcherStarted=true;
Â  Â  watchRemoteOffersLoop();
Â  }

Â  // ===== â€OgÅ‚oÅ›: jestem gospodarzemâ€ =====
Â  function announceHost(){ hostAnnounced = true; refreshUI(); }

Â  // ===== Host: PoÅ‚Ä…cz =====
Â  async function startHost(){
Â  Â  if(joined || connecting) return; connecting=true;
Â  Â  const btn=document.getElementById('host-connect');
Â  Â  btn.textContent='ÅÄ…czenieâ€¦'; btn.classList.add('disabled');

Â  Â  try{
Â  Â  Â  attachRemoteAudio(); setupPeerBase();

Â  Â  Â  setSig('creating-offer');
Â  Â  Â  const offer=await pc.createOffer();
Â  Â  Â  await pc.setLocalDescription(offer);
Â  Â  Â  await waitIceComplete();

Â  Â  Â  setSig('posting-offer');
Â  Â  Â  await postJSON(OFFER_URL, { type:pc.localDescription.type, sdp:pc.localDescription.sdp, from: WHO }, 'offer-post');
Â  Â  Â  lastLocalOfferSDP = pc.localDescription.sdp;

Â  Â  Â  joined=true; refreshUI(); await populateOutputs();
Â  Â  Â  requestMicNow();

Â  Â  Â  // >>> DODANE: Rozpocznij nasÅ‚uchiwanie na renegocjacje
Â  Â  Â  startOfferWatcher();

Â  Â  Â  setSig('waiting-answer');
Â  Â  Â  for(let i=0;i<120 && pc;i++){
Â  Â  Â  Â  const ans=await getJSON(ANSWER_URL,'answer-get');
Â  Â  Â  Â  if(ans && ans.type==='answer' && ans.sdp){
Â  Â  Â  Â  Â  await pc.setRemoteDescription(new RTCSessionDescription(ans));
Â  Â  Â  Â  Â  setSig('answer-set'); break;
Â  Â  Â  Â  }
Â  Â  Â  Â  await sleep(1000);
Â  Â  Â  }
Â  Â  } catch(err){
Â  Â  Â  setSig('ERROR: '+String(err).slice(0,150));
Â  Â  Â  alert('Host error: '+err);
Â  Â  Â  teardown();
Â  Â  } finally {
Â  Â  Â  btn.textContent='ğŸ”— PoÅ‚Ä…cz (gospodarz)'; btn.classList.remove('disabled');
Â  Â  Â  connecting=false; updateIceNow(); updateIcePathNow();
Â  Â  }
Â  }

Â  // ===== Student: PoÅ‚Ä…cz =====
Â  async function joinMeeting(){
Â  Â  if(joined || connecting) return; connecting=true;
Â  Â  const btn=document.getElementById('student-connect');
Â  Â  const waitEl=document.getElementById('waiting-host');
Â  Â  btn.textContent='ÅÄ…czenieâ€¦'; btn.classList.add('disabled');

Â  Â  try{
Â  Â  Â  attachRemoteAudio(); setupPeerBase(); ensureAudio(); requestMicNow();

Â  Â  Â  setSig('fetch-offer'); waitEl && (waitEl.style.display='inline-flex');
Â  Â  Â  let offer=null;
Â  Â  Â  for(let i=0;i<120;i++){
Â  Â  Â  Â  offer=await getJSON(OFFER_URL,'offer-get');
Â  Â  Â  Â  if(offer && offer.type==='offer' && offer.sdp){ setSig('got-offer'); break; }
Â  Â  Â  Â  await sleep(1000);
Â  Â  Â  }
Â  Â  Â  waitEl && (waitEl.style.display='none');
Â  Â  Â  if(!offer){ setSig('no-offer'); alert('Brak gospodarza (offer).'); return; }

Â  Â  Â  await pc.setRemoteDescription(new RTCSessionDescription(offer));

Â  Â  Â  setSig('creating-answer');
Â  Â  Â  const answer=await pc.createAnswer();
Â  Â  Â  await pc.setLocalDescription(answer);
Â  Â  Â  await waitIceComplete();

Â  Â  Â  setSig('posting-answer');
Â  Â  Â  await postJSON(ANSWER_URL, { type:pc.localDescription.type, sdp:pc.localDescription.sdp }, 'answer-post');

Â  Â  Â  joined=true; refreshUI(); await populateOutputs();
Â  Â  Â  startOfferWatcher();

Â  Â  } catch(err){
Â  Â  Â  setSig('ERROR: '+String(err).slice(0,150));
Â  Â  Â  alert('Join error: '+err);
Â  Â  Â  teardown();
Â  Â  } finally {
Â  Â  Â  btn.textContent='ğŸ”— PoÅ‚Ä…cz (uczeÅ„)'; btn.classList.remove('disabled');
Â  Â  Â  connecting=false; updateIceNow(); updateIcePathNow();
Â  Â  }
Â  }

Â  function stopPeer(){ teardown(); }

Â  // ===== AUTO-CONNECT po â€DostÄ™pnyâ€ =====
Â  function maybeAutoConnect(){
Â  Â  if(!otherOnline || joined || connecting) return;
Â  Â  if(IS_TEACHER){
Â  Â  Â  if(!autoHostTried){ autoHostTried=true; startHost(); }
Â  Â  }else{
Â  Â  Â  if(!autoStudentTried){ autoStudentTried=true; joinMeeting(); }
Â  Â  }
Â  }

Â  // ===== Presence =====
Â  function pingOnlineStatus(){
Â  Â  fetch("{% url 'ping_online_status' %}", {
Â  Â  Â  method:"POST",
Â  Â  Â  headers:{ "X-CSRFToken": csrfToken, "Content-Type":"application/x-www-form-urlencoded" },
Â  Â  Â  body:"rezerwacja_id="+encodeURIComponent(rezerwacjaId)
Â  Â  }).catch(()=>{});
Â  }
Â  function checkOtherUserStatus(){
Â  Â  fetch(`/check-online-status/${rezerwacjaId}/`)
Â  Â  Â  .then(r=>r.ok?r.json():Promise.reject(r.status))
Â  Â  Â  .then(data=>{
Â  Â  Â  Â  otherOnline=!!(data&&data.online);
Â  Â  Â  Â  const dot=document.getElementById('presence-dot'), text=document.getElementById('presence-text');
Â  Â  Â  Â  dot.classList.toggle('status--on', otherOnline);
Â  Â  Â  Â  dot.classList.toggle('status--off', !otherOnline);
Â  Â  Â  Â  text.textContent=otherOnline?"DostÄ™pny":"NiedostÄ™pny";
Â  Â  Â  Â  refreshUI();
Â  Â  Â  Â  maybeAutoConnect();
Â  Â  Â  })
Â  Â  Â  .catch(()=>{});
Â  }

Â  // ===== Store badge (diagnostyka) =====
Â  function updateStoreBadge(){
Â  Â  const el=document.getElementById('store-badge');
Â  Â  Promise.all([getJSON(OFFER_URL,'offer-get'), getJSON(ANSWER_URL,'answer-get')])
Â  Â  Â  .then(([off,ans])=>{
Â  Â  Â  Â  const o = off && off.sdp ? `âœ“(${off.sdp.length})` : 'â€“(0)';
Â  Â  Â  Â  const a = ans && ans.sdp ? `âœ“(${ans.sdp.length})` : 'â€“(0)';
Â  Â  Â  Â  el.textContent = `offer: ${o}, answer: ${a}`;
Â  Â  Â  })
Â  Â  Â  .catch(()=>{ el.textContent='offer: ?, answer: ?'; });
Â  }

Â  // ===== Timer & Init =====
Â  function initCountdown(){
Â  Â  const el=document.getElementById('countdown');
Â  Â  const start=new Date("{{ rezerwacja.termin|date:'Y-m-d H:i:s' }}").getTime();
Â  Â  const end=start+55*60*1000;
Â  Â  function tick(){
Â  Â  Â  const diff=end-Date.now();
Â  Â  Â  if(diff<=0){ el.textContent="ZakoÅ„czone"; el.classList.add('red'); return; }
Â  Â  Â  const m=Math.floor(diff/60000), s=Math.floor((diff%60000)/1000);
Â  Â  Â  el.textContent=`PozostaÅ‚o: ${m}:${String(s).padStart(2,'0')}`;
Â  Â  Â  el.classList.toggle('red', m<5);
Â  Â  }
Â  Â  tick(); setInterval(tick, 1000);
Â  }

Â  document.addEventListener('DOMContentLoaded', ()=>{
Â  Â  initCountdown(); refreshUI(); populateOutputs();

Â  Â  pingOnlineStatus(); checkOtherUserStatus(); updateStoreBadge();
Â  Â  setInterval(pingOnlineStatus,10_000);
Â  Â  setInterval(checkOtherUserStatus,10_000);
Â  Â  setInterval(updateStoreBadge,2_000);

Â  Â  document.getElementById('autoplay-btn')?.addEventListener('click', ensureAudio);
Â  Â  document.getElementById('presence-pill')?.addEventListener('click', maybeAutoConnect);

Â  Â  console.log('OFFER_URL=', OFFER_URL);
Â  Â  console.log('ANSWER_URL=', ANSWER_URL);
Â  });

Â  // ===== Eksport =====
Â  window.announceHost = announceHost;
Â  window.startHost Â  Â = startHost;
Â  window.joinMeeting Â = joinMeeting;
Â  window.stopPeer Â  Â  = stopPeer;
Â  window.toggleMic Â  Â = toggleMic;
Â  window.setVolume Â  Â = setVolume;
Â  window.changeOutput = changeOutput;
Â  window.playSpeakerTest = playSpeakerTest;
</script>
</body>
</html>