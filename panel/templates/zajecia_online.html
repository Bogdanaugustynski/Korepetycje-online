<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Zajęcia online — audio + tablica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#007bff; --ok:#28a745; --muted:#ccc; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:#f4f4f4; }
    header {
      background: var(--primary); color:#fff; padding:10px 14px;
      display:flex; align-items:center; gap:14px; flex-wrap:wrap;
    }
    .title { font-weight:700; font-size:18px; flex:1 1 auto; }
    .pill {
      background:#fff; color:#000; padding:8px 10px; border-radius:8px; border:1px solid #ddd;
      display:flex; align-items:center; gap:8px; font-weight:600;
    }
    .status-dot { width:14px; height:14px; border-radius:50%; display:inline-block; vertical-align:middle; }
    .status--on { background:#39d158; }
    .status--off { background:#b1b1b1; }
    .countdown { font-weight:700; }
    .countdown.red { color:#ffeb3b; }
    main { padding:24px 16px; display:flex; flex-direction:column; align-items:center; gap:18px; }
    .btn-tablica {
      padding:14px 24px; font-size:18px; background:var(--ok); color:#fff;
      border:none; border-radius:10px; text-decoration:none; display:inline-block;
    }
    .hint {
      max-width:900px; background:#fff; border:1px dashed #cfd6e4; padding:12px 14px; border-radius:8px; color:#2a2f3a;
    }

    /* UKRYTE okno Jitsi (zostawiamy element, ale go nie pokazujemy) */
    #jitsi-preview {
      width: 100%;
      height: 70vh;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
      display: none; /* <- ukryte */
    }
    /* techniczny kontener do renderu Jitsi w tle */
    #jitsi-hidden {
      position: fixed;
      left: -9999px; top: -9999px;
      width: 1px; height: 1px;
      opacity: 0; pointer-events: none;
    }

    .vol-wrap { display:flex; align-items:center; gap:10px; }
    input[type="range"] { width:200px; }
    select { padding:6px 8px; border-radius:8px; border:1px solid #ddd; }
  </style>
</head>
<body>

<header>
  <div class="title">Zajęcia online — audio</div>

  <!-- PRZYWRÓCONA KONTROLKA OBECNOŚCI -->
  <div class="pill" id="presence-pill">
    <span id="presence-dot" class="status-dot status--off"></span>
    <span id="presence-text">Niedostępny</span>
  </div>

  <div class="pill">
    <span>👥</span>
    <span id="participants-count">1</span>
  </div>

  <button class="pill" id="mic-toggle" type="button" onclick="toggleMic()">
    <span id="mic-icon">🔇</span>
    <span id="mic-label">Wycisz mikrofon</span>
  </button>

  <div class="pill vol-wrap">
    <span>🔈</span>
    <input id="vol" type="range" min="0" max="100" value="100" oninput="setVolume(this.value)">
    <span id="vol-val">100%</span>
  </div>

  <div class="pill">
    <span>⏱</span>
    <span id="countdown" class="countdown">Pozostało: --:--</span>
  </div>

  <div class="pill">
    🔊 Wyjście:
    <select id="audio-output" onchange="changeOutput(this.value)"><option>Ładowanie...</option></select>
  </div>

  <button class="pill" type="button" onclick="playSpeakerTest()">🔉 Test głośnika</button>
</header>

<main>
  <a class="btn-tablica" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">✏️ Otwórz tablicę</a>

  {% if is_teacher %}
  <form method="POST" style="display:flex; gap:8px; flex-wrap:wrap;">
    {% csrf_token %}
    <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required
           style="min-width:280px; width:420px; max-width:100%; padding:10px 12px; border-radius:8px; border:1px solid #cfd6e4;">
    <button type="submit" class="pill">💾 Zapisz link</button>
  </form>
  {% endif %}

  <!-- Zostawiamy, ale ukryte -->
  <div id="jitsi-preview"></div>

  <div class="hint">
    Jeśli dźwięk znika po sekundzie: często Windows przełącza słuchawki w tryb „Połączenie telefoniczne” (HFP) i zmienia urządzenie.
    Wybierz właściwe <b>Wyjście</b> z listy powyżej. W Windows → Dźwięk → <i>Komunikacja</i> ustaw „Nie rób nic”.
    Upewnij się, że karta przeglądarki nie jest wyciszona (prawy klik na zakładce → Włącz dźwięk).
  </div>
</main>

<!-- Kontener do Jitsi działającego w tle -->
<div id="jitsi-hidden"></div>

<script src="https://meet.jit.si/external_api.js"></script>
<script>
  const rezerwacjaId = "{{ rezerwacja.id }}";
  const csrfToken   = "{{ csrf_token }}";

  let api = null;
  let isMuted = false;

  // Licznik wg Jitsi i wg backendu presence
  let jitsiCount = 1;
  let otherOnline = false;

  // ——— Jitsi init (hidden) ———
  function startJitsi(parentNode) {
    if (api) { try { api.dispose(); } catch(e) {} api = null; }

    api = new JitsiMeetExternalAPI("meet.jit.si", {
      roomName: "ZajeciaAudio_{{ rezerwacja.id }}",
      parentNode,
      configOverwrite: {
        startWithVideoMuted: true,
        startWithAudioMuted: false,
        prejoinConfig: { enabled: false },   // bez prejoin/„gospodarza”
        disableDeepLinking: true,

        // stabilny tor audio
        p2p: { enabled: true },
        webrtcIceUdpDisable: false,
        webrtcIceTcpDisable: false,

        // audio sanity
        startSilent: false,
        disableAudioLevels: false,
        enableNoAudioDetection: true,
        enableNoisyMicDetection: true,
        constraints: {
          audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
        }
      },
      interfaceConfigOverwrite: {
        MOBILE_APP_PROMO: false,
        TOOLBAR_BUTTONS: [],                 // i tak hidden
        SHOW_JITSI_WATERMARK: false
      },
      userInfo: { displayName: "{{ request.user.get_full_name|default:request.user.username|default:'Gość' }}" }
    });

    api.addListener('audioMuteStatusChanged', ({ muted }) => {
      isMuted = muted; syncMicLabel();
    });
    api.addListener('participantJoined', refreshCount);
    api.addListener('participantLeft', refreshCount);
    api.addListener('videoConferenceJoined', () => {
      refreshCount();
      setVolume(100);
      populateOutputs();
    });
    api.addListener('devicesChanged', () => {
      populateOutputs(true);
    });
    api.addListener('audioAvailabilityChanged', ({ available }) => {
      if (available) { setTimeout(populateOutputs, 200); }
    });
  }

  function refreshCount() {
    try {
      api.getParticipantsInfo().then(list => {
        jitsiCount = Math.max(1, list.length);
        updateParticipantsBadge();
      });
    } catch(e) {}
  }

  // ——— Presence (backend) ———
  function pingOnlineStatus() {
    fetch("{% url 'ping_online_status' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: "rezerwacja_id=" + encodeURIComponent(rezerwacjaId)
    }).catch(()=>{});
  }

  function checkOtherUserStatus() {
    fetch(`/check-online-status/${rezerwacjaId}/`)
      .then(r => r.json())
      .then(data => {
        otherOnline = !!data.online;
        const dot = document.getElementById('presence-dot');
        const text = document.getElementById('presence-text');
        dot.classList.toggle('status--on', otherOnline);
        dot.classList.toggle('status--off', !otherOnline);
        text.textContent = otherOnline ? "Dostępny" : "Niedostępny";
        updateParticipantsBadge();
      })
      .catch(()=>{});
  }

  function updateParticipantsBadge() {
    // Jeśli druga osoba jest online wg backendu → pokaż min. 2
    const count = otherOnline ? Math.max(2, jitsiCount) : jitsiCount;
    document.getElementById('participants-count').textContent = count;
  }

  // ——— UI mic/vol ———
  function syncMicLabel() {
    document.getElementById('mic-icon').textContent = isMuted ? '🎙️' : '🔇';
    document.getElementById('mic-label').textContent = isMuted ? 'Włącz mikrofon' : 'Wycisz mikrofon';
  }

  function toggleMic() {
    if (!api) return;
    api.executeCommand('toggleAudio');
  }

  function setVolume(val) {
    document.getElementById('vol-val').textContent = val + '%';
    try { api && api.setAudioVolume(Number(val)); } catch(e) {}
  }

  // ——— WYJŚCIE audio (głośnik) ———
  async function populateOutputs(keepCurrent=false) {
    if (!api) return;
    try {
      const devs = await api.getAvailableDevices();
      const select = document.getElementById('audio-output');
      const current = select.value || '';
      select.innerHTML = '';

      const outs = devs.audioOutput || [];
      if (!outs.length) {
        const opt = document.createElement('option');
        opt.textContent = 'Brak wyboru (domyślne)';
        opt.value = '';
        select.appendChild(opt);
        return;
      }

      outs.sort((a,b) => (b.label.toLowerCase().includes('default')?1:0) - (a.label.toLowerCase().includes('default')?1:0));
      outs.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.deviceId;
        opt.textContent = o.label || o.deviceId;
        select.appendChild(opt);
      });

      let target = outs[0].deviceId;
      if (keepCurrent && outs.some(o => o.deviceId === current)) target = current;
      await changeOutput(target);
      select.value = target;
    } catch(e) {
      const select = document.getElementById('audio-output');
      select.innerHTML = '<option value="">Domyślne</option>';
    }
  }

  async function changeOutput(deviceId) {
    try { if (api && deviceId) await api.setAudioOutputDevice(deviceId); } catch(e) {}
    setTimeout(() => setVolume(document.getElementById('vol').value), 50);
  }

  // ——— Test głośnika ———
  function playSpeakerTest() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      g.gain.value = 0.03;
      o.type = 'sine'; o.frequency.value = 880;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(() => { try { o.stop(); ctx.close(); } catch(e) {} }, 400);
    } catch(e) {}
  }

  // ——— Odliczanie ———
  function initCountdown() {
    const el = document.getElementById('countdown');
    const start = new Date("{{ rezerwacja.termin|date:'Y-m-d H:i:s' }}").getTime();
    const end = start + 55 * 60 * 1000;
    function tick() {
      const diff = end - Date.now();
      if (diff <= 0) { el.textContent = "Zakończone"; el.classList.add('red'); return; }
      const m = Math.floor(diff/60000), s = Math.floor((diff%60000)/1000);
      el.textContent = `Pozostało: ${m}:${String(s).padStart(2,'0')}`;
      el.classList.toggle('red', m < 5);
    }
    tick(); setInterval(tick, 1000);
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Jitsi działa w tle (bez okienka)
    startJitsi(document.getElementById('jitsi-hidden'));
    initCountdown();

    // Presence online (backend)
    pingOnlineStatus();
    checkOtherUserStatus();
    setInterval(pingOnlineStatus, 10_000);
    setInterval(checkOtherUserStatus, 10_000);
  });
</script>
</body>
</html>
