<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>ZajÄ™cia online â€” audio + tablica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#007bff; --ok:#28a745; --muted:#ccc; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:#f4f4f4; }
    header {
      background: var(--primary); color:#fff; padding:10px 14px;
      display:flex; align-items:center; gap:14px; flex-wrap:wrap;
    }
    .title { font-weight:700; font-size:18px; flex: 1 1 auto; }
    .status-dot { width:14px; height:14px; border-radius:50%; display:inline-block; vertical-align:middle; margin-right:6px; background:#b1b1b1; }
    .status--on { background:#39d158; }
    .pill {
      background:#fff; color:#000; padding:8px 10px; border-radius:8px; border:1px solid #ddd;
      display:flex; align-items:center; gap:8px; font-weight:600;
    }
    .countdown { font-weight:700; }
    .countdown.red { color:#ffeb3b; }
    main { padding:24px 16px; display:flex; flex-direction:column; align-items:center; gap:18px; }
    .btn-tablica {
      padding:14px 24px; font-size:18px; background:var(--ok); color:#fff;
      border:none; border-radius:10px; text-decoration:none; display:inline-block;
    }
    .hint {
      max-width:850px; background:#fff; border:1px dashed #cfd6e4; padding:12px 14px; border-radius:8px; color:#2a2f3a;
    }
    #jitsi-container { position:fixed; inset:auto auto 0 0; width:1px; height:1px; opacity:0; pointer-events:none; }
    .vol-wrap { display:flex; align-items:center; gap:8px; min-width:200px; }
    .vol-range { width:120px; }
  </style>
</head>
<body>

<header>
  <div class="title">ZajÄ™cia online â€” tryb audio</div>

  <div class="pill" id="presence-pill">
    <span id="presence-dot" class="status-dot"></span>
    <span id="presence-text">NiedostÄ™pny</span>
  </div>

  <button class="pill" id="mic-toggle" type="button" onclick="toggleMic()">
    <span id="mic-icon">ğŸ”‡</span>
    <span id="mic-label">Wycisz mikrofon</span>
  </button>

  <div class="pill vol-wrap" title="GÅ‚oÅ›noÅ›Ä‡ odsÅ‚uchu">
    <span>ğŸ”Š</span>
    <input id="vol" class="vol-range" type="range" min="0" max="100" step="1" value="100" oninput="setOutputVolume(this.value)">
    <span id="vol-val">100%</span>
  </div>

  <div class="pill">
    <span>â±</span>
    <span id="countdown" class="countdown">PozostaÅ‚o: --:--</span>
  </div>
</header>

<main>
  <a class="btn-tablica" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">
    âœï¸ OtwÃ³rz tablicÄ™
  </a>

  {% if is_teacher %}
  <form method="POST" style="display:flex; gap:8px; flex-wrap:wrap;">
    {% csrf_token %}
    <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required
           style="min-width:280px; width:420px; max-width:100%; padding:10px 12px; border-radius:8px; border:1px solid #cfd6e4;">
    <button type="submit" class="pill">ğŸ’¾ Zapisz link</button>
  </form>
  {% endif %}

  <div class="hint" id="vol-hint" style="display:none">
    ğŸ’¡ Nie udaÅ‚o siÄ™ sterowaÄ‡ gÅ‚oÅ›noÅ›ciÄ… przez API. UÅ¼yj przyciskÃ³w gÅ‚oÅ›noÅ›ci urzÄ…dzenia lub miksera systemowego (ikonka gÅ‚oÅ›nika obok paska adresu).
  </div>

  <div class="hint">
    â„¹ï¸ JeÅ›li przeglÄ…darka (zwÅ‚aszcza w telefonie) zablokuje automatyczny start audio,
    <b>stuknij raz w przycisk mikrofonu lub w dowolne miejsce strony</b>, aby poÅ‚Ä…czyÄ‡ dÅºwiÄ™k.
  </div>
</main>

<div id="jitsi-container"></div>

<script src="https://meet.jit.si/external_api.js"></script>
<script>
  const rezerwacjaId = "{{ rezerwacja.id }}";
  const csrfToken = "{{ csrf_token }}";

  let api = null;
  let isMuted = false;
  window.audioActivated = false;
  let volumeSupported = true; // wykryjemy po prÃ³bnym wywoÅ‚aniu

  function startJitsiAudio() {
    const domain = "meet.jit.si";
    const options = {
      roomName: "ZajeciaAudio_{{ rezerwacja.id }}",
      parentNode: document.getElementById("jitsi-container"),
      configOverwrite: {
        startWithAudioMuted: false,
        startWithVideoMuted: true,
        disableVideoBackground: true,
        prejoinConfig: { enabled: false },
        disableDeepLinking: true
      },
      interfaceConfigOverwrite: {
        TOOLBAR_BUTTONS: [],
        SHOW_JITSI_WATERMARK: false,
        HIDE_DEEP_LINKING_LOGO: true,
        MOBILE_APP_PROMO: false
      }
    };

    api = new JitsiMeetExternalAPI(domain, options);

    api.addListener('audioMuteStatusChanged', ({ muted }) => {
      isMuted = muted;
      syncMicLabel();
    });

    // sprÃ³bujmy od razu ustawiÄ‡ gÅ‚oÅ›noÅ›Ä‡ na 100 â€“ jeÅ›li rzuci wyjÄ…tek, pokaÅ¼emy tip
    setTimeout(() => {
      try {
        api.executeCommand('setAudioOutputVolume', 100);
        volumeSupported = true;
      } catch (e) {
        volumeSupported = false;
        document.getElementById('vol-hint').style.display = 'block';
      }
    }, 500);
  }

  function activateAudioOnce() {
    if (window.audioActivated || !api) return;
    window.audioActivated = true;
    api.executeCommand('toggleAudio');
    api.executeCommand('toggleAudio');
    isMuted = false;
    syncMicLabel();
    document.removeEventListener('click', activateAudioOnce, true);
    document.removeEventListener('touchstart', activateAudioOnce, true);
  }

  document.addEventListener('click', activateAudioOnce, true);
  document.addEventListener('touchstart', activateAudioOnce, true);

  function syncMicLabel() {
    document.getElementById('mic-icon').textContent = isMuted ? 'ğŸ™ï¸' : 'ğŸ”‡';
    document.getElementById('mic-label').textContent = isMuted ? 'WÅ‚Ä…cz mikrofon' : 'Wycisz mikrofon';
  }

  function toggleMic() {
    if (!api) return;
    if (!window.audioActivated) {
      activateAudioOnce();
      return;
    }
    isMuted = !isMuted;
    api.executeCommand('toggleAudio');
    syncMicLabel();
  }

  function setOutputVolume(val) {
    const v = Number(val);
    document.getElementById('vol-val').textContent = v + '%';
    if (!api) return;
    try {
      api.executeCommand('setAudioOutputVolume', v);
      if (!volumeSupported) {
        volumeSupported = true;
        document.getElementById('vol-hint').style.display = 'none';
      }
    } catch (e) {
      volumeSupported = false;
      document.getElementById('vol-hint').style.display = 'block';
    }
  }

  function pingOnlineStatus() {
    fetch("{% url 'ping_online_status' %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken, "Content-Type": "application/x-www-form-urlencoded" },
      body: "rezerwacja_id=" + encodeURIComponent(rezerwacjaId)
    }).catch(()=>{});
  }

  function checkOtherUserStatus() {
    fetch(`/check-online-status/${rezerwacjaId}/`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('presence-dot').classList.toggle('status--on', !!data.online);
        document.getElementById('presence-text').textContent = data.online ? "DostÄ™pny" : "NiedostÄ™pny";
      })
      .catch(()=>{});
  }

  function initCountdown() {
    const el = document.getElementById('countdown');
    const start = new Date("{{ rezerwacja.termin|date:'Y-m-d H:i:s' }}").getTime();
    const end = start + 55 * 60 * 1000;

    function tick() {
      const now = Date.now();
      const diff = end - now;
      if (diff <= 0) {
        el.textContent = "ZakoÅ„czone";
        el.classList.add('red');
        return;
      }
      const m = Math.floor(diff/60000), s = Math.floor((diff%60000)/1000);
      el.textContent = `PozostaÅ‚o: ${m}:${String(s).padStart(2,'0')}`;
      el.classList.toggle('red', m < 5);
    }
    tick();
    setInterval(tick, 1000);
  }

  document.addEventListener('DOMContentLoaded', () => {
    startJitsiAudio();
    syncMicLabel();
    initCountdown();
    pingOnlineStatus();
    checkOtherUserStatus();
    setInterval(pingOnlineStatus, 10_000);
    setInterval(checkOtherUserStatus, 10_000);
  });
</script>
</body>
</html>
