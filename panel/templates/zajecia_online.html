<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Zajęcia online — audio (WebRTC + TURN + BOOST, single-transceiver)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#007bff; --ok:#28a745; --muted:#ccc; --warn:#ffb300; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:#f4f4f4; }
    header { background: var(--primary); color:#fff; padding:10px 14px; display:flex; align-items:center; gap:14px; flex-wrap:wrap; }
    .title { font-weight:700; font-size:18px; flex:1 1 auto; }
    .pill { background:#fff; color:#000; padding:8px 10px; border-radius:8px; border:1px solid #ddd; display:flex; align-items:center; gap:8px; font-weight:600; }
    .status-dot { width:14px; height:14px; border-radius:50%; display:inline-block; vertical-align:middle; }
    .status--on { background:#39d158; } .status--off { background:#b1b1b1; }
    .countdown { font-weight:700; } .countdown.red { color:#ffeb3b; }
    main { padding:24px 16px; display:flex; flex-direction:column; align-items:center; gap:18px; }
    .btn-tablica { padding:14px 24px; font-size:18px; background:var(--ok); color:#fff; border:none; border-radius:10px; text-decoration:none; display:inline-block; }
    .hint { max-width:900px; background:#fff; border:1px dashed #cfd6e4; padding:12px 14px; border-radius:8px; color:#2a2f3a; }
    .vol-wrap { display:flex; align-items:center; gap:10px; } input[type="range"] { width:200px; } select { padding:6px 8px; border-radius:8px; border:1px solid #ddd; }
    #remote-audio { width:0; height:0; opacity:0; pointer-events:none; }
    #autoplay-banner { display:none; align-items:center; gap:10px; background:#fff3cd; border:1px solid #ffe08a; color:#663c00; padding:10px 12px; border-radius:8px; }
    #autoplay-banner button { border:0; border-radius:8px; padding:8px 10px; cursor:pointer; background:var(--warn); color:#000; font-weight:700; }
  </style>
</head>
<body>
<header>
  <div class="title">Zajęcia online — audio</div>

  <div class="pill" id="presence-pill"><span id="presence-dot" class="status-dot status--off"></span><span id="presence-text">Niedostępny</span></div>
  <div class="pill"><span>👥</span><span id="participants-count">1</span></div>

  <button class="pill" id="mic-toggle" type="button" onclick="toggleMic()"><span id="mic-icon">🔇</span><span id="mic-label">Wycisz mikrofon</span></button>

  <div class="pill vol-wrap">
    <span>🔈</span><input id="vol" type="range" min="0" max="100" value="100" oninput="setVolume(this.value)"><span id="vol-val">100%</span>
  </div>

  <div class="pill"><span>⏱</span><span id="countdown" class="countdown">Pozostało: --:--</span></div>

  <div class="pill" id="output-pill">🔊 Wyjście: <select id="audio-output" onchange="changeOutput(this.value)"><option>Ładowanie...</option></select></div>

  <div class="pill" id="boost-pill">💥 Wzmocnienie: <input id="boost" type="range" min="100" max="300" value="100" oninput="setBoost(this.value)"><span id="boost-val">100%</span></div>

  <button class="pill" type="button" onclick="playSpeakerTest()">🔉 Test głośnika</button>

  {% if is_teacher %}
    <button class="pill" id="host-start" type="button" onclick="startHost()">🔑 Start (gospodarz)</button>
    <button class="pill" id="host-stop"  type="button" onclick="stopPeer()" style="display:none;">⏹ Zakończ</button>
  {% else %}
    <button class="pill" id="join-meeting" type="button" onclick="joinMeeting()">✅ Dołącz do spotkania</button>
    <span class="pill" id="waiting-host" style="display:none;">⏳ Czekamy na gospodarza…</span>
  {% endif %}
</header>

<main>
  <a class="btn-tablica" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">✏️ Otwórz tablicę</a>

  {% if is_teacher %}
  <form method="POST" style="display:flex; gap:8px; flex-wrap:wrap;">{% csrf_token %}
    <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required
           style="min-width:280px; width:420px; max-width:100%; padding:10px 12px; border-radius:8px; border:1px solid #cfd6e4;">
    <button type="submit" class="pill">💾 Zapisz link</button>
  </form>
  {% endif %}

  <div id="autoplay-banner">🔇 Przeglądarka zablokowała dźwięk. Kliknij: <button type="button" id="autoplay-btn">Włącz audio</button></div>

  <div class="hint">Jeśli nadal cisza: upewnij się, że obie strony mają tę samą wersję i działa <b>TURN</b> (3478 UDP/TCP).</div>
</main>

<audio id="remote-audio" autoplay playsinline></audio>

<script>
  const rezerwacjaId = "{{ rezerwacja.id }}";
  const csrfToken    = "{{ csrf_token }}";

  // TURN – podmień hosta jak używasz
  const TURN = { host: "YOUR_TURN_HOST", username: "webrtc", credential: "webrtc123" };

  const rtcConfig = {
    iceServers: [
      { urls: ["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"] },
      { urls: [`turn:${TURN.host}:3478?transport=udp`,`turn:${TURN.host}:3478?transport=tcp`],
        username: TURN.username, credential: TURN.credential }
    ],
    iceTransportPolicy: "all",
    bundlePolicy: "max-bundle"
  };

  let pc=null, localStream=null, remoteStream=null, audioTransceiver=null;
  let joined=false, remoteConnected=false, isMuted=false, otherOnline=false;

  const supportsSinkId = ('setSinkId' in HTMLMediaElement.prototype);
  let audioCtx=null, boostNode=null, sourceNode=null;

  const sleep=(ms)=>new Promise(r=>setTimeout(r, ms));
  async function postJSON(url,data){const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":csrfToken},body:JSON.stringify(data)}); if(!r.ok) throw new Error(await r.text()); return r.json();}
  async function getJSON(url){const r=await fetch(url); if(r.status===404) return null; if(!r.ok) throw new Error(await r.text()); return r.json();}

  function updateParticipantsBadge(){
    const base = 1;
    const withRemote = remoteConnected ? 2 : base;
    const count = otherOnline ? Math.max(2, withRemote) : withRemote;
    document.getElementById('participants-count').textContent = count;
  }

  // ===== AUDIO UNLOCK =====
  async function ensureAudio(){
    try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state!=='running') await audioCtx.resume(); }catch(e){}
    try{ const el=document.getElementById('remote-audio'); await el.play(); document.getElementById('autoplay-banner').style.display='none'; }
    catch(e){ document.getElementById('autoplay-banner').style.display='flex'; }
  }

  // ===== UI MIC/VOL/BOOST =====
  function toggleMic(){
    if(!localStream) return;
    const t=localStream.getAudioTracks()[0]; if(!t) return;
    t.enabled=!t.enabled; isMuted=!t.enabled;
    document.getElementById('mic-icon').textContent=isMuted?'🎙️':'🔇';
    document.getElementById('mic-label').textContent=isMuted?'Włącz mikrofon':'Wycisz mikrofon';
  }
  function setVolume(v){ document.getElementById('vol-val').textContent=v+'%'; const el=document.getElementById('remote-audio'); el.volume=Math.max(0,Math.min(1,Number(v)/100)); }
  async function setBoost(val){
    document.getElementById('boost-val').textContent = val + '%';
    const el=document.getElementById('remote-audio');
    if (Number(val) <= 100) {
      if (sourceNode){ try{ sourceNode.disconnect(); }catch(e){} sourceNode=null; }
      if (boostNode){ try{ boostNode.disconnect(); }catch(e){} boostNode=null; }
      el.muted = false; return;
    }
    try{
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      await audioCtx.resume();
      if (!boostNode) boostNode = audioCtx.createGain();
      boostNode.gain.value = Number(val)/100;
      if (!sourceNode && remoteStream) {
        sourceNode = audioCtx.createMediaStreamSource(remoteStream);
        sourceNode.connect(boostNode).connect(audioCtx.destination);
      }
      el.muted = true;
    }catch(e){}
  }

  async function populateOutputs(){
    const pill=document.getElementById('output-pill'), sel=document.getElementById('audio-output');
    if(!supportsSinkId){ pill.style.display='none'; return; }
    try{
      const devs=await navigator.mediaDevices.enumerateDevices();
      const outs=devs.filter(d=>d.kind==='audiooutput'); sel.innerHTML='';
      if(!outs.length){ const opt=document.createElement('option'); opt.textContent='Domyślne'; opt.value=''; sel.appendChild(opt); return; }
      outs.forEach(d=>{ const opt=document.createElement('option'); opt.value=d.deviceId; opt.textContent=d.label||d.deviceId; sel.appendChild(opt); });
    }catch(e){ pill.style.display='none'; }
  }
  async function changeOutput(deviceId){
    const el=document.getElementById('remote-audio');
    if(!supportsSinkId) return;
    try{ await el.setSinkId(deviceId||''); }catch(e){}
    setVolume(document.getElementById('vol').value);
  }

  // ===== WEBRTC =====
  function attachRemoteAudio(){ const el=document.getElementById('remote-audio'); remoteStream=new MediaStream(); el.srcObject=remoteStream; ensureAudio(); }

  function setupPeerBase(){
    pc=new RTCPeerConnection(rtcConfig);

    // KLUCZ: JEDEN transceiver 'sendrecv'
    audioTransceiver = pc.addTransceiver('audio', { direction: 'sendrecv' });

    pc.ontrack=(ev)=>{
      if (ev.track && ev.track.kind === 'audio') remoteStream.addTrack(ev.track);
      remoteConnected=true; updateParticipantsBadge();
      ev.track.onunmute = ()=> ensureAudio();
      ensureAudio();
      const boostVal = Number(document.getElementById('boost').value||'100');
      if (boostVal>100) setBoost(boostVal);
    };

    pc.oniceconnectionstatechange=()=>{ /* console.log('ice:', pc.iceConnectionState); */ };
    pc.onconnectionstatechange=()=>{ /* console.log('conn:', pc.connectionState); */ };
  }

  async function getMic(){
    // pobierz mikrofon
    localStream=await navigator.mediaDevices.getUserMedia({
      audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true }
    });
    // wstaw lokalny track do JEDYNEGO sendera
    const track = localStream.getAudioTracks()[0];
    if (audioTransceiver && audioTransceiver.sender) {
      await audioTransceiver.sender.replaceTrack(track);
    }
    return localStream;
  }

  function waitIceComplete(){
    if(!pc) return Promise.resolve();
    if(pc.iceGatheringState==='complete') return Promise.resolve();
    return new Promise(res=>{ const f=()=>{ if(pc.iceGatheringState==='complete'){ pc.removeEventListener('icegatheringstatechange', f); res(); } }; pc.addEventListener('icegatheringstatechange', f); });
  }

  function teardown(){
    try{ pc&&pc.close(); }catch(e){} pc=null;
    audioTransceiver=null;
    try{ localStream&&localStream.getTracks().forEach(t=>t.stop()); }catch(e){} localStream=null;
    remoteConnected=false; joined=false;
    if (sourceNode){ try{ sourceNode.disconnect(); }catch(e){} sourceNode=null; }
    if (boostNode){ try{ boostNode.disconnect(); }catch(e){} boostNode=null; }
    document.getElementById('remote-audio').muted = false;
    updateParticipantsBadge(); updateRoleButtons();
  }

  function amHost(){ return !!document.getElementById('host-start'); }

  // ===== HOST =====
  async function startHost(){
    if(joined) return;
    attachRemoteAudio(); setupPeerBase(); await getMic(); await ensureAudio();

    const offer=await pc.createOffer(); // transceiver już definiuje recv/send
    await pc.setLocalDescription(offer); await waitIceComplete();
    await postJSON(`/webrtc/offer/${rezerwacjaId}/`, { type:pc.localDescription.type, sdp:pc.localDescription.sdp });

    // czekaj na ANSWER i ustaw remote SDP
    for (let i=0; i<120 && pc; i++) {
      const ans = await getJSON(`/webrtc/answer/${rezerwacjaId}/`);
      if (ans && ans.type === 'answer' && ans.sdp) { await pc.setRemoteDescription(new RTCSessionDescription(ans)); break; }
      await sleep(1000);
    }

    joined=true; updateParticipantsBadge(); updateRoleButtons(); await populateOutputs();
  }

  // ===== STUDENT =====
  async function joinMeeting(){
    if(joined) return;
    attachRemoteAudio(); setupPeerBase(); await ensureAudio();

    const waitEl=document.getElementById('waiting-host'); if(waitEl) waitEl.style.display='inline-flex';
    let offer=null; for(let i=0;i<120;i++){ offer=await getJSON(`/webrtc/offer/${rezerwacjaId}/`); if(offer && offer.type==='offer' && offer.sdp) break; await sleep(1000); }
    if(waitEl) waitEl.style.display='none';
    if(!offer){ alert('Brak gospodarza (offer). Spróbuj za chwilę.'); return; }

    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    await getMic(); // replaceTrack na transceiverze
    const answer=await pc.createAnswer();
    await pc.setLocalDescription(answer); await waitIceComplete();
    await postJSON(`/webrtc/answer/${rezerwacjaId}/`, { type:pc.localDescription.type, sdp:pc.localDescription.sdp });

    joined=true; updateParticipantsBadge(); updateRoleButtons(); await populateOutputs();
  }

  function stopPeer(){ teardown(); }

  // ===== Presence =====
  function pingOnlineStatus(){ fetch("{% url 'ping_online_status' %}", { method:"POST", headers:{ "X-CSRFToken":csrfToken, "Content-Type":"application/x-www-form-urlencoded" }, body:"rezerwacja_id="+encodeURIComponent(rezerwacjaId) }).catch(()=>{}); }
  function checkOtherUserStatus(){
    fetch(`/check-online-status/${rezerwacjaId}/`).then(r=>r.json()).then(data=>{
      otherOnline=!!data.online;
      const dot=document.getElementById('presence-dot'), text=document.getElementById('presence-text');
      dot.classList.toggle('status--on', otherOnline); dot.classList.toggle('status--off', !otherOnline);
      text.textContent = otherOnline ? "Dostępny" : "Niedostępny";
      updateParticipantsBadge(); updateRoleButtons();
    }).catch(()=>{});
  }

  // ===== Role UI =====
  function updateRoleButtons(){
    const hostStart=document.getElementById('host-start'), hostStop=document.getElementById('host-stop');
    const joinBtn=document.getElementById('join-meeting'), waitHost=document.getElementById('waiting-host');
    if(hostStart&&hostStop){ hostStart.style.display=joined?'none':'inline-flex'; hostStop.style.display=joined?'inline-flex':'none'; }
    if(joinBtn&&waitHost){ waitHost.style.display=otherOnline?'none':'inline-flex'; }
  }

  // ===== Beep =====
  async function playSpeakerTest(){
    try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); await audioCtx.resume();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='sine'; o.frequency.setValueAtTime(880, audioCtx.currentTime); g.gain.setValueAtTime(0.08, audioCtx.currentTime);
      o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(()=>{ try{o.stop();}catch(e){} }, 350);
      document.getElementById('autoplay-banner').style.display='none';
    }catch(e){}
  }

  // ===== Timer =====
  function initCountdown(){
    const el=document.getElementById('countdown');
    const start=new Date("{{ rezerwacja.termin|date:'Y-m-d H:i:s' }}").getTime();
    const end=start+55*60*1000;
    function tick(){ const diff=end-Date.now(); if(diff<=0){ el.textContent="Zakończone"; el.classList.add('red'); return; }
      const m=Math.floor(diff/60000), s=Math.floor((diff%60000)/1000); el.textContent=`Pozostało: ${m}:${String(s).padStart(2,'0')}`;
      el.classList.toggle('red', m<5); }
    tick(); setInterval(tick, 1000);
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    initCountdown(); updateParticipantsBadge(); populateOutputs();
    pingOnlineStatus(); checkOtherUserStatus(); setInterval(pingOnlineStatus,10_000); setInterval(checkOtherUserStatus,10_000);
    document.getElementById('autoplay-btn')?.addEventListener('click', ensureAudio);
  });
</script>
</body>
</html>
