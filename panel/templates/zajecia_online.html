<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Zajęcia online — audio (Hard Mic debug)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#0b74ff; --ok:#28a745; --warn:#ffb300; --danger:#dc3545; --bg:#f4f6fb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg)}
    header{background:var(--primary);color:#fff;padding:10px 14px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .title{font-weight:800;font-size:18px;margin-right:auto}
    .pill{background:#fff;color:#111;padding:8px 10px;border-radius:10px;border:1px solid #dde3f0;display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .pill.disabled{opacity:.55;pointer-events:none}
    .status-dot{width:14px;height:14px;border-radius:50%}
    .status--on{background:#2dd66f}.status--off{background:#bdbdbd}
    main{padding:22px 16px;display:flex;flex-direction:column;align-items:center;gap:18px}
    .btn{padding:12px 18px;border-radius:10px;border:1px solid #d7e0f0;background:#fff;cursor:pointer}
    .btn.primary{background:var(--ok);color:#fff;border:none}
    .btn.danger{background:#fff;color:#b30000;border-color:#f3c3c3}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .slider{width:220px}
    .badge{padding:6px 10px;border-radius:10px;background:#fff;border:1px dashed #cfd6e4;color:#2a2f3a}
    #vu{width:120px;height:10px;background:#eef3fb;border-radius:6px;overflow:hidden}
    #vu>span{display:block;height:100%;width:0;background:#28a745;transition:width .08s linear}
    small{opacity:.9;font-weight:600}
    audio{width:0;height:0;opacity:0;pointer-events:none}
  </style>
</head>
<body>

<header>
  <div class="title">Zajęcia online — audio</div>

  <button class="pill" id="presence-pill" type="button">
    <span id="presence-dot" class="status-dot status--off"></span>
    <span id="presence-text">Niedostępny</span>
  </button>

  <div class="pill">👥 <span id="participants">1</span></div>

  <button class="pill disabled" id="mic-btn" type="button" onclick="toggleMic()">
    <span id="mic-ico">🔇</span><span id="mic-lbl">Wycisz mikrofon</span>
  </button>

  <!-- NOWY PRZYCISK HARD MIC -->
  <button class="pill" id="hard-mic" type="button" onclick="forceMic()">🎤 Hard Mic</button>

  <div class="pill">
    🔈 <input id="vol" class="slider" type="range" min="0" max="100" value="100" oninput="setVolume(this.value)">
    <span id="vol-val">100%</span>
  </div>

  <div class="pill">⏱ <span id="timer">--:--</span></div>

  <div class="pill" id="out-pill">🔊 Wyjście:
    <select id="out" onchange="changeOutput(this.value)"><option>Ładowanie…</option></select>
  </div>

  <div class="pill">📶 Wejście: <div id="vu"><span></span></div></div>

  <div class="pill">🧊 ICE: <small id="ice">init</small> <small id="ice-path" style="opacity:.8"></small></div>
  <div class="pill">🔁 Signaling: <small id="sig">init</small></div>
  <div class="pill">🗃️ Store: <small id="store">offer: –, answer: –</small></div>

  {% if is_teacher %}
    <button class="pill" id="announce" type="button" onclick="announceHost()">📣 Ogłoś: jestem gospodarzem</button>
    <button class="pill" id="host" type="button" onclick="startHost()">🔗 Połącz (gospodarz)</button>
  {% else %}
    <span class="pill" id="wait-host" style="display:none;">⏳ Czekamy na gospodarza…</span>
    <button class="pill" id="student" type="button" onclick="joinMeeting()">🔗 Połącz (uczeń)</button>
  {% endif %}

  <button class="pill btn danger" id="bye" type="button" onclick="hangup()" style="display:none;">🔌 Rozłącz</button>
</header>

<main>
  <a class="btn primary" target="_blank" href="{{ rezerwacja.excalidraw_link|default:'#' }}">✏️ Otwórz tablicę</a>

  {% if is_teacher %}
  <form method="POST" style="display:flex;gap:8px;flex-wrap:wrap">
    {% csrf_token %}
    <input type="url" name="excalidraw_link" placeholder="https://excalidraw.com/#room=..." required
           style="min-width:280px;width:420px;max-width:100%;padding:10px 12px;border-radius:10px;border:1px solid #cfd6e4">
    <button type="submit" class="pill">💾 Zapisz link</button>
  </form>
  {% endif %}

  <div class="badge">📱 Mobile wymaga <b>HTTPS</b>. Dla ciężkich NAT skonfiguruj <b>TURN</b>.</div>
</main>

<audio id="remote" autoplay playsinline></audio>

<script>
/* ====== Kontekst szablonu ====== */
const rezerwacjaId = "{{ rezerwacja.id }}";
const csrfToken    = "{{ csrf_token }}";
const IS_TEACHER   = {% if is_teacher %}true{% else %}false{% endif %};

const OFFER_URL  = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_offer' rez_id=rezerwacja.id %}";
const ANSWER_URL = "{{ request.scheme }}://{{ request.get_host }}{% url 'webrtc_answer' rez_id=rezerwacja.id %}";

/* ====== RTC config ====== */
const rtcConfig = { iceServers: [{ urls:["stun:stun.l.google.com:19302"] }] };

/* ====== Stan ====== */
let pc=null, localStream=null, remoteStream=null, audioTransceiver=null;
let joined=false, isMuted=false;

/* ====== Helpers ====== */
const $ = sel => document.querySelector(sel);

/* ====== Audio ====== */
async function requestMicNow(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    localStream = stream;
    const track = stream.getAudioTracks()[0];

    if(!audioTransceiver && pc){
      audioTransceiver = pc.addTransceiver('audio',{direction:'sendrecv'});
    }
    if(audioTransceiver?.sender){
      await audioTransceiver.sender.replaceTrack(track);
      if(audioTransceiver.sender.setStreams){ audioTransceiver.sender.setStreams(localStream); }
    }else if(pc){
      pc.addTrack(track, localStream);
    }
    $('#mic-btn').classList.remove('disabled');
    $('#mic-ico').textContent='🎙️'; $('#mic-lbl').textContent='Wycisz mikrofon';
  }catch(e){ console.warn('[MIC] error', e); }
}

/* ====== Hard Mic (debug) ====== */
async function forceMic(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    const track = stream.getAudioTracks()[0];
    if(!pc){ alert("⚠️ PeerConnection nie istnieje"); return; }
    if(audioTransceiver?.sender){
      await audioTransceiver.sender.replaceTrack(track);
      if(audioTransceiver.sender.setStreams){ audioTransceiver.sender.setStreams(stream); }
    }else{
      pc.addTrack(track, stream);
    }
    localStream = stream;
    alert("✅ Mikrofon wymuszony!");
  }catch(e){
    console.error("Hard Mic error:", e);
    alert("❌ Hard Mic error: " + (e?.message||e));
  }
}

/* ====== Mic toggle ====== */
function toggleMic(){
  if(!localStream){ requestMicNow(); return; }
  const t = localStream.getAudioTracks()[0]; if(!t) return;
  t.enabled = !t.enabled; isMuted = !t.enabled;
  $('#mic-ico').textContent = isMuted ? '🔇' : '🎙️';
  $('#mic-lbl').textContent = isMuted ? 'Włącz mikrofon' : 'Wycisz mikrofon';
}

/* ====== Dummy placeholders (Twoje istniejące funkcje) ====== */
function startHost(){ console.log("TODO startHost"); }
function joinMeeting(){ console.log("TODO joinMeeting"); }
function hangup(){ console.log("TODO hangup"); }
function setVolume(v){ $('#vol-val').textContent = v+'%'; }
</script>
</body>
</html>
