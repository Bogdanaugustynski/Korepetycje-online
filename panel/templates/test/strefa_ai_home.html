{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Strefa AI ‚Äî PolubiszTo.pl</title>
<style>
  :root{
    --brand:#0b74ff; --ink:#0b1320; --muted:#5b6777; --ok:#21c77a;
    --bg:#f7faff; --line:#e6edff; --card:#fff; --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  body::before{
    content:""; position:fixed; inset:0; z-index:-1;
    background:
      radial-gradient(900px 320px at 10% -10%, rgba(11,116,255,.12), transparent),
      radial-gradient(700px 260px at 85% 0%, rgba(106,92,255,.10), transparent);
  }
  header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.86);
    backdrop-filter:saturate(1.1) blur(10px); border-bottom:1px solid var(--line)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit}
  .mark{width:40px;height:40px;border-radius:12px;background:var(--brand);
    display:grid;place-items:center;color:#fff;box-shadow:0 8px 22px rgba(11,116,255,.28)}
  .brand h1{margin:0;font-size:20px}
  .brand p{margin:0;color:var(--muted);font-size:12px}
  main{padding:16px}
  .layout{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:280px 1fr;gap:16px}
  @media(max-width:980px){.layout{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
    box-shadow:0 12px 42px rgba(11,116,255,.10)}
  .side{padding:14px}
  .side .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .side h3{margin:0;font-size:16px}
  .btn, .iconbtn{border:1px solid var(--line);background:#fff;border-radius:12px;cursor:pointer}
  .btn{padding:10px 12px;font-weight:700}
  .iconbtn{padding:8px;display:inline-grid;place-items:center}
  .sessions{margin-top:10px;display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
  .session{
    display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);
    border-radius:12px;background:#fff;cursor:pointer
  }
  .session.active{outline:2px solid var(--brand);background:#f4f9ff}
  .avatar{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;color:#fff;font-weight:800}
  .av-noa{background:#0b74ff}.av-ali{background:#8b5cf6}.av-lyra{background:#10b981}.av-eid{background:#f59e0b}
  .sname{font-size:14px;font-weight:700}
  .smeta{font-size:11px;color:#5b6777}
  .srow{display:flex;flex-direction:column}
  .sact{margin-left:auto;display:flex;gap:6px}
  .content{display:flex;flex-direction:column}
  .topbar{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px}
  .personas{display:flex;gap:8px;flex-wrap:wrap}
  .pill{
    display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);
    border-radius:999px;background:#fff;cursor:pointer;font-weight:700;font-size:13px
  }
  .pill.active{background:var(--brand);color:#fff;border-color:transparent;box-shadow:0 8px 20px rgba(11,116,255,.18)}
  .mainchat{display:grid;grid-template-rows:auto 1fr auto;min-height:70vh}
  .chathead{padding:12px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
  .chatbody{height:58vh;overflow:auto;padding:16px;background:#f8fbff}
  .msg{display:flex;gap:10px;margin-bottom:12px}
  .msg.me{justify-content:flex-end}
  .bubble{max-width:70%;padding:10px 12px;border-radius:12px;background:#fff;border:1px solid var(--line);
    font-size:14px;color:#2a3956;box-shadow:0 6px 18px rgba(11,116,255,.06)}
  .msg.me .bubble{background:#0b74ff;color:#fff;border-color:transparent}
  .chatfoot{border-top:1px solid var(--line);padding:12px;display:grid;gap:8px;background:#fff}
  .chatfoot textarea{width:100%;min-height:80px;resize:vertical;padding:10px 12px;border:1px solid var(--line);
    border-radius:12px;font:inherit;color:#111;background:#f9fbff}

  /* === upload === */
  .uploader{border:1px dashed var(--line); background:#f9fbff; border-radius:12px; padding:10px}
  .uploader.drag{outline:2px solid var(--brand)}
  .uploader .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .uploader input[type=file]{display:none}
  .uploader .pick{border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:700}
  .attach-list{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .attach{
    display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line);
    background:#fff; border-radius:10px; max-width:240px;
  }
  .attach img{width:36px; height:36px; object-fit:cover; border-radius:6px; border:1px solid var(--line)}
  .attach .meta{display:flex; flex-direction:column; min-width:0}
  .attach .name{font-size:12px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .attach .size{font-size:11px; color:#5b6777}
  .attach .x{margin-left:auto; cursor:pointer; border:none; background:#fff; font-size:16px}
  .actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .btn.primary{background:var(--brand);color:#fff;border-color:transparent;box-shadow:0 8px 22px rgba(11,116,255,.18)}
  .hint{font-size:12px;color:#5b6777;text-align:right}
  .search{width:100%;display:flex;gap:8px;margin-top:8px}
  .search input{flex:1;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font:inherit;background:#f9fbff}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <a class="brand" href="#">
        <div class="mark">
          <svg viewBox="0 0 48 48" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 16l20-8 20 8-20 8-20-8z" stroke="#fff"/>
            <path d="M12 20v7c0 2 6 5 12 5s12-3 12-5v-7" stroke="#dbe9ff"/>
            <circle cx="36" cy="10" r="3" fill="#dbe9ff" stroke="none"/>
          </svg>
        </div>
        <div>
          <h1>PolubiszTo.pl</h1>
          <p>Strefa AI ‚Äî czaty ‚Ä¢ pliki ‚Ä¢ archiwum</p>
        </div>
      </a>
      <div class="tools">
        <button class="btn" id="btnNew">+ Nowy czat</button>
        <button class="btn" id="btnExport">Eksport</button>
        <button class="btn" id="btnImport">Import</button>
      </div>
    </div>
  </div>
</header>

<main class="layout">
  <aside class="card side">
    <div class="head">
      <h3>Archiwum czat√≥w</h3>
      <button class="iconbtn" id="btnClearAll" title="Usu≈Ñ wszystkie czaty">üóëÔ∏è</button>
    </div>
    <div class="search">
      <input id="searchBox" placeholder="Szukaj w tytu≈Çach‚Ä¶">
      <button class="btn" id="btnSearch">Szukaj</button>
    </div>
    <div class="sessions" id="sessions"></div>
  </aside>

  <section class="card content">
    <div class="topbar">
      <div class="personas" id="personas">
        <button class="pill" data-persona="Noa"><span class="avatar av-noa" style="width:20px;height:20px">N</span> Noa</button>
        <button class="pill" data-persona="Ali"><span class="avatar av-ali" style="width:20px;height:20px">A</span> Ali</button>
        <button class="pill" data-persona="Lyra"><span class="avatar av-lyra" style="width:20px;height:20px">L</span> Lyra</button>
        <button class="pill" data-persona="Eidos"><span class="avatar av-eid" style="width:20px;height:20px">E</span> Eidos</button>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn" id="btnRename">Zmie≈Ñ nazwƒô</button>
        <button class="btn" id="btnReset">Reset rozmowy</button>
      </div>
    </div>

    <div class="mainchat">
      <div class="chathead" id="chatTitle">
        <div class="avatar av-noa" id="personaAvatar">N</div>
        <div>
          <div style="font-weight:800" id="sessionName">Nowy czat ‚Äî Noa</div>
          <small style="color:var(--muted)" id="sessionMeta">Dzi≈õ ‚Ä¢ 0 wiadomo≈õci</small>
        </div>
      </div>

      <div class="chatbody" id="chatLog" role="log" aria-live="polite"></div>

      <div class="chatfoot">
        <div class="uploader" id="uploader">
          <div class="row">
            <label class="pick" for="fileInput">‚ûï Dodaj pliki</label>
            <span style="font-size:12px; color:#5b6777">PrzeciƒÖgnij i upu≈õƒá tutaj (obrazy, PDF, DOCX‚Ä¶)</span>
          </div>
          <input id="fileInput" type="file" multiple accept="image/*,.pdf,.doc,.docx,.txt,.ppt,.pptx,.xls,.xlsx">
          <div class="attach-list" id="attachList"></div>
        </div>

        <textarea id="chatInput" placeholder="Napisz wiadomo≈õƒá‚Ä¶ (Enter ‚Äî wy≈õlij, Shift+Enter ‚Äî nowa linia)"></textarea>
        <div class="actions">
          <button class="btn" id="btnClear">Wyczy≈õƒá okno</button>
          <button class="btn primary" id="btnSend">Wy≈õlij</button>
        </div>
        <div class="hint">Uwaga: Lyra nie skanuje du≈ºych plik√≥w w trakcie pisania ‚Äî robi to tylko na wyra≈∫ne polecenie.</div>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  const API_URL = "{% url 'ai_chat' %}".includes('%') ? "/ai_chat/" : "{% url 'ai_chat' %}";
  const MAX_SESSIONS = 200;
  const storeKey = 'pt_ai_sessions_v1';

  let sessions = loadSessions();
  let activeId = null;
  let activePersona = "Noa";

  const sessionsEl = document.getElementById('sessions');
  const chatLogEl   = document.getElementById('chatLog');
  const chatInputEl = document.getElementById('chatInput');
  const sendBtn     = document.getElementById('btnSend');
  const clearBtn    = document.getElementById('btnClear');
  const resetBtn    = document.getElementById('btnReset');
  const newBtn      = document.getElementById('btnNew');
  const renameBtn   = document.getElementById('btnRename');
  const clearAllBtn = document.getElementById('btnClearAll');
  const exportBtn   = document.getElementById('btnExport');
  const importBtn   = document.getElementById('btnImport');
  const searchBtn   = document.getElementById('btnSearch');
  const searchBox   = document.getElementById('searchBox');
  const sessionNameEl = document.getElementById('sessionName');
  const sessionMetaEl = document.getElementById('sessionMeta');
  const personaAvatar = document.getElementById('personaAvatar');

  const uploaderEl   = document.getElementById('uploader');
  const fileInputEl  = document.getElementById('fileInput');
  const attachListEl = document.getElementById('attachList');

  let pendingFiles = [];
  function fmtBytes(b){ if(!b && b!==0) return ""; const u=['B','KB','MB','GB']; let i=0; while(b>=1024&&i<u.length-1){b/=1024;i++;} return b.toFixed((i?1:0))+' '+u[i]; }
  function isImage(f){ return (f.type||'').startsWith('image/'); }

  function uid(){ return 's_' + Math.random().toString(36).slice(2,9); }
  function nowISO(){ return new Date().toISOString(); }
  function saveSessions(){ try{ localStorage.setItem(storeKey, JSON.stringify(sessions.slice(-MAX_SESSIONS))); }catch(e){} }
  function loadSessions(){ try{ const raw = localStorage.getItem(storeKey); return raw ? JSON.parse(raw) : []; }catch{ return []; } }
  function defaultTitleFor(persona){ return `Nowy czat ‚Äî ${persona}`; }
  function avatarLetter(p){ return p==='Noa'?'N':p==='Ali'?'A':p==='Lyra'?'L':'E'; }
  function avatarClass(p){ return p==='Noa'?'av-noa':p==='Ali'?'av-ali':p==='Lyra'?'av-lyra':'av-eid'; }
  function formatShort(ts){ const d=new Date(ts); return d.toLocaleString([], {hour:'2-digit', minute:'2-digit', year:'numeric', month:'2-digit', day:'2-digit'}); }

  function renderAttachments(){
    attachListEl.innerHTML = "";
    for(const it of pendingFiles){
      const wrap = document.createElement('div');
      wrap.className = 'attach';
      if(isImage(it.file)){
        const img = document.createElement('img');
        img.src = URL.createObjectURL(it.file);
        wrap.appendChild(img);
      }else{
        const ph = document.createElement('div');
        ph.style.cssText = "width:36px;height:36px;border:1px solid var(--line);border-radius:6px;display:grid;place-items:center;font-size:12px;background:#fff";
        ph.textContent = it.file.name.split('.').pop()?.toUpperCase().slice(0,4) || 'FILE';
        wrap.appendChild(ph);
      }
      const meta = document.createElement('div'); meta.className='meta';
      const nm = document.createElement('div'); nm.className='name'; nm.textContent = it.file.name;
      const sz = document.createElement('div'); sz.className='size'; sz.textContent = fmtBytes(it.file.size);
      meta.appendChild(nm); meta.appendChild(sz);
      const x = document.createElement('button'); x.className='x'; x.title='Usu≈Ñ'; x.textContent='√ó';
      x.addEventListener('click', ()=>{ pendingFiles = pendingFiles.filter(p=>p.id!==it.id); renderAttachments(); });
      wrap.appendChild(meta); wrap.appendChild(x);
      attachListEl.appendChild(wrap);
    }
  }

  function addFiles(files){
    for(const f of files){
      pendingFiles.push({ id: 'f_'+Math.random().toString(36).slice(2,9), file: f });
    }
    renderAttachments();
  }
  fileInputEl.addEventListener('change', (e)=> addFiles(e.target.files));
  ;['dragenter','dragover'].forEach(evt=>{
    uploaderEl.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); uploaderEl.classList.add('drag'); });
  });
  ;['dragleave','drop'].forEach(evt=>{
    uploaderEl.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); uploaderEl.classList.remove('drag'); });
  });
  uploaderEl.addEventListener('drop', (e)=>{
    const dt = e.dataTransfer;
    if(dt && dt.files && dt.files.length){ addFiles(dt.files); }
  });

  function createSession(persona = activePersona){
    const id = uid();
    const s = { id, title: defaultTitleFor(persona), persona, createdAt: nowISO(), updatedAt: nowISO(), messages: [] };
    sessions.push(s);
    activeId = id;
    saveSessions();
    renderSessions();
    renderActive();
    return s;
  }
  function getActive(){ return sessions.find(s=>s.id===activeId) || null; }
  function setActive(id){
    activeId = id;
    const s = getActive();
    if(s){ activePersona = s.persona; updatePersonaUI(); }
    renderSessions(); renderActive();
  }
  function removeSession(id){
    const idx = sessions.findIndex(s=>s.id===id);
    if(idx>=0){ sessions.splice(idx,1); saveSessions(); }
    if(activeId===id){ activeId = sessions[0]?.id || null; }
    renderSessions(); renderActive();
  }
  function filteredSessions(){
    const q = (searchBox.value||'').toLowerCase().trim();
    if(!q) return sessions.slice().sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
    return sessions.filter(s=>s.title.toLowerCase().includes(q)).sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
  }

  function renderSessions(){
    sessionsEl.innerHTML = "";
    for(const s of filteredSessions()){
      const el = document.createElement('div');
      el.className = 'session' + (s.id===activeId?' active':'');
      el.addEventListener('click', ()=> setActive(s.id));

      const av = document.createElement('div');
      av.className = 'avatar ' + avatarClass(s.persona);
      av.textContent = avatarLetter(s.persona);

      const sr = document.createElement('div');
      sr.className = 'srow';

      const nm = document.createElement('div');
      nm.className = 'sname'; nm.textContent = s.title;

      const sm = document.createElement('div');
      sm.className = 'smeta';
      sm.textContent = `${s.persona} ‚Ä¢ ${formatShort(s.updatedAt)} ‚Ä¢ ${s.messages.length} wiad.`;

      sr.appendChild(nm); sr.appendChild(sm);

      const acts = document.createElement('div'); acts.className = 'sact';
      const del = document.createElement('button'); del.className = 'iconbtn'; del.title = 'Usu≈Ñ czat'; del.textContent = 'üóëÔ∏è';
      del.addEventListener('click', (e)=>{ e.stopPropagation(); if(confirm('UsunƒÖƒá ten czat?')) removeSession(s.id); });

      const ren = document.createElement('button'); ren.className = 'iconbtn'; ren.title = 'Zmie≈Ñ nazwƒô'; ren.textContent = '‚úèÔ∏è';
      ren.addEventListener('click', (e)=>{ e.stopPropagation(); const t=prompt('Nowa nazwa czatu:', s.title); if(t){ s.title=t; s.updatedAt=nowISO(); saveSessions(); renderSessions(); renderActive(); } });

      acts.appendChild(ren); acts.appendChild(del);
      el.appendChild(av); el.appendChild(sr); el.appendChild(acts);
      sessionsEl.appendChild(el);
    }
    if(!sessions.length){
      const empty = document.createElement('div');
      empty.style.cssText = "margin-top:10px;color:#5b6777;font-size:14px";
      empty.textContent = "Brak czat√≥w. Kliknij ‚ÄûNowy czat‚Äù.";
      sessionsEl.appendChild(empty);
    }
  }

  function renderActive(){
    chatLogEl.innerHTML = "";
    const s = getActive();
    if(!s){
      sessionNameEl.textContent = "Brak czatu";
      sessionMetaEl.textContent = "";
      return;
    }
    personaAvatar.textContent = avatarLetter(s.persona);
    personaAvatar.className = "avatar " + avatarClass(s.persona);
    sessionNameEl.textContent = s.title;
    sessionMetaEl.textContent = `${formatShort(s.updatedAt)} ‚Ä¢ ${s.messages.length} wiadomo≈õci`;

    for(const m of s.messages){
      appendMessage(m.content, m.role === 'user' ? 'me' : 'ai');
    }
    chatLogEl.scrollTop = chatLogEl.scrollHeight;
  }

  function appendMessage(text, who){
    const row = document.createElement('div');
    row.className = 'msg ' + (who==='me'?'me':'ai');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    row.appendChild(bubble);
    chatLogEl.appendChild(row);
    chatLogEl.scrollTop = chatLogEl.scrollHeight;
  }

  async function sendMessage(){
    let s = getActive();
    if(!s){ s = createSession(activePersona); }

    const text = chatInputEl.value.trim();
    if(!text && !pendingFiles.length) return;
    chatInputEl.value = "";

    s.messages.push({role:'user', content:text || '(za≈ÇƒÖczniki)', ts:nowISO()});
    s.updatedAt = nowISO();
    saveSessions();
    renderActive();

    sendBtn.disabled = true;
    sendBtn.textContent = "Wysy≈Çanie‚Ä¶";

    const fd = new FormData();
    fd.append("message", text);
    fd.append("persona", s.persona);
    for(const it of pendingFiles){
      fd.append("files[]", it.file, it.file.name);
    }

    try{
      const res = await fetch(API_URL, { method: "POST", body: fd });
      const data = await res.json();
      const reply = data.reply || data.error || "(pusta odpowied≈∫)";
      s.messages.push({role:'assistant', content:reply, ts:nowISO(), persona:s.persona});
      s.updatedAt = nowISO();
      saveSessions();
      renderActive();
    }catch(err){
      const msg = "B≈ÇƒÖd po≈ÇƒÖczenia: " + err.message;
      s.messages.push({role:'assistant', content:msg, ts:nowISO(), persona:s.persona});
      s.updatedAt = nowISO();
      saveSessions();
      renderActive();
    }finally{
      pendingFiles = [];
      renderAttachments();
      sendBtn.disabled = false;
      sendBtn.textContent = "Wy≈õlij";
      chatInputEl.focus();
    }
  }

  function updatePersonaUI(){
    document.querySelectorAll('#personas .pill').forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.persona===activePersona);
    });
    const s = getActive();
    if(s && s.persona !== activePersona){
      s.persona = activePersona;
      s.updatedAt = nowISO();
      saveSessions();
      renderSessions(); renderActive();
    }
  }

  document.getElementById('personas').addEventListener('click', (e)=>{
    const b = e.target.closest('.pill');
    if(!b) return;
    activePersona = b.dataset.persona;
    updatePersonaUI();
    if(!getActive()) createSession(activePersona);
  });

  newBtn.addEventListener('click', ()=>{ createSession(activePersona); });
  renameBtn.addEventListener('click', ()=>{
    const s = getActive(); if(!s) return;
    const t = prompt('Nowa nazwa czatu:', s.title);
    if(t){ s.title=t; s.updatedAt=nowISO(); saveSessions(); renderSessions(); renderActive(); }
  });
  clearBtn.addEventListener('click', ()=>{ chatLogEl.innerHTML=""; });
  resetBtn.addEventListener('click', async ()=>{
    const s = getActive(); if(!s) return;
    if(!confirm('Zresetowaƒá rozmowƒô (pamiƒôƒá persony po stronie serwera)?')) return;
    try{
      await fetch(API_URL, { method:"POST", headers:{}, body: (()=>{ const fd=new FormData(); fd.append('reset','true'); fd.append('persona', s.persona); return fd; })() });
    }catch{}
    createSession(s.persona);
  });
  clearAllBtn.addEventListener('click', ()=>{
    if(!confirm('UsunƒÖƒá wszystkie czaty lokalne?')) return;
    sessions = []; activeId = null; saveSessions(); renderSessions(); renderActive();
  });
  searchBtn.addEventListener('click', renderSessions);
  searchBox.addEventListener('keydown', e=>{ if(e.key==='Enter') renderSessions(); });

  exportBtn.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(sessions, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `polubiszto_strefa_ai_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
  });

  importBtn.addEventListener('click', ()=>{
    const inp = document.createElement('input');
    inp.type='file'; inp.accept='application/json';
    inp.onchange = ()=>{
      const f = inp.files[0]; if(!f) return;
      const fr = new FileReader();
      fr.onload = ()=>{
        try{
          const data = JSON.parse(fr.result);
          if(Array.isArray(data)){ sessions = data; saveSessions(); activeId = sessions[0]?.id || null; renderSessions(); renderActive(); }
          else alert('Z≈Çy format pliku.');
        }catch(e){ alert('Nie uda≈Ço siƒô wczytaƒá JSON.'); }
      };
      fr.readAsText(f);
    };
    inp.click();
  });

  sendBtn.addEventListener('click', sendMessage);
  chatInputEl.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
  });

  if(!sessions.length){ createSession(activePersona); }
  else { activeId = sessions[0].id; }
  updatePersonaUI();
  renderSessions();
  renderActive();
})();
</script>
</body>
</html>
