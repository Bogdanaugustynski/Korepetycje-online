{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aliboard 2.5.2 ‚Äî PolubiszTo.pl</title>

<!-- PDF render -->
<link rel="preload" as="script" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- PDF export -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>

<style>
  :root{ --brand:#0b74ff; --ink:#0b1320; --muted:#5b6777; --line:#e6edff; --bg:#f7f9fe; --radius:16px; }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  header{
    position:sticky; top:0; z-index:50; background:#fff; border-bottom:1px solid var(--line);
    display:flex; align-items:stretch; gap:12px; padding:10px 12px; flex-wrap:wrap;
  }
  .left{display:flex;flex-direction:column;gap:8px;min-width:260px}
  .brand{display:flex;align-items:center;gap:10px}
  .mark{width:40px;height:40px;border-radius:10px;overflow:hidden;display:grid;place-items:center;flex:0 0 auto}
  .mark img{width:100%;height:100%;object-fit:contain}
  .state{font-size:12px;color:var(--muted)}
  .toolrow{
    display:flex; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch;
    scroll-snap-type:x proximity; width:100%; padding:8px 0; min-height:48px; align-items:center;
  }
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;font-weight:700;flex:0 0 auto}
  .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
  .btn.is-active{outline:2px solid var(--brand);outline-offset:2px}
  .right{margin-left:auto;display:flex;align-items:flex-start}
  .menu-wrap{position:relative}
  .menu-btn{display:inline-flex;align-items:center;gap:8px}
  .dropdown{
    position:absolute;right:0;top:calc(100% + 8px);min-width:240px;background:#fff;border:1px solid var(--line);
    border-radius:12px;box-shadow:0 12px 40px rgba(11,116,255,.12);padding:8px;display:none
  }
  .dropdown.open{display:block}
  .drop-group{padding:6px}
  .drop-title{font-size:12px;color:var(--muted);margin:4px 6px 6px}
  .drop-item{width:100%;text-align:left;background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;cursor:pointer;margin:4px 0}
  .drop-item.primary{background:var(--brand);color:#fff;border-color:transparent}
  .drop-row{display:flex;gap:6px;flex-wrap:wrap}

  main{min-height:60vh}
  .pages{width:100%;max-width:1100px;margin:20px auto;padding:0 12px}
  .page{
    position:relative;margin:0 auto 24px;background:#fff;border:1px solid var(--line);border-radius:12px;
    box-shadow:0 8px 32px rgba(11,116,255,.08);overflow:hidden
  }
  .page .label{position:absolute;right:10px;bottom:8px;font-size:12px;color:#94a3b8;background:#f8fafc;padding:4px 8px;border-radius:8px}
  .page .stage{position:relative;width:100%;height:0;padding-bottom:70.7%} /* A4 proporcja 1/‚àö2 ‚âà 0.707 */
  canvas{position:absolute;inset:0;width:100%;height:100%;touch-action:none}
  .grid,.overlay{pointer-events:none}

  .footer{position:fixed;right:12px;bottom:12px;display:flex;gap:8px;flex-wrap:wrap}
  .btn[title]{position:relative}
  .btn[title]:hover::after{content:attr(title);position:absolute;top:calc(100% + 6px);left:50%;transform:translateX(-50%);
    background:#111;color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;white-space:nowrap}

  /* inline text editor */
  .text-editor{
    position:absolute;min-width:120px;min-height:24px;padding:4px 6px;background:rgba(255,255,255,.9);
    border:1px dashed var(--brand); border-radius:6px; outline:none; z-index:5
  }
</style>
</head>
<body>
<header>
  <div class="left">
    <div class="brand">
      <div class="mark"><img src="{% static 'img/brand/logo_head.png' %}" alt="PolubiszTo.pl"></div>
      <div>
        <div style="font-weight:800">Aliboard</div>
        <div class="state" id="state">Tryb: Kursor ‚Ä¢ 3px ‚Ä¢ #0b74ff</div>
      </div>
    </div>

    <div class="toolrow" id="tools">
      <button class="btn" data-tool="select" title="Kursor (V)">üñ±Ô∏è V</button>
      <button class="btn" data-tool="pen"    title="O≈Ç√≥wek (P)">‚úèÔ∏è P</button>
      <button class="btn" data-tool="line"   title="Linia (L)">Ôºè L</button>
      <button class="btn" data-tool="eraser" title="Gumka ‚Äî usu≈Ñ kreskƒô (E)">ü©π E</button>
      <button class="btn" data-tool="crop"   title="Wycinanie (C)">‚úÇÔ∏è C</button>
      <button class="btn" data-tool="text"   title="Tekst (T)">T</button>

      <label class="btn" title="Kolor">
        üé® <input type="color" id="color" value="#0b74ff" style="width:28px;height:28px;border:0;padding:0;background:#fff;border-radius:8px;margin-left:6px">
      </label>
      <label class="btn" title="Grubo≈õƒá">
        ‚ÜïÔ∏è
        <select id="size" style="border:1px solid var(--line);border-radius:8px;padding:6px 8px;background:#fff;margin-left:6px">
          <option value="1">1px</option>
          <option value="3" selected>3px</option>
          <option value="5">5px</option>
          <option value="8">8px</option>
        </select>
      </label>

      <label class="btn" title="Wstaw obraz">
        üñºÔ∏è
        <input id="imgInput" type="file" accept="image/*" style="display:none">
      </label>
      <label class="btn" title="Wstaw PDF">
        üìÑ
        <input id="pdfInput" type="file" accept="application/pdf" style="display:none">
      </label>

      <button class="btn" id="undo" title="Cofnij (Ctrl+Z)">‚Ü∂</button>
      <button class="btn" id="redo" title="Pon√≥w (Ctrl+Y)">‚Ü∑</button>
      <button class="btn" id="clear" title="Wyczy≈õƒá bie≈ºƒÖcƒÖ kartkƒô">üóëÔ∏è</button>
    </div>
  </div>

  <div class="right">
    <div class="menu-wrap">
      <button class="btn primary menu-btn" id="menuBtn" aria-expanded="false" aria-controls="dropdown">‚ò∞ Menu</button>
      <div class="dropdown" id="dropdown" role="menu" aria-labelledby="menuBtn">
        <div class="drop-group">
          <div class="drop-title">Zapisz</div>
          <div class="drop-row">
            <button class="drop-item primary" id="savePng">üíæ PNG</button>
            <button class="drop-item" id="saveJpg">üñºÔ∏è JPG</button>
            <button class="drop-item" id="savePdf">üìÑ PDF</button>
          </div>
        </div>
        <div class="drop-group">
          <div class="drop-title">Siatka</div>
          <div class="drop-row">
            <button class="drop-item" data-grid="0">Brak</button>
            <button class="drop-item" data-grid="16">Ma≈Ça</button>
            <button class="drop-item" data-grid="24">≈örednia</button>
            <button class="drop-item" data-grid="32">Du≈ºa</button>
          </div>
        </div>
        <div class="drop-group">
          <div class="drop-title">Strony</div>
          <div class="drop-row">
            <button class="drop-item" id="newPageBtn">‚ûï Nowa kartka A4</button>
            <button class="drop-item" id="newBoardBtn">üßπ Nowa tablica</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="pages" id="pages"></div>
</main>

<div class="footer">
  <a href="{% url 'pokoj_testowy' %}" class="btn">‚Üê Powr√≥t do Pokoju Testowego</a>
  <span class="btn" id="roomInfo" title="Room ID z query string">room_id: ‚Äî</span>
</div>

<script>
(()=>{
// === SAFE banner b≈Çƒôd√≥w (mobile) ===
const $err = document.createElement('div');
$err.style.cssText='position:fixed;left:8px;bottom:8px;z-index:9999;background:#111;color:#fff;padding:6px 10px;border-radius:8px;font:12px system-ui;display:none;max-width:90vw';
document.body.appendChild($err);
const showErr = (m)=>{ $err.textContent='Aliboard: '+m; $err.style.display='block'; };
window.addEventListener('error',(e)=>showErr(e.message));
window.addEventListener('unhandledrejection',(e)=>showErr(String(e.reason && e.reason.message||e.reason)));

// === MODEL STRONY ===
const pagesEl = document.getElementById('pages');
const stateEl = document.getElementById('state');
const qs = new URLSearchParams(location.search);
document.getElementById('roomInfo').textContent = 'room_id: ' + (qs.get('room')||'local-test');

const TOOLS={SELECT:'select',PEN:'pen',LINE:'line',ERASER:'eraser',CROP:'crop',TEXT:'text'};
let tool=TOOLS.SELECT, color='#0b74ff', size=3, gridSize=0;

let PAGES=[]; // [{gridC, drawC, ovlC, g, ctx, ovl, strokes, images, selection, editor}]

// strokes/images format jak wcze≈õniej
function pageStruct(){
  const wrap=document.createElement('div'); wrap.className='page';
  const stage=document.createElement('div'); stage.className='stage';
  const gridC=document.createElement('canvas'); gridC.className='grid';
  const drawC=document.createElement('canvas'); drawC.className='board';
  const ovlC=document.createElement('canvas'); ovlC.className='overlay';
  stage.append(gridC,drawC,ovlC);
  wrap.append(stage);
  const label=document.createElement('div'); label.className='label'; label.textContent='A4';
  wrap.append(label);
  pagesEl.append(wrap);

  const g=gridC.getContext('2d'), ctx=drawC.getContext('2d'), ovl=ovlC.getContext('2d');

  const p={wrap,stage,gridC,drawC,ovlC,g,ctx,ovl,strokes:[],images:[],selection:null,editor:null};
  resizePage(p);
  attachEvents(p);
  drawGrid(p);
  renderAll(p);
  return p;
}
function resizePage(p){
  // ustal fizyczne piksele wg dpr i rozmiaru stage
  const rect=p.stage.getBoundingClientRect(), dpr=window.devicePixelRatio||1;
  [p.gridC,p.drawC,p.ovlC].forEach(c=>{
    c.width=Math.floor(rect.width*dpr); c.height=Math.floor(rect.height*dpr);
    c.style.width=rect.width+'px'; c.style.height=rect.height+'px';
    c.getContext('2d').setTransform(dpr,0,0,dpr,0,0);
  });
}
function drawGrid(p){
  const dpr=window.devicePixelRatio||1, w=p.gridC.width/dpr, h=p.gridC.height/dpr;
  p.g.clearRect(0,0,w,h); if(!gridSize) return;
  p.g.save(); p.g.strokeStyle='#e6edff'; p.g.lineWidth=1;
  for(let x=0;x<=w;x+=gridSize){ p.g.beginPath(); p.g.moveTo(x,0); p.g.lineTo(x,h); p.g.stroke(); }
  for(let y=0;y<=h;y+=gridSize){ p.g.beginPath(); p.g.moveTo(0,y); p.g.lineTo(w,y); p.g.stroke(); }
  p.g.restore();
}
function renderAll(p){
  const dpr=window.devicePixelRatio||1, w=p.drawC.width/dpr, h=p.drawC.height/dpr;
  p.ctx.clearRect(0,0,w,h);
  // obrazy
  for(const im of p.images){
    const img=new Image(); img.onload=()=>p.ctx.drawImage(img,im.x,im.y,im.w,im.h); img.src=im.src;
  }
  // wektory NAD obrazami (wa≈ºne!)
  p.ctx.lineCap='round'; p.ctx.lineJoin='round';
  for(const s of p.strokes){
    if(s.type==='pen'){
      const pts=s.points; if(!pts.length) continue;
      p.ctx.strokeStyle=s.color; p.ctx.lineWidth=s.size;
      p.ctx.beginPath(); p.ctx.moveTo(pts[0].x,pts[0].y);
      for(let i=1;i<pts.length;i++) p.ctx.lineTo(pts[i].x,pts[i].y);
      p.ctx.stroke();
    }else if(s.type==='line'){
      p.ctx.strokeStyle=s.color; p.ctx.lineWidth=s.size;
      p.ctx.beginPath(); p.ctx.moveTo(s.a.x,s.a.y); p.ctx.lineTo(s.b.x,s.b.y); p.ctx.stroke();
    }else if(s.type==='text'){
      p.ctx.save(); p.ctx.fillStyle=s.color;
      p.ctx.font = `${Math.max(14, s.size*6)}px ui-sans-serif, system-ui, Arial`;
      p.ctx.textBaseline='top'; p.ctx.fillText(s.text,s.x,s.y); p.ctx.restore();
    }
  }
}
function compositeToCanvas(p){
  const dpr=window.devicePixelRatio||1, W=p.drawC.width/dpr, H=p.drawC.height/dpr;
  const tmp=document.createElement('canvas'); tmp.width=W; tmp.height=H;
  const t=tmp.getContext('2d');
  if(gridSize){
    t.save(); t.strokeStyle='#e6edff'; t.lineWidth=1;
    for(let x=0;x<=W;x+=gridSize){ t.beginPath(); t.moveTo(x,0); t.lineTo(x,H); t.stroke(); }
    for(let y=0;y<=H;y+=gridSize){ t.beginPath(); t.moveTo(0,y); t.lineTo(W,y); t.stroke(); }
    t.restore();
  }
  let pending=p.images.length;
  const drawVec=()=>{
    t.lineCap='round'; t.lineJoin='round';
    for(const s of p.strokes){
      if(s.type==='pen'){
        const pts=s.points; if(!pts.length) continue;
        t.strokeStyle=s.color; t.lineWidth=s.size;
        t.beginPath(); t.moveTo(pts[0].x,pts[0].y);
        for(let i=1;i<pts.length;i++) t.lineTo(pts[i].x,pts[i].y);
        t.stroke();
      }else if(s.type==='line'){
        t.strokeStyle=s.color; t.lineWidth=s.size; t.beginPath(); t.moveTo(s.a.x,s.a.y); t.lineTo(s.b.x,s.b.y); t.stroke();
      }else if(s.type==='text'){
        t.save(); t.fillStyle=s.color; t.font=`${Math.max(14, s.size*6)}px ui-sans-serif, system-ui, Arial`; t.textBaseline='top'; t.fillText(s.text,s.x,s.y); t.restore();
      }
    }
  };
  if(pending===0){ drawVec(); return tmp; }
  p.images.forEach(im=>{
    const i=new Image(); i.onload=()=>{ t.drawImage(i,im.x,im.y,im.w,im.h); if(--pending===0) drawVec(); }; i.src=im.src;
  });
  return tmp;
}

// === NARZƒòDZIA ===
const toolButtons=[...document.querySelectorAll('[data-tool]')];
function setTool(next){ tool=next; updateState(); toolButtons.forEach(b=>b.classList.toggle('is-active', b.getAttribute('data-tool')===tool)); }
function toolLabel(){ return tool===TOOLS.SELECT?'Kursor':tool===TOOLS.PEN?'O≈Ç√≥wek':tool===TOOLS.LINE?'Linia':tool===TOOLS.ERASER?'Gumka':tool===TOOLS.CROP?'Wycinanie':'Tekst'; }
function updateState(){ stateEl.textContent=`Tryb: ${toolLabel()} ‚Ä¢ ${size}px ‚Ä¢ ${color}`; }

document.getElementById('tools').addEventListener('click', (e)=>{
  const b=e.target.closest('[data-tool]'); if(!b) return; setTool(b.getAttribute('data-tool'));
});

// === PLIK WEJ≈öCIOWY: OBRAZ ===
document.getElementById('imgInput').addEventListener('change',(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const url=URL.createObjectURL(f); const img=new Image();
  const p=PAGES.at(-1);
  img.onload=()=>{
    const dpr=window.devicePixelRatio||1, W=p.drawC.width/dpr, H=p.drawC.height/dpr;
    const ratio=Math.min(W/img.width,H/img.height), w=Math.max(120,img.width*ratio), h=Math.max(120,img.height*ratio);
    const x=(W-w)/2, y=(H-h)/2;
    p.images.push({type:'image',x,y,w,h,src:url}); renderAll(p);
  };
  img.src=url;
});

// === PDF -> obraz ===
document.getElementById('pdfInput').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const ab=await f.arrayBuffer(); const pdf=await pdfjsLib.getDocument({data:ab}).promise;
  let pageNum=1; const ask=prompt(`PDF ma ${pdf.numPages} stron. Numer do wstawienia:`, "1");
  if(ask){ const n=parseInt(ask,10); if(!isNaN(n) && n>=1 && n<=pdf.numPages) pageNum=n; }
  const page=await pdf.getPage(pageNum);
  const viewport=page.getViewport({scale:2}); const c=document.createElement('canvas'); c.width=viewport.width; c.height=viewport.height;
  await page.render({canvasContext:c.getContext('2d'),viewport}).promise;
  const url=c.toDataURL('image/png');
  const p=PAGES.at(-1);
  const dpr=window.devicePixelRatio||1, W=p.drawC.width/dpr, H=p.drawC.height/dpr;
  const ratio=Math.min(W/c.width,H/c.height), w=Math.max(160,c.width*ratio), h=Math.max(160,c.height*ratio);
  const x=(W-w)/2, y=(H-h)/2;
  p.images.push({type:'image',x,y,w,h,src:url,meta:{pdf:true,page:pageNum}});
  renderAll(p);
});

// === UNDO/REDO PER PAGE (prosty stos) ===
const history=[]; let redoStack=[];
function pushHistory(){ const p=PAGES.at(-1); redoStack=[]; history.push(JSON.stringify({pages:PAGES.map(pp=>({strokes:pp.strokes,images:pp.images}))})); if(history.length>50) history.shift(); }
function restoreState(json){
  try{
    const data=JSON.parse(json);
    if(!data.pages) return;
    PAGES.forEach((pp,i)=>{ const snap=data.pages[i]||{strokes:[],images:[]}; pp.strokes=snap.strokes; pp.images=snap.images; renderAll(pp); });
  }catch(e){ showErr('restore: '+e.message); }
}

document.getElementById('undo').addEventListener('click',()=>{
  if(!history.length) return; const last=history.pop(); redoStack.push(JSON.stringify({pages:PAGES.map(pp=>({strokes:pp.strokes,images:pp.images}))})); restoreState(last);
});
document.getElementById('redo').addEventListener('click',()=>{
  if(!redoStack.length) return; const next=redoStack.pop(); history.push(JSON.stringify({pages:PAGES.map(pp=>({strokes:pp.strokes,images:pp.images}))})); restoreState(next);
});
document.getElementById('clear').addEventListener('click',()=>{ const p=PAGES.at(-1); pushHistory(); p.strokes=[]; p.images=[]; p.selection=null; renderAll(p); clearOverlay(p); });

// === MENU ===
const menuBtn=document.getElementById('menuBtn'), dropdown=document.getElementById('dropdown');
function toggleMenu(force){ const open=typeof force==='boolean'?force:!dropdown.classList.contains('open'); dropdown.classList.toggle('open',open); menuBtn.setAttribute('aria-expanded', String(open)); }
menuBtn.addEventListener('click', ()=>toggleMenu());
document.addEventListener('click',(e)=>{ if(!dropdown.contains(e.target) && e.target!==menuBtn) toggleMenu(false); });
dropdown.querySelectorAll('[data-grid]').forEach(btn=>btn.addEventListener('click',()=>{ gridSize=parseInt(btn.getAttribute('data-grid'),10)||0; PAGES.forEach(drawGrid); toggleMenu(false); }));
document.getElementById('newPageBtn').addEventListener('click',()=>{ newPage(); toggleMenu(false); });
document.getElementById('newBoardBtn').addEventListener('click',()=>{ newBoard(); toggleMenu(false); });

document.getElementById('savePng').addEventListener('click',()=>{ const p=PAGES.at(-1); const c=compositeToCanvas(p); downloadURL(c.toDataURL('image/png'),'png'); toggleMenu(false); });
document.getElementById('saveJpg').addEventListener('click',()=>{ const p=PAGES.at(-1); const c=compositeToCanvas(p); downloadURL(c.toDataURL('image/jpeg',0.92),'jpg'); toggleMenu(false); });
document.getElementById('savePdf').addEventListener('click',()=>{
  const {jsPDF}=window.jspdf||{}; if(!jsPDF){ alert('PDF nieza≈Çadowany'); return; }
  const p=PAGES.at(-1); const c=compositeToCanvas(p); const dataUrl=c.toDataURL('image/png');
  const pdf=new jsPDF({orientation:'landscape',unit:'pt',format:'a4'});
  const pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight();
  const img=new Image(); img.onload=()=>{ const r=Math.min(pageW/img.width,pageH/img.height); const w=img.width*r,h=img.height*r; const x=(pageW-w)/2,y=(pageH-h)/2; pdf.addImage(dataUrl,'PNG',x,y,w,h); pdf.save(fn('pdf')); };
  img.src=dataUrl; toggleMenu(false);
});
function downloadURL(url,ext){ const a=document.createElement('a'); a.href=url; a.download=fn(ext); a.click(); }
function fn(ext){ return `aliboard_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.${ext}`; }

// === SELEKCJA/TEKST/CROP ===
function clearOverlay(p){ p.ovl.clearRect(0,0,p.ovlC.width,p.ovlC.height); }
function bboxOfStroke(s){
  if(s.type==='pen'){ const xs=s.points.map(p=>p.x), ys=s.points.map(p=>p.y); return {x:Math.min(...xs),y:Math.min(...ys),w:Math.max(...xs)-Math.min(...xs),h:Math.max(...ys)-Math.min(...ys)}; }
  if(s.type==='line'){ return {x:Math.min(s.a.x,s.b.x),y:Math.min(s.a.y,s.b.y),w:Math.abs(s.a.x-s.b.x),h:Math.abs(s.a.y-s.b.y)}; }
  if(s.type==='text'){ const w=(Math.max(14,s.size*6)*0.6)*(s.text?.length||0), h=Math.max(14,s.size*6); return {x:s.x,y:s.y,w,h}; }
  return {x:0,y:0,w:0,h:0};
}
function drawSelection(p){
  clearOverlay(p); if(!p.selection) return; const b=p.selection.bbox;
  p.ovl.save(); p.ovl.strokeStyle='#0b74ff'; p.ovl.setLineDash([6,4]); p.ovl.lineWidth=1.5; p.ovl.strokeRect(b.x,b.y,b.w,b.h); p.ovl.setLineDash([]); p.ovl.restore();
}
function hitPolyline(pts,p,eps){ for(let i=1;i<pts.length;i++){ if(distToSegment(p,pts[i-1],pts[i])<=eps) return true; } return false; }
function dist(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }
function distToSegment(p,a,b){ const ABx=b.x-a.x,ABy=b.y-a.y,APx=p.x-a.x,APy=p.y-a.y; const ab2=ABx*ABx+ABy*ABy; const t=ab2?Math.max(0,Math.min(1,(APx*ABx+APy*ABy)/ab2)):0; const proj={x:a.x+t*ABx,y:a.y+t*ABy}; return dist(p,proj); }
function hitTest(pnt,p){
  for(let i=p.images.length-1;i>=0;i--){ const im=p.images[i]; if(pnt.x>=im.x&&pnt.x<=im.x+im.w&&pnt.y>=im.y&&pnt.y<=im.y+im.h) return {kind:'image',index:i,bbox:{x:im.x,y:im.y,w:im.w,h:im.h}}; }
  const eps=Math.max(6,size*2);
  for(let i=p.strokes.length-1;i>=0;i--){ const s=p.strokes[i];
    if(s.type==='pen' && hitPolyline(s.points,pnt,eps)) return {kind:'stroke',index:i,bbox:bboxOfStroke(s)};
    if(s.type==='line' && distToSegment(pnt,s.a,s.b)<=eps) return {kind:'stroke',index:i,bbox:bboxOfStroke(s)};
    if(s.type==='text'){ const b=bboxOfStroke(s); if(pnt.x>=b.x&&pnt.x<=b.x+b.w&&pnt.y>=b.y&&pnt.y<=b.y+b.h) return {kind:'stroke',index:i,bbox:b}; }
  }
  return null;
}

// inline text editor
function openEditor(p,x,y){
  closeEditor(p);
  const ed=document.createElement('div'); ed.className='text-editor'; ed.contentEditable='true';
  ed.style.left=x+'px'; ed.style.top=y+'px'; ed.style.color=color; ed.style.fontSize=(Math.max(14,size*6))+'px';
  p.wrap.append(ed); ed.focus();
  const commit=()=>{
    const txt=(ed.textContent||'').trim();
    if(txt){ p.strokes.push({type:'text',color,size,x,y,text:txt}); renderAll(p); }
    closeEditor(p);
  };
  ed.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); commit(); } if(e.key==='Escape'){ closeEditor(p);} });
  ed.addEventListener('blur',commit);
  p.editor=ed;
}
function closeEditor(p){ if(p.editor){ p.editor.remove(); p.editor=null; } }

// crop (prostokƒÖt -> obraz pod spodem dodany na koniec tablicy)
function cropCommit(p,rect){
  const c=compositeToCanvas(p);
  const out=document.createElement('canvas'); out.width=Math.max(10,rect.w); out.height=Math.max(10,rect.h);
  const t=out.getContext('2d'); t.drawImage(c, rect.x, rect.y, rect.w, rect.h, 0, 0, rect.w, rect.h);
  const url=out.toDataURL('image/png');

  // spr√≥buj wkleiƒá poni≈ºej zaznaczenia, a je≈õli brak miejsca ‚Äì na nowej kartce
  const dpr=window.devicePixelRatio||1, H=p.drawC.height/dpr;
  let target=p, x=rect.x, y=rect.y+rect.h+16;
  if(y+rect.h+16>H){ target=newPage(); x=24; y=24; }
  target.images.push({type:'image',x,y,w:rect.w,h:rect.h,src:url});
  renderAll(target);
}

// === INTERAKCJE NA STRONIE ===
function attachEvents(p){
  let drawing=false, startX=0, startY=0, current=null, dragging=null, cropRect=null;

  function getXY(e){
    const r=p.drawC.getBoundingClientRect();
    if(e.touches && e.touches[0]) return {x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top};
    if(typeof e.clientX==='number') return {x:e.clientX-r.left,y:e.clientY-r.top};
    if(e.changedTouches && e.changedTouches[0]) return {x:e.changedTouches[0].clientX-r.left,y:e.changedTouches[0].clientY-r.top};
    return {x:startX,y:startY};
  }

  function begin(x,y){
    closeEditor(p);
    if(tool===TOOLS.SELECT){
      const hit=hitTest({x,y},p); p.selection=hit; drawSelection(p); dragging = hit? {mode:'move',lastX:x,lastY:y}:{mode:null};
      return;
    }
    if(tool===TOOLS.TEXT){ openEditor(p,x,y); return; }
    if(tool===TOOLS.CROP){ cropRect={x,y,w:0,h:0}; drawing=true; return; }

    drawing=true; startX=x; startY=y; pushHistory();
    if(tool===TOOLS.PEN){ current={type:'pen',color,size,points:[{x,y}]}; p.strokes.push(current); renderAll(p); }
    else if(tool===TOOLS.LINE){ current={type:'line',color,size,a:{x,y},b:{x,y}}; }
    else if(tool===TOOLS.ERASER){ eraseAt(p,{x,y}); drawing=false; }
  }
  function move(x,y){
    if(tool===TOOLS.SELECT && dragging && dragging.mode==='move' && p.selection){
      const dx=x-dragging.lastX, dy=y-dragging.lastY; dragging.lastX=x; dragging.lastY=y;
      const sel=p.selection;
      if(sel.kind==='image'){ const im=p.images[sel.index]; im.x+=dx; im.y+=dy; sel.bbox.x+=dx; sel.bbox.y+=dy; }
      else { const s=p.strokes[sel.index];
        if(s.type==='pen') s.points.forEach(pt=>{pt.x+=dx; pt.y+=dy;});
        if(s.type==='line'){ s.a.x+=dx; s.a.y+=dy; s.b.x+=dx; s.b.y+=dy; }
        if(s.type==='text'){ s.x+=dx; s.y+=dy; }
        sel.bbox=bboxOfStroke(s);
      }
      renderAll(p); drawSelection(p); return;
    }
    if(tool===TOOLS.CROP && drawing){
      cropRect.w=Math.abs(x-startX); cropRect.h=Math.abs(y-startY);
      cropRect.x=Math.min(x,startX); cropRect.y=Math.min(y,startY);
      p.ovl.clearRect(0,0,p.ovlC.width,p.ovlC.height);
      p.ovl.save(); p.ovl.strokeStyle='#0b74ff'; p.ovl.setLineDash([6,4]); p.ovl.strokeRect(cropRect.x,cropRect.y,cropRect.w,cropRect.h); p.ovl.restore();
      return;
    }
    if(!drawing) return;
    if(tool===TOOLS.PEN){ current.points.push({x,y}); renderAll(p); }
    else if(tool===TOOLS.LINE){
      current.b={x,y}; p.ovl.clearRect(0,0,p.ovlC.width,p.ovlC.height);
      p.ovl.lineCap='round'; p.ovl.lineJoin='round'; p.ovl.strokeStyle=color; p.ovl.lineWidth=size;
      p.ovl.beginPath(); p.ovl.moveTo(startX,startY); p.ovl.lineTo(x,y); p.ovl.stroke();
    }else if(tool===TOOLS.ERASER){ previewErase(p,{x,y}); }
  }
  function end(x,y){
    if(tool===TOOLS.SELECT){ dragging=null; return; }
    if(tool===TOOLS.CROP && drawing){ p.ovl.clearRect(0,0,p.ovlC.width,p.ovlC.height); if(cropRect && cropRect.w>4 && cropRect.h>4) cropCommit(p,cropRect); drawing=false; cropRect=null; return; }
    if(!drawing) return;
    if(tool===TOOLS.LINE){ p.ovl.clearRect(0,0,p.ovlC.width,p.ovlC.height); current.b={x,y}; p.strokes.push(current); renderAll(p); }
    drawing=false; current=null;
  }

  function eraseAt(p,pt){
    const eps=Math.max(6,size*2);
    for(let i=p.strokes.length-1;i>=0;i--){
      const s=p.strokes[i];
      if(s.type==='pen' && hitPolyline(s.points,pt,eps)){ p.strokes.splice(i,1); renderAll(p); clearOverlay(p); return; }
      if(s.type==='line' && distToSegment(pt,s.a,s.b)<=eps){ p.strokes.splice(i,1); renderAll(p); clearOverlay(p); return; }
      if(s.type==='text'){ const b=bboxOfStroke(s); if(pt.x>=b.x&&pt.x<=b.x+b.w&&pt.y>=b.y&&pt.y<=b.y+b.h){ p.strokes.splice(i,1); renderAll(p); clearOverlay(p); return; } }
    }
  }
  function previewErase(p,pt){
    clearOverlay(p); const eps=Math.max(6,size*2);
    for(let i=p.strokes.length-1;i>=0;i--){
      const s=p.strokes[i]; let hit=false;
      if(s.type==='pen') hit=hitPolyline(s.points,pt,eps);
      else if(s.type==='line') hit=distToSegment(pt,s.a,s.b)<=eps;
      else if(s.type==='text'){ const b=bboxOfStroke(s); hit=(pt.x>=b.x&&pt.x<=b.x+b.w&&pt.y>=b.y&&pt.y<=b.y+b.h); }
      if(hit){
        p.ovl.save(); p.ovl.strokeStyle='#ff3b3b'; p.ovl.lineWidth=Math.max(2,(s.size||2)+2);
        if(s.type==='pen'){ const pts=s.points; p.ovl.beginPath(); p.ovl.moveTo(pts[0].x,pts[0].y); for(let j=1;j<pts.length;j++) p.ovl.lineTo(pts[j].x,pts[j].y); p.ovl.stroke(); }
        else if(s.type==='line'){ p.ovl.beginPath(); p.ovl.moveTo(s.a.x,s.a.y); p.ovl.lineTo(s.b.x,s.b.y); p.ovl.stroke(); }
        else{ const b=bboxOfStroke(s); p.ovl.setLineDash([5,4]); p.ovl.strokeRect(b.x,b.y,b.w,b.h); p.ovl.setLineDash([]); }
        p.ovl.restore(); return;
      }
    }
  }

  p.drawC.addEventListener('mousedown',(e)=>{ const {x,y}=getXY(e); begin(x,y); });
  p.drawC.addEventListener('touchstart',(e)=>{ e.preventDefault(); const {x,y}=getXY(e); begin(x,y); }, {passive:false});
  window.addEventListener('mousemove',(e)=>{ const {x,y}=getXY(e); move(x,y); });
  window.addEventListener('touchmove',(e)=>{ e.preventDefault(); const {x,y}=getXY(e); move(x,y); }, {passive:false});
  window.addEventListener('mouseup',(e)=>{ const {x,y}=getXY(e); end(x,y); });
  window.addEventListener('touchend',(e)=>{ e.preventDefault(); const {x,y}=getXY(e); end(x,y); }, {passive:false});
  window.addEventListener('mouseleave',(e)=>{ const {x,y}=getXY(e); end(x,y); });

  // reaguj na resize
  new ResizeObserver(()=>{ resizePage(p); drawGrid(p); renderAll(p); drawSelection(p); }).observe(p.stage);
}

// === STRONY: nowa + nowa tablica + auto-dok≈Çadanie przy scrollu ===
function newPage(){ const p=pageStruct(); PAGES.push(p); return p; }
function newBoard(){ pagesEl.innerHTML=''; PAGES=[]; newPage(); window.scrollTo({top:0,behavior:'smooth'}); }

function safeInit(){ try{ newBoard(); }catch(err){ showErr('Init: '+err.message); try{ pagesEl.innerHTML=''; PAGES=[]; newPage(); }catch(_){} } }
safeInit();
window.addEventListener('scroll',()=>{
  const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 200;
  if(nearBottom) newPage();
});

// === PICKERY / SKR√ìTY ===
const colorEl=document.getElementById('color'), sizeEl=document.getElementById('size');
colorEl.addEventListener('input',(e)=>{ color=e.target.value; updateState(); });
sizeEl.addEventListener('change',(e)=>{ size=parseInt(e.target.value,10); updateState(); });
updateState(); setTool(TOOLS.SELECT);

window.addEventListener('keydown',(e)=>{
  if(e.key==='v'||e.key==='V') setTool(TOOLS.SELECT);
  if(e.key==='p'||e.key==='P') setTool(TOOLS.PEN);
  if(e.key==='l'||e.key==='L') setTool(TOOLS.LINE);
  if(e.key==='e'||e.key==='E') setTool(TOOLS.ERASER);
  if(e.key==='t'||e.key==='T') setTool(TOOLS.TEXT);
  if(e.key==='c'||e.key==='C') setTool(TOOLS.CROP);
  if(e.ctrlKey && e.key==='z') document.getElementById('undo').click();
  if(e.ctrlKey && (e.key==='y' || (e.shiftKey && e.key==='Z'))) document.getElementById('redo').click();
});

// === AUTOSAVE lokalny (ostatnia tablica) ===
const KEY='aliboard_252_state';
setInterval(()=>{ try{
  const data={pages:PAGES.map(p=>({strokes:p.strokes,images:p.images}))};
  localStorage.setItem(KEY, JSON.stringify(data));
}catch(_){} }, 30000);
(function restoreLocal(){ try{
  const raw=localStorage.getItem(KEY); if(!raw) return;
  const data=JSON.parse(raw); if(!data.pages) return;
  newBoard(); // ju≈º utworzone 1
  // nadpisz zawarto≈õƒá
  PAGES[0].strokes=data.pages[0]?.strokes||[]; PAGES[0].images=data.pages[0]?.images||[];
  renderAll(PAGES[0]);
  for(let i=1;i<data.pages.length;i++){ const p=newPage(); p.strokes=data.pages[i].strokes||[]; p.images=data.pages[i].images||[]; renderAll(p); }
}catch(_){} })();

})();
</script>
</body>
</html>
