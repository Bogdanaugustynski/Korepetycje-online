{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aliboard 2.0 ‚Äî PolubiszTo.pl (test)</title>
<!-- PDF (client-side) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
<style>
  :root{
    --brand:#0b74ff; --ink:#0b1320; --muted:#5b6777; --line:#e6edff;
    --card:#fff; --bg:#f7f9fe; --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{
    position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--line);
    display:flex; align-items:center; gap:10px; padding:10px 12px;
  }
  .brand{display:flex;align-items:center;gap:10px}
  .brand .mark{width:36px;height:36px;border-radius:10px;background:var(--brand);
    display:grid;place-items:center;color:#fff}
  .tools{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
  .btn,.seg{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;font-weight:700}
  .seg{display:inline-flex;gap:6px}
  .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
  .btn.is-active{ outline:2px solid var(--brand); outline-offset:2px }
  .state{font-size:12px;color:var(--muted)}
  .wrap{height:calc(100% - 64px)}
  .stage{
    position:relative; height:100%; width:100%; overflow:hidden; background:#fff;
    border-top:1px solid var(--line);
  }
  canvas{
    position:absolute; inset:0; width:100%; height:100%;
    /* blokuje scroll/gesty przeglƒÖdarki nad canvasem mobilnie */
    touch-action:none;
  }
  #grid{pointer-events:none}
  #overlay{pointer-events:none}
  .footer{
    position:fixed; right:12px; bottom:12px; display:flex; gap:8px; flex-wrap:wrap;
  }
  .picker{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .picker input[type=color]{width:28px;height:28px;border:0;padding:0;background:#fff;border-radius:8px}
  .picker select{border:1px solid var(--line);border-radius:8px;padding:6px 8px;background:#fff}
  .btn[title]{position:relative}
  .btn[title]:hover::after{
    content:attr(title); position:absolute; bottom:calc(100% + 6px); left:50%; transform:translateX(-50%);
    background:#111;color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;white-space:nowrap
  }
  @media (max-width: 720px){
    .tools{gap:6px}
    .btn,.picker{padding:6px 8px}
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="mark">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 7l9-4 9 4-9 4-9-4z" stroke="#fff"/>
      </svg>
    </div>
    <div>
      <div style="font-weight:800">Aliboard</div>
      <div class="state" id="state">Tryb: O≈Ç√≥wek ‚Ä¢ 3px ‚Ä¢ #0b74ff</div>
    </div>
  </div>

  <div class="tools">
    <div class="seg">
      <button class="btn" data-tool="pen"   title="O≈Ç√≥wek (P)">‚úèÔ∏è</button>
      <button class="btn" data-tool="line"  title="Linia (L)">Ôºè</button>
      <button class="btn" data-tool="eraser" title="Gumka (E)">ü©π</button>
      <button class="btn" data-tool="text"  title="Tekst (T)">T</button>
    </div>

    <div class="picker">
      Kolor <input type="color" id="color" value="#0b74ff">
      Grubo≈õƒá
      <select id="size">
        <option value="1">1px</option>
        <option value="3" selected>3px</option>
        <option value="5">5px</option>
        <option value="8">8px</option>
      </select>
    </div>

    <div class="picker">
      Siatka
      <select id="gridSize">
        <option value="0">Brak</option>
        <option value="16">Ma≈Ça</option>
        <option value="24" selected>≈örednia</option>
        <option value="32">Du≈ºa</option>
      </select>
    </div>

    <label class="btn" title="Wstaw obraz">
      üì∑ Obraz
      <input id="imgInput" type="file" accept="image/*" style="display:none">
    </label>

    <button class="btn" id="undo" title="Cofnij (Ctrl+Z)">‚Ü∂</button>
    <button class="btn" id="redo" title="Pon√≥w (Ctrl+Y)">‚Ü∑</button>
    <button class="btn" id="clear" title="Wyczy≈õƒá">üóëÔ∏è</button>
    <button class="btn primary" id="savePng" title="Zapisz jako PNG">üíæ PNG</button>
    <button class="btn primary" id="savePdf" title="Zapisz jako PDF">üìÑ PDF</button>
    <button class="btn primary" id="saveSrv" title="Zapisz na serwer" style="display:none">‚òÅÔ∏è Serwer</button>
  </div>
</header>

<div class="wrap">
  <div class="stage" id="stage">
    <canvas id="grid"></canvas>
    <canvas id="board"></canvas>
    <canvas id="overlay"></canvas>
  </div>
</div>

<div class="footer">
  <a href="{% url 'pokoj_testowy' %}" class="btn">‚Üê Powr√≥t do Pokoju Testowego</a>
  <span class="btn" id="roomInfo" title="Room ID z query string">room_id: ‚Äî</span>
</div>

<script>
(function(){
  // ====== Konfiguracja opcjonalna (serwerowy zapis) ======
  // Je≈õli ustawisz poni≈ºej URL, pojawi siƒô przycisk "Zapisz na serwer".
  // Przyk≈Çad: window.SERVER_SAVE_URL = "/api/boards/save/";
  // Backend: przyjmuje JSON: { filename, image_base64, room_id }
  // window.SERVER_SAVE_URL = undefined;

  // ====== CANVASY / KONTEXTY ======
  const stage = document.getElementById('stage');
  const gridC = document.getElementById('grid');
  const drawC = document.getElementById('board');
  const ovlC  = document.getElementById('overlay');
  const g = gridC.getContext('2d');
  const ctx = drawC.getContext('2d');
  const ovl = ovlC.getContext('2d');
  const stateEl = document.getElementById('state');

  // ====== NARZƒòDZIA ======
  const TOOLS = { PEN:'pen', LINE:'line', ERASER:'eraser', TEXT:'text' };
  let tool = TOOLS.PEN;
  let color = '#0b74ff';
  let size  = 3;
  let gridSize = 24;

  // room_id z query string (?room=UUID) ‚Äî pod test integracji
  const qs = new URLSearchParams(location.search);
  const roomId = qs.get('room') || 'local-test';
  const roomInfo = document.getElementById('roomInfo');
  if(roomInfo){ roomInfo.textContent = 'room_id: ' + roomId; }

  // ====== HISTORIA (undo/redo) ======
  const history = [];
  let redoStack = [];

  // ====== DPI-aware resize ======
  function resize(){
    const {clientWidth:w, clientHeight:h} = stage;
    const dpr = window.devicePixelRatio || 1;
    [gridC, drawC, ovlC].forEach(c=>{
      c.width = Math.floor(w * dpr);
      c.height = Math.floor(h * dpr);
      c.style.width = w+'px';
      c.style.height = h+'px';
      const c2d = c.getContext('2d');
      c2d.setTransform(dpr,0,0,dpr,0,0); // rysujemy w CSS px
    });
    drawGrid();
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  // ====== SIATKA ======
  function drawGrid(){
    const dpr = window.devicePixelRatio || 1;
    const w = gridC.width / dpr;   // w CSS px
    const h = gridC.height / dpr;  // w CSS px
    g.clearRect(0,0,w,h);
    if(!gridSize){ return; }
    g.save();
    g.strokeStyle = '#e6edff';
    g.lineWidth = 1;

    for(let x=0; x<=w; x+=gridSize){
      g.beginPath(); g.moveTo(x,0); g.lineTo(x,h); g.stroke();
    }
    for(let y=0; y<=h; y+=gridSize){
      g.beginPath(); g.moveTo(0,y); g.lineTo(w,y); g.stroke();
    }
    g.restore();
  }

  // ====== SNAPSHOTS ======
  function snapshot(){
    redoStack = [];
    try{
      history.push(drawC.toDataURL('image/png'));
      if(history.length>50) history.shift();
    }catch(_){}
  }

  function restore(dataURL){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>{
        const dpr = window.devicePixelRatio || 1;
        const w = drawC.width / dpr;
        const h = drawC.height / dpr;
        ctx.clearRect(0,0,w,h);
        ctx.drawImage(img, 0, 0, w, h); // rysuj w CSS px
        resolve();
      };
      img.src = dataURL;
    });
  }

  // ====== STATUS ======
  function toolLabel(){
    return tool===TOOLS.PEN?'O≈Ç√≥wek':tool===TOOLS.LINE?'Linia':tool===TOOLS.ERASER?'Gumka':'Tekst';
  }
  function updateState(){
    stateEl.textContent = `Tryb: ${toolLabel()} ‚Ä¢ ${size}px ‚Ä¢ ${color}`;
  }

  // Aktywny wyglƒÖd przycisk√≥w
  const toolButtons = Array.from(document.querySelectorAll('[data-tool]'));
  function setTool(next){
    tool = next;
    updateState();
    toolButtons.forEach(b=>{
      b.classList.toggle('is-active', b.getAttribute('data-tool') === tool);
    });
  }
  toolButtons.forEach(b=>{
    b.addEventListener('click', ()=> setTool(b.getAttribute('data-tool')));
  });

  // Picker-y
  const colorEl = document.getElementById('color');
  const sizeEl  = document.getElementById('size');
  const gridEl  = document.getElementById('gridSize');
  colorEl.addEventListener('input', (e)=>{ color=e.target.value; updateState(); });
  sizeEl.addEventListener('change', (e)=>{ size=parseInt(e.target.value,10); updateState(); });
  gridEl.addEventListener('change', (e)=>{ gridSize=parseInt(e.target.value,10); drawGrid(); });

  // Startowe warto≈õci
  color = colorEl.value;
  size = parseInt(sizeEl.value,10);
  gridSize = parseInt(gridEl.value,10);
  setTool(TOOLS.PEN);

  // ====== WSTAW OBRAZ ======
  document.getElementById('imgInput').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const img = new Image();
    img.onload = ()=>{
      snapshot();
      const dpr = window.devicePixelRatio || 1;
      const W = drawC.width / dpr, H = drawC.height / dpr;
      const ratio = Math.min(W/img.width, H/img.height);
      const w = img.width * ratio;
      const h = img.height * ratio;
      const x = (W - w)/2;
      const y = (H - h)/2;
      ctx.drawImage(img, x, y, w, h);
    };
    img.src = URL.createObjectURL(f);
  });

  // ====== UNDO / REDO / CLEAR ======
  document.getElementById('undo').addEventListener('click', async ()=>{
    if(!history.length) return;
    const last = history.pop();
    redoStack.push(drawC.toDataURL('image/png'));
    await restore(last);
  });
  document.getElementById('redo').addEventListener('click', async ()=>{
    if(!redoStack.length) return;
    const next = redoStack.pop();
    history.push(drawC.toDataURL('image/png'));
    await restore(next);
  });
  document.getElementById('clear').addEventListener('click', ()=>{
    snapshot();
    const dpr = window.devicePixelRatio || 1;
    const w = drawC.width / dpr, h = drawC.height / dpr;
    ctx.clearRect(0,0,w,h);
  });

  // ====== ZAPIS PNG ======
  document.getElementById('savePng').addEventListener('click', ()=>{
    const url = drawC.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = url;
    a.download = `aliboard_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
    a.click();
  });

  // ====== ZAPIS PDF ======
  document.getElementById('savePdf').addEventListener('click', async ()=>{
    try{
      const { jsPDF } = window.jspdf || {}; // umd
      if(!jsPDF){ alert('Biblioteka PDF nie jest jeszcze za≈Çadowana. Spr√≥buj za chwilƒô.'); return; }
      const pdf = new jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
      // render canvas -> image
      const dataUrl = drawC.toDataURL('image/png');
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      // dopasowanie z zachowaniem proporcji
      const img = new Image();
      img.onload = ()=>{
        const ratio = Math.min(pageW/img.width, pageH/img.height);
        const w = img.width * ratio;
        const h = img.height * ratio;
        const x = (pageW - w)/2, y = (pageH - h)/2;
        pdf.addImage(dataUrl, 'PNG', x, y, w, h);
        pdf.save(`aliboard_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`);
      };
      img.src = dataUrl;
    }catch(err){
      console.error(err);
      alert('Nie uda≈Ço siƒô zapisaƒá PDF.');
    }
  });

  // ====== ZAPIS NA SERWER (opcjonalny) ======
  const saveSrvBtn = document.getElementById('saveSrv');
  if(window.SERVER_SAVE_URL){
    saveSrvBtn.style.display = '';
    saveSrvBtn.addEventListener('click', async ()=>{
      try{
        const image_base64 = drawC.toDataURL('image/png');
        const filename = `aliboard_${Date.now()}.png`;
        const payload = { filename, image_base64, room_id: roomId };
        const res = await fetch(window.SERVER_SAVE_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest' },
          body: JSON.stringify(payload),
          credentials:'include'
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
        alert('Zapisano na serwerze ‚úî');
      }catch(e){
        console.error(e);
        alert('B≈ÇƒÖd zapisu na serwer.');
      }
    });
  }

  // ====== RYSOWANIE ======
  let drawing = false;
  let startX=0, startY=0;

  function begin(x,y){
    drawing = true; startX=x; startY=y;
    snapshot();
    if(tool===TOOLS.PEN || tool===TOOLS.ERASER){
      ctx.beginPath(); ctx.moveTo(x,y);
    }
  }
  function move(x,y){
    if(!drawing) return;
    if(tool===TOOLS.PEN){
      ctx.globalCompositeOperation = 'source-over';
      ctx.lineCap = 'round'; ctx.lineJoin='round';
      ctx.strokeStyle = color; ctx.lineWidth = size;
      ctx.lineTo(x,y); ctx.stroke();
    }else if(tool===TOOLS.ERASER){
      ctx.globalCompositeOperation = 'destination-out';
      ctx.lineCap = 'round'; ctx.lineJoin='round';
      ctx.lineWidth = size*2;
      ctx.lineTo(x,y); ctx.stroke();
      ctx.globalCompositeOperation = 'source-over';
    }else if(tool===TOOLS.LINE){
      ovl.clearRect(0,0, ovlC.width, ovlC.height);
      ovl.lineCap='round'; ovl.lineJoin='round';
      ovl.strokeStyle = color; ovl.lineWidth = size;
      ovl.beginPath(); ovl.moveTo(startX,startY); ovl.lineTo(x,y); ovl.stroke();
    }
  }
  function end(x,y){
    if(!drawing) return;
    if(tool===TOOLS.LINE){
      ovl.clearRect(0,0, ovlC.width, ovlC.height);
      ctx.lineCap='round'; ctx.lineJoin='round';
      ctx.strokeStyle = color; ctx.lineWidth = size;
      ctx.beginPath(); ctx.moveTo(startX,startY); ctx.lineTo(x,y); ctx.stroke();
    }else if(tool===TOOLS.TEXT){
      const txt = prompt('Wpisz tekst:');
      if(txt && txt.trim()){
        ctx.save();
        ctx.fillStyle = color;
        ctx.font = `${Math.max(14, size*6)}px ui-sans-serif, system-ui, Arial`;
        ctx.textBaseline = 'top';
        ctx.fillText(txt.trim(), x, y);
        ctx.restore();
      }else{
        // je≈õli anulowano, cofamy snapshot dodany przy begin()
        if(history.length){ restore(history.pop()); }
      }
    }
    drawing = false;
  }

  // Pozycja wska≈∫nika (mysz/dotyk)
  function getXY(e){
    const rect = drawC.getBoundingClientRect();
    if(e.touches && e.touches[0]){
      return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
    }
    if(typeof e.clientX === 'number'){
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }
    if(e.changedTouches && e.changedTouches[0]){
      return { x: e.changedTouches[0].clientX - rect.left, y: e.changedTouches[0].clientY - rect.top };
    }
    return { x: startX, y: startY };
  }

  // Eventy z poprawkami mobilnymi (passive:false + preventDefault)
  drawC.addEventListener('mousedown', (e)=>{ const {x,y}=getXY(e); begin(x,y); });
  drawC.addEventListener('touchstart', (e)=>{ e.preventDefault(); const {x,y}=getXY(e); begin(x,y); }, {passive:false});

  window.addEventListener('mousemove', (e)=>{ if(!drawing) return; const {x,y}=getXY(e); move(x,y); }, {passive:true});
  window.addEventListener('touchmove',  (e)=>{ if(!drawing) return; e.preventDefault(); const {x,y}=getXY(e); move(x,y); }, {passive:false});

  window.addEventListener('mouseup',   (e)=>{ if(!drawing) return; const {x,y}=getXY(e); end(x,y); }, {passive:true});
  window.addEventListener('touchend',  (e)=>{ if(!drawing) return; e.preventDefault(); const {x,y}=getXY(e); end(x,y); }, {passive:false});
  window.addEventListener('mouseleave',(e)=>{ if(!drawing) return; const {x,y}=getXY(e); end(x,y); }, {passive:true});

  // Skr√≥ty klawiaturowe
  window.addEventListener('keydown', (e)=>{
    if(e.key==='p'||e.key==='P') setTool(TOOLS.PEN);
    if(e.key==='l'||e.key==='L') setTool(TOOLS.LINE);
    if(e.key==='e'||e.key==='E') setTool(TOOLS.ERASER);
    if(e.key==='t'||e.key==='T') setTool(TOOLS.TEXT);
    if(e.ctrlKey && e.key==='z'){ document.getElementById('undo').click(); }
    if(e.ctrlKey && (e.key==='y' || (e.shiftKey && e.key==='Z'))){ document.getElementById('redo').click(); }
  });

  // ====== AUTOSAVE lokalny ======
  const AUTOSAVE_KEY = 'aliboard_autosave_v2';
  function autosave(){
    try{ localStorage.setItem(AUTOSAVE_KEY, drawC.toDataURL('image/png')); }catch(_){}
  }
  setInterval(autosave, 30000); // co 30 s

  (function tryRestoreFromLocal(){
    const url = localStorage.getItem(AUTOSAVE_KEY);
    if(!url) return;
    restore(url);
  })();

  updateState();
})();
</script>
</body>
</html>
