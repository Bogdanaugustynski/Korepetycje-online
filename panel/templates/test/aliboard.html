{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aliboard 2.4.1 ‚Äî PolubiszTo.pl</title>

<link rel="preload" as="script" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>

<style>
  :root{ --brand:#0b74ff; --ink:#0b1320; --muted:#5b6777; --line:#e6edff; --bg:#f7f9fe; --radius:16px; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{
    position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--line);
    display:flex; align-items:stretch; gap:16px; padding:10px 12px; flex-wrap:wrap;
  }
  .left{ display:flex; flex-direction:column; gap:8px; min-width:260px; }
  .brand{display:flex;align-items:center;gap:10px}
  .brand .mark{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;flex:0 0 auto;overflow:hidden}
  .brand .mark img{width:100%;height:100%;object-fit:contain}
  .state{font-size:12px;color:var(--muted)}
  .toolrow{
    display:flex; gap:8px; flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; padding:8px 0;
  }
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;font-weight:700;flex:0 0 auto}
  .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
  .btn.is-active{ outline:2px solid var(--brand); outline-offset:2px }
  .right{margin-left:auto; display:flex; align-items:flex-start;}
  .menu-wrap{position:relative}
  .menu-btn{display:inline-flex; align-items:center; gap:8px}
  .dropdown{
    position:absolute; right:0; top:calc(100% + 8px); min-width:240px;
    background:#fff; border:1px solid var(--line); border-radius:12px;
    box-shadow:0 12px 40px rgba(11,116,255,.12); padding:8px; display:none;
  }
  .dropdown.open{display:block}
  .drop-group{padding:6px 6px}
  .drop-title{font-size:12px; color:var(--muted); margin:4px 6px 6px}
  .drop-item{width:100%; text-align:left; background:#fff; border:1px solid var(--line);
    border-radius:10px; padding:8px 10px; cursor:pointer; margin:4px 0}
  .drop-row{display:flex; gap:6px; flex-wrap:wrap}
  .drop-item.primary{background:var(--brand);color:#fff;border-color:transparent}

  /* Obszar kartek */
  .wrap{ height:calc(100% - 64px); overflow:auto; padding:16px; }
  .pages{ display:flex; flex-direction:column; align-items:center; gap:24px; }
  .page{
    position:relative; background:#fff; border:1px solid var(--line);
    border-radius:12px; box-shadow:0 8px 30px rgba(11,116,255,.10);
    width:min(1200px, 96vw); aspect-ratio: 1 / 1.4142; /* A4 */
    overflow:hidden;
  }
  /* porzƒÖdek warstw */
  .page .grid{ position:absolute; inset:0; width:100%; height:100%; z-index:0; pointer-events:none; }
  .page .board{ position:absolute; inset:0; width:100%; height:100%; z-index:1; touch-action:none; }
  .page .overlay{ position:absolute; inset:0; width:100%; height:100%; z-index:2; pointer-events:none; }

  .btn[title]{position:relative}
  .btn[title]:hover::after{
    content:attr(title); position:absolute; top:calc(100% + 6px); left:50%; transform:translateX(-50%);
    background:#111;color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;white-space:nowrap
  }

  .text-editor{
    position:absolute; z-index:50; min-width:60px;
    border:1px solid var(--line); border-radius:8px; padding:6px 8px; background:#fff;
    font: 16px ui-sans-serif, system-ui, Arial; color: var(--ink);
    outline: none; box-shadow:0 6px 20px rgba(15,23,42,.15);
  }
  .crop-rect{ position:absolute; z-index:40; border:2px dashed #0b74ff; background:rgba(11,116,255,.06); pointer-events:none; }

  .footer{ position:fixed; right:12px; bottom:12px; display:flex; gap:8px; flex-wrap:wrap; }
</style>
</head>
<body>
<header>
  <div class="left">
    <div class="brand">
      <div class="mark">
        <img src="{% static 'img/brand/logo_head.png' %}" alt="PolubiszTo.pl">
      </div>
      <div>
        <div style="font-weight:800">Aliboard</div>
        <div class="state" id="state">Tryb: Kursor ‚Ä¢ 3px ‚Ä¢ #0b74ff</div>
      </div>
    </div>

    <div class="toolrow" id="tools">
      <button class="btn" data-tool="select" title="Kursor (V)">üñ±Ô∏è</button>
      <button class="btn" data-tool="pen"    title="O≈Ç√≥wek (P)">‚úèÔ∏è</button>
      <button class="btn" data-tool="line"   title="Linia (L)">Ôºè</button>
      <button class="btn" data-tool="eraser" title="Gumka (E)">ü©π</button>
      <button class="btn" data-tool="text"   title="Tekst (T)">T</button>
      <button class="btn" data-tool="crop"   title="Wycinanie (C)">‚úÇÔ∏è</button>

      <label class="btn" title="Kolor">
        üé® <input type="color" id="color" value="#0b74ff" style="width:28px;height:28px;border:0;padding:0;background:#fff;border-radius:8px;margin-left:6px">
      </label>
      <label class="btn" title="Grubo≈õƒá">
        ‚ÜïÔ∏è
        <select id="size" style="border:1px solid var(--line);border-radius:8px;padding:6px 8px;background:#fff;margin-left:6px">
          <option value="1">1px</option>
          <option value="3" selected>3px</option>
          <option value="5">5px</option>
          <option value="8">8px</option>
        </select>
      </label>

      <label class="btn" title="Wstaw obraz">
        üñºÔ∏è <input id="imgInput" type="file" accept="image/*" style="display:none">
      </label>
      <label class="btn" title="Wstaw PDF">
        üìÑ <input id="pdfInput" type="file" accept="application/pdf" style="display:none">
      </label>

      <button class="btn" id="undo" title="Cofnij">‚Ü∂</button>
      <button class="btn" id="redo" title="Pon√≥w">‚Ü∑</button>
      <button class="btn" id="clear" title="Wyczy≈õƒá tƒô stronƒô">üóëÔ∏è</button>
    </div>
  </div>

  <div class="right">
    <div class="menu-wrap">
      <button class="btn primary menu-btn" id="menuBtn" aria-expanded="false" aria-controls="dropdown">‚ò∞ Menu</button>
      <div class="dropdown" id="dropdown" role="menu" aria-labelledby="menuBtn">
        <div class="drop-group">
          <div class="drop-title">Zapisz (aktualna strona)</div>
          <div class="drop-row">
            <button class="drop-item primary" id="savePng">üíæ PNG</button>
            <button class="drop-item" id="saveJpg">üñºÔ∏è JPG</button>
            <button class="drop-item" id="savePdf">üìÑ PDF</button>
          </div>
        </div>
        <div class="drop-group">
          <div class="drop-title">Siatka</div>
          <div class="drop-row">
            <button class="drop-item" data-grid="0">Brak</button>
            <button class="drop-item" data-grid="16">Ma≈Ça</button>
            <button class="drop-item" data-grid="24">≈örednia</button>
            <button class="drop-item" data-grid="32">Du≈ºa</button>
          </div>
        </div>
        <div class="drop-group">
          <div class="drop-title">Strony</div>
          <div class="drop-row">
            <button class="drop-item" id="newPageBtn">‚ûï Nowa kartka A4</button>
            <button class="drop-item" id="newBoardBtn">üßπ Nowa tablica</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="wrap" id="wrap">
  <div class="pages" id="pages"></div>
</div>

<div class="footer">
  <a href="{% url 'pokoj_testowy' %}" class="btn">‚Üê Powr√≥t do Pokoju Testowego</a>
  <span class="btn" id="roomInfo" title="Room ID z query string">room_id: ‚Äî</span>
</div>

<script>
(function(){
  /* --- STAN --- */
  const wrapEl = document.getElementById('wrap');
  const pagesEl= document.getElementById('pages');
  const stateEl= document.getElementById('state');
  const qs = new URLSearchParams(location.search);
  document.getElementById('roomInfo').textContent = 'room_id: ' + (qs.get('room') || 'local-test');

  const TOOLS={SELECT:'select',PEN:'pen',LINE:'line',ERASER:'eraser',TEXT:'text',CROP:'crop'};
  let tool=TOOLS.SELECT, color='#0b74ff', size=3, gridSize=0;

  const PAGES=[]; // {el,gridC,drawC,ovlC,g,ctx,ovl,state}
  function currentPage(){ return PAGES[PAGES.length-1] || null; }

  function makeEmpty(){ return {strokes:[], images:[], history:[], redo:[], selection:null, dragging:null}; }

  /* --- STRONA --- */
  function createPage(){
    const page=document.createElement('div'); page.className='page';
    const gridC=document.createElement('canvas'); gridC.className='grid';
    const drawC=document.createElement('canvas'); drawC.className='board';
    const ovlC =document.createElement('canvas'); ovlC.className='overlay';
    page.append(gridC,drawC,ovlC); pagesEl.append(page);

    const g=gridC.getContext('2d'), ctx=drawC.getContext('2d'), ovl=ovlC.getContext('2d');
    const p={el:page,gridC,drawC,ovlC,g,ctx,ovl,state:makeEmpty()};
    PAGES.push(p); resize(p); drawGrid(p); renderAll(p); bindPage(p);
    return p;
  }
  function resize(p){
    const r=p.el.getBoundingClientRect(), dpr=window.devicePixelRatio||1;
    [p.gridC,p.drawC,p.ovlC].forEach(c=>{
      c.width=Math.floor(r.width*dpr); c.height=Math.floor(r.height*dpr);
      c.style.width=r.width+'px'; c.style.height=r.height+'px';
      c.getContext('2d').setTransform(dpr,0,0,dpr,0,0);
    });
  }
  function drawGrid(p){
    const dpr=window.devicePixelRatio||1, w=p.gridC.width/dpr, h=p.gridC.height/dpr;
    p.g.clearRect(0,0,w,h); if(!gridSize) return;
    p.g.save(); p.g.strokeStyle='#e6edff'; p.g.lineWidth=1;
    for(let x=0;x<=w;x+=gridSize){ p.g.beginPath(); p.g.moveTo(x,0); p.g.lineTo(x,h); p.g.stroke(); }
    for(let y=0;y<=h;y+=gridSize){ p.g.beginPath(); p.g.moveTo(0,y); p.g.lineTo(w,y); p.g.stroke(); }
    p.g.restore();
  }
  function renderAll(p){
    const dpr=window.devicePixelRatio||1, w=p.drawC.width/dpr, h=p.drawC.height/dpr;
    p.ctx.clearRect(0,0,w,h);
    for(const im of p.state.images){ if(im.img) p.ctx.drawImage(im.img,im.x,im.y,im.w,im.h); }
    p.ctx.lineCap='round'; p.ctx.lineJoin='round';
    for(const s of p.state.strokes){
      if(s.type==='pen'){ const pts=s.points; if(!pts.length) continue; p.ctx.strokeStyle=s.color; p.ctx.lineWidth=s.size; p.ctx.beginPath(); p.ctx.moveTo(pts[0].x,pts[0].y); for(let i=1;i<pts.length;i++) p.ctx.lineTo(pts[i].x,pts[i].y); p.ctx.stroke(); }
      else if(s.type==='line'){ p.ctx.strokeStyle=s.color; p.ctx.lineWidth=s.size; p.ctx.beginPath(); p.ctx.moveTo(s.a.x,s.a.y); p.ctx.lineTo(s.b.x,s.b.y); p.ctx.stroke(); }
      else if(s.type==='text'){ p.ctx.save(); p.ctx.fillStyle=s.color; p.ctx.font=`${Math.max(14,s.size*6)}px ui-sans-serif, system-ui, Arial`; p.ctx.textBaseline='top'; p.ctx.fillText(s.text,s.x,s.y); p.ctx.restore(); }
    }
  }
  function reviveImage(im,p){
    const obj={x:im.x,y:im.y,w:im.w,h:im.h,src:im.src,meta:im.meta,img:null};
    const el=new Image(); el.onload=()=>{ obj.img=el; renderAll(p); }; el.src=im.src; return obj;
  }
  function addImageFromSrc(src,w,h,x,y,meta,p){
    pushHistory(p);
    const im=reviveImage({src,w,h,x,y,meta},p);
    p.state.images.push(im); renderAll(p);
  }

  /* --- Historia --- */
  function snapshot(p){ return JSON.stringify({strokes:p.state.strokes, images:p.state.images.map(im=>({x:im.x,y:im.y,w:im.w,h:im.h,src:im.src,meta:im.meta}))}); }
  function pushHistory(p){ p.state.redo=[]; try{ p.state.history.push(snapshot(p)); if(p.state.history.length>100) p.state.history.shift(); }catch{} }
  function restore(p,json){
    try{ const s=JSON.parse(json); p.state.strokes=s.strokes||[]; p.state.images=(s.images||[]).map(im=>reviveImage(im,p)); renderAll(p); drawSelection(p); }catch{}
  }

  /* --- Selektor --- */
  function clearOverlay(p){ p.ovl.clearRect(0,0,p.ovlC.width,p.ovlC.height); }
  function bboxStroke(s){
    if(s.type==='pen'){ const xs=s.points.map(q=>q.x), ys=s.points.map(q=>q.y); return {x:Math.min(...xs),y:Math.min(...ys),w:Math.max(...xs)-Math.min(...xs),h:Math.max(...ys)-Math.min(...ys)}; }
    if(s.type==='line'){ return {x:Math.min(s.a.x,s.b.x),y:Math.min(s.a.y,s.b.y),w:Math.abs(s.a.x-s.b.x),h:Math.abs(s.a.y-s.b.y)}; }
    if(s.type==='text'){ const w=(Math.max(14,s.size*6)*0.6)*(s.text?.length||0), h=Math.max(14,s.size*6); return {x:s.x,y:s.y,w,h}; }
    return {x:0,y:0,w:0,h:0};
  }
  function drawSelection(p){
    clearOverlay(p); const sel=p.state.selection; if(!sel) return; const b=sel.bbox;
    p.ovl.save(); p.ovl.strokeStyle='#0b74ff'; p.ovl.lineWidth=1.5; p.ovl.setLineDash([6,4]); p.ovl.strokeRect(b.x,b.y,b.w,b.h); p.ovl.setLineDash([]); p.ovl.restore();
  }
  function dist(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }
  function distSeg(p,a,b){ const ABx=b.x-a.x,ABy=b.y-a.y,APx=p.x-a.x,APy=p.y-a.y; const ab2=ABx*ABx+ABy*ABy; const t=ab2?Math.max(0,Math.min(1,(APx*ABx+APy*ABy)/ab2)):0; const proj={x:a.x+t*ABx,y:a.y+t*ABy}; return dist(p,proj); }
  function hitPolyline(pts,pt,eps){ for(let i=1;i<pts.length;i++){ if(distSeg(pt,pts[i-1],pts[i])<=eps) return true; } return false; }
  function hitTest(pt,p){
    for(let i=p.state.images.length-1;i>=0;i--){ const im=p.state.images[i]; if(pt.x>=im.x&&pt.x<=im.x+im.w&&pt.y>=im.y&&pt.y<=im.y+im.h) return {kind:'image',index:i,bbox:{x:im.x,y:im.y,w:im.w,h:im.h}}; }
    const eps=Math.max(6,size*2);
    for(let i=p.state.strokes.length-1;i>=0;i--){ const s=p.state.strokes[i];
      if(s.type==='pen' && hitPolyline(s.points,pt,eps)) return {kind:'stroke',index:i,bbox:bboxStroke(s)};
      if(s.type==='line'&& distSeg(pt,s.a,s.b)<=eps)   return {kind:'stroke',index:i,bbox:bboxStroke(s)};
      if(s.type==='text'){ const b=bboxStroke(s); if(pt.x>=b.x&&pt.x<=b.x+b.w&&pt.y>=b.y&&pt.y<=b.y+b.h) return {kind:'stroke',index:i,bbox:b}; }
    }
    return null;
  }

  /* --- Gumka podglƒÖd --- */
  function previewErase(pt,p){
    clearOverlay(p); if(p.state.selection) drawSelection(p);
    const eps=Math.max(6,size*2);
    for(let i=p.state.strokes.length-1;i>=0;i--){
      const s=p.state.strokes[i]; let ok=false;
      if(s.type==='pen') ok=hitPolyline(s.points,pt,eps);
      else if(s.type==='line') ok=distSeg(pt,s.a,s.b)<=eps;
      else if(s.type==='text'){ const b=bboxStroke(s); ok=(pt.x>=b.x&&pt.x<=b.x+b.w&&pt.y>=b.y&&pt.y<=b.y+b.h); }
      if(ok){
        p.ovl.save(); p.ovl.strokeStyle='#ff3b3b'; p.ovl.lineWidth=Math.max(2,(s.size||2)+2);
        if(s.type==='pen'){ const pts=s.points; p.ovl.beginPath(); p.ovl.moveTo(pts[0].x,pts[0].y); for(let j=1;j<pts.length;j++) p.ovl.lineTo(pts[j].x,pts[j].y); p.ovl.stroke(); }
        else if(s.type==='line'){ p.ovl.beginPath(); p.ovl.moveTo(s.a.x,s.a.y); p.ovl.lineTo(s.b.x,s.b.y); p.ovl.stroke(); }
        else{ const b=bboxStroke(s); p.ovl.setLineDash([5,4]); p.ovl.strokeRect(b.x,b.y,b.w,b.h); p.ovl.setLineDash([]); }
        p.ovl.restore(); return;
      }
    }
  }
  function eraseAt(pt,p){
    const eps=Math.max(6,size*2);
    for(let i=p.state.strokes.length-1;i>=0;i--){
      const s=p.state.strokes[i];
      if(s.type==='pen' && hitPolyline(s.points,pt,eps)){ p.state.strokes.splice(i,1); renderAll(p); clearOverlay(p); return; }
      if(s.type==='line'&& distSeg(pt,s.a,s.b)<=eps){ p.state.strokes.splice(i,1); renderAll(p); clearOverlay(p); return; }
      if(s.type==='text'){ const b=bboxStroke(s); if(pt.x>=b.x&&pt.x<=b.x+b.w&&pt.y>=b.y&&pt.y<=b.y+b.h){ p.state.strokes.splice(i,1); renderAll(p); clearOverlay(p); return; } }
    }
  }

  /* --- Tekst --- */
  let activeEditor=null;
  function openTextEditor(x,y,p){
    closeTextEditor(false);
    const ed=document.createElement('textarea'); ed.className='text-editor';
    const r=p.el.getBoundingClientRect(); ed.style.left=(r.left+x)+'px'; ed.style.top=(r.top+y)+'px';
    ed.style.fontSize=Math.max(14,size*6)+'px'; ed.placeholder='Wpisz tekst‚Ä¶';
    document.body.appendChild(ed); ed.focus();
    ed.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); closeTextEditor(true,p,x,y); } if(e.key==='Escape'){ e.preventDefault(); closeTextEditor(false);} });
    ed.addEventListener('blur',()=>closeTextEditor(true,p,x,y));
    activeEditor={el:ed};
  }
  function closeTextEditor(commit,p,x,y){
    if(!activeEditor) return; const el=activeEditor.el; const val=el.value.trim(); el.remove(); activeEditor=null;
    if(commit&&p&&val){ pushHistory(p); p.state.strokes.push({type:'text',color,size,x,y,text:val}); renderAll(p); }
  }

  /* --- Crop --- */
  let cropRectEl=null,cropStart=null;
  function beginCrop(x,y,p){
    cropCancel(); cropStart={x,y};
    const r=p.el.getBoundingClientRect();
    cropRectEl=document.createElement('div'); cropRectEl.className='crop-rect';
    cropRectEl.style.left=(r.left+x)+'px'; cropRectEl.style.top=(r.top+y)+'px';
    cropRectEl.style.width='0px'; cropRectEl.style.height='0px'; document.body.appendChild(cropRectEl);
  }
  function updateCrop(x,y,p){
    if(!cropRectEl||!cropStart) return; const r=p.el.getBoundingClientRect();
    const x0=Math.min(cropStart.x,x), y0=Math.min(cropStart.y,y), x1=Math.max(cropStart.x,x), y1=Math.max(cropStart.y,y);
    cropRectEl.style.left=(r.left+x0)+'px'; cropRectEl.style.top=(r.top+y0)+'px';
    cropRectEl.style.width=(x1-x0)+'px'; cropRectEl.style.height=(y1-y0)+'px';
  }
  function cropCancel(){ cropStart=null; if(cropRectEl){ cropRectEl.remove(); cropRectEl=null; } }
  async function finalizeCrop(x,y,p){
    if(!cropRectEl||!cropStart) return;
    const x0=Math.min(cropStart.x,x), y0=Math.min(cropStart.y,y), x1=Math.max(cropStart.x,x), y1=Math.max(cropStart.y,y);
    cropCancel();
    const comp=await compositePageCanvas(p);
    const sx=Math.max(0,Math.floor(x0)), sy=Math.max(0,Math.floor(y0));
    const sw=Math.max(1,Math.floor(x1-x0)), sh=Math.max(1,Math.floor(y1-y0));
    const cut=document.createElement('canvas'); cut.width=sw; cut.height=sh; cut.getContext('2d').drawImage(comp,sx,sy,sw,sh,0,0,sw,sh);
    const url=cut.toDataURL('image/png');

    // wklej pod najni≈ºszym tekstem, albo nowa kartka
    const rect=p.el.getBoundingClientRect(), pageW=rect.width, pageH=rect.height;
    const bottoms=p.state.strokes.filter(s=>s.type==='text').map(s=>{const b=bboxStroke(s);return b.y+b.h;});
    const lowest= bottoms.length?Math.max(...bottoms):0;
    const margin=24, maxW=pageW*0.9, scale=Math.min(1,maxW/sw), w=Math.max(80,sw*scale), h=Math.max(80,sh*scale);
    let target=p, xPos=Math.floor((pageW-w)/2), yPos=lowest+margin;
    if(yPos+h+margin>pageH){ target=createPage(); const r2=target.el.getBoundingClientRect(); xPos=Math.floor((r2.width-w)/2); yPos=24; }
    addImageFromSrc(url,w,h,xPos,yPos,{crop:true},target);
    target.el.scrollIntoView({behavior:'smooth',block:'center'});
  }
  async function compositePageCanvas(p){
    const dpr=window.devicePixelRatio||1, W=p.drawC.width/dpr, H=p.drawC.height/dpr;
    const tmp=document.createElement('canvas'); tmp.width=W; tmp.height=H; const t=tmp.getContext('2d');
    if(gridSize){ t.save(); t.strokeStyle='#e6edff'; t.lineWidth=1; for(let x=0;x<=W;x+=gridSize){ t.beginPath(); t.moveTo(x,0); t.lineTo(x,H); t.stroke(); } for(let y=0;y<=H;y+=gridSize){ t.beginPath(); t.moveTo(0,y); t.lineTo(W,y); t.stroke(); } t.restore(); }
    await Promise.all(p.state.images.map(im=>im.img?Promise.resolve():new Promise(res=>{ const el=new Image(); el.onload=()=>{im.img=el;res();}; el.src=im.src; })));
    for(const im of p.state.images){ if(im.img) t.drawImage(im.img,im.x,im.y,im.w,im.h); }
    t.lineCap='round'; t.lineJoin='round';
    for(const s of p.state.strokes){
      if(s.type==='pen'){ const pts=s.points; if(!pts.length) continue; t.strokeStyle=s.color; t.lineWidth=s.size; t.beginPath(); t.moveTo(pts[0].x,pts[0].y); for(let i=1;i<pts.length;i++) t.lineTo(pts[i].x,pts[i].y); t.stroke(); }
      else if(s.type==='line'){ t.strokeStyle=s.color; t.lineWidth=s.size; t.beginPath(); t.moveTo(s.a.x,s.a.y); t.lineTo(s.b.x,s.b.y); t.stroke(); }
      else if(s.type==='text'){ t.save(); t.fillStyle=s.color; t.font=`${Math.max(14,s.size*6)}px ui-sans-serif, system-ui, Arial`; t.textBaseline='top'; t.fillText(s.text,s.x,s.y); t.restore(); }
    }
    return tmp;
  }

  /* --- Zdarzenia na stronie (mysz + dotyk) --- */
  function bindPage(p){
    function getXY(e){
      const r=p.drawC.getBoundingClientRect();
      if(e.touches&&e.touches[0]) return {x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top};
      if(typeof e.clientX==='number') return {x:e.clientX-r.left,y:e.clientY-r.top};
      if(e.changedTouches&&e.changedTouches[0]) return {x:e.changedTouches[0].clientX-r.left,y:e.changedTouches[0].clientY-r.top};
      return {x:0,y:0};
    }
    let drawing=false,startX=0,startY=0,current=null,cropping=false;

    function start(x,y){
      if(tool===TOOLS.SELECT){ p.state.selection = hitTest({x,y},p) || null; drawSelection(p); p.state.dragging = p.state.selection ? {startX:x,startY:y} : null; return; }
      if(tool===TOOLS.TEXT){ openTextEditor(x,y,p); return; }
      if(tool===TOOLS.CROP){ beginCrop(x,y,p); cropping=true; return; }
      drawing=true; startX=x; startY=y; pushHistory(p);
      if(tool===TOOLS.PEN){ current={type:'pen',color,size,points:[{x,y}]}; p.state.strokes.push(current); renderAll(p); }
      else if(tool===TOOLS.LINE){ current={type:'line',color,size,a:{x,y},b:{x,y}}; clearOverlay(p); }
      else if(tool===TOOLS.ERASER){ eraseAt({x,y},p); drawing=false; current=null; }
    }
    function move(x,y){
      if(tool===TOOLS.SELECT){
        if(p.state.dragging && p.state.selection){
          const dx=x-p.state.dragging.startX, dy=y-p.state.dragging.startY;
          p.state.dragging.startX=x; p.state.dragging.startY=y;
          const sel=p.state.selection;
          if(sel.kind==='image'){ const im=p.state.images[sel.index]; im.x+=dx; im.y+=dy; sel.bbox.x+=dx; sel.bbox.y+=dy; }
          else{ const s=p.state.strokes[sel.index]; if(s.type==='pen') s.points.forEach(pt=>{pt.x+=dx;pt.y+=dy;});
                if(s.type==='line'){ s.a.x+=dx; s.a.y+=dy; s.b.x+=dx; s.b.y+=dy; }
                if(s.type==='text'){ s.x+=dx; s.y+=dy; }
                sel.bbox=bboxStroke(s); }
          renderAll(p); drawSelection(p);
        }
        return;
      }
      if(tool===TOOLS.CROP && cropping){ updateCrop(x,y,p); return; }
      if(tool===TOOLS.ERASER){ previewErase({x,y},p); return; }
      if(!drawing) return;
      if(tool===TOOLS.PEN){ current.points.push({x,y}); renderAll(p); }
      else if(tool===TOOLS.LINE){ current.b={x,y}; clearOverlay(p); p.ovl.lineCap='round'; p.ovl.lineJoin='round'; p.ovl.strokeStyle=color; p.ovl.lineWidth=size; p.ovl.beginPath(); p.ovl.moveTo(startX,startY); p.ovl.lineTo(x,y); p.ovl.stroke(); }
    }
    function end(x,y){
      if(tool===TOOLS.SELECT){ p.state.dragging=null; return; }
      if(tool===TOOLS.CROP && cropping){ cropping=false; finalizeCrop(x,y,p); return; }
      if(!drawing) return;
      if(tool===TOOLS.LINE){ clearOverlay(p); current.b={x,y}; p.state.strokes.push(current); renderAll(p); }
      drawing=false; current=null;
    }

    // mouse
    p.drawC.addEventListener('mousedown', e=>{ const {x,y}=getXY(e); start(x,y); });
    window.addEventListener('mousemove', e=>{ const {x,y}=getXY(e); move(x,y); });
    window.addEventListener('mouseup',   e=>{ const {x,y}=getXY(e); end(x,y); });

    // touch (wa≈ºne: passive:false)
    p.drawC.addEventListener('touchstart', e=>{ e.preventDefault(); const {x,y}=getXY(e); start(x,y); }, {passive:false});
    window.addEventListener('touchmove',   e=>{ if(drawing || tool!==TOOLS.SELECT) e.preventDefault(); const {x,y}=getXY(e); move(x,y); }, {passive:false});
    window.addEventListener('touchend',    e=>{ e.preventDefault(); const {x,y}=getXY(e); end(x,y); }, {passive:false});

    new ResizeObserver(()=>{ resize(p); drawGrid(p); renderAll(p); drawSelection(p); }).observe(p.el);
  }

  /* --- UI --- */
  const toolBtns=[...document.querySelectorAll('[data-tool]')];
  function toolLabel(){ return tool===TOOLS.SELECT?'Kursor':tool===TOOLS.PEN?'O≈Ç√≥wek':tool===TOOLS.LINE?'Linia':tool===TOOLS.ERASER?'Gumka':tool===TOOLS.TEXT?'Tekst':'Wycinanie'; }
  function setTool(t){ tool=t; stateEl.textContent=`Tryb: ${toolLabel()} ‚Ä¢ ${size}px ‚Ä¢ ${color}`; toolBtns.forEach(b=>b.classList.toggle('is-active', b.getAttribute('data-tool')===tool)); }
  document.getElementById('tools').addEventListener('click', (e)=>{ const b=e.target.closest('[data-tool]'); if(!b) return; setTool(b.getAttribute('data-tool')); });
  document.getElementById('color').addEventListener('input', e=>{ color=e.target.value; stateEl.textContent=`Tryb: ${toolLabel()} ‚Ä¢ ${size}px ‚Ä¢ ${color}`; });
  document.getElementById('size').addEventListener('change', e=>{ size=parseInt(e.target.value,10); stateEl.textContent=`Tryb: ${toolLabel()} ‚Ä¢ ${size}px ‚Ä¢ ${color}`; });
  window.addEventListener('keydown', (e)=>{ if(e.key==='v'||e.key==='V') setTool(TOOLS.SELECT); if(e.key==='p'||e.key==='P') setTool(TOOLS.PEN); if(e.key==='l'||e.key==='L') setTool(TOOLS.LINE); if(e.key==='e'||e.key==='E') setTool(TOOLS.ERASER); if(e.key==='t'||e.key==='T') setTool(TOOLS.TEXT); if(e.key==='c'||e.key==='C') setTool(TOOLS.CROP); });

  // MENU
  const menuBtn=document.getElementById('menuBtn');
  const dropdown=document.getElementById('dropdown');
  function toggleMenu(force){ const open=typeof force==='boolean'?force:!dropdown.classList.contains('open'); dropdown.classList.toggle('open',open); menuBtn.setAttribute('aria-expanded',String(open)); }
  menuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); });
  document.addEventListener('click', (e)=>{ if(!dropdown.contains(e.target) && e.target!==menuBtn){ toggleMenu(false);} });
  dropdown.querySelectorAll('[data-grid]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ gridSize=parseInt(btn.getAttribute('data-grid'),10)||0; PAGES.forEach(drawGrid); toggleMenu(false); });
  });
  document.getElementById('newPageBtn').addEventListener('click', ()=>{ createPage(); toggleMenu(false); });
  document.getElementById('newBoardBtn').addEventListener('click', ()=>{ pagesEl.innerHTML=''; PAGES.length=0; createPage(); window.scrollTo({top:0,behavior:'smooth'}); toggleMenu(false); });

  // EXPORT
  async function exportCurrent(ext){
    const p=currentPage(); if(!p) return;
    const c=await compositePageCanvas(p);
    if(ext==='png'){ const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download=ts('png'); a.click(); }
    if(ext==='jpg'){ const a=document.createElement('a'); a.href=c.toDataURL('image/jpeg',.92); a.download=ts('jpg'); a.click(); }
    if(ext==='pdf'){ const lib=window.jspdf?.jsPDF; if(!lib) return alert('PDF nieza≈Çadowany.'); const data=c.toDataURL('image/png'); const pdf=new lib({orientation:'portrait',unit:'pt',format:'a4'}); const pw=pdf.internal.pageSize.getWidth(), ph=pdf.internal.pageSize.getHeight(); const img=new Image(); img.onload=()=>{ const ratio=Math.min(pw/img.width,ph/img.height); const w=img.width*ratio, h=img.height*ratio; const x=(pw-w)/2, y=(ph-h)/2; pdf.addImage(data,'PNG',x,y,w,h); pdf.save(ts('pdf')); }; img.src=data; }
  }
  function ts(ext){ return `aliboard_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.${ext}`; }
  document.getElementById('savePng').addEventListener('click', ()=>{ exportCurrent('png'); toggleMenu(false); });
  document.getElementById('saveJpg').addEventListener('click', ()=>{ exportCurrent('jpg'); toggleMenu(false); });
  document.getElementById('savePdf').addEventListener('click', ()=>{ exportCurrent('pdf'); toggleMenu(false); });

  // UNDO/REDO/CLEAR
  document.getElementById('undo').addEventListener('click', ()=>{ const p=currentPage(); if(!p||!p.state.history.length) return; const last=p.state.history.pop(); p.state.redo.push(snapshot(p)); restore(p,last); });
  document.getElementById('redo').addEventListener('click', ()=>{ const p=currentPage(); if(!p||!p.state.redo.length) return; const next=p.state.redo.pop(); p.state.history.push(snapshot(p)); restore(p,next); });
  document.getElementById('clear').addEventListener('click', ()=>{ const p=currentPage(); if(!p) return; pushHistory(p); p.state.strokes=[]; p.state.images=[]; p.state.selection=null; renderAll(p); clearOverlay(p); });

  // OBRAZ/PDF
  document.getElementById('imgInput').addEventListener('change', (e)=>{
    const f=e.target.files[0]; if(!f) return; const p=currentPage(); if(!p) return;
    const url=URL.createObjectURL(f); const tmp=new Image();
    tmp.onload=()=>{ const r=p.el.getBoundingClientRect(); const ratio=Math.min(r.width/tmp.width,r.height/tmp.height); const w=Math.max(80,tmp.width*ratio), h=Math.max(80,tmp.height*ratio); const x=(r.width-w)/2, y=(r.height-h)/2; addImageFromSrc(url,w,h,x,y,{file:true},p); };
    tmp.src=url;
  });
  document.getElementById('pdfInput').addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return; const p=currentPage(); if(!p) return;
    const ab=await f.arrayBuffer(); const pdf=await pdfjsLib.getDocument({data:ab}).promise;
    let pageNum=1; const ask=prompt(`PDF ma ${pdf.numPages} stron. Numer do wstawienia:`, "1"); if(ask){ const n=parseInt(ask,10); if(!isNaN(n)&&n>=1&&n<=pdf.numPages) pageNum=n; }
    const page=await pdf.getPage(pageNum); const viewport=page.getViewport({scale:2}); const c=document.createElement('canvas'); c.width=viewport.width; c.height=viewport.height; await page.render({canvasContext:c.getContext('2d'),viewport}).promise;
    const url=c.toDataURL('image/png'); const r=p.el.getBoundingClientRect(); const ratio=Math.min(r.width/c.width,r.height/c.height); const w=Math.max(120,c.width*ratio), h=Math.max(120,c.height*ratio); const x=(r.width-w)/2, y=(r.height-h)/2; addImageFromSrc(url,w,h,x,y,{pdf:true,page:pageNum},p);
  });

  // AUTO-A4 przy scrolu
  wrapEl.addEventListener('scroll', ()=>{ const near=wrapEl.scrollTop + wrapEl.clientHeight >= wrapEl.scrollHeight - 80; if(near){ createPage(); } }, {passive:true});

  // START
  createPage();
  setTool(TOOLS.SELECT);
})();
</script>
</body>
</html>
