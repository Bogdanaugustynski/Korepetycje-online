{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aliboard 2.5 ‚Äî PolubiszTo.pl (test)</title>

<!-- PDF render (klient) -->
<link rel="preload" as="script" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- PDF export (klient) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>

<style>
  :root{
    --brand:#0b74ff; --ink:#0b1320; --muted:#5b6777; --line:#e6edff;
    --card:#fff; --bg:#f7f9fe; --radius:16px;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{
    position:sticky; top:0; z-index:50; background:#fff; border-bottom:1px solid var(--line);
    display:flex; align-items:stretch; gap:12px; padding:10px 12px;
  }
  .brand{display:flex;align-items:center;gap:10px;min-width:190px}
  .brand .mark{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;overflow:hidden;flex:0 0 auto}
  .brand .mark img{width:100%;height:100%;object-fit:contain}
  .state{font-size:12px;color:var(--muted)}
  /* Pasek narzƒôdzi przewijany (powr√≥t do 2.4) */
  .toolrow{
    display:flex; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch;
    scroll-snap-type:x proximity; flex:1; padding-bottom:2px;
  }
  .toolrow::-webkit-scrollbar{height:8px} .toolrow::-webkit-scrollbar-thumb{background:#e6edff;border-radius:8px}
  .btn{
    border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px 12px;
    font-weight:700; cursor:pointer; user-select:none; touch-action:manipulation; white-space:nowrap;
  }
  .btn.icon-only{padding:10px}
  .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
  .btn.is-active{ outline:2px solid var(--brand); outline-offset:2px }
  .btn[title]{position:relative}
  /* Tooltips POD przyciskiem */
  .btn[title]:hover::after{
    content:attr(title); position:absolute; top:calc(100% + 6px); left:50%; transform:translateX(-50%);
    background:#111;color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;white-space:nowrap
  }
  /* Menu */
  .right{margin-left:auto; display:flex; align-items:flex-start; position:relative}
  .menu-wrap{position:relative; z-index:60}
  .dropdown{
    position:absolute; right:0; top:calc(100% + 8px); min-width:250px;
    background:#fff; border:1px solid var(--line); border-radius:12px;
    box-shadow:0 16px 48px rgba(11,116,255,.18); padding:8px; display:none;
  }
  .dropdown.open{display:block}
  .drop-group{padding:6px}
  .drop-title{font-size:12px;color:var(--muted);margin:4px 6px 6px}
  .drop-row{display:flex; gap:6px; flex-wrap:wrap}
  .drop-item{width:100%; text-align:left; background:#fff; border:1px solid var(--line);
    border-radius:10px; padding:8px 10px; cursor:pointer; margin:4px 0}
  .drop-item.primary{background:var(--brand);color:#fff;border-color:transparent}

  /* Etap rysowania */
  .pages{ position:relative; }
  .page{
    position:relative; margin:18px auto; background:#fff; border:1px solid var(--line);
    box-shadow:0 8px 26px rgba(15,23,42,.06); width:calc(min(100% - 24px, 1123px)); /* ~A4 w px w poziomie dla landscape rysowania */
    aspect-ratio: 1.414/1; /* A4 (wys/szer) w pionie ‚Äî ale u≈ºywamy wysokiej sekcji */
    height:calc(1123px * 1.414); /* ~A4 portrait, przewijalna */
    border-radius:12px; overflow:hidden;
  }
  canvas{ position:absolute; inset:0; width:100%; height:100%; touch-action:none; }
  .grid, .overlay{pointer-events:none}

  .footer{ position:fixed; right:12px; bottom:12px; display:flex; gap:8px; flex-wrap:wrap; z-index:40 }

  /* Pole tekstowe inline */
  .text-editor{
    position:absolute; min-width:120px; min-height:28px; padding:6px 8px;
    border:1.5px dashed var(--brand); border-radius:8px; background:#ffffffcc;
    outline:0; font: 16px/1.3 ui-sans-serif, system-ui, Arial; color:var(--ink);
  }

  @media (max-width: 900px){
    .brand{min-width:auto}
    .btn{padding:10px}
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="mark">
      <!-- Sama g≈Çowa loga (statics) -->
      <img src="{% static 'img/brand/logo_head.png' %}" alt="PolubiszTo.pl">
    </div>
    <div>
      <div style="font-weight:800">Aliboard</div>
      <div class="state" id="state">Tryb: Kursor ‚Ä¢ 3px ‚Ä¢ #0b74ff</div>
    </div>
  </div>

  <div class="toolrow" id="tools" aria-label="Pasek narzƒôdzi" role="toolbar">
    <button class="btn icon-only" data-tool="select" title="Kursor (V)">üñ±Ô∏è</button>
    <button class="btn icon-only" data-tool="pen" title="O≈Ç√≥wek (P)">‚úèÔ∏è</button>
    <button class="btn icon-only" data-tool="line" title="Linia (L)">Ôºè</button>
    <button class="btn icon-only" data-tool="eraser" title="Gumka ‚Äî usu≈Ñ kreskƒô (E)">ü©π</button>
    <button class="btn icon-only" data-tool="crop" title="Wycinanie (C)">‚úÇÔ∏è</button>
    <button class="btn icon-only" data-tool="text" title="Tekst (T)">T</button>

    <!-- Kolor i grubo≈õƒá -->
    <label class="btn" title="Kolor pisaka">
      üé® <input type="color" id="color" value="#0b74ff" style="width:28px;height:28px;border:0;padding:0;background:#fff;border-radius:8px;margin-left:6px">
    </label>
    <label class="btn" title="Grubo≈õƒá linii">
      ‚ÜïÔ∏è
      <select id="size" style="border:1px solid var(--line);border-radius:8px;padding:6px 8px;background:#fff;margin-left:6px">
        <option value="1">1px</option>
        <option value="3" selected>3px</option>
        <option value="5">5px</option>
        <option value="8">8px</option>
      </select>
    </label>

    <!-- Obraz + PDF (ikony) -->
    <label class="btn icon-only" title="Wstaw obraz">
      üñºÔ∏è
      <input id="imgInput" type="file" accept="image/*" style="display:none">
    </label>
    <label class="btn icon-only" title="Wstaw PDF">
      üìÑ
      <input id="pdfInput" type="file" accept="application/pdf" style="display:none">
    </label>

    <button class="btn icon-only" id="undo" title="Cofnij (Ctrl+Z)">‚Ü∂</button>
    <button class="btn icon-only" id="redo" title="Pon√≥w (Ctrl+Y)">‚Ü∑</button>
    <button class="btn icon-only" id="clear" title="Wyczy≈õƒá">üóëÔ∏è</button>
  </div>

  <!-- MENU po prawej -->
  <div class="right">
    <div class="menu-wrap">
      <button class="btn primary" id="menuBtn" aria-expanded="false" aria-controls="dropdown">‚ò∞ Menu</button>
      <div class="dropdown" id="dropdown" role="menu" aria-labelledby="menuBtn">
        <div class="drop-group">
          <div class="drop-title">Tablica</div>
          <div class="drop-row">
            <button class="drop-item primary" id="newBoard">‚ûï Nowa tablica</button>
            <button class="drop-item" id="newPage">üìÑ Nowa kartka A4</button>
          </div>
        </div>
        <div class="drop-group">
          <div class="drop-title">Siatka</div>
          <div class="drop-row">
            <button class="drop-item" data-grid="0">Brak</button>
            <button class="drop-item" data-grid="16">Ma≈Ça</button>
            <button class="drop-item" data-grid="24">≈örednia</button>
            <button class="drop-item" data-grid="32">Du≈ºa</button>
          </div>
        </div>
        <div class="drop-group">
          <div class="drop-title">Zapisz</div>
          <div class="drop-row">
            <button class="drop-item" id="savePng">üíæ PNG (bie≈ºƒÖca)</button>
            <button class="drop-item" id="saveJpg">üñºÔ∏è JPG (bie≈ºƒÖca)</button>
            <button class="drop-item" id="savePdf">üìÑ PDF (bie≈ºƒÖca)</button>
            <button class="drop-item" id="savePdfAll">üìö PDF (wszystkie kartki)</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- PAGES -->
<main class="pages" id="pages"></main>

<div class="footer">
  <a href="{% url 'pokoj_testowy' %}" class="btn">‚Üê Powr√≥t do Pokoju Testowego</a>
  <span class="btn" id="roomInfo" title="Room ID z query string">room_id: ‚Äî</span>
</div>

<script>
(()=>{
// ===== Model stron (A4) =====
const pagesEl = document.getElementById('pages');
const roomInfo = document.getElementById('roomInfo');
const qs = new URLSearchParams(location.search);
roomInfo.textContent = 'room_id: ' + (qs.get('room') || 'local-test');

const TOOLS = { SELECT:'select', PEN:'pen', LINE:'line', ERASER:'eraser', CROP:'crop', TEXT:'text' };
let tool = TOOLS.SELECT;
let color = '#0b74ff';
let size  = 3;
let gridSize = 0;

const stateEl = document.getElementById('state');
const toolButtons = Array.from(document.querySelectorAll('[data-tool]'));

function setTool(next){
  tool = next;
  updateState();
  toolButtons.forEach(b=> b.classList.toggle('is-active', b.getAttribute('data-tool')===tool));
}
function toolLabel(){
  return tool===TOOLS.SELECT?'Kursor':
         tool===TOOLS.PEN?'O≈Ç√≥wek':
         tool===TOOLS.LINE?'Linia':
         tool===TOOLS.ERASER?'Gumka':
         tool===TOOLS.CROP?'Wycinanie':'Tekst';
}
function updateState(){ stateEl.textContent = `Tryb: ${toolLabel()} ‚Ä¢ ${size}px ‚Ä¢ ${color}`; }

// ===== Struktura strony =====
function createPage(){
  const wrap = document.createElement('section');
  wrap.className = 'page';
  wrap.innerHTML = `
    <canvas class="grid"></canvas>
    <canvas class="draw"></canvas>
    <canvas class="overlay"></canvas>
  `;
  pagesEl.appendChild(wrap);

  const gridC = wrap.querySelector('.grid');
  const drawC = wrap.querySelector('.draw');
  const ovlC  = wrap.querySelector('.overlay');
  const g  = gridC.getContext('2d');
  const ctx= drawC.getContext('2d');
  const ovl= ovlC.getContext('2d');

  const page = {
    el: wrap, gridC, drawC, ovlC, g, ctx, ovl,
    strokes: [], images: [],
    selection: null, dragging: null, history: [], redo: [],
    editorEl: null, cropRect: null
  };
  pageResize(page);
  attachEvents(page);
  drawGrid(page);
  renderAll(page);
  return page;
}
let PAGES = [];
function newPage(){ const p = createPage(); PAGES.push(p); return p; }
function clearBoard(){
  pagesEl.innerHTML = '';
  PAGES = [];
  newPage();
  setTool(TOOLS.SELECT);
}
clearBoard();

// ===== DPI resize per page =====
function pageResize(page){
  const dpr = window.devicePixelRatio || 1;
  [page.gridC, page.drawC, page.ovlC].forEach(c=>{
    const rect = page.el.getBoundingClientRect();
    c.width  = Math.floor(rect.width * dpr);
    c.height = Math.floor(rect.height * dpr);
    c.style.width  = rect.width + 'px';
    c.style.height = rect.height + 'px';
    c.getContext('2d').setTransform(dpr,0,0,dpr,0,0);
  });
}
function drawGrid(page){
  const {gridC,g} = page;
  const dpr = window.devicePixelRatio || 1;
  const w = gridC.width / dpr, h = gridC.height / dpr;
  g.clearRect(0,0,w,h);
  if(!gridSize) return;
  g.save(); g.strokeStyle='#e6edff'; g.lineWidth=1;
  for(let x=0;x<=w;x+=gridSize){ g.beginPath(); g.moveTo(x,0); g.lineTo(x,h); g.stroke(); }
  for(let y=0;y<=h;y+=gridSize){ g.beginPath(); g.moveTo(0,y); g.lineTo(w,y); g.stroke(); }
  g.restore();
}
function renderAll(page){
  const {drawC, ctx, images, strokes} = page;
  const dpr = window.devicePixelRatio || 1;
  const w = drawC.width / dpr, h = drawC.height / dpr;
  ctx.clearRect(0,0,w,h);

  // 1) Obrazy najpierw
  for(const im of images){
    if(!im._el){
      im._el = new Image();
      im._el.src = im.src;
      // Po za≈Çadowaniu jedna repainty
      im._el.decode?.().then(()=> renderAll(page)).catch(()=> ctx.drawImage(im._el, im.x, im.y, im.w, im.h));
    }
    try{ ctx.drawImage(im._el, im.x, im.y, im.w, im.h); }catch(_){}
  }

  // 2) Wektory nad obrazami
  ctx.lineCap='round'; ctx.lineJoin='round';
  for(const s of strokes){
    if(s.type==='pen'){
      const pts=s.points; if(!pts.length) continue;
      ctx.strokeStyle=s.color; ctx.lineWidth=s.size;
      ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++){ ctx.lineTo(pts[i].x, pts[i].y); }
      ctx.stroke();
    }else if(s.type==='line'){
      ctx.strokeStyle=s.color; ctx.lineWidth=s.size;
      ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
    }else if(s.type==='text'){
      ctx.save(); ctx.fillStyle=s.color;
      ctx.font = `${Math.max(14, s.size*6)}px ui-sans-serif, system-ui, Arial`;
      ctx.textBaseline='top'; ctx.fillText(s.text, s.x, s.y); ctx.restore();
    }
  }
  drawSelection(page);
}
function drawSelection(page){
  const {ovl, ovlC, selection} = page;
  ovl.clearRect(0,0, ovlC.width, ovlC.height);
  if(!selection) return;
  const b = selection.bbox;
  ovl.save();
  ovl.strokeStyle = '#0b74ff'; ovl.lineWidth = 1.5; ovl.setLineDash([6,4]);
  ovl.strokeRect(b.x, b.y, b.w, b.h);
  ovl.setLineDash([]);
  // uchwyty
  const hs = 10;
  const pts = handlePoints(b);
  ovl.fillStyle='#fff'; ovl.strokeStyle='#0b74ff'; ovl.lineWidth=2;
  pts.forEach(p=>{ ovl.beginPath(); ovl.rect(p.x-hs/2,p.y-hs/2,hs,hs); ovl.fill(); ovl.stroke(); });
  ovl.restore();
}
function handlePoints(b){
  const cx=b.x+b.w/2, cy=b.y+b.h/2;
  return [
    {x:b.x, y:b.y}, {x:cx, y:b.y}, {x:b.x+b.w, y:b.y},
    {x:b.x, y:cy},                {x:b.x+b.w, y:cy},
    {x:b.x, y:b.y+b.h}, {x:cx, y:b.y+b.h}, {x:b.x+b.w, y:b.y+b.h},
  ];
}
function bboxOfStroke(s){
  if(s.type==='pen'){
    const xs=s.points.map(p=>p.x), ys=s.points.map(p=>p.y);
    return {x:Math.min(...xs), y:Math.min(...ys), w:Math.max(...xs)-Math.min(...xs), h:Math.max(...ys)-Math.min(...ys)};
  }else if(s.type==='line'){
    const minx=Math.min(s.a.x,s.b.x), maxx=Math.max(s.a.x,s.b.x);
    const miny=Math.min(s.a.y,s.b.y), maxy=Math.max(s.a.y,s.b.y);
    return {x:minx,y=miny,w:maxx-minx,h:maxy-miny};
  }else if(s.type==='text'){
    const w = (Math.max(14, s.size*6)*0.6)*(s.text?.length||0);
    const h = Math.max(14, s.size*6);
    return {x:s.x, y:s.y, w, h};
  }
  return {x:0,y:0,w:0,h:0};
}

// ===== Historia =====
function pushHistory(p){ p.redo = []; p.history.push(JSON.stringify({strokes:p.strokes, images:p.images})); if(p.history.length>80) p.history.shift(); }
function restoreHistory(p, json){
  try{
    const s = JSON.parse(json);
    p.strokes = s.strokes||[]; p.images = s.images||[];
    p.selection=null; renderAll(p);
  }catch(_){}
}

// ===== Hity/odleg≈Ço≈õci =====
const dist = (a,b)=> Math.hypot(a.x-b.x, a.y-b.y);
function distToSegment(p, a, b){
  const ABx=b.x-a.x, ABy=b.y-a.y, APx=p.x-a.x, APy=p.y-a.y;
  const ab2=ABx*ABx+ABy*ABy; const t=ab2?Math.max(0,Math.min(1,(APx*ABx+APy*ABy)/ab2)):0;
  const proj={x:a.x+t*ABx,y:a.y+t*ABy}; return dist(p,proj);
}
function hitPolyline(pts, p, eps){ for(let i=1;i<pts.length;i++){ if(distToSegment(p, pts[i-1], pts[i])<=eps) return true;} return false; }
function approxTextWidth(s){ return (Math.max(14, s.size*6)*0.6)*(s.text?.length||0); }

// ===== Interakcje =====
function attachEvents(p){
  // resize jednej strony gdy okno siƒô zmienia
  const ro = new ResizeObserver(()=>{ pageResize(p); drawGrid(p); renderAll(p); });
  ro.observe(p.el);

  // wska≈∫nik
  const getXY = (e)=>{
    const r = p.drawC.getBoundingClientRect();
    if(e.touches && e.touches[0]) return { x:e.touches[0].clientX - r.left, y:e.touches[0].clientY - r.top };
    if(typeof e.clientX==='number') return { x:e.clientX - r.left, y:e.clientY - r.top };
    if(e.changedTouches && e.changedTouches[0]) return { x:e.changedTouches[0].clientX - r.left, y:e.changedTouches[0].clientY - r.top };
    return {x:0,y:0};
  };

  // mousedown/touchstart
  const onStart = (e)=>{
    // nie pozw√≥l, by klik menubutton od razu zamyka≈Ç dropdown
    if(e.target.closest('#dropdown') || e.target.closest('#menuBtn')) return;

    const {x,y} = getXY(e);
    if(tool===TOOLS.SELECT){ startSelect(p, x,y); return; }
    if(tool===TOOLS.ERASER){ pushHistory(p); eraseAt(p,{x,y}); p.dragging=null; return; }
    if(tool===TOOLS.TEXT){ spawnEditor(p,x,y); return; }
    if(tool===TOOLS.CROP){ beginCrop(p,x,y); return; }

    // Rysunek
    pushHistory(p);
    p.dragging = {mode:'draw', startX:x, startY:y};
    if(tool===TOOLS.PEN){
      p._current = {type:'pen', color, size, points:[{x,y}]};
      p.strokes.push(p._current);
      renderAll(p);
    }else if(tool===TOOLS.LINE){
      p._current = {type:'line', color, size, a:{x,y}, b:{x,y}};
    }
  };
  const onMove = (e)=>{
    const {x,y} = getXY(e);
    if(tool===TOOLS.SELECT){
      if(p.dragging){
        const dx=x-p.dragging.startX, dy=y-p.dragging.startY;
        if(p.dragging.mode==='move') applyMove(p, dx,dy);
        if(p.dragging.mode==='scale') applyScale(p, p.dragging.handle, dx,dy);
        p.dragging.startX=x; p.dragging.startY=y;
      }
      return;
    }
    if(tool===TOOLS.ERASER){ previewErase(p,{x,y}); return; }
    if(tool===TOOLS.CROP){ moveCrop(p,x,y); return; }

    if(!p.dragging) return;
    if(tool===TOOLS.PEN){
      p._current.points.push({x,y}); renderAll(p);
    }else if(tool===TOOLS.LINE){
      p._current.b = {x,y};
      p.ovl.clearRect(0,0,p.ovlC.width,p.ovlC.height);
      p.ovl.lineCap='round'; p.ovl.lineJoin='round';
      p.ovl.strokeStyle=color; p.ovl.lineWidth=size;
      p.ovl.beginPath(); p.ovl.moveTo(p.dragging.startX,p.dragging.startY); p.ovl.lineTo(x,y); p.ovl.stroke();
    }
  };
  const onEnd = (e)=>{
    const {x,y} = getXY(e);
    if(tool===TOOLS.SELECT){ p.dragging=null; return; }
    if(tool===TOOLS.ERASER){ p.ovl.clearRect(0,0,p.ovlC.width,p.ovlC.height); return; }
    if(tool===TOOLS.CROP){ endCrop(p,x,y); return; }

    if(!p.dragging) return;
    if(tool===TOOLS.LINE){
      p.ovl.clearRect(0,0,p.ovlC.width,p.ovlC.height);
      p._current.b = {x,y}; p.strokes.push(p._current); renderAll(p);
    }
    p.dragging=null; p._current=null;
  };

  // Eventy ‚Äî wa≈ºne dla mobile: passive:false i preventDefault na touchmove
  p.drawC.addEventListener('mousedown', onStart, {passive:true});
  p.drawC.addEventListener('touchstart', (e)=>{ e.preventDefault(); onStart(e); }, {passive:false});

  window.addEventListener('mousemove', onMove, {passive:true});
  window.addEventListener('touchmove', (e)=>{ e.preventDefault(); onMove(e); }, {passive:false});

  window.addEventListener('mouseup', onEnd, {passive:true});
  window.addEventListener('touchend', (e)=>{ e.preventDefault(); onEnd(e); }, {passive:false});
  window.addEventListener('mouseleave', onEnd, {passive:true});

  // Undo/redo/clear dla aktywnej strony
  document.getElementById('undo').addEventListener('click', ()=>{ if(!p.history.length) return; const last=p.history.pop(); p.redo.push(JSON.stringify({strokes:p.strokes,images:p.images})); restoreHistory(p,last); }, {passive:true});
  document.getElementById('redo').addEventListener('click', ()=>{ if(!p.redo.length) return; const next=p.redo.pop(); p.history.push(JSON.stringify({strokes:p.strokes,images:p.images})); restoreHistory(p,next); }, {passive:true});
  document.getElementById('clear').addEventListener('click', ()=>{ pushHistory(p); p.strokes=[]; p.images=[]; p.selection=null; renderAll(p); }, {passive:true});

  // Auto-dodawanie kartki A4 przy doj≈õciu do do≈Çu strony
  p.el.addEventListener('touchend', ()=> maybeAddPageOnBottom(p), {passive:true});
  p.el.addEventListener('mouseup',   ()=> maybeAddPageOnBottom(p), {passive:true});
}
function maybeAddPageOnBottom(page){
  const r = page.el.getBoundingClientRect();
  // je≈õli dolny brzeg strony jest w polu widzenia i u≈ºytkownik by≈Ç blisko do≈Çu ‚Äî dodaj nastƒôpnƒÖ
  if(r.bottom < window.innerHeight + 120){ newPage(); }
}

// ===== Select / Move / Scale =====
function startSelect(p,x,y){
  // uchwyty?
  if(p.selection){
    const h = hitHandle({x,y}, p.selection.bbox);
    if(h>=0){ p.dragging={mode:'scale', handle:h, startX:x, startY:y}; pushHistory(p); return; }
    const b=p.selection.bbox;
    if(x>=b.x&&x<=b.x+b.w&&y>=b.y&&y<=b.y+b.h){ p.dragging={mode:'move', startX:x, startY:y}; pushHistory(p); return; }
  }
  // nowy hit
  const hit = hitTest(p,{x,y});
  p.selection = hit; renderAll(p);
}
function hitHandle(pnt, b){
  const hs=10, pts=handlePoints(b);
  for(let i=0;i<pts.length;i++){
    if(Math.abs(pnt.x-pts[i].x)<=hs && Math.abs(pnt.y-pts[i].y)<=hs) return i;
  }
  return -1;
}
function hitTest(p,pnt){
  // images najpierw (od g√≥ry)
  for(let i=p.images.length-1;i>=0;i--){
    const im=p.images[i];
    if(pnt.x>=im.x && pnt.x<=im.x+im.w && pnt.y>=im.y && pnt.y<=im.y+im.h){
      return {kind:'image', index:i, bbox:{x:im.x,y:im.y,w:im.w,h:im.h}};
    }
  }
  const eps = Math.max(6, size*2);
  for(let i=p.strokes.length-1;i>=0;i--){
    const s=p.strokes[i];
    if(s.type==='pen'){ if(hitPolyline(s.points,pnt,eps)) return {kind:'stroke',index:i,bbox:bboxOfStroke(s)}; }
    else if(s.type==='line'){ if(distToSegment(pnt,s.a,s.b)<=eps) return {kind:'stroke',index:i,bbox:bboxOfStroke(s)}; }
    else if(s.type==='text'){
      const b=bboxOfStroke(s);
      if(pnt.x>=b.x&&pnt.x<=b.x+b.w&&pnt.y>=b.y&&pnt.y<=b.y+b.h) return {kind:'stroke',index:i,bbox:b};
    }
  }
  return null;
}
function applyMove(p,dx,dy){
  const sel=p.selection; if(!sel) return;
  if(sel.kind==='image'){
    const im=p.images[sel.index]; im.x+=dx; im.y+=dy; sel.bbox.x+=dx; sel.bbox.y+=dy;
  }else{
    const s=p.strokes[sel.index];
    if(s.type==='pen') s.points.forEach(pt=>{pt.x+=dx; pt.y+=dy;});
    else if(s.type==='line'){ s.a.x+=dx; s.a.y+=dy; s.b.x+=dx; s.b.y+=dy; }
    else if(s.type==='text'){ s.x+=dx; s.y+=dy; }
    sel.bbox = bboxOfStroke(s);
  }
  renderAll(p);
}
function applyScale(p,handle,dx,dy){
  const sel=p.selection; if(!sel) return;
  const b = sel.bbox;
  let {x,y,w,h}=b; const ox=x,oy=y,ow=w,oh=h;
  const minSize=10;
  if(handle===0){ x += dx; y += dy; w -= dx; h -= dy; }
  if(handle===1){ y += dy; h -= dy; }
  if(handle===2){ y += dy; h -= dy; w += dx; }
  if(handle===3){ x += dx; w -= dx; }
  if(handle===4){ w += dx; }
  if(handle===5){ x += dx; w -= dx; h += dy; }
  if(handle===6){ h += dy; }
  if(handle===7){ w += dx; h += dy; }
  w=Math.max(minSize,w); h=Math.max(minSize,h);
  const sx=w/ow, sy=h/oh;

  if(sel.kind==='image'){
    const im=p.images[sel.index]; im.x=x; im.y=y; im.w=w; im.h=h;
  }else{
    const s=p.strokes[sel.index];
    if(s.type==='pen'){ s.points=s.points.map(pt=>({x:x + (pt.x-ox)*sx, y:y + (pt.y-oy)*sy})); }
    else if(s.type==='line'){ s.a={x:x+(s.a.x-ox)*sx, y:y+(s.a.y-oy)*sy}; s.b={x:x+(s.b.x-ox)*sx, y:y+(s.b.y-oy)*sy}; }
    else if(s.type==='text'){ s.x=x; s.y=y; }
  }
  sel.bbox={x,y,w,h}; renderAll(p);
}

// ===== Gumka (pod≈õwietla cel i kasuje ca≈Çe kreski/teksty) =====
function previewErase(p,pnt){
  const {ovl, ovlC, strokes} = p;
  ovl.clearRect(0,0,ovlC.width,ovlC.height);
  if(p.selection) drawSelection(p);
  const eps = Math.max(6, size*2);
  for(let i=strokes.length-1;i>=0;i--){
    const s=strokes[i];
    let hit=false;
    if(s.type==='pen') hit=hitPolyline(s.points,pnt,eps);
    else if(s.type==='line') hit=distToSegment(pnt,s.a,s.b)<=eps;
    else if(s.type==='text'){
      const b=bboxOfStroke(s); hit=(pnt.x>=b.x && pnt.x<=b.x+b.w && pnt.y>=b.y && pnt.y<=b.y+b.h);
    }
    if(hit){
      ovl.save();
      if(s.type==='text'){
        const b=bboxOfStroke(s);
        ovl.strokeStyle='#ff3b3b'; ovl.lineWidth=2; ovl.setLineDash([5,4]); ovl.strokeRect(b.x,b.y,b.w,b.h); ovl.setLineDash([]);
      }else{
        ovl.strokeStyle='#ff3b3b'; ovl.lineWidth=Math.max(2,s.size+2);
        ovl.beginPath(); if(s.type==='pen'){ const pts=s.points; ovl.moveTo(pts[0].x,pts[0].y); for(let j=1;j<pts.length;j++) ovl.lineTo(pts[j].x,pts[j].y); }
        else { ovl.moveTo(s.a.x,s.a.y); ovl.lineTo(s.b.x,s.b.y); }
        ovl.stroke();
      }
      ovl.restore(); return;
    }
  }
}
function eraseAt(p,pnt){
  const eps = Math.max(6, size*2);
  for(let i=p.strokes.length-1;i>=0;i--){
    const s=p.strokes[i];
    if(s.type==='pen' && hitPolyline(s.points,pnt,eps)){ p.strokes.splice(i,1); renderAll(p); p.ovl.clearRect(0,0,p.ovlC.width,p.ovlC.height); return; }
    if(s.type==='line' && distToSegment(pnt,s.a,s.b)<=eps){ p.strokes.splice(i,1); renderAll(p); p.ovl.clearRect(0,0,p.ovlC.width,p.ovlC.height); return; }
    if(s.type==='text'){ const b=bboxOfStroke(s); if(pnt.x>=b.x&&pnt.x<=b.x+b.w&&pnt.y>=b.y&&pnt.y<=b.y+b.h){ p.strokes.splice(i,1); renderAll(p); p.ovl.clearRect(0,0,p.ovlC.width,p.ovlC.height); return; } }
  }
}

// ===== Tekst inline =====
function spawnEditor(p,x,y){
  if(p.editorEl){ p.editorEl.remove(); p.editorEl=null; }
  const ed = document.createElement('div');
  ed.className='text-editor';
  ed.contentEditable='true';
  ed.style.left = x+'px'; ed.style.top = y+'px';
  p.el.appendChild(ed);
  ed.focus();

  const commit = ()=>{
    const txt = ed.textContent.trim();
    ed.remove(); p.editorEl=null;
    if(!txt) return;
    p.strokes.push({type:'text', color, size, x, y, text:txt});
    renderAll(p);
  };
  ed.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); commit(); }
    if(e.key==='Escape'){ ed.remove(); p.editorEl=null; }
  });
  ed.addEventListener('blur', commit);
  p.editorEl = ed;
}

// ===== Wycinanie =====
function beginCrop(p,x,y){ p.cropRect={x,y,w:0,h:0}; drawCropRect(p); }
function moveCrop(p,x,y){
  if(!p.cropRect) return;
  p.cropRect.w = x - p.cropRect.x;
  p.cropRect.h = y - p.cropRect.y;
  drawCropRect(p);
}
function endCrop(p,x,y){
  if(!p.cropRect) return;
  // znormalizuj
  let {x:cx,y:cy,w,h} = p.cropRect;
  if(w<0){ cx=cx+w; w=-w; } if(h<0){ cy=cy+h; h=-h; }
  drawCropRect(p,true);

  // wytnij z kompozytu strony (obrazy + wektory)
  const comp = compositePageToCanvas(p);
  const cut = document.createElement('canvas');
  cut.width = w; cut.height = h;
  cut.getContext('2d').drawImage(comp, cx, cy, w, h, 0, 0, w, h);
  const url = cut.toDataURL('image/png');

  // wklej pod tre≈õciƒÖ na tej lub nowej kartce (je≈õli brak miejsca)
  const dpr = window.devicePixelRatio || 1;
  const pageW = p.drawC.width/dpr, pageH = p.drawC.height/dpr;
  const bottomY = getContentBottomY(p);
  const margin = 16;
  let placeY = bottomY + margin;
  let placeX = margin;
  let wFit = Math.min(pageW - 2*margin, w), hFit = (h/w)*wFit;

  if(placeY + hFit > pageH - margin){
    // nowa kartka
    const np = newPage();
    placeX = margin; placeY = margin;
    np.images.push({x:placeX,y:placeY,w:wFit,h:hFit,src:url});
    renderAll(np);
  }else{
    p.images.push({x:placeX,y:placeY,w:wFit,h:hFit,src:url});
    renderAll(p);
  }
  p.cropRect=null;
}
function drawCropRect(p, clear=false){
  const {ovl, ovlC} = p;
  ovl.clearRect(0,0, ovlC.width, ovlC.height);
  if(clear || !p.cropRect) return;
  let {x,y,w,h} = p.cropRect;
  if(w<0){ x+=w; w=-w; } if(h<0){ y+=h; h=-h; }
  ovl.save();
  ovl.setLineDash([6,4]); ovl.strokeStyle='#0b74ff'; ovl.lineWidth=1.5;
  ovl.strokeRect(x,y,w,h);
  ovl.restore();
}
function getContentBottomY(p){
  let maxY = 0;
  p.images.forEach(im=> maxY = Math.max(maxY, im.y+im.h));
  p.strokes.forEach(s=>{
    const b=bboxOfStroke(s); maxY = Math.max(maxY, b.y+b.h);
  });
  return maxY;
}

// ===== Kompozyt strony (do wycinania/zapisu) =====
function compositePageToCanvas(p){
  const dpr = window.devicePixelRatio || 1;
  const W = p.drawC.width / dpr, H = p.drawC.height / dpr;
  const tmp = document.createElement('canvas'); tmp.width = W; tmp.height = H;
  const tctx = tmp.getContext('2d');

  if(gridSize){
    tctx.save(); tctx.strokeStyle='#e6edff'; tctx.lineWidth=1;
    for(let x=0;x<=W;x+=gridSize){ tctx.beginPath(); tctx.moveTo(x,0); tctx.lineTo(x,H); tctx.stroke(); }
    for(let y=0;y<=H;y+=gridSize){ tctx.beginPath(); tctx.moveTo(0,y); tctx.lineTo(W,y); tctx.stroke(); }
    tctx.restore();
  }
  // images
  for(const im of p.images){
    if(im._el){ tctx.drawImage(im._el, im.x, im.y, im.w, im.h); }
    else{
      const el = new Image(); el.src=im.src; try{ tctx.drawImage(el, im.x, im.y, im.w, im.h); }catch(_){}
    }
  }
  // strokes
  tctx.lineCap='round'; tctx.lineJoin='round';
  for(const s of p.strokes){
    if(s.type==='pen'){
      tctx.strokeStyle=s.color; tctx.lineWidth=s.size;
      const pts=s.points; if(!pts.length) continue;
      tctx.beginPath(); tctx.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++){ tctx.lineTo(pts[i].x, pts[i].y); }
      tctx.stroke();
    }else if(s.type==='line'){
      tctx.strokeStyle=s.color; tctx.lineWidth=s.size;
      tctx.beginPath(); tctx.moveTo(s.a.x,s.a.y); tctx.lineTo(s.b.x,s.b.y); tctx.stroke();
    }else if(s.type==='text'){
      tctx.save(); tctx.fillStyle=s.color;
      tctx.font = `${Math.max(14, s.size*6)}px ui-sans-serif, system-ui, Arial`;
      tctx.textBaseline='top'; tctx.fillText(s.text, s.x, s.y); tctx.restore();
    }
  }
  return tmp;
}

// ===== Wstaw obraz / PDF =====
document.getElementById('imgInput').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  const p = PAGES.at(-1);
  const img = new Image();
  img.onload = ()=>{
    const dpr = window.devicePixelRatio||1;
    const W = p.drawC.width/dpr, H = p.drawC.height/dpr;
    const ratio = Math.min((W*0.8)/img.width, (H*0.8)/img.height);
    const w = Math.max(80, img.width*ratio), h=Math.max(80,img.height*ratio);
    const x=(W-w)/2, y=(H-h)/2;
    pushHistory(p);
    p.images.push({x,y,w,h,src:url,_el:img});
    renderAll(p);
  };
  img.src = url;
});

document.getElementById('pdfInput').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const buffer = await f.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: buffer}).promise;
  let pageNum = 1;
  const ask = prompt(`PDF ma ${pdf.numPages} stron. Wpisz numer strony do wstawienia:`, "1");
  if(ask){ const n = parseInt(ask,10); if(!isNaN(n) && n>=1 && n<=pdf.numPages) pageNum=n; }
  const page = await pdf.getPage(pageNum);
  const viewport = page.getViewport({scale: 2});
  const c = document.createElement('canvas'); c.width=viewport.width; c.height=viewport.height;
  const cctx = c.getContext('2d');
  await page.render({canvasContext:cctx, viewport}).promise;
  const url = c.toDataURL('image/png');

  const p = PAGES.at(-1);
  const dpr = window.devicePixelRatio||1;
  const W = p.drawC.width/dpr, H = p.drawC.height/dpr;
  const ratio = Math.min((W*0.9)/c.width, (H*0.9)/c.height);
  const w = Math.max(120, c.width*ratio), h=Math.max(120, c.height*ratio);
  const x=(W-w)/2, y=(H-h)/2;
  pushHistory(p);
  const img = new Image(); img.src=url;
  p.images.push({x,y,w,h,src:url,_el:img, meta:{pdf:true,page:pageNum}});
  renderAll(p);
});

// ===== Menu (z naprawƒÖ tap√≥w) =====
const menuBtn = document.getElementById('menuBtn');
const dropdown = document.getElementById('dropdown');
function toggleMenu(force){
  const open = typeof force==='boolean' ? force : !dropdown.classList.contains('open');
  dropdown.classList.toggle('open', open);
  menuBtn.setAttribute('aria-expanded', String(open));
}
menuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); }, {passive:true});
dropdown.addEventListener('click', (e)=> e.stopPropagation(), {passive:true});
document.addEventListener('click', ()=> toggleMenu(false), {passive:true});

// Nowa tablica / kartka
document.getElementById('newBoard').addEventListener('click', ()=>{ toggleMenu(false); clearBoard(); }, {passive:true});
document.getElementById('newPage').addEventListener('click', ()=>{ toggleMenu(false); newPage(); }, {passive:true});

// Siatka
dropdown.querySelectorAll('[data-grid]').forEach(btn=>{
  btn.addEventListener('click', ()=>{ gridSize=parseInt(btn.getAttribute('data-grid'),10)||0; PAGES.forEach(p=>{ drawGrid(p); renderAll(p); }); toggleMenu(false); }, {passive:true});
});

// Zapis (bie≈ºƒÖca / wszystkie)
function downloadURL(url, name){
  const a = document.createElement('a'); a.href=url; a.download=name; a.click();
}
document.getElementById('savePng').addEventListener('click', ()=>{
  const p=PAGES.at(-1); const c = compositePageToCanvas(p);
  downloadURL(c.toDataURL('image/png'), `aliboard_${Date.now()}.png`); toggleMenu(false);
},{passive:true});
document.getElementById('saveJpg').addEventListener('click', ()=>{
  const p=PAGES.at(-1); const c = compositePageToCanvas(p);
  downloadURL(c.toDataURL('image/jpeg',0.92), `aliboard_${Date.now()}.jpg`); toggleMenu(false);
},{passive:true});
document.getElementById('savePdf').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf || {}; if(!jsPDF){ alert('PDF nieza≈Çadowany.'); return; }
  const p=PAGES.at(-1); const c = compositePageToCanvas(p); const dataUrl=c.toDataURL('image/png');
  const pdf = new jsPDF({orientation:'portrait', unit:'pt', format:'a4'});
  const W=pdf.internal.pageSize.getWidth(), H=pdf.internal.pageSize.getHeight();
  const img=new Image(); img.onload=()=>{ const r=Math.min(W/img.width,H/img.height); const w=img.width*r,h=img.height*r; const x=(W-w)/2,y=(H-h)/2; pdf.addImage(dataUrl,'PNG',x,y,w,h); pdf.save(`aliboard_${Date.now()}.pdf`);};
  img.src=dataUrl; toggleMenu(false);
},{passive:true});
document.getElementById('savePdfAll').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf || {}; if(!jsPDF){ alert('PDF nieza≈Çadowany.'); return; }
  const pdf = new jsPDF({orientation:'portrait', unit:'pt', format:'a4'});
  PAGES.forEach((p,idx)=>{
    const c = compositePageToCanvas(p); const dataUrl=c.toDataURL('image/png');
    if(idx>0) pdf.addPage();
    const W=pdf.internal.pageSize.getWidth(), H=pdf.internal.pageSize.getHeight();
    const img=new Image(); img.onload=()=>{ const r=Math.min(W/img.width,H/img.height); const w=img.width*r,h=img.height*r; const x=(W-w)/2,y=(H-h)/2; pdf.addImage(dataUrl,'PNG',x,y,w,h); if(idx===PAGES.length-1) pdf.save(`aliboard_all_${Date.now()}.pdf`); };
    img.src=dataUrl;
  });
  toggleMenu(false);
},{passive:true});

// Kolor / grubo≈õƒá
document.getElementById('color').addEventListener('input', (e)=>{ color=e.target.value; updateState(); }, {passive:true});
document.getElementById('size').addEventListener('change', (e)=>{ size=parseInt(e.target.value,10); updateState(); }, {passive:true});
updateState();

// Tools ‚Äî NAPRAWA mobile: ≈ºaden kod nie prze≈ÇƒÖcza narzƒôdzia sam z siebie
document.getElementById('tools').addEventListener('click', (e)=>{
  const b = e.target.closest('[data-tool]'); if(!b) return;
  setTool(b.getAttribute('data-tool'));
}, {passive:true});

// Skr√≥ty
window.addEventListener('keydown', (e)=>{
  if(e.key==='v'||e.key==='V') setTool(TOOLS.SELECT);
  if(e.key==='p'||e.key==='P') setTool(TOOLS.PEN);
  if(e.key==='l'||e.key==='L') setTool(TOOLS.LINE);
  if(e.key==='e'||e.key==='E') setTool(TOOLS.ERASER);
  if(e.key==='c'||e.key==='C') setTool(TOOLS.CROP);
  if(e.key==='t'||e.key==='T') setTool(TOOLS.TEXT);
  if(e.ctrlKey && e.key==='z'){ document.getElementById('undo').click(); }
  if(e.ctrlKey && (e.key==='y' || (e.shiftKey && e.key==='Z'))){ document.getElementById('redo').click(); }
});

// ===== Autosave lokalny (ostatnia strona) =====
const KEY='aliboard_v25_state';
setInterval(()=>{ try{
  const dump = PAGES.map(p=>({strokes:p.strokes, images:p.images}));
  localStorage.setItem(KEY, JSON.stringify(dump));
}catch(_){ }}, 30000);
// restore
try{
  const raw = localStorage.getItem(KEY);
  if(raw){
    clearBoard();
    const arr = JSON.parse(raw);
    if(Array.isArray(arr) && arr.length){
      pagesEl.innerHTML=''; PAGES=[];
      arr.forEach((snap,i)=>{
        const p = newPage();
        p.strokes = snap.strokes||[]; p.images = snap.images||[];
        renderAll(p);
      });
    }
  }
}catch(_){}
})();
</script>
</body>
</html>
